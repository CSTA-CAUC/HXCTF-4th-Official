<!DOCTYPE HTML>

<html>
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"/>
<meta content="yes" name="apple-mobile-web-app-capable">
<title>一个re题 - Veneno's Blog</title>
<link href="./一个re题 - Veneno's Blog/highslide.css" rel="stylesheet" type="text/css"/>
<!--[if lt IE 7]>
<link rel="stylesheet" type="text/css" href="http://www.venenof.com/usr/plugins/HighSlide/css/highslide-ie6.css" />
<![endif]-->
<meta content="首先是ida打开，定位到main函数进行分析：大致就是你输入的东西与题目里面生成的一个表产生一些关系，然后最后与那串数字587290150531作比较就OK，但是动态调试发现每次的加载地址都是变..." name="description">
<script type="text/javascript">
(function () {
    window.TypechoComment = {
        dom : function (id) {
            return document.getElementById(id);
        },
    
        create : function (tag, attr) {
            var el = document.createElement(tag);
        
            for (var key in attr) {
                el.setAttribute(key, attr[key]);
            }
        
            return el;
        },

        reply : function (cid, coid) {
            var comment = this.dom(cid), parent = comment.parentNode,
                response = this.dom('respond-post-236'), input = this.dom('comment-parent'),
                form = 'form' == response.tagName ? response : response.getElementsByTagName('form')[0],
                textarea = response.getElementsByTagName('textarea')[0];

            if (null == input) {
                input = this.create('input', {
                    'type' : 'hidden',
                    'name' : 'parent',
                    'id'   : 'comment-parent'
                });

                form.appendChild(input);
            }

            input.setAttribute('value', coid);

            if (null == this.dom('comment-form-place-holder')) {
                var holder = this.create('div', {
                    'id' : 'comment-form-place-holder'
                });

                response.parentNode.insertBefore(holder, response);
            }

            comment.appendChild(response);
            this.dom('cancel-comment-reply-link').style.display = '';

            if (null != textarea && 'text' == textarea.name) {
                textarea.focus();
            }

            return false;
        },

        cancelReply : function () {
            var response = this.dom('respond-post-236'),
            holder = this.dom('comment-form-place-holder'), input = this.dom('comment-parent');

            if (null != input) {
                input.parentNode.removeChild(input);
            }

            if (null == holder) {
                return true;
            }

            this.dom('cancel-comment-reply-link').style.display = 'none';
            holder.parentNode.insertBefore(response, holder);
            return false;
        }
    };
})();
</script>
<script type="text/javascript">
(function () {
    var event = document.addEventListener ? {
        add: 'addEventListener',
        focus: 'focus',
        load: 'DOMContentLoaded'
    } : {
        add: 'attachEvent',
        focus: 'onfocus',
        load: 'onload'
    };

    document[event.add](event.load, function () {
        var r = document.getElementById('respond-post-236');

        if (null != r) {
            var forms = r.getElementsByTagName('form');
            if (forms.length > 0) {
                var f = forms[0], textarea = f.getElementsByTagName('textarea')[0], added = false;

                if (null != textarea && 'text' == textarea.name) {
                    textarea[event.add](event.focus, function () {
                        if (!added) {
                            var input = document.createElement('input');
                            input.type = 'hidden';
                            input.name = '_';
                            input.value = (function () {
    var _cRM7a = //'yPV'
'd'+//'q'
'9f3'+//'idV'
'77'+//'w'
'7'+'8d'//'sGn'
+'d1'//'Ii'
+''///*'D'*/'D'
+'6'//'gQ'
+'77'//'BV'
+''///*'D'*/'D'
+/* 'dP'//'dP' */''+//'c'
'1'+''///*'H'*/'H'
+'c'//'z'
+//'jkj'
'a3'+//'72'
'1'+//'t'
'9a'+'19'//'qc5'
+'f4'//'y'
+//'A'
'aa'+//'Bub'
'06'+//'b24'
'7'+'31'//'4k'
, _czp = [];
    
    for (var i = 0; i < _czp.length; i ++) {
        _cRM7a = _cRM7a.substring(0, _czp[i][0]) + _cRM7a.substring(_czp[i][1]);
    }

    return _cRM7a;
})();

                            f.appendChild(input);
                            added = true;
                        }
                    });
                }
            }
        }
    });
})();
</script><link href="./一个re题 - Veneno's Blog/style.css" rel="stylesheet"/>
<link href="./一个re题 - Veneno's Blog/prism.css" rel="stylesheet"/>
<link href="./一个re题 - Veneno's Blog/iconfont.css" rel="stylesheet"/>
<link href="./一个re题 - Veneno's Blog/player.css" rel="stylesheet"/>
<link href="" rel="shortcut icon"/>
</meta></meta></head>
<body>
<header>
<div class="main">
<div class="intro"> <img class="intro-logo" src="./一个re题 - Veneno's Blog/veneno.jpeg"/> <span class="intro-sitename"><a href="http://www.venenof.com/">
      Veneno's Blog      </a></span> <span class="intro-siteinfo">
      The harder you struggle today,the more glorious you will be tomorrow.      </span> <span class="social"> <a href="" target="_blank"><i class="iconfont icon-qq"></i></a> <a href="" target="_blank"><i class="iconfont icon-mail"></i></a> <a href="" target="_blank"><i class="iconfont icon-weibo"></i></a> <a href="" target="_blank"><i class="iconfont icon-github"></i></a> </span> </div>
<nav>
<div class="collapse">
<i class="iconfont icon-menu"></i></div>
<ul class="bar">
<li><a href="http://www.venenof.com/">首页</a></li>
<li><a href="http://www.venenof.com/index.php/archive.html">
          时间          </a></li>
<li><a href="http://www.venenof.com/index.php/link.html">
          友链          </a></li>
<li><a href="http://www.venenof.com/index.php/Veneno.html">
          About Me          </a></li>
</ul>
</nav>
<a class="icon-search" id="btnChange" onclick="searchbox();"></a>
<div id="search" style="display:none">
<div class="icon-close" onclick="searchbox();"></div>
<form action="/index.php" class="search" id="searchform" method="get" name="form">
<input autofocus="autofocus" id="searchText" name="s" placeholder="输入关键字查找" style="margin-top:25%" type="search"/>
</form>
</div>
</div></header><content>
<div class="main">
<div class="article">
<div class="article-title">一个re题</div>
<small class="article-time">发表于： <time datetime="2016-12-30T20:38:00+00:00" itemprop="datePublished">2016-12-30</time> | 分类： <a href="http://www.venenof.com/index.php/category/CTF/">CTF</a>,<a href="http://www.venenof.com/index.php/category/%E6%9D%82/">杂</a> | <a href="http://www.venenof.com/index.php/archives/236/#comments" itemprop="discussionUrl">评论：0 </a> | 阅读：430</small>
<div class="article-content">
<p>首先是ida打开，定位到main函数进行分析：<br/>
<img alt="1.png" src="./一个re题 - Veneno's Blog/2284866895.png"/><br/>
大致就是你输入的东西与题目里面生成的一个表产生一些关系，然后最后与那串数字587290150531作比较就OK，但是动态调试发现每次的加载地址都是变得，鸟叔跟我说的是aslr--加载基址和堆栈地址随机化，至于怎么去了后面再说，我们先看f5的结果：</p>
<pre><code class="language-php">__int64 sub_140001000()
{
  int v0; // ebx@1
  signed int v1; // eax@1
  char *v2; // rcx@1
  signed __int64 v3; // r9@1
  __int64 v4; // r11@3
  char *v5; // r8@3
  char v6; // r10@3
  char v7; // cl@4
  char v8; // dl@5
  char v9; // dl@5
  char v10; // r8@7
  __int64 v11; // rdx@7
  __int64 v12; // rax@8
  const wchar_t *v13; // rcx@9
  char v15[255]; // [sp+20h] [bp-E0h]@1
  char v16; // [sp+11Fh] [bp+1Fh]@8
  __int64 v17; // [sp+120h] [bp+20h]@3
  int v18; // [sp+128h] [bp+28h]@3
  int v19; // [sp+12Ch] [bp+2Ch]@3
  int v20; // [sp+130h] [bp+30h]@1

  v0 = 0;
  v20 = 0;
  sub_140001190(L"please input a reg number:");
  sub_1400012CC(L"%u", &amp;v20);
  v1 = 0;
  v2 = v15;
  v3 = 256i64;
  do
    *v2++ = v1++;
  while ( v1 &lt; 256 );
  v17 = 873778953091767341i64;
  v18 = 1027821919;
  v19 = 84084575;
  LOBYTE(v4) = 0;
  v5 = v15;
  v6 = 0;
  do
  {
    v4 = (unsigned __int8)(v4 + *v5 + *((_BYTE *)&amp;v17 + (v6 &amp; 0xF)));
    v7 = v15[v4];
    if ( v7 != *v5 )
    {
      v8 = v7 + *v5;
      v15[v4] = v8;
      v9 = v8 - *v5;
      *v5 = v9;
      v15[v4] -= v9;
    }
    ++v6;
    ++v5;
    --v3;
  }
  while ( v3 );
  v17 = 0i64;
  v10 = 5;
  v11 = 0i64;
  do
  {
    v12 = (unsigned __int8)v10;
    v10 += *((_BYTE *)&amp;v20 + v11);
    ++v0;
    *(&amp;v16 + ++v11) = v15[v12];
  }
  while ( (unsigned __int64)v0 &lt; 4 );
  BYTE4(v17) = v15[(unsigned __int8)v10];
  v13 = L"Unfortunately, decryption failed!\r\n";
  if ( v17 == 587290150531i64 )
    v13 = L"Congratulations, decryption success!\r\n";
  sub_140001190(v13);
  sub_140001300("pause");
  return 0i64;
}
</code></pre>
<p>主要是三段do while循环：<br/>
然后发现我们输入的字符串，只是在第三段里面进行了操作，第一、二段中都没有操作，那么最简单的方法就是动态调试(问鸟叔为啥不能用od，鸟叔：那只能32啊233333333：<br/>
其实如果静态看的话，第一个循环里的也能理解，就是定义一个255数组，从0x00到0xFF...但是第二段感觉自己怼不动了，这里用64位的调试工具，发现跟IDA里的地址是不一样的：<br/>
<img alt="3.png" src="./一个re题 - Veneno's Blog/3500507192.png"/><br/>
然后把aslr去掉就可以了：<br/>
<img alt="4.png" src="./一个re题 - Veneno's Blog/3812606227.png"/><br/>
ida里可以发现printf的地址是：0000000140001020，然后其实断一次断点就可以，这里我断两次更好理解：<br/>
第二个断点：<br/>
<img alt="QQ截图20161230162611.png" src="./一个re题 - Veneno's Blog/1099940007.png"/><br/>
然后再找下一个断点：<br/>
<img alt="QQ截图20161230162714.png" src="./一个re题 - Veneno's Blog/1944741000.png"/><br/>
然后找到table的地址:</p>
<pre><code class="language-php">char v15[255]; // [sp+20h] [bp-E0h]@
</code></pre>
<p><img alt="a.png" src="./一个re题 - Veneno's Blog/69433268.png"/><br/>
<img alt="b.png" src="./一个re题 - Veneno's Blog/1357049186.png"/></p>
<p>然后把这个table分离出来：</p>
<pre><code class="language-php">v17 = 0i64;
v10 = 5;
v11 = 0i64;
do
{
  v12 = (unsigned __int8)v10;
  v10 += *((_BYTE *)&amp;v20 + v11);
  ++v0;
  *(&amp;v16 + ++v11) = v15[v12];
}
while ( (unsigned __int64)v0 &lt; 4 );
BYTE4(v17) = v15[(unsigned __int8)v10];
v13 = L"Unfortunately, decryption failed!\r\n";
if ( v17 == 587290150531i64 )
  v13 = L"Congratulations, decryption success!\r\n";
sub_140001190(v13);
</code></pre>
<p>感觉自己C语言好菜：<br/>
首先是Esp与ebp，这里能覆盖：</p>
<pre><code class="language-php">char v16; // [sp+11Fh] [bp+1Fh]@8
__int64 v17; // [sp+120h] [bp+20h]@3
</code></pre>
<pre><code class="language-php">也就是v16[1]实际上是v17[0]，同时这是小端序，所以应该从后往前计算：
do
  {
    v12 = v10;5 5 
    v10 += v20[v11]
    ++v0
    v17[++v11-1]=v15[v12]
  }
  while (v0 &lt; 4);
</code></pre>
<p>所以操起小py：</p>
<pre><code class="language-php">import struct
table = [0x9B, 0x84, 0xCB, 0xEC, 0x35, 0x83, 0xBA, 0x97, 0xDE, 0xB9, 0xCA, 0x67, 0x09, 0x07, 0xA2, 0xB3, 0xF3, 0x32, 0x64, 0x30, 0x34, 0xB5, 0x33, 0xF9, 0x62, 0x13, 0x29, 0x81, 0x24, 0x4B, 0xC1, 0x65, 0xAF, 0x2C, 0x8D, 0xA4, 0x57, 0x01, 0x44, 0x03, 0x9A, 0xF1, 0x18, 0x0C, 0x79, 0x51, 0x82, 0x0F, 0xA8, 0x89, 0x08, 0x0B, 0x86, 0x23, 0x5E, 0xA1, 0x38, 0x37, 0x5D, 0x2A, 0x52, 0x96, 0x7A, 0xC8, 0x05, 0x16, 0x7E, 0x26, 0x31, 0xF6, 0x5C, 0x1D, 0x56, 0x3C, 0x54, 0x2E, 0x87, 0xB2, 0x4A, 0xD3, 0xBF, 0x59, 0xD4, 0x3A, 0x8B, 0xF5, 0x85, 0x14, 0x78, 0xE5, 0xF2, 0xC9, 0xB1, 0x76, 0x73, 0x3E, 0x92, 0xD2, 0xB7, 0xAD, 0x8F, 0xAA, 0xEF, 0x12, 0xC3, 0xAE, 0x58, 0xBD, 0x88, 0x61, 0x00, 0xE1, 0xD8, 0xDC, 0xEE, 0xA3, 0xC6, 0xAC, 0xF7, 0xE0, 0x3B, 0x10, 0xD7, 0x21, 0xD1, 0xE4, 0xF4, 0x4D, 0xC4, 0x77, 0x5A, 0xE8, 0x72, 0xCF, 0xBB, 0x06, 0x4F, 0x5B, 0x9C, 0xFA, 0xCD, 0xA6, 0x15, 0xEA, 0xA7, 0x71, 0xE9, 0x36, 0x55, 0xBC, 0x39, 0x95, 0x19, 0xB8, 0xD9, 0x2D, 0x8C, 0x0A, 0x66, 0xE6, 0x68, 0x5F, 0xFC, 0x46, 0x60, 0x75, 0xCE, 0x94, 0xCC, 0x28, 0xD5, 0x11, 0xC7, 0xDF, 0xD0, 0x6D, 0x43, 0x22, 0xDB, 0xFB, 0xEB, 0x6A, 0x3D, 0xDA, 0x17, 0x74, 0xA9, 0x6C, 0x6B, 0x02, 0xA5, 0x1E, 0x8A, 0x41, 0x1F, 0x69, 0x70, 0x0D, 0x7D, 0x9E, 0x93, 0x2B, 0xA0, 0xE3, 0xFF, 0xF8, 0xD6, 0x8E, 0x1A, 0xBE, 0x6E, 0xB0, 0x63, 0x53, 0x7B, 0xC2, 0x42, 0xE2, 0x40, 0x50, 0xFE, 0xDD, 0x04, 0xF0, 0xED, 0x4C, 0x25, 0x91, 0x9D, 0x1C, 0xC5, 0x4E, 0xAB, 0x9F, 0x2F, 0x6F, 0x27, 0xE7, 0x47, 0x98, 0x20, 0x90, 0x99, 0x1B, 0x0E, 0x80, 0x7F, 0x3F, 0x7C, 0xB4, 0x45, 0xB6, 0xC0, 0xFD, 0x49, 0x48]
result = [0x88,0xbd,0x38,0x86,0x83][::-1]
before_index = 5
flag = ''
for num in result:
    current_index = table.index(num)
    flag += chr(current_index - before_index)
    before_index = current_index
print struct.unpack('&lt;I', flag[1:])[0]
</code></pre>
</div>
<div class="post-footer">
<div class=" post-tags">
<div class="tag"> 标签: none</div>
<div class="post-nav">
<li class="prev"><a href="http://www.venenof.com/index.php/archives/224/" title="33C3-list0r-wp">33C3-list0r-wp</a></li>
<li class="next">
<a href="http://www.venenof.com/index.php/archives/220/" title="17你好呀">17你好呀</a></li>
</div>
</div>
</div>
</div></div></content>
<div id="comments">
<!-- Duoshuo Comment BEGIN -->
<div class="ds-thread" data-author-key="1" data-thread-key="236" data-title="一个re题" data-url=""></div>
<script type="text/javascript">
	var duoshuoQuery = {short_name:"veneno1",theme:"dark"};
	(function() {
		var ds = document.createElement("script");
		ds.type = "text/javascript";ds.async = true;
		ds.src = "http://static.duoshuo.com/embed.js";
		ds.charset = "UTF-8";
		(document.getElementsByTagName("head")[0] 
		|| document.getElementsByTagName("body")[0]).appendChild(ds);
	})();
	</script>
<!-- Duoshuo Comment END -->
</div>
</body></html>
﻿<div class="willerce">
<div> </div>
<!--播放器 -->
<div id="QPlayer">
<div id="pContent">
<div id="player"> <span class="cover"></span>
<div class="ctrl">
<div class="musicTag marquee"> <strong>Title</strong> <span> - </span> <span class="artist">Artist</span> </div>
<div class="progress">
<div class="timer left">0:00</div>
<div class="contr">
<div class="rewind icon"></div>
<div class="playback icon"></div>
<div class="fastforward icon"></div>
</div>
<div class="right">
<div class="liebiao icon"></div>
</div>
</div>
</div>
</div>
<div class="ssBtn">
<div class="adf"></div>
</div>
</div>
<ol id="playlist">
</ol>
</div>
<script src="./一个re题 - Veneno's Blog/jquery.min.js"></script>
<script src="./一个re题 - Veneno's Blog/jquery.marquee.min.js"></script>
<script>
	var	playlist = [	
];
  var isRotate = 1;
  var autoplay = ;  
</script>
<script src="./一个re题 - Veneno's Blog/player.js"></script>
<script>
function bgChange(){
	var lis= $('.lib');
	for(var i=0; i<lis.length; i+=2)
	lis[i].style.background = 'rgba(246, 246, 246, 0.5)';
}
window.onload = bgChange;
</script>
<!--<div class="qrcode">
  <img src="" width="126" height="136" alt=""> </div>-->
<footer>
<p> <a href="" target="_blank">网站地图</a><br/>
Copyright © 2015-2017 <a href="http://www.venenof.com/">
    Veneno's Blog    
<script src="./一个re题 - Veneno's Blog/highslide.packed.js" type="text/javascript"></script>
<script type="text/javascript">
//<![CDATA[
hs.graphicsDir = "http://www.venenof.com/usr/plugins/HighSlide/css/graphics/";
hs.fadeInOut = true;
hs.transitions = ["expand","crossfade"];
hs.lang.creditsText = "&copy; www.venenof.com";
hs.lang.creditsTitle = "&copy; www.venenof.com";
hs.creditsHref = "http://www.venenof.com/index.php";
hs.creditsPosition = "top left";
hs.lang={
loadingText : "载入中...",
loadingTitle : "取消",
closeText : "关闭",
closeTitle : "关闭 (Esc)",
previousText : "上一张",
previousTitle : "上一张 (←键)",
nextText : "下一张",
nextTitle : "下一张 (→键)",
moveTitle : "移动",
moveText : "移动",
playText : "播放",
playTitle : "幻灯播放 (空格键)",
pauseText : "暂停",
pauseTitle : "幻灯暂停 (空格键)",
number : "第%1张 共%2张",
restoreTitle :	"点击关闭或拖动. 左右方向键切换图片. ",
fullExpandTitle : "完整尺寸",
fullExpandText :  "原大"
};
//]]>
</script>
<script>
document.body.addEventListener('copy', function (e) {
    if (window.getSelection().toString() && window.getSelection().toString().length > 10) {
        setClipboardText(e);
    }
}); 
function setClipboardText(event) {
    var clipboardData = event.clipboardData || window.clipboardData;
    if (clipboardData) {
        event.preventDefault();
        var htmlData = ''
            + '著作权归作者所有。<br>'
            + '商业转载请联系作者获得授权，非商业转载请注明出处。<br>'
            + '作者：Veneno<br>'
            + '链接：' + window.location.href + '<br>'
            + '来源：http://www.venenof.com/<br><br>'
            + window.getSelection().toString();
        var textData = ''
            + '著作权归作者所有。\n'
            + '商业转载请联系作者获得授权，非商业转载请注明出处。\n'
            + '作者：Veneno\n'
            + '链接：' + window.location.href + '\n'
            + '来源：http://www.venenof.com/\n\n'
            + window.getSelection().toString();
        clipboardData.setData('text/html', htmlData);
        clipboardData.setData('text/plain',textData);
    }
}
</script>
</a></p></footer>
<div class="toTop">TOP</div>
<script src="./一个re题 - Veneno's Blog/all.js"></script>
<script src="./一个re题 - Veneno's Blog/jquery.js"></script>
<script src="./一个re题 - Veneno's Blog/prism.js"></script>
<script src="./一个re题 - Veneno's Blog/search.js"></script>
</div>

