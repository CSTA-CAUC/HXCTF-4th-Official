<!DOCTYPE html>

<html class="no-js" lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<link href="./三个白帽代码审计之条条大路通罗马1 – Melody有奥妙/11" rel="profile"/>
<link href="http://www.melodia.pw/xmlrpc.php" rel="pingback"/>
<script>(function(html){html.className = html.className.replace(/\bno-js\b/,'js')})(document.documentElement);</script>
<title>三个白帽代码审计之条条大路通罗马1 – Melody有奥妙</title>
<link href="./三个白帽代码审计之条条大路通罗马1 – Melody有奥妙/s.w.org" rel="dns-prefetch">
<link href="./三个白帽代码审计之条条大路通罗马1 – Melody有奥妙/feed=rss2" rel="alternate" title="Melody有奥妙 » Feed" type="application/rss+xml">
<link href="./三个白帽代码审计之条条大路通罗马1 – Melody有奥妙/feed=comments-rss2" rel="alternate" title="Melody有奥妙 » 评论Feed" type="application/rss+xml"/>
<link href="./三个白帽代码审计之条条大路通罗马1 – Melody有奥妙/feed=rss2&amp;p=706" rel="alternate" title="Melody有奥妙 » 三个白帽代码审计之条条大路通罗马1评论Feed" type="application/rss+xml"/>
<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.2.1\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.2.1\/svg\/","svgExt":".svg","source":{"concatemoji":"http:\/\/www.melodia.pw\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.7.5"}};
			!function(a,b,c){function d(a){var b,c,d,e,f=String.fromCharCode;if(!k||!k.fillText)return!1;switch(k.clearRect(0,0,j.width,j.height),k.textBaseline="top",k.font="600 32px Arial",a){case"flag":return k.fillText(f(55356,56826,55356,56819),0,0),!(j.toDataURL().length<3e3)&&(k.clearRect(0,0,j.width,j.height),k.fillText(f(55356,57331,65039,8205,55356,57096),0,0),b=j.toDataURL(),k.clearRect(0,0,j.width,j.height),k.fillText(f(55356,57331,55356,57096),0,0),c=j.toDataURL(),b!==c);case"emoji4":return k.fillText(f(55357,56425,55356,57341,8205,55357,56507),0,0),d=j.toDataURL(),k.clearRect(0,0,j.width,j.height),k.fillText(f(55357,56425,55356,57341,55357,56507),0,0),e=j.toDataURL(),d!==e}return!1}function e(a){var c=b.createElement("script");c.src=a,c.defer=c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g,h,i,j=b.createElement("canvas"),k=j.getContext&&j.getContext("2d");for(i=Array("flag","emoji4"),c.supports={everything:!0,everythingExceptFlag:!0},h=0;h<i.length;h++)c.supports[i[h]]=d(i[h]),c.supports.everything=c.supports.everything&&c.supports[i[h]],"flag"!==i[h]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[i[h]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link href="./三个白帽代码审计之条条大路通罗马1 – Melody有奥妙/genericons.cssver=3.4.1" id="genericons-css" media="all" rel="stylesheet" type="text/css"/>
<link href="./三个白帽代码审计之条条大路通罗马1 – Melody有奥妙/style.cssver=4.7.5" id="twentysixteen-style-css" media="all" rel="stylesheet" type="text/css"/>
<!--[if lt IE 10]>
<link rel='stylesheet' id='twentysixteen-ie-css'  href='http://www.melodia.pw/wp-content/themes/twentysixteen/css/ie.css?ver=20160816' type='text/css' media='all' />
<![endif]-->
<!--[if lt IE 9]>
<link rel='stylesheet' id='twentysixteen-ie8-css'  href='http://www.melodia.pw/wp-content/themes/twentysixteen/css/ie8.css?ver=20160816' type='text/css' media='all' />
<![endif]-->
<!--[if lt IE 8]>
<link rel='stylesheet' id='twentysixteen-ie7-css'  href='http://www.melodia.pw/wp-content/themes/twentysixteen/css/ie7.css?ver=20160816' type='text/css' media='all' />
<![endif]-->
<!--[if lt IE 9]>
<script type='text/javascript' src='http://www.melodia.pw/wp-content/themes/twentysixteen/js/html5.js?ver=3.7.3'></script>
<![endif]-->
<script src="./三个白帽代码审计之条条大路通罗马1 – Melody有奥妙/jquery.jsver=1.12.4" type="text/javascript"></script>
<script src="./三个白帽代码审计之条条大路通罗马1 – Melody有奥妙/jquery-migrate.min.jsver=1.4.1" type="text/javascript"></script>
<link href="./三个白帽代码审计之条条大路通罗马1 – Melody有奥妙/rest_route=" rel="https://api.w.org/"/>
<link href="http://www.melodia.pw/xmlrpc.php?rsd" rel="EditURI" title="RSD" type="application/rsd+xml"/>
<link href="./三个白帽代码审计之条条大路通罗马1 – Melody有奥妙/wlwmanifest.xml" rel="wlwmanifest" type="application/wlwmanifest+xml"/>
<link href="./三个白帽代码审计之条条大路通罗马1 – Melody有奥妙/p=704" rel="prev" title="常见web源码泄漏解析"/>
<link href="./三个白帽代码审计之条条大路通罗马1 – Melody有奥妙/p=728" rel="next" title="鸡肋漏洞利用两则"/>
<meta content="WordPress 4.7.5" name="generator">
<link href="./三个白帽代码审计之条条大路通罗马1 – Melody有奥妙/p=706" rel="canonical"/>
<link href="./三个白帽代码审计之条条大路通罗马1 – Melody有奥妙/p=706" rel="shortlink"/>
<link href="./三个白帽代码审计之条条大路通罗马1 – Melody有奥妙/rest_route=%2Foembed%2F1.0%2Fembed&amp;url=http%3A%2F%2Fwww.melodia.pw%2F%3Fp%3D706" rel="alternate" type="application/json+oembed"/>
<link href="./三个白帽代码审计之条条大路通罗马1 – Melody有奥妙/rest_route=%2Foembed%2F1.0%2Fembed&amp;url=http%3A%2F%2Fwww.melodia.pw%2F%3Fp%3D706&amp;format=xml" rel="alternate" type="text/xml+oembed"/>
<style type="text/css">.recentcomments a{display:inline !important;padding:0 !important;margin:0 !important;}</style>
</meta></link></link></head>
<body class="post-template-default single single-post postid-706 single-format-standard">
<div class="site" id="page">
<div class="site-inner">
<a class="skip-link screen-reader-text" href="#content">跳至内容</a>
<header class="site-header" id="masthead" role="banner">
<div class="site-header-main">
<div class="site-branding">
<p class="site-title"><a href="http://www.melodia.pw/" rel="home">Melody有奥妙</a></p>
<p class="site-description">Keep thinking, sometimes naive.</p>
</div><!-- .site-branding -->
<button class="menu-toggle" id="menu-toggle">菜单</button>
<div class="site-header-menu" id="site-header-menu">
<nav aria-label="主菜单" class="main-navigation" id="site-navigation" role="navigation">
<div class="menu-%e9%a1%b5%e9%9d%a2-container"><ul class="primary-menu" id="menu-%e9%a1%b5%e9%9d%a2"><li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-688" id="menu-item-688"><a href="http://www.melodia.pw/?page_id=5">About</a></li>
</ul></div> </nav><!-- .main-navigation -->
</div><!-- .site-header-menu -->
</div><!-- .site-header-main -->
</header><!-- .site-header -->
<div class="site-content" id="content">
<div class="content-area" id="primary">
<main class="site-main" id="main" role="main">
<article class="post-706 post type-post status-publish format-standard hentry category-2" id="post-706">
<header class="entry-header">
<h1 class="entry-title">三个白帽代码审计之条条大路通罗马1</h1> </header><!-- .entry-header -->
<div class="entry-content">
<p>代码审计好难做，这几天做这些做的异常压抑，好在最后在v牛帮助下总算解决了，最终知道了自己不是常规思路。。。。mdzz,问了超威蓝猫，orz！！！</p>
<p>index.php</p>
<pre><code>define ('PATH_WEB', dirname(__FILE__).'/');
include_once 'init.php';

if($_M['form']['class']){
    include PATH_WEB . $_M['form']['class'].'.php';
}
if($_M['form']['formname'] || $_FILES['file']['name']){
        $upfile = new upfile();
        $upfile-&gt;set('savepath', '');
        $upfile-&gt;set('is_rename', $_M['form']['is_rename']);
        $back = $upfile-&gt;upload($_M['form']['formname']);
    }

    $gb_array = [
        "name" =&gt; htmlspecialchars(filter($_M['form']['name'])),
        "message" =&gt; htmlspecialchars(filter($_M['form']['message'])),
        "filename" =&gt; $back,
    ];
    $content = jsonencode($gb_array);
    $sql = "insert into guestbook(`content`) values('".$content."');";
    $result = mysql_query($sql);
    if($result)
    {
        echo "&lt;script&gt;alert('thx for your feedback~')&lt;/script&gt;";
    }
</code></pre>
<p>可以控制的部分，name，message，file，这里还把变量带入了函数，把相关的几个函数提取出来看一下有什么可以钻空子的地方。 显而易见，这里有任意php文件读取，因为参数经过过滤，所以截断是失效的，意味着这里只能读取php文件。</p>
<p>include.php</p>
<pre><code>function daddslashes($string, $force = 0) {
    !defined('MAGIC_QUOTES_GPC') &amp;&amp; define('MAGIC_QUOTES_GPC', get_magic_quotes_gpc());
    if(!MAGIC_QUOTES_GPC || $force) {
        if(is_array($string)) {
            foreach($string as $key =&gt; $val) {
                $string[$key] = daddslashes($val, $force);
            }
        } else {
            $string = trim(addslashes($string));
        }
    }
    return $string;
}
/*
获取GET,POST,COOKIE，存放在$_M['form']，系统表单提交变量数组
*/
$_M['form'] =array();
isset($_REQUEST['GLOBALS']) &amp;&amp; exit('Access Error');
foreach($_COOKIE as $_key =&gt; $_value) {
    $_key{0} != '_' &amp;&amp; $_M['form'][$_key] = daddslashes($_value);
}
foreach($_POST as $_key =&gt; $_value) {
    $_key{0} != '_' &amp;&amp; $_M['form'][$_key] = daddslashes($_value);
}
foreach($_GET as $_key =&gt; $_value) {
    $_key{0} != '_' &amp;&amp; $_M['form'][$_key] = daddslashes($_value);
}
</code></pre>
<p>有戏！这里说明$_M[‘form’]所有变量均可控，为之后的操作带来了很大的便利，我们可以借此控制不属于用户域内的变量，然而这里输入都经过了daddslashes的过滤，这里的过滤比较严密，去除了空格，并且对输入做了转义，需要考虑php多字节输入带来的安全问题或者通过二次覆盖来绕过，这里暂时没什么头绪</p>
<pre><code>&lt;?php
//define ('PATH_WEB', dirname(__FILE__));

class upfile {
    public    $savepath;
    public    $is_rename;

    public function __construct() {
        global $_M;
        $this-&gt;set_upfile();
    }

    public function set($name, $value) {
        if ($value === NULL) {
            return false;
        }
        switch ($name) {
            case 'savepath':
                $this-&gt;savepath = PATH_WEB.'upload/'.$value;
                break;
            case 'is_rename':
                $this-&gt;is_rename = $value;
                break;
        }   
    }

    public function set_upfile() {
        global $_M;
        $this-&gt;set('savepath', '');
        $this-&gt;set('is_rename', 1);
    }

    public function upload($form = '') {
        global $_M;
        if (is_array($form)) {
            $filear = $form;
        }else{
            $filear = $_FILES[$form];
        }
        if(!$filear){
            foreach($_FILES as $key =&gt; $val){
                $filear = $_FILES[$key];
                break;
            }
        }
        //是否能正常上传
        if(!is_array($filear))$filear['error'] = 4;
        var_dump($filear);
        //文件后缀是否为合法后缀
        $this-&gt;getext($filear["name"]); //获取允许的后缀
        if (strtolower($this-&gt;ext)=='php'||strtolower($this-&gt;ext)=='php3'||strtolower($this-&gt;ext)=='php4'||strtolower($this-&gt;ext)=='php5') {
            return false;
        }

        //文件名重命名
        $this-&gt;set_savename($filear["name"], $this-&gt;is_rename);

        //复制文件
        $upfileok=0;
        $file_tmp=$filear["tmp_name"];
        $file_name=$this-&gt;savepath.$this-&gt;savename;

        if (function_exists("move_uploaded_file")) {
            if (move_uploaded_file($file_tmp, $file_name)) {
                $upfileok=1;
            } else if (copy($file_tmp, $file_name)) {
                $upfileok=1;
            }
        } elseif (copy($file_tmp, $file_name)) {
            $upfileok=1;
        }
        if ($upfileok) {
            @unlink($filear['tmp_name']); //任意文件删除，指哪儿打哪儿
        } 

        $back = str_replace(PATH_WEB, '', $this-&gt;savepath).$this-&gt;savename;
        return $back;
    }

    protected function set_savename($filename, $is_rename) {
        if ($is_rename) {
            srand((double)microtime() * 1000000);
            $rnd = rand(100, 999);
            $filename = date('U') + $rnd;
            $filename = $filename.".".$this-&gt;ext;   
        } else {
            $name_verification = explode('.',$filename);
            $verification_mun = count($name_verification);
            if($verification_mun&gt;2){
                $verification_mun1 = $verification_mun-1;
                $name_verification1 = $name_verification[0];
                for($i=0;$i&lt;$verification_mun1;$i++){
                    $name_verification1 .= '_'.$name_verification[$i];
                }
                $name_verification1 .= '.'.$name_verification[$verification_mun1];
                $filename = $name_verification1;
            }
            $filename = str_replace(array(":", "*", "?", "|", "/" , "\\" , "\"" , "&lt;" , "&gt;" , "——" , " " ),'_',$filename);
            $filename_temp = $filename;
            $i=0;
            $savename_temp=str_replace('.'.$this-&gt;ext,'',$filename_temp);
            while (file_exists($this-&gt;savepath.$filename_temp)) {
                $i++;
                $filename_temp = $savename_temp.'('.$i.')'.'.'.$this-&gt;ext;  
            }
            if ($i != 0) {
                $filename = str_replace('.'.$this-&gt;ext,'',$filename).'('.$i.')'.'.'.$this-&gt;ext; 
            }
        }
        return $this-&gt;savename = $filename;
    }

    protected function getext($filename) {
        if ($filename == "") {//弱类型判断 可以用 数组 直接 返回null
            return ;
        }
        $ext = explode(".", $filename);
        return $this-&gt;ext = $ext[count($ext)-1];
    }

}
?&gt;

</code></pre>
<p>太长了，说实话，别人的代码超过了一页根本不想看啊。。。然而还是需要慢慢审，逻辑基本上是这样的，首先在index.php调用这个类时，就会初始化savepath为’/’和is_rename为1 然后把$form传入upload()，根据代码逻辑，$form如果不是数组是没办法成功上传的，所以$form必须是数组，而且是符合格式的数组。这里已经暴露了一个漏洞，不过这个漏洞没啥用…就在unlink这里，通过控制formname可以修改缓存文件路径，如果权限没有设置的话就能做到指哪儿打哪儿。</p>
<p>文件重命名，判断if($is_rename)，初始化时被设置为1，如何绕过呢？经过几次本地测试，发现当$is_rename=”;时，可以绕过这里的判断，再结合之前的变量覆盖，拍脑袋想这里覆盖后可直接绕过文件重命名。 结果绕过后还仅仅是开始，之后对文件名是否合法有其他判断，以’.’为单位分割文件名为一个数组，取数组最后一个元素为扩展名，扩展名做了白名单判断，fuzz后倍感无力，其他格式都执行不了，愣是让我测了一夜。。 如果出现了两个以上的小数点，会对文件名做特殊处理，这样.php.jpg这种形式也无法绕过了。理论上已经堵死了php的上传，但是有个黑科技没有堵，就是包含php脚本的html文档，扩展名为pht，这样经过一次变量覆盖之后绕过重命名，就能访问到我们的shell了，菜刀连上得flag。</p>
<p>然而这道题如果堵死了pht的上传……</p>
<p>继续看这段的逻辑。他会把文件从php临时文件的文件夹中复制过来，并且重命名，发现临时文件的文件夹可以通过get参数控制，又是一次变量覆盖，这样就能造成任意文件读取，指哪儿打哪儿。</p>
<p>总结一下以上发现的洞：</p>
<pre><code>1.php文件包含
2.任意文件删除（权限之内）
3.任意文件读取（通过复制的方式）
4.phtml格式未过滤
</code></pre>
<p>题目描述是需要找到后台，所以第四个做法是意外之喜….找到了洞然而并不会用！！！！应不是出题者本义，我们需要获取后台地址，也就是目录信息，询问了Cr的做法，下面就是几个常见的敏感目录泄漏的重灾区</p>
<p>/etc/init.d/nginx</p>
<p>/etc/apache2/apache</p>
<p>/usr/local/nginx/conf/nginx.conf</p>
<p>/homw/wwwlogs/access.log</p>
<p>需要的时候多google一下吧。这里读取到了/etc/apache2/apache</p>
<p>截取关键信息</p>
<pre><code>&lt;VirtualHost *:80&gt;

    ServerAdmin webmaster@localhost
    DocumentRoot /var/www/html/sgbmwww

&lt;/VirtualHost&gt;
&lt;VirtualHost *:8080&gt;

    ServerAdmin webmaster@localhost
    DocumentRoot /var/www/html/sgbmadmin

&lt;/VirtualHost&gt;
</code></pre>
<p>我们现在在的目录是sgbmwww，我们下一步应当是sgbadmin，8080端口不允许外部访问。新一轮代码审计~，把后台的index.php读回来</p>
<pre><code>&lt;?php

include_once 'init.php';

$sql = "select id,content from guestbook where content like '%".$_M['form']['search']."%' order by id desc limit 0,100;";
$result = mysql_query($sql);
?&gt;
&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;title&gt;Animated Form Switching with jQuery&lt;/title&gt;
        &lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/&gt;
        &lt;meta name="description" content="Expand, contract, animate forms with jQuery wihtout leaving the page" /&gt;
        &lt;meta name="keywords" content="expand, form, css3, jquery, animate, width, height, adapt, unobtrusive javascript"/&gt;
        &lt;link rel="shortcut icon" href="../favicon.ico" type="image/x-icon"/&gt;
        &lt;link rel="stylesheet" type="text/css" href="css/style.css" /&gt;
        &lt;script src="js/cufon-yui.js" type="text/javascript"&gt;&lt;/script&gt;
        &lt;script src="js/ChunkFive_400.font.js" type="text/javascript"&gt;&lt;/script&gt;
        &lt;script type="text/javascript"&gt;
            Cufon.replace('h1',{ textShadow: '1px 1px #fff'});
            Cufon.replace('h2',{ textShadow: '1px 1px #fff'});
            Cufon.replace('h3',{ textShadow: '1px 1px #000'});
            Cufon.replace('.back');
        &lt;/script&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;div class="wrapper"&gt;
            &lt;h1&gt;SanGeBaiMao HouTai&lt;/h1&gt;&lt;h2 style="text-align:right;"&gt;&lt;/h2&gt;
            &lt;div class="content" style="text-align:center;padding-left:200px;width:500px"&gt;
            &lt;div id="form_wrapper" class="form_wrapper"&gt;&lt;/div&gt;
            &lt;br/&gt;
            &lt;form class="MessageBox" action="index.php" method="post"&gt;
                    &lt;div&gt;
                            &lt;h3&gt;Guestbook Search&lt;h3&gt;
                            &lt;input id="fd-name" class="text" type="text" name="search"/&gt;
                            &lt;input id="fd-button" class="input-submit" type="submit" name="submit" value="Search" /&gt;&lt;/p&gt; 
                    &lt;/div&gt;  
            &lt;/form&gt;
            &lt;div style="text-align:center;width" &gt;
&lt;?php
while($row = @mysql_fetch_array($result))
{   
    $content = jsondecode($row['content']);
    echo "&lt;div style=\"text-align:left\"&gt;&lt;h4&gt;"."第".$row['id']."条留言：&lt;/h4&gt;&lt;/div&gt;&lt;br/&gt;";
    echo "&lt;div&gt;".$content['name']."|".$content['message']."|".$content['filename']."&lt;/div&gt;&lt;br/&gt;";
    echo "&lt;div&gt;&lt;hr&gt;&lt;/div&gt;&lt;br/&gt;";

}
?&gt;

                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/body&gt;
&lt;/html&gt;

</code></pre>
<p>这简陋的后台就是管理员查询留言的地方，从这里似乎看不出什么，经过处理的参数注入的可能性也比较小，这里的sql查询用的是like，匹配查询，可能是没有直接的注入漏洞，数据库中的数据取出来之后才造成了危害。 继续审，init.php取回来</p>
<pre><code>&lt;?php

include 'config.php';
include 'include.php';

?&gt;

</code></pre>
<p>继续读取include.php</p>
<pre><code>&lt;?php
function filter($input)
{
    $input = str_replace('&lt;','',$input);
    $input = str_replace('&gt;','',$input);
    $input = str_replace('0x','',$input);
    return $input;
}
function errorBox($message)
{
    echo $message;
}
function jsonencode($arr){
    $parts = array();
    $is_type = false;         //false 鍏宠仈鏁扮粍         true 绱㈠紩鏁扮粍
    $keys = array_keys($arr);
    $length = count($arr)-1;
    if($keys[0] === 0 &amp;&amp; $keys[$length] == $length){//鍒ゆ柇鏄储寮曟暟缁勮繕鏄叧鑱旀暟缁�
        $is_type = true;
        for($i=0; $i&lt;count($keys); $i++){
            if($i != $keys[$i]){
                $is_type = false;
                break;
            }
        }
    }
    foreach($arr as $key=&gt;$val){
        if(is_array($val)){
            if($is_type){
                $parts[] = jsonencode($val);
            }else{
                $parts[] = '"' . $key . '":' . jsonencode($val);
            }
        }else{
            $str = '';
            if(!$is_type){
                $str = '"' . $key . '":';
            }
            if($val === false){
                $str .= 'false';
            }else if($val === true){
                $str .= 'true';
            }else{
                $str .= '"' . str_replace(array('\\' ,'/', '"') , array('\\\\' ,'\\/', '\"'),$val) . '"';
            }
            $parts[] = $str;
        }
    }
    $json = implode(',', $parts);
    $json = str_replace(array("\r", "\n", "\t"), '', $json);
    if($is_type)return '[' . $json . ']';
    return '{' . $json . '}';
}
function jsondecode($json){
    if($json){
        $convert = false;
        $str = '$arr=';
        for ($i=0; $i&lt;strlen($json); $i++){
            if (!$convert){
                if (($json[$i] == '{') || ($json[$i] == '[')){
                    $str .= ' array(';
                }else if (($json[$i] == '}') || ($json[$i] == ']')){
                    $str .= ')';
                }else if ($json[$i] == ':'){
                    $str .= '=&gt;';
                }else{
                    $str .= $json[$i];
                }                                    
            }else{
                $str .= $json[$i];
            }         
            if ($json[$i] == '"' &amp;&amp; $json[($i-1)]!="\\"){
                $convert = !$convert;
            }
        }
        $str = str_replace(array('\\\\' ,'\\/'), array('\\' ,'/'), $str);
        @eval($str . ';');
    }else{
        $arr = array();
    }
    return $arr;
}

function daddslashes($string, $force = 0) {
    !defined('MAGIC_QUOTES_GPC') &amp;&amp; define('MAGIC_QUOTES_GPC', get_magic_quotes_gpc());
    if(!MAGIC_QUOTES_GPC || $force) {
        if(is_array($string)) {
            foreach($string as $key =&gt; $val) {
                $string[$key] = daddslashes($val, $force);
            }
        } else {
            $string = trim(addslashes($string));
        }
    }
    return $string;
}
/*** 
鑾峰彇GET,POST,COOKIE锛屽瓨鏀惧湪$_M['form']锛岀郴缁熻〃鍗曟彁浜ゅ彉閲忔暟缁�
*/
$_M['form'] =array();
isset($_REQUEST['GLOBALS']) &amp;&amp; exit('Access Error');
foreach($_COOKIE as $_key =&gt; $_value) {
    $_key{0} != '_' &amp;&amp; $_M['form'][$_key] = daddslashes($_value);
}
foreach($_POST as $_key =&gt; $_value) {
    $_key{0} != '_' &amp;&amp; $_M['form'][$_key] = daddslashes($_value);
}
foreach($_GET as $_key =&gt; $_value) {
    $_key{0} != '_' &amp;&amp; $_M['form'][$_key] = daddslashes($_value);
}

</code></pre>
<p>其他基本和前台处理函数一致，不过这里jsondecode函数中return之前留了个莫名其妙的执行函数@eval($str . ‘;’); 的确和之前的猜想一样，我们要构造一个畸形的留言，在被jsdecode之后能够完整的代入eval中，从而造成了任意命令执行。</p>
<p>再联想到index.php的任意文件包含，很清楚了，通过index.php的任意php文件包含向后台的index.php通过get方式取出数据库中的数据，jsondecode后可以造成任意命令执行</p>
</div><!-- .entry-content -->
<footer class="entry-footer">
<span class="byline"><span class="author vcard"><img alt="" class="avatar avatar-49 photo" height="49" src="http://1.gravatar.com/avatar/7edb2f4a0823cf89ed72b0f0a154c121?s=49&amp;d=mm&amp;r=g" srcset="http://1.gravatar.com/avatar/7edb2f4a0823cf89ed72b0f0a154c121?s=98&amp;d=mm&amp;r=g 2x" width="49"/><span class="screen-reader-text">作者 </span> <a class="url fn n" href="http://www.melodia.pw/?author=1">Melody</a></span></span><span class="posted-on"><span class="screen-reader-text">发布于 </span><a href="http://www.melodia.pw/?p=706" rel="bookmark"><time class="entry-date published" datetime="2016-05-06T22:33:03+00:00">2016年5月6日</time><time class="updated" datetime="2016-05-15T20:39:00+00:00">2016年5月15日</time></a></span><span class="cat-links"><span class="screen-reader-text">分类 </span><a href="http://www.melodia.pw/?cat=2" rel="category">每刻，知识分享</a></span> </footer><!-- .entry-footer -->
</article><!-- #post-## -->
<div class="comments-area" id="comments">
<h2 class="comments-title">
			《三个白帽代码审计之条条大路通罗马1》有3个想法		</h2>
<ol class="comment-list">
<li class="comment even thread-even depth-1" id="comment-108597">
<article class="comment-body" id="div-comment-108597">
<footer class="comment-meta">
<div class="comment-author vcard">
<img alt="" class="avatar avatar-42 photo" height="42" src="./三个白帽代码审计之条条大路通罗马1 – Melody有奥妙/5fb89150137afa39f2703e803e658675s=42&amp;d=mm&amp;r=g" srcset="http://2.gravatar.com/avatar/5fb89150137afa39f2703e803e658675?s=84&amp;d=mm&amp;r=g 2x" width="42"/> <b class="fn"><a class="url" href="http://coshadow.com" rel="external nofollow">霜酱</a></b><span class="says">说道：</span> </div><!-- .comment-author -->
<div class="comment-metadata">
<a href="http://www.melodia.pw/?p=706#comment-108597">
<time datetime="2016-05-17T12:56:33+00:00">
								2016年5月17日 下午12:56							</time>
</a>
</div><!-- .comment-metadata -->
</footer><!-- .comment-meta -->
<div class="comment-content">
<p>根本看不懂QAQ M菊苣好厉害</p>
</div><!-- .comment-content -->
<div class="reply"><a aria-label="回复给霜酱" class="comment-reply-link" href="http://www.melodia.pw/?p=706&amp;replytocom=108597#respond" onclick='return addComment.moveForm( "div-comment-108597", "108597", "respond", "706" )' rel="nofollow">回复</a></div> </article><!-- .comment-body -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-odd thread-alt depth-1 parent" id="comment-257311">
<article class="comment-body" id="div-comment-257311">
<footer class="comment-meta">
<div class="comment-author vcard">
<img alt="" class="avatar avatar-42 photo" height="42" src="./三个白帽代码审计之条条大路通罗马1 – Melody有奥妙/7b283078f6bb9b680a1178c0dcd1d979s=42&amp;d=mm&amp;r=g" srcset="http://1.gravatar.com/avatar/7b283078f6bb9b680a1178c0dcd1d979?s=84&amp;d=mm&amp;r=g 2x" width="42"/> <b class="fn">jaye</b><span class="says">说道：</span> </div><!-- .comment-author -->
<div class="comment-metadata">
<a href="http://www.melodia.pw/?p=706#comment-257311">
<time datetime="2016-10-20T18:06:20+00:00">
								2016年10月20日 下午6:06							</time>
</a>
</div><!-- .comment-metadata -->
</footer><!-- .comment-meta -->
<div class="comment-content">
<p>楼主，你的那个变量覆盖漏洞哪里找到的？</p>
</div><!-- .comment-content -->
<div class="reply"><a aria-label="回复给jaye" class="comment-reply-link" href="http://www.melodia.pw/?p=706&amp;replytocom=257311#respond" onclick='return addComment.moveForm( "div-comment-257311", "257311", "respond", "706" )' rel="nofollow">回复</a></div> </article><!-- .comment-body -->
<ol class="children">
<li class="comment byuser comment-author-melody bypostauthor even depth-2" id="comment-257312">
<article class="comment-body" id="div-comment-257312">
<footer class="comment-meta">
<div class="comment-author vcard">
<img alt="" class="avatar avatar-42 photo" height="42" src="./三个白帽代码审计之条条大路通罗马1 – Melody有奥妙/7edb2f4a0823cf89ed72b0f0a154c121s=42&amp;d=mm&amp;r=g" srcset="http://1.gravatar.com/avatar/7edb2f4a0823cf89ed72b0f0a154c121?s=84&amp;d=mm&amp;r=g 2x" width="42"/> <b class="fn">Melody</b><span class="says">说道：</span> </div><!-- .comment-author -->
<div class="comment-metadata">
<a href="http://www.melodia.pw/?p=706#comment-257312">
<time datetime="2016-10-20T23:47:42+00:00">
								2016年10月20日 下午11:47							</time>
</a>
</div><!-- .comment-metadata -->
</footer><!-- .comment-meta -->
<div class="comment-content">
<p>时间也比较长了，应该是include.php里面的那个吧</p>
</div><!-- .comment-content -->
<div class="reply"><a aria-label="回复给Melody" class="comment-reply-link" href="http://www.melodia.pw/?p=706&amp;replytocom=257312#respond" onclick='return addComment.moveForm( "div-comment-257312", "257312", "respond", "706" )' rel="nofollow">回复</a></div> </article><!-- .comment-body -->
</li><!-- #comment-## -->
</ol><!-- .children -->
</li><!-- #comment-## -->
</ol><!-- .comment-list -->
<div class="comment-respond" id="respond">
<h2 class="comment-reply-title" id="reply-title">发表评论 <small><a href="/?p=706#respond" id="cancel-comment-reply-link" rel="nofollow" style="display:none;">取消回复</a></small></h2> <form action="http://www.melodia.pw/wp-comments-post.php" class="comment-form" id="commentform" method="post" novalidate="">
<p class="comment-notes"><span id="email-notes">电子邮件地址不会被公开。</span> 必填项已用<span class="required">*</span>标注</p><p class="comment-form-comment"><label for="comment">评论</label> <textarea aria-required="true" cols="45" id="comment" maxlength="65525" name="comment" required="required" rows="8"></textarea></p><p class="comment-form-author"><label for="author">姓名 <span class="required">*</span></label> <input aria-required="true" id="author" maxlength="245" name="author" required="required" size="30" type="text" value=""/></p>
<p class="comment-form-email"><label for="email">电子邮件 <span class="required">*</span></label> <input aria-describedby="email-notes" aria-required="true" id="email" maxlength="100" name="email" required="required" size="30" type="email" value=""/></p>
<p class="comment-form-url"><label for="url">站点</label> <input id="url" maxlength="200" name="url" size="30" type="url" value=""/></p>
<p class="form-submit"><input class="submit" id="submit" name="submit" type="submit" value="发表评论"/> <input id="comment_post_ID" name="comment_post_ID" type="hidden" value="706"/>
<input id="comment_parent" name="comment_parent" type="hidden" value="0"/>
</p><p style="display: none;"><input id="akismet_comment_nonce" name="akismet_comment_nonce" type="hidden" value="f508986c63"/></p><p style="display: none;"><input id="ak_js" name="ak_js" type="hidden" value="66"/></p> </form>
</div><!-- #respond -->
</div><!-- .comments-area -->
<nav class="navigation post-navigation" role="navigation">
<h2 class="screen-reader-text">文章导航</h2>
<div class="nav-links"><div class="nav-previous"><a href="http://www.melodia.pw/?p=704" rel="prev"><span aria-hidden="true" class="meta-nav">上一</span> <span class="screen-reader-text">上篇文章：</span> <span class="post-title">常见web源码泄漏解析</span></a></div><div class="nav-next"><a href="http://www.melodia.pw/?p=728" rel="next"><span aria-hidden="true" class="meta-nav">下一</span> <span class="screen-reader-text">下篇文章：</span> <span class="post-title">鸡肋漏洞利用两则</span></a></div></div>
</nav>
</main><!-- .site-main -->
<aside class="content-bottom-widgets" id="content-bottom-widgets" role="complementary">
<div class="widget-area">
<section class="widget widget_text" id="text-2"> <div class="textwidget"></div>
</section> </div><!-- .widget-area -->
</aside><!-- .content-bottom-widgets -->
</div><!-- .content-area -->
<aside class="sidebar widget-area" id="secondary" role="complementary">
<section class="widget widget_search" id="search-2">
<form action="http://www.melodia.pw/" class="search-form" method="get" role="search">
<label>
<span class="screen-reader-text">搜索：</span>
<input class="search-field" name="s" placeholder="搜索…" type="search" value=""/>
</label>
<button class="search-submit" type="submit"><span class="screen-reader-text">搜索</span></button>
</form>
</section> <section class="widget widget_recent_entries" id="recent-posts-2"> <h2 class="widget-title">近期文章</h2> <ul>
<li>
<a href="http://www.melodia.pw/?p=895">简单谈谈过去一年看得动漫</a>
</li>
<li>
<a href="http://www.melodia.pw/?p=889">0ctf 2017 quals web writeup</a>
</li>
<li>
<a href="http://www.melodia.pw/?p=771">Boston Key Party 2017 writeup</a>
</li>
<li>
<a href="http://www.melodia.pw/?p=743">HITCON 2016 WEB WRITEUP[2016.10.12已更新web500]</a>
</li>
<li>
<a href="http://www.melodia.pw/?p=730">LCTF 2016 WEB Writeup</a>
</li>
</ul>
</section> <section class="widget widget_recent_comments" id="recent-comments-2"><h2 class="widget-title">近期评论</h2><ul id="recentcomments"><li class="recentcomments"><span class="comment-author-link"><a class="url" href="http://www.netsec0day.com/?p=294" rel="external nofollow">半月安全看看看第四期 – 安全0day</a></span>发表在《<a href="http://www.melodia.pw/?p=889#comment-257433">0ctf 2017 quals web writeup</a>》</li><li class="recentcomments"><span class="comment-author-link">Melody</span>发表在《<a href="http://www.melodia.pw/?p=889#comment-257432">0ctf 2017 quals web writeup</a>》</li><li class="recentcomments"><span class="comment-author-link"><a class="url" href="http://blog.albertchang.cn" rel="external nofollow">albertchang</a></span>发表在《<a href="http://www.melodia.pw/?p=889#comment-257419">0ctf 2017 quals web writeup</a>》</li><li class="recentcomments"><span class="comment-author-link">jjj</span>发表在《<a href="http://www.melodia.pw/?p=889#comment-257418">0ctf 2017 quals web writeup</a>》</li><li class="recentcomments"><span class="comment-author-link">Melody</span>发表在《<a href="http://www.melodia.pw/?p=889#comment-257417">0ctf 2017 quals web writeup</a>》</li></ul></section><section class="widget widget_links" id="linkcat-0"><h2 class="widget-title">书签</h2>
<ul class="xoxo blogroll">
<li><a href="http://aklis.info">Aklis</a></li>
<li><a href="http://blog.albertchang.cn">albertchang</a></li>
<li><a href="http://blog.cal1.cn/" target="_blank" title="社会我猫哥">CurseRed</a></li>
<li><a href="http://www.venenof.com/" target="_blank">Veneno</a></li>
<li><a href="https://www.virzz.com/">Virink</a></li>
</ul>
</section>
<section class="widget widget_archive" id="archives-2"><h2 class="widget-title">文章归档</h2> <ul>
<li><a href="http://www.melodia.pw/?m=201704">2017年四月</a></li>
<li><a href="http://www.melodia.pw/?m=201703">2017年三月</a></li>
<li><a href="http://www.melodia.pw/?m=201702">2017年二月</a></li>
<li><a href="http://www.melodia.pw/?m=201610">2016年十月</a></li>
<li><a href="http://www.melodia.pw/?m=201605">2016年五月</a></li>
<li><a href="http://www.melodia.pw/?m=201602">2016年二月</a></li>
<li><a href="http://www.melodia.pw/?m=201208">2012年八月</a></li>
<li><a href="http://www.melodia.pw/?m=201207">2012年七月</a></li>
<li><a href="http://www.melodia.pw/?m=201109">2011年九月</a></li>
<li><a href="http://www.melodia.pw/?m=201108">2011年八月</a></li>
<li><a href="http://www.melodia.pw/?m=201106">2011年六月</a></li>
<li><a href="http://www.melodia.pw/?m=201104">2011年四月</a></li>
<li><a href="http://www.melodia.pw/?m=201103">2011年三月</a></li>
</ul>
</section><section class="widget widget_categories" id="categories-2"><h2 class="widget-title">分类目录</h2> <ul>
<li class="cat-item cat-item-1"><a href="http://www.melodia.pw/?cat=1">未分类</a>
</li>
<li class="cat-item cat-item-2"><a href="http://www.melodia.pw/?cat=2">每刻，知识分享</a>
</li>
<li class="cat-item cat-item-5"><a href="http://www.melodia.pw/?cat=5">每日，寻寻觅觅</a>
</li>
<li class="cat-item cat-item-6"><a href="http://www.melodia.pw/?cat=6">每时，走走停停</a>
</li>
</ul>
</section><section class="widget widget_meta" id="meta-2"><h2 class="widget-title">功能</h2> <ul>
<li><a href="http://www.melodia.pw/wp-login.php">登录</a></li>
<li><a href="http://www.melodia.pw/?feed=rss2">文章<abbr title="Really Simple Syndication">RSS</abbr></a></li>
<li><a href="http://www.melodia.pw/?feed=comments-rss2">评论<abbr title="Really Simple Syndication">RSS</abbr></a></li>
<li><a href="https://cn.wordpress.org/" title="基于WordPress，一个优美、先进的个人信息发布平台。">WordPress.org</a></li> </ul>
</section> </aside><!-- .sidebar .widget-area -->
</div><!-- .site-content -->
<footer class="site-footer" id="colophon" role="contentinfo">
<nav aria-label="页脚主菜单" class="main-navigation" role="navigation">
<div class="menu-%e9%a1%b5%e9%9d%a2-container"><ul class="primary-menu" id="menu-%e9%a1%b5%e9%9d%a2-1"><li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-688"><a href="http://www.melodia.pw/?page_id=5">About</a></li>
</ul></div> </nav><!-- .main-navigation -->
<div class="site-info">
<span class="site-title"><a href="http://www.melodia.pw/" rel="home">Melody有奥妙</a></span>
<a href="https://cn.wordpress.org/">自豪地采用WordPress</a>
</div><!-- .site-info -->
</footer><!-- .site-footer -->
</div><!-- .site-inner -->
</div><!-- .site -->
<script src="./三个白帽代码审计之条条大路通罗马1 – Melody有奥妙/form.jsver=3.3.1" type="text/javascript"></script>
<script src="./三个白帽代码审计之条条大路通罗马1 – Melody有奥妙/skip-link-focus-fix.jsver=20160816" type="text/javascript"></script>
<script src="./三个白帽代码审计之条条大路通罗马1 – Melody有奥妙/comment-reply.min.jsver=4.7.5" type="text/javascript"></script>
<script type="text/javascript">
/* <![CDATA[ */
var screenReaderText = {"expand":"\u5c55\u5f00\u5b50\u83dc\u5355","collapse":"\u6298\u53e0\u5b50\u83dc\u5355"};
/* ]]> */
</script>
<script src="./三个白帽代码审计之条条大路通罗马1 – Melody有奥妙/functions.jsver=20160816" type="text/javascript"></script>
<script src="./三个白帽代码审计之条条大路通罗马1 – Melody有奥妙/wp-embed.min.jsver=4.7.5" type="text/javascript"></script>
</body>
</html>
