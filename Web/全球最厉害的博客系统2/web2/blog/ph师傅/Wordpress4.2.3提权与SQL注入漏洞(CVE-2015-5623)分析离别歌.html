
<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="True" name="HandheldFriendly"/>
<meta content="width=device-width, initial-scale=1, maximum-scale=1" name="viewport">
<meta content="phithon的小站，长期存在与分享关于网络安全与各种编程的原创文章。" name="description"/>
<meta content="网络安全,代码审计,信息安全,漏洞挖掘,php,C++,mysql,python" name="keywords"/>
<link href="./Wordpress4.2.3提权与SQL注入漏洞(CVE-2015-5623)分析  离别歌/favicon.ico" rel="shortcut icon"/>
<link href="./Wordpress4.2.3提权与SQL注入漏洞(CVE-2015-5623)分析  离别歌/favicon-192x192.png" rel="icon" sizes="192x192" type="image/png"/>
<link href="./Wordpress4.2.3提权与SQL注入漏洞(CVE-2015-5623)分析  离别歌/apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180"/>
<title>Wordpress4.2.3提权与SQL注入漏洞(CVE-2015-5623)分析 | 离别歌</title>
<link href="./Wordpress4.2.3提权与SQL注入漏洞(CVE-2015-5623)分析  离别歌/font-awesome.min.css" rel="stylesheet"/>
<link href="./Wordpress4.2.3提权与SQL注入漏洞(CVE-2015-5623)分析  离别歌/styles.css" rel="stylesheet"/>
<link href="./Wordpress4.2.3提权与SQL注入漏洞(CVE-2015-5623)分析  离别歌/style.css" rel="stylesheet"/>
<link href="./Wordpress4.2.3提权与SQL注入漏洞(CVE-2015-5623)分析  离别歌/flexboxgrid.min.css" rel="stylesheet"/>
<link href="./Wordpress4.2.3提权与SQL注入漏洞(CVE-2015-5623)分析  离别歌/feed" rel="alternate" title="离别歌" type="application/atom+xml">
<script src="./Wordpress4.2.3提权与SQL注入漏洞(CVE-2015-5623)分析  离别歌/jquery.min.js"></script>
<link href="./Wordpress4.2.3提权与SQL注入漏洞(CVE-2015-5623)分析  离别歌/code.css" rel="stylesheet"/>
<link href="./Wordpress4.2.3提权与SQL注入漏洞(CVE-2015-5623)分析  离别歌/button.css" rel="stylesheet"/>
<link href="./Wordpress4.2.3提权与SQL注入漏洞(CVE-2015-5623)分析  离别歌/pagination.css" rel="stylesheet"/>
<link href="./Wordpress4.2.3提权与SQL注入漏洞(CVE-2015-5623)分析  离别歌/jquery.fancybox.min.css" rel="stylesheet"/>
</link></meta></head>
<body>
<div id="header-post">
<a class="active" href="#" id="menu-icon"><i class="fa fa-bars fa-lg"></i></a>
<a class="active" href="#" id="menu-icon-tablet"><i class="fa fa-bars fa-lg"></i></a>
<a href="#" id="top-icon-tablet" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a>
<span id="menu" style="visibility: visible">
<span id="nav">
<ul>
<li><a href="/">主页</a></li>
<li><a href="javascript:history.back(-1)">返回</a></li>
</ul>
</span>
<br/>
<span id="actions">
<ul>
<li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i aria-hidden="true" class="fa fa-chevron-up" onmouseout="$('#i-top').toggle();" onmouseover="$('#i-top').toggle();"></i></a></li>
<li><a class="icon" href="#"><i aria-hidden="true" class="fa fa-share-alt" onclick="$('#share').toggle();return false;" onmouseout="$('#i-share').toggle();" onmouseover="$('#i-share').toggle();"></i></a></li>
</ul>
<span class="info" id="i-top" style="display:none;">Back to top</span>
<span class="info" id="i-share" style="display:none;">Share post</span>
</span>
<br/>
<div id="share" style="display: none">
<ul>
<li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3A//www.leavesongs.com/PENETRATION/cve-2015-5623-and-wordpress-sql-injection.html"><i aria-hidden="true" class="fa fa-facebook "></i></a></li>
<li><a class="icon" href="https://twitter.com/share?url=https%3A//www.leavesongs.com/PENETRATION/cve-2015-5623-and-wordpress-sql-injection.html&amp;text=Wordpress4.2.3%E6%8F%90%E6%9D%83%E4%B8%8ESQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%28CVE-2015-5623%29%E5%88%86%E6%9E%90"><i aria-hidden="true" class="fa fa-twitter "></i></a></li>
<li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3A//www.leavesongs.com/PENETRATION/cve-2015-5623-and-wordpress-sql-injection.html&amp;title=Wordpress4.2.3%E6%8F%90%E6%9D%83%E4%B8%8ESQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%28CVE-2015-5623%29%E5%88%86%E6%9E%90"><i aria-hidden="true" class="fa fa-linkedin "></i></a></li>
<li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3A//www.leavesongs.com/PENETRATION/cve-2015-5623-and-wordpress-sql-injection.html&amp;is_video=false&amp;description=Wordpress4.2.3%E6%8F%90%E6%9D%83%E4%B8%8ESQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%28CVE-2015-5623%29%E5%88%86%E6%9E%90"><i aria-hidden="true" class="fa fa-pinterest "></i></a></li>
<li><a class="icon" href="mailto:?subject=Wordpress4.2.3%E6%8F%90%E6%9D%83%E4%B8%8ESQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%28CVE-2015-5623%29%E5%88%86%E6%9E%90&amp;body=Check out this article: https%3A//www.leavesongs.com/PENETRATION/cve-2015-5623-and-wordpress-sql-injection.html"><i aria-hidden="true" class="fa fa-envelope "></i></a></li>
<li><a class="icon" href="https://getpocket.com/save?url=https%3A//www.leavesongs.com/PENETRATION/cve-2015-5623-and-wordpress-sql-injection.html&amp;title=Wordpress4.2.3%E6%8F%90%E6%9D%83%E4%B8%8ESQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%28CVE-2015-5623%29%E5%88%86%E6%9E%90"><i aria-hidden="true" class="fa fa-get-pocket "></i></a></li>
<li><a class="icon" href="http://reddit.com/submit?url=https%3A//www.leavesongs.com/PENETRATION/cve-2015-5623-and-wordpress-sql-injection.html&amp;title=Wordpress4.2.3%E6%8F%90%E6%9D%83%E4%B8%8ESQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%28CVE-2015-5623%29%E5%88%86%E6%9E%90"><i aria-hidden="true" class="fa fa-reddit "></i></a></li>
<li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3A//www.leavesongs.com/PENETRATION/cve-2015-5623-and-wordpress-sql-injection.html&amp;title=Wordpress4.2.3%E6%8F%90%E6%9D%83%E4%B8%8ESQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%28CVE-2015-5623%29%E5%88%86%E6%9E%90"><i aria-hidden="true" class="fa fa-stumbleupon "></i></a></li>
<li><a class="icon" href="http://digg.com/submit?url=https%3A//www.leavesongs.com/PENETRATION/cve-2015-5623-and-wordpress-sql-injection.html&amp;title=Wordpress4.2.3%E6%8F%90%E6%9D%83%E4%B8%8ESQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%28CVE-2015-5623%29%E5%88%86%E6%9E%90"><i aria-hidden="true" class="fa fa-digg "></i></a></li>
<li><a class="icon" href="http://www.tumblr.com/share/link?url=https%3A//www.leavesongs.com/PENETRATION/cve-2015-5623-and-wordpress-sql-injection.html&amp;name=Wordpress4.2.3%E6%8F%90%E6%9D%83%E4%B8%8ESQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%28CVE-2015-5623%29%E5%88%86%E6%9E%90&amp;description="><i aria-hidden="true" class="fa fa-tumblr "></i></a></li>
</ul>
</div>
</span>
</div>
<div class="content index width mx-auto px2 my4">
<article class="post" itemscope="" itemtype="http://schema.org/BlogPosting">
<header>
<h1 class="posttitle" itemprop="name headline">Wordpress4.2.3提权与SQL注入漏洞(CVE-2015-5623)分析</h1>
<div class="meta">
<span class="author" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
<span itemprop="name">Phithon</span>
</span>
<div class="postdate">
<time datetime="2015年8月18日 14:22" itemprop="datePublished">
                    2015 八月 18 14:22
                </time>
</div>
<div class="article-tag">
            阅读：4065
            </div>
<div class="article-tag">
<i class="fa fa-bookmark"></i>
<a class="tag-link" href="/sort/PENETRATION">网络安全</a>
</div>
<div class="article-tag">
<i class="fa fa-tag"></i>
<a class="tag-link" href="/tag/%E8%B6%8A%E6%9D%83%E6%BC%8F%E6%B4%9E">越权漏洞</a>,
                
                <a class="tag-link" href="/tag/wordpress">wordpress</a>,
                
                <a class="tag-link" href="/tag/%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E">注入漏洞</a>
</div>
</div>
</header>
<div class="content" itemprop="articleBody">
<p>这是我在TSRC实习期间的研究任务X号：<a href="http://security.tencent.com/index.php/blog/msg/93"><a href="http://security.tencent.com/index.php/blog/msg/93">http://security.tencent.com/index.php/blog/msg/93</a></a></p>
<p>这是这几天一直关注的漏洞了，wordpress上个礼拜发布的4.2.4版本，其中提到修补了可能存在的SQL漏洞和多个XSS。</p>
<p>Check point也很快发出了分析，我也来分析与复现一下最新的这个漏洞。</p>
<h2 id="0x01-gp"><a class="toclink" href="#0x01-gp">0x01 GP混用造成的越权漏洞</a></h2>
<p>首先，说明一下背景。wordpress中用户权限分为订阅者、投稿者、作者、编辑和管理员。</p>
<p>权限最低的是订阅者，订阅者只有订阅文章的权限，wordpress开启注册后默认注册的用户就是订阅者。国内很多知名网站，如Freebuf，用户注册后身份即为“订阅者”。</p>
<p>我们先看到一个提权漏洞，通过这个提权漏洞，我们作为一个订阅者，可以越权在数据库里插入一篇文章。</p>
<p>Wordpress检查用户权限是调用current_user_can函数，我们看到这个函数：</p>
<p><a href="https://www.leavesongs.com/content/uploadfile/201508/29551439879078.png"><img alt="image001.png" src="./Wordpress4.2.3提权与SQL注入漏洞(CVE-2015-5623)分析  离别歌/thum-29551439879078.png"/></a> </p>
<p>调用的has_cap方法，跟进</p>
<p><a href="https://www.leavesongs.com/content/uploadfile/201508/25ae1439879079.png"><img alt="image003.png" src="./Wordpress4.2.3提权与SQL注入漏洞(CVE-2015-5623)分析  离别歌/thum-25ae1439879079.png"/></a></p>
<p>再次跟进map_meta_cap函数：</p>
<p><a href="https://www.leavesongs.com/content/uploadfile/201508/f3c81439879079.png"><img alt="image005.png" src="./Wordpress4.2.3提权与SQL注入漏洞(CVE-2015-5623)分析  离别歌/thum-f3c81439879079.png"/></a> </p>
<p>可以见到，这个函数是真正检查权限的。出错误的代码在检查’edit_post’和’edit_page’的部分：</p>
<p><a href="https://www.leavesongs.com/content/uploadfile/201508/46071439879080.png"><img alt="image007.png" src="./Wordpress4.2.3提权与SQL注入漏洞(CVE-2015-5623)分析  离别歌/thum-46071439879080.png"/></a> </p>
<p>可见，这里当$post不存在的时候，直接break出switch逻辑了，后面所有检查的代码都没有执行。</p>
<p>$post是要编辑的文章的ID，也就是说，如果我要编辑一篇不存在的文章，这里不检查权限直接返回。</p>
<p>正常情况下是没有问题的，因为不存在的文章也没有编辑一说了。</p>
<p>我们再看到后台编辑文章的部分：/wp-admin/post.php</p>
<p><a href="https://www.leavesongs.com/content/uploadfile/201508/7dfd1439879080.png"><img alt="image009.png" src="./Wordpress4.2.3提权与SQL注入漏洞(CVE-2015-5623)分析  离别歌/thum-7dfd1439879080.png"/></a> </p>
<p>这里首先获取$_GET['post']，找不到才获取$_POST['post_ID']，也就是可以说此时的$post_ID是来自GET的。</p>
<p>但我们后面调用current_user_can函数时传入的post_ID却是来自POST的：</p>
<p><a href="https://www.leavesongs.com/content/uploadfile/201508/e1fb1439879081.png"><img alt="image011.png" src="./Wordpress4.2.3提权与SQL注入漏洞(CVE-2015-5623)分析  离别歌/thum-e1fb1439879081.png"/></a></p>
<p>这里就是一个逻辑问题，当我们在GET参数中传入正确的postid（这样在get_post的时候不会产生错误），而在POST参数中传入一个不存在的postid，那么就能够绕过检查edit_post权限的步骤。</p>
<p>但是这个逻辑错误暂时不能造成严重的危害，因为实际上编辑文章的代码在edit_post函数中，而这个函数取的post_ID来自$_POST。</p>
<h2 id="0x02_wpnoncecsrf"><a class="toclink" href="#0x02_wpnoncecsrf">0x02获取_wpnonce绕过CSRF防御</a></h2>
<p>wordpress对于CSRF漏洞的防御措施是使用_wpnonce（也就是token），而且它的token很严格，不同的操作有不同的token。</p>
<p>比如我们这里，如果想调用edit_post函数，需要经过以下逻辑：</p>
<p><a href="https://www.leavesongs.com/content/uploadfile/201508/47c11439879081.png"><img alt="image013.png" src="./Wordpress4.2.3提权与SQL注入漏洞(CVE-2015-5623)分析  离别歌/thum-47c11439879081.png"/></a></p>
<p>check_admin_referer就是检查_wpnonce的函数，当$post_type==’postajaxpost’的时候，此时_wpnonce的名字就是“add-postajaxpost”。</p>
<p>那么怎么获取名字为”add-postajaxpost”的_wpnonce呢？</p>
<p>看到上面一点的位置：</p>
<p><a href="https://www.leavesongs.com/content/uploadfile/201508/4c4f1439879082.png"><img alt="image015.png" src="./Wordpress4.2.3提权与SQL注入漏洞(CVE-2015-5623)分析  离别歌/thum-4c4f1439879082.png"/></a></p>
<p>有个post-quickdraft-save操作。这个操作是用来临时储存草稿的，只要用户访问这个操作，就会在数据库post表中插入一个status为auto-draft的新文章。</p>
<p>如上图画出来的步骤，因为我们不知道名字为”add-post”的_wpnonce，所以进入到wp_dashboard_quick_press函数，跟进：</p>
<p><a href="https://www.leavesongs.com/content/uploadfile/201508/37991439879082.png"><img alt="image017.png" src="./Wordpress4.2.3提权与SQL注入漏洞(CVE-2015-5623)分析  离别歌/thum-37991439879082.png"/></a> </p>
<p>见上图，很幸运的是，在这个函数中wordpress居然自己把此时的_wpnonce输出在表单里了。</p>
<p>所以，只要我们访问一次post-quickdraft-save，就可以获得add-post的_wpnonce，从而绕过check_admin_referer函数。</p>
<h2 id="0x03"><a class="toclink" href="#0x03">0x03 竞争漏洞导致的逻辑漏洞</a></h2>
<p>这一节实际上是这个提权洞的真正核心，在我们拿到_wpnonce后，进入edit_post函数。</p>
<p>我们目的是去update一篇文章，但刚才0x01中说到，如果要绕过权限检查的函数，需要传入一个“不存在”的文章id。那么即使可以执行update，我们也不可能修改已经存在的文章呀？</p>
<p>这里实际上涉及到一个由竞争造成的逻辑漏洞。看到edit_post函数代码：</p>
<p><a href="https://www.leavesongs.com/content/uploadfile/201508/d7151439879085.png"><img alt="image019.png" src="./Wordpress4.2.3提权与SQL注入漏洞(CVE-2015-5623)分析  离别歌/thum-d7151439879085.png"/></a> </p>
<p><a href="https://www.leavesongs.com/content/uploadfile/201508/b2691439879088.png"><img alt="image021.png" src="./Wordpress4.2.3提权与SQL注入漏洞(CVE-2015-5623)分析  离别歌/thum-b2691439879088.png"/></a></p>
<p>上面两个图应该很直观了。在0x01中说到的current_user_can被绕过以后，到最终执行update语句中间，这一段代码的执行时间是真空的。</p>
<p>比如我们传入的tax_input=1,2,3,4…10000，那么实际上那条查询语句就要执行10000次，这是需要执行很长时间的。（在我自己的虚拟机上测试，执行10000次这条语句，大概需要5~10秒左右）</p>
<p>那么假设在这段时间内，有新插入的文章，那么我们之前那个“不存在”的id，不就可能可以存在了吗（只需要把id设置为最新一篇文章id+1）？</p>
<p>但有个问题是，我们怎么在这段时间内插入一篇新的文章？因为在0x02中为了获取_wpnonce，已经执行过post-quickdraft-save了。执行post-quickdraft-save可以在数据库插入一篇status为auto-draft的文章，但每个用户最多只会插入一篇文章。</p>
<p>在check-point的原文中，它提到的方法是，等待一个星期，wordpress会自动将这篇文章删除，而_wpnonce会多保留一天，这样在这天我们再次执行post-quickdraft-save又可以插入一篇文章了。</p>
<p>我自己想了一下，其实没必要这么麻烦。如果我们能够再注册一个身份为订阅者的账号，就可以再插入一篇文章了，所以我的POC是不需要等待一个礼拜的。</p>
<p>这三个漏洞组合起来，造成了一个提权漏洞。针对第一篇文章描述的提权漏洞，我写了一个EXP，执行后订阅者就可以在垃圾桶内插入一篇文章：</p>
<p><a href="https://www.leavesongs.com/content/uploadfile/201508/65041439879089.png"><img alt="image023.png" src="./Wordpress4.2.3提权与SQL注入漏洞(CVE-2015-5623)分析  离别歌/thum-65041439879089.png"/></a></p>
<p>访问文章编辑页面可以看到这篇文章：</p>
<p><a href="https://www.leavesongs.com/content/uploadfile/201508/db8f1439879092.png"><img alt="image025.png" src="./Wordpress4.2.3提权与SQL注入漏洞(CVE-2015-5623)分析  离别歌/thum-db8f1439879092.png"/></a> </p>
<h2 id="0x04-untrashsql"><a class="toclink" href="#0x04-untrashsql">0x04 untrash文章时造成的SQL注入漏洞</a></h2>
<p>那么，仅仅是一个这样的提权漏洞，实际上没有太大意义。Check-point第二篇文章里提到了一个因为这个提权漏洞导致的SQL注入。</p>
<p>先说这个注入的原理。</p>
<p>/wp-includes/post.php</p>
<p><a href="https://www.leavesongs.com/content/uploadfile/201508/ae3c1439879141.png"><img alt="image027.png" src="./Wordpress4.2.3提权与SQL注入漏洞(CVE-2015-5623)分析  离别歌/thum-ae3c1439879141.png"/></a></p>
<p>如上图。Wordpress很多地方执行SQL语句使用的预编译，但仅限于直接接受用户输入的地方。而上图中明显是一个二次操作，先用get_post_meta函数从数据库中取出meta，之后以字符串拼接的方式插入SQL语句。</p>
<p>这个地方造成一个二次注入。</p>
<p>我们来看看第一次是如何入库的。首先wp_trash_post是将文章删除的方法，其中删除文章后又调用wp_trash_post_comments将文章下的评论也删除了：</p>
<p><a href="https://www.leavesongs.com/content/uploadfile/201508/3ac41439879141.png"><img alt="image029.png" src="./Wordpress4.2.3提权与SQL注入漏洞(CVE-2015-5623)分析  离别歌/thum-3ac41439879141.png"/></a></p>
<p>跟进wp_trash_post_comments函数：</p>
<p><a href="https://www.leavesongs.com/content/uploadfile/201508/7d891439879142.png"><img alt="image031.png" src="./Wordpress4.2.3提权与SQL注入漏洞(CVE-2015-5623)分析  离别歌/thum-7d891439879142.png"/></a> </p>
<p>如上图，可以看到这个“comment_approved”其实也是从数据库中取出来的。所以这个注入我称之为“三次注入”。</p>
<p>那么我再继续跟进，看看最早的comment_approved是从哪来的。</p>
<p>实际上看到图中的SQL语句就大概知道了，这个comment_approved是comments（评论）表的一个字段，我分别看了新增评论、修改评论两个函数，发现修改评论的函数（edit_comment）中，有涉及到这个字段：</p>
<p><a href="https://www.leavesongs.com/content/uploadfile/201508/70a31439879625.png"><img alt="image033.png" src="./Wordpress4.2.3提权与SQL注入漏洞(CVE-2015-5623)分析  离别歌/thum-70a31439879625.png"/></a> </p>
<p>所以，这一连串操作最后造成的结果就是一个SQL注入漏洞。</p>
<p>总结一下123，整个利用过程如下：</p>
<p>利用快速草稿插入文章-&gt;越权编辑文章-&gt;插入评论-&gt;修改评论（恶意数据入库）-&gt;删除文章（恶意数据进入另一个库）-&gt;反删除文章（恶意数据被取出，直接插入SQL语句导致注入）</p>
<h2 id="0x05"><a class="toclink" href="#0x05">0x05 原文隐藏的部分与真实利用过程的研究</a></h2>
<p>这里不得不提到check-point的原文，原文的第二篇全文只字未提wordpress的token也就是_wpnonce，但wordpress后台几乎所有操作都需要特定的_wpnonce。在第一步中我们通过一处泄露点获取了“add-postajaxpost”的_wpnonce，但实际上后面的每一步（增加、编辑评论、trash文章、untrash文章）都需要不同的_wpnonce，那么这些_wpnonce我们怎么获得？</p>
<p>经过我的分析，最后实在找不到在订阅者权限下怎么获得“增加评论”和“反删除文章”的_wpnonce，而“修改评论”、“删除文章”的_wpnonce倒是可以在后台找到。</p>
<p>另外，虽然前台也可以增加评论，但前台增加评论会检查所属文章是否是草稿、状态是否是public或private，我们没法给这篇文章以及其派生的预览文章增加评论。</p>
<p>所以我把基础账号的权限提升一下，提升到可以发表文章与编辑文章的作者权限，再来对注入漏洞进行复现。</p>
<p><a href="https://www.leavesongs.com/content/uploadfile/201508/b7721439879143.png"><img alt="image035.png" src="./Wordpress4.2.3提权与SQL注入漏洞(CVE-2015-5623)分析  离别歌/thum-b7721439879143.png"/></a></p>
<p>首先发表一篇文章，并在该文下回复一条评论：</p>
<p><a href="https://www.leavesongs.com/content/uploadfile/201508/f1ab1439879144.png"><img alt="image037.png" src="./Wordpress4.2.3提权与SQL注入漏洞(CVE-2015-5623)分析  离别歌/thum-f1ab1439879144.png"/></a> </p>
<p>我们再来修改这条评论：</p>
<p><a href="https://www.leavesongs.com/content/uploadfile/201508/e9f61439879144.png"><img alt="image039.png" src="./Wordpress4.2.3提权与SQL注入漏洞(CVE-2015-5623)分析  离别歌/thum-e9f61439879144.png"/></a> </p>
<p>在文章编辑页面找到trash的_wpnonce，将该评论所属的文章丢入垃圾箱：</p>
<p><a href="https://www.leavesongs.com/content/uploadfile/201508/9f851439879145.png"><img alt="image041.png" src="./Wordpress4.2.3提权与SQL注入漏洞(CVE-2015-5623)分析  离别歌/thum-9f851439879145.png"/></a> </p>
<p><a href="https://www.leavesongs.com/content/uploadfile/201508/e9441439879146.png"><img alt="image043.png" src="./Wordpress4.2.3提权与SQL注入漏洞(CVE-2015-5623)分析  离别歌/thum-e9441439879146.png"/></a></p>
<p>再找到反删除的_wpnonce，从垃圾箱里反删除这篇文章： </p>
<p><a href="https://www.leavesongs.com/content/uploadfile/201508/e4411439879147.png"><img alt="image045.png" src="./Wordpress4.2.3提权与SQL注入漏洞(CVE-2015-5623)分析  离别歌/thum-e4411439879147.png"/></a> </p>
<p><a href="https://www.leavesongs.com/content/uploadfile/201508/b8c51439879149.png"><img alt="image047.png" src="./Wordpress4.2.3提权与SQL注入漏洞(CVE-2015-5623)分析  离别歌/thum-b8c51439879149.png"/></a> </p>
<p>查看SQL执行记录，发现已经注入成功，引入单引号：</p>
<p><a href="https://www.leavesongs.com/content/uploadfile/201508/c5a91439879150.png"><img alt="image049.png" src="./Wordpress4.2.3提权与SQL注入漏洞(CVE-2015-5623)分析  离别歌/thum-c5a91439879150.png"/></a></p>
<p>最后，我来总结一下这个漏洞。</p>
<p>这个漏洞有两个核心点，一是利用一个竞争条件逻辑错误，造成的一个越权漏洞；二是利用一个三次操作，导致最后的SQL注入漏洞。</p>
<p>这两个核心技术点都是很有代表性的，通篇学习下来，不得不佩服洞主的思路和对wordpress的研究深度。</p>
<p>但我也很遗憾，没能分析出在最低权限下怎样去注入，主要还是_wpnonce的获取导致漏洞利用上出现了一些问题。</p>
<p>另外，该SQL注入有一个不得不说的鸡肋点，在污染数据第一次入库的时候，数据库中保存这个数据的字段只有20字符长度，所以导致最后我们的注入点是一个“存在长度限制”的注入点，对于这个长度限制的利用，我也暂时没有相处更好的方法。</p>
<p>虽然存在长度限制，但因为注入点出现在update语句的评论表中，所以通过这个漏洞，可以将一整个站的评论全部置为0，对于像Freebuf这类社交性质的网站来说危害还是巨大的。</p>
<p>所以，我对这个SQL注入的评价是：利用上（可能）比较鸡肋，但思路是绝对一流的，值得学习。</p>
<h2 id="_1"><a class="toclink" href="#_1">参考链接</a></h2>
<p><a href="http://blog.checkpoint.com/2015/08/11/finding-vulnerabilities-in-core-wordpress-a-bug-hunters-trilogy-part-ii-supremacy/"><a href="http://blog.checkpoint.com/2015/08/11/finding-vulnerabilities-in-core-wordpress-a-bug-hunters-trilogy-part-ii-supremacy/">http://blog.checkpoint.com/2015/08/11/finding-vulnerabilities-in-core-wordpress-a-bug-hunters-trilogy-part-ii-supremacy/</a></a></p>
<p><a href="http://blog.checkpoint.com/2015/08/04/wordpress-vulnerabilities-1/"><a href="http://blog.checkpoint.com/2015/08/04/wordpress-vulnerabilities-1/">http://blog.checkpoint.com/2015/08/04/wordpress-vulnerabilities-1/</a></a></p>
</div>
</article>
<div id="reply-list">
<h1>评论</h1>
<div class="row" id="comment-2246">
<div class="col-xs-2 col-sm-1 gravatar">
<img alt="" src="./Wordpress4.2.3提权与SQL注入漏洞(CVE-2015-5623)分析  离别歌/d41d8cd98f00b204e9800998ecf8427e.jpgs=100&amp;d=mm&amp;r=g" width="100%"/>
</div>
<div class="col-xs-10 col-sm-11">
<p class="comment-meta title">
<a href="" target="_blank">依旧路人甲</a>
<time datetime="2015年11月2日 13:29" itemprop="datePublished">
                            2015 十一月 02 13:29
                        </time>
<a href="javascript:reply_to('2246', '依旧路人甲')">回复</a>
</p>
<p class="comment-meta">思路漂亮，BTW  P牛的个人分析也很赞！！</p>
</div>
</div>
<div class="row" id="comment-2197">
<div class="col-xs-2 col-sm-1 gravatar">
<img alt="" src="./Wordpress4.2.3提权与SQL注入漏洞(CVE-2015-5623)分析  离别歌/52eb673b25924a1233bb9304a643fab1.jpgs=100&amp;d=mm&amp;r=g" width="100%"/>
</div>
<div class="col-xs-10 col-sm-11">
<p class="comment-meta title">
<a href="" target="_blank">badboy</a>
<time datetime="2015年8月24日 15:36" itemprop="datePublished">
                            2015 八月 24 15:36
                        </time>
<a href="javascript:reply_to('2197', 'badboy')">回复</a>
</p>
<p class="comment-meta">膜拜。虽然懂PHP，但是挖不到这么深</p>
</div>
</div>
<div class="row" id="comment-2195">
<div class="col-xs-2 col-sm-1 gravatar">
<img alt="" src="./Wordpress4.2.3提权与SQL注入漏洞(CVE-2015-5623)分析  离别歌/525c5760293913bfc5cbabe28c4f62b8.jpgs=100&amp;d=mm&amp;r=g" width="100%"/>
</div>
<div class="col-xs-10 col-sm-11">
<p class="comment-meta title">
<a href="http://www.wangshifu.net" target="_blank">王师傅装修</a>
<time datetime="2015年8月23日 18:47" itemprop="datePublished">
                            2015 八月 23 18:47
                        </time>
<a href="javascript:reply_to('2195', '王师傅装修')">回复</a>
</p>
<p class="comment-meta">赶紧回去升级去。</p>
</div>
</div>
</div>
<form action="#reply" enctype="multipart/form-data" id="reply" method="post">
<textarea cols="40" id="id_content" name="content" required="" rows="6">
</textarea>
<div class="row">
<div class="col-xs-4">
<input id="id_nickname" maxlength="64" name="nickname" placeholder="昵称" required="" type="text"/>
</div>
<div class="col-xs-4">
<input id="id_email" maxlength="254" name="email" placeholder="邮箱（可留空）" type="text"/>
</div>
<div class="col-xs-4">
<input id="id_url" maxlength="200" name="url" placeholder="链接（可留空）" type="text"/>
</div>
</div>
<div class="row" style="margin-top: 8px"><div class="col-xs-4"><input autocomplete="off" id="id_captcha_1" name="captcha_1" placeholder="验证码" type="text"/> <input id="id_captcha_0" name="captcha_0" type="hidden" value="6f8d9c0bdd3fbdbbbb3d026d9732d69c42804263"/>
</div><div class="col-xs-4">
<img alt="captcha" class="captcha" height="25" src="./Wordpress4.2.3提权与SQL注入漏洞(CVE-2015-5623)分析  离别歌/6f8d9c0bdd3fbdbbbb3d026d9732d69c42804263"/></div></div>
<div class="clearfix"></div>
<input class="ui-button ui-button-sgreen" type="submit" value="提交"/>
<input id="id_archive" name="archive" type="hidden" value="365">
<input id="id_parent" name="parent" type="hidden"/>
<input name="csrfmiddlewaretoken" type="hidden" value="M4m10FTDmb2Yjs2wCxkqNuWPxLWPlXFpkoHxO95SNYWnj7qLqOOam8YUGPpX4ruz"/>
</input></form>
</div>
<footer id="footer">
<div class="footer-left">
    Copyright © 2017 Powered by talkbook
  </div>
<div class="footer-right">
<nav>
<ul>
<li><a href="/">首页</a></li>
<li><a href="http://weibo.com/101yx" target="_blank">微博</a></li>
<li><a href="https://github.com/phith0n" target="_blank">项目</a></li>
<li><a href="/template/change/">更换模板</a></li>
</ul>
</nav>
</div>
</footer>
<script src="./Wordpress4.2.3提权与SQL注入漏洞(CVE-2015-5623)分析  离别歌/main.js"></script>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?ad9ab5e37c2811b9f0979e46123fc898";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<script src="./Wordpress4.2.3提权与SQL注入漏洞(CVE-2015-5623)分析  离别歌/jquery.fancybox.pack.js"></script>
<script>
$(document).ready(function () {
    $("article a").each(function (i, e) {
        if(e.host != 'www.leavesongs.com') {
            e.target = '_blank';
        }
    });
    $("article img").each(function (i, e) {
        if(e.parentNode.tagName.toUpperCase() != 'A') {
            $(e).wrap('<a href="'+escapeHtml(e.src)+'" class="fancybox"></a>');
        } else {
            $(e.parentNode).addClass('fancybox');
        }
    });
    $('.fancybox').fancybox();
})
</script>
</body>
</html>