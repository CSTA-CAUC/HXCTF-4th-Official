<!DOCTYPE html>

<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, maximum-scale=1" name="viewport"/>
<title>SQLMAP|阅读手记二{参数翻译、系统初始化} – Wupco's Blog</title>
<script src="./SQLMAP阅读手记二{参数翻译、系统初始化} – Wupco's Blog/jquery.jsver=1.12.4" type="text/javascript"></script>
<script src="./SQLMAP阅读手记二{参数翻译、系统初始化} – Wupco's Blog/jquery-migrate.min.jsver=1.4.1" type="text/javascript"></script>
<link href="./SQLMAP阅读手记二{参数翻译、系统初始化} – Wupco's Blog/rest_route=" rel="https://api.w.org/"/>
<link href="http://www.wupco.cn/xmlrpc.php?rsd" rel="EditURI" title="RSD" type="application/rsd+xml"/>
<link href="./SQLMAP阅读手记二{参数翻译、系统初始化} – Wupco's Blog/wlwmanifest.xml" rel="wlwmanifest" type="application/wlwmanifest+xml"/>
<link href="./SQLMAP阅读手记二{参数翻译、系统初始化} – Wupco's Blog/p=375" rel="prev" title="SQLMAP|（参数篇完毕）附上使用脑图"/>
<link href="./SQLMAP阅读手记二{参数翻译、系统初始化} – Wupco's Blog/p=1437" rel="next" title="SQLMAP|阅读手记三{“三测”、开始注入}"/>
<link href="./SQLMAP阅读手记二{参数翻译、系统初始化} – Wupco's Blog/p=378" rel="canonical"/>
<link href="./SQLMAP阅读手记二{参数翻译、系统初始化} – Wupco's Blog/p=378" rel="shortlink"/>
<script src="./SQLMAP阅读手记二{参数翻译、系统初始化} – Wupco's Blog/shCore.js" type="text/javascript"></script><link href=" http://www.wupco.cn/wp-content/plugins/wp-ueditor2/ueditor/third-party/SyntaxHighlighter/shCoreDefault.css" rel="stylesheet" type="text/css"/><link href="./SQLMAP阅读手记二{参数翻译、系统初始化} – Wupco's Blog/R5K8RH7ACHA7KEV8P.gif" rel="icon" sizes="32x32"/>
<link href="./SQLMAP阅读手记二{参数翻译、系统初始化} – Wupco's Blog/R5K8RH7ACHA7KEV8P.gif" rel="icon" sizes="192x192"/>
<link href="./SQLMAP阅读手记二{参数翻译、系统初始化} – Wupco's Blog/R5K8RH7ACHA7KEV8P.gif" rel="apple-touch-icon-precomposed"/>
<meta content="http://www.wupco.cn/wp-content/uploads/2016/11/R5K8RH7ACHA7KEV8P.gif" name="msapplication-TileImage">
<link href="./SQLMAP阅读手记二{参数翻译、系统初始化} – Wupco's Blog/favicon.png" rel="shortcut icon" type="image/vnd.microsoft.icon"/>
<link href="./SQLMAP阅读手记二{参数翻译、系统初始化} – Wupco's Blog/style.css" rel="stylesheet" type="text/css">
<!--[if lt IE 9]>
<script src="//cdn.bootcss.com/html5shiv/r29/html5.min.js"></script>
<script src="//cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->
</link></meta></head>
<body>
<div class="container" id="main">
<div class="pjax">
<header id="header">
<div class="container">
<h1 class="logo">
<i class="iconfont"></i><a href="http://www.wupco.cn">Wupco's Blog</a>
</h1>
<nav class="menu_click" id="topMenu">
<div class="menu-menu-1-container"><ul class="menu" id="menu-menu-1"><li><a href="http://www.wupco.cn/">首页</a></li>
<li><a href="http://www.wupco.cn/?page_id=1174">关于我</a></li>
<li><a href="http://www.wupco.cn/?page_id=1448">数据备份</a></li>
<li><a href="http://www.wupco.cn/?page_id=1959">CTF备忘录</a></li>
</ul></div><i class="i_1"></i>
<i class="i_2"></i>
</nav>
</div>
</header>
<section class="blockGroup">
<h2 class="s_title" itemprop="name headline">SQLMAP|阅读手记二{参数翻译、系统初始化}</h2>
<article class="post single" itemscope="" itemtype="http://schema.org/BlogPosting">
<blockquote><p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>sqlmap可以说是目前使用人数最多，功能最复杂的注入工具。作为一款开源工具，开发者有意的让我们自行去阅读并扩充，作为一个Web狗，阅读sqlmap源码也是有必要的，更何况从软件工程的角度，sqlmap的源码部署也是很值得学习的。</span></p>
</blockquote>
<h2><span style='font-family: 微软雅黑, "Microsoft YaHei";'>参数翻译与初始化<br/></span></h2>
<pre class="brush:python;toolbar:false"> if hasattr(conf, "api"):
            # Overwrite system standard output and standard error to write
            # to an IPC database
            sys.stdout = StdDbOut(conf.taskid, messagetype="stdout")
            sys.stderr = StdDbOut(conf.taskid, messagetype="stderr")
            setRestAPILog()

        conf.showTime = True
        dataToStdout("[!] legal disclaimer: %s\n\n" % LEGAL_DISCLAIMER, forceOutput=True)
        dataToStdout("[*] starting at %s\n\n" % time.strftime("%X"), forceOutput=True)

        init()

        if conf.profile:
            profile()
        elif conf.smokeTest:
            smokeTest()
        elif conf.liveTest:
            liveTest()
        else:
            try:
                start()
            except thread.error as ex:
                if "can't start new thread" in getSafeExString(ex):
                    errMsg = "unable to start new threads. Please check OS (u)limits"
                    logger.critical(errMsg)
                    raise SystemExit
                else:
                    raise</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>首先判断了conf对象中是否有名api的属性</span></p>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>我们跟踪一下conf对象，在/lib/core/data.py里对其进行初始化</span></p>
<p><span style="font-family:微软雅黑, Microsoft YaHei">官方注释为</span></p>
<pre class="brush:python;toolbar:false"># object to share within function and classes command
# line options and settings</pre>
<p><span style="font-family:微软雅黑, Microsoft YaHei">dir了一下，发现有如下属性</span><img src="./SQLMAP阅读手记二{参数翻译、系统初始化} – Wupco's Blog/72641487689512.png" style='font-family: 微软雅黑, "Microsoft YaHei";'/></p>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>应该是一个字典对象，里面存储着命令行选项和设置的相关内容，而这个对象就是在各个类和方法中共享的，以至于进程间的共享。</span></p>
<p><span style="font-family:微软雅黑, Microsoft YaHei">可以看到/lib/core/datatype.py中有个例子</span></p>
<pre class="brush:python;toolbar:false">&gt;&gt;&gt; foo = AttribDict()
    &gt;&gt;&gt; foo.bar = 1
    &gt;&gt;&gt; foo.bar
    1</pre>
<p><span style="font-family:微软雅黑, Microsoft YaHei">而data.py中conf就是这样创建出来的对象</span></p>
<pre class="brush:python;toolbar:false">conf = AttribDict()</pre>
<p><span style="font-family:微软雅黑, Microsoft YaHei">在sqlmap.py print了一下conf，发现没有api这个属性，那这是个什么鬼呢？</span></p>
<p><span style="font-family:微软雅黑, Microsoft YaHei">首先要弄清楚它的属性是什么时候加上去的，于是通过在不同位置print conf，发现是在初始化cmd设置的时候添加的属性</span></p>
<pre class="brush:python;toolbar:false">initOptions(cmdLineOptions)</pre>
<p><span style="font-family:微软雅黑, Microsoft YaHei">于是跟踪它到/lib/core/option.py</span></p>
<pre class="brush:python;toolbar:false">def initOptions(inputOptions=AttribDict(), overrideOptions=False):
    _setConfAttributes()
    _setKnowledgeBaseAttributes()
    _mergeOptions(inputOptions, overrideOptions)</pre>
<p><span style="font-family:微软雅黑, Microsoft YaHei">找到了</span></p>
<pre class="brush:python;toolbar:false">_setConfAttributes()</pre>
<pre class="brush:python;toolbar:false">def _setConfAttributes():
    """
    This function set some needed attributes into the configuration
    singleton.
    """

    debugMsg = "initializing the configuration"
    logger.debug(debugMsg)

    conf.authUsername = None
    conf.authPassword = None
    conf.boundaries = []
    conf.cj = None
    conf.dbmsConnector = None
    conf.dbmsHandler = None
    conf.dnsServer = None
    conf.dumpPath = None
    conf.hashDB = None
    conf.hashDBFile = None
    conf.httpHeaders = []
    conf.hostname = None
    conf.ipv6 = False
    conf.multipleTargets = False
    conf.outputPath = None
    conf.paramDict = {}
    conf.parameters = {}
    conf.path = None
    conf.port = None
    conf.proxyList = None
    conf.resultsFilename = None
    conf.resultsFP = None
    conf.scheme = None
    conf.tests = []
    conf.trafficFP = None
    conf.wFileType = None</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>噫，只是对一些基本设置初始化，继续看</span></p>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'></span></p>
<pre class="brush:python;toolbar:false">_setKnowledgeBaseAttributes()</pre>
<pre class="brush:python;toolbar:false">def _setKnowledgeBaseAttributes(flushAll=True):
    """
    This function set some needed attributes into the knowledge base
    singleton.
    """

    debugMsg = "initializing the knowledge base"
    logger.debug(debugMsg)

    kb.absFilePaths = set()
    kb.adjustTimeDelay = None
    kb.alerted = False
    kb.alwaysRefresh = None
    kb.arch = None
    kb.authHeader = None
    kb.bannerFp = AttribDict()
    kb.binaryField = False

    kb.brute = AttribDict({"tables": [], "columns": []})
    kb.bruteMode = False

    kb.cache = AttribDict()
    kb.cache.content = {}
    kb.cache.regex = {}
    kb.cache.stdev = {}

    kb.chars = AttribDict()
    kb.chars.delimiter = randomStr(length=6, lowercase=True)
    kb.chars.start = "%s%s%s" % (KB_CHARS_BOUNDARY_CHAR, randomStr(length=3, alphabet=KB_CHARS_LOW_FREQUENCY_ALPHABET), KB_CHARS_BOUNDARY_CHAR)
    kb.chars.stop = "%s%s%s" % (KB_CHARS_BOUNDARY_CHAR, randomStr(length=3, alphabet=KB_CHARS_LOW_FREQUENCY_ALPHABET), KB_CHARS_BOUNDARY_CHAR)
    kb.chars.at, kb.chars.space, kb.chars.dollar, kb.chars.hash_ = ("%s%s%s" % (KB_CHARS_BOUNDARY_CHAR, _, KB_CHARS_BOUNDARY_CHAR) for _ in randomStr(length=4, lowercase=True))

    kb.columnExistsChoice = None
    kb.commonOutputs = None
    kb.counters = {}
    kb.data = AttribDict()
    kb.dataOutputFlag = False

    # Active back-end DBMS fingerprint
    kb.dbms = None
    kb.dbmsVersion = [UNKNOWN_DBMS_VERSION]

    kb.delayCandidates = TIME_DELAY_CANDIDATES * [0]
    kb.dep = None
    kb.dnsMode = False
    kb.dnsTest = None
    kb.docRoot = None
    kb.dumpTable = None
    kb.dumpKeyboardInterrupt = False
    kb.dynamicMarkings = []
    kb.dynamicParameter = False
    kb.endDetection = False
    kb.explicitSettings = set()
    kb.extendTests = None
    kb.errorChunkLength = None
    kb.errorIsNone = True
    kb.falsePositives = []
    kb.fileReadMode = False
    kb.followSitemapRecursion = None
    kb.forcedDbms = None
    kb.forcePartialUnion = False
    kb.forceWhere = None
    kb.futileUnion = None
    kb.headersFp = {}
    kb.heuristicDbms = None
    kb.heuristicMode = False
    kb.heuristicTest = None
    kb.hintValue = None
    kb.htmlFp = []
    kb.httpErrorCodes = {}
    kb.inferenceMode = False
    kb.ignoreCasted = None
    kb.ignoreNotFound = False
    kb.ignoreTimeout = False
    kb.injection = InjectionDict()
    kb.injections = []
    kb.laggingChecked = False
    kb.lastParserStatus = None

    kb.locks = AttribDict()
    for _ in ("cache", "count", "index", "io", "limit", "log", "socket", "redirect", "request", "value"):
        kb.locks[_] = threading.Lock()

    kb.matchRatio = None
    kb.maxConnectionsFlag = False
    kb.mergeCookies = None
    kb.multiThreadMode = False
    kb.negativeLogic = False
    kb.nullConnection = None
    kb.oldMsf = None
    kb.orderByColumns = None
    kb.originalCode = None
    kb.originalPage = None
    kb.originalPageTime = None
    kb.originalTimeDelay = None
    kb.originalUrls = dict()

    # Back-end DBMS underlying operating system fingerprint via banner (-b)
    # parsing
    kb.os = None
    kb.osVersion = None
    kb.osSP = None

    kb.pageCompress = True
    kb.pageTemplate = None
    kb.pageTemplates = dict()
    kb.pageEncoding = DEFAULT_PAGE_ENCODING
    kb.pageStable = None
    kb.partRun = None
    kb.permissionFlag = False
    kb.postHint = None
    kb.postSpaceToPlus = False
    kb.postUrlEncode = True
    kb.prependFlag = False
    kb.processResponseCounter = 0
    kb.previousMethod = None
    kb.processUserMarks = None
    kb.proxyAuthHeader = None
    kb.queryCounter = 0
    kb.redirectChoice = None
    kb.reflectiveMechanism = True
    kb.reflectiveCounters = {REFLECTIVE_COUNTER.MISS: 0, REFLECTIVE_COUNTER.HIT: 0}
    kb.requestCounter = 0
    kb.resendPostOnRedirect = None
    kb.responseTimes = {}
    kb.responseTimeMode = None
    kb.responseTimePayload = None
    kb.resumeValues = True
    kb.safeCharEncode = False
    kb.safeReq = AttribDict()
    kb.singleLogFlags = set()
    kb.reduceTests = None
    kb.tlsSNI = {}
    kb.stickyDBMS = False
    kb.stickyLevel = None
    kb.storeCrawlingChoice = None
    kb.storeHashesChoice = None
    kb.suppressResumeInfo = False
    kb.technique = None
    kb.tempDir = None
    kb.testMode = False
    kb.testOnlyCustom = False
    kb.testQueryCount = 0
    kb.testType = None
    kb.threadContinue = True
    kb.threadException = False
    kb.tableExistsChoice = None
    kb.timeValidCharsRun = 0
    kb.uChar = NULL
    kb.unionDuplicates = False
    kb.xpCmdshellAvailable = False

    if flushAll:
        kb.headerPaths = {}
        kb.keywords = set(getFileItems(paths.SQL_KEYWORDS))
        kb.passwordMgr = None
        kb.skipVulnHost = None
        kb.tamperFunctions = []
        kb.targets = oset()
        kb.testedParams = set()
        kb.userAgents = None
        kb.vainRun = True
        kb.vulnHosts = set()
        kb.wafFunctions = []
        kb.wordlists = None</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>kb和conf一样也是在/lib/core/data.py里面首次初始化的</span></p>
<pre class="brush:python;toolbar:false"># object to share within function and classes results
kb = AttribDict()</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei"; text-decoration: line-through;'>可以估计臆测是一个类或者函数的结果共享集。也就是说这里把它初始化，可能之后每个进程在不同步骤中跑出的结果存储在这里。</span></p>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>在这里就属于共享知识库了</span></p>
<p></p>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'><img src="./SQLMAP阅读手记二{参数翻译、系统初始化} – Wupco's Blog/13021487689512.png"/></span></p>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>可以肯定它和conf是两个存储对象了，既然这样，我们先不管这个，继续看<br/></span></p>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'></span></p>
<pre class="brush:python;toolbar:false">_mergeOptions(inputOptions, overrideOptions)</pre>
<pre class="brush:python;toolbar:false">def _mergeOptions(inputOptions, overrideOptions):
    """
    Merge command line options with configuration file and default options.

    @param inputOptions: optparse object with command line options.
    @type inputOptions: C{instance}
    """

    if inputOptions.pickledOptions:
        try:
            inputOptions = base64unpickle(inputOptions.pickledOptions)
            _normalizeOptions(inputOptions)
        except Exception, ex:
            errMsg = "provided invalid value '%s' for option '--pickled-options'" % inputOptions.pickledOptions
            errMsg += " ('%s')" % ex if ex.message else ""
            raise SqlmapSyntaxException(errMsg)

    if inputOptions.configFile:
        configFileParser(inputOptions.configFile)

    if hasattr(inputOptions, "items"):
        inputOptionsItems = inputOptions.items()
    else:
        inputOptionsItems = inputOptions.__dict__.items()

    for key, value in inputOptionsItems:
        if key not in conf or value not in (None, False) or overrideOptions:
            conf[key] = value

    for key, value in conf.items():
        if value is not None:
            kb.explicitSettings.add(key)

    for key, value in defaults.items():
        if hasattr(conf, key) and conf[key] is None:
            conf[key] = value

    lut = {}
    for group in optDict.keys():
        lut.update((_.upper(), _) for _ in optDict[group])

    envOptions = {}
    for key, value in os.environ.items():
        if key.upper().startswith(SQLMAP_ENVIRONMENT_PREFIX):
            _ = key[len(SQLMAP_ENVIRONMENT_PREFIX):].upper()
            if _ in lut:
                envOptions[lut[_]] = value

    if envOptions:
        _normalizeOptions(envOptions)
        for key, value in envOptions.items():
            conf[key] = value

    mergedOptions.update(conf)</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>从注释中可以看的很清楚，从config文件里面和缺省设置种读取配置信息更新conf，kb对象（合并命令行选项）。于是一切都明朗了，把你所输入的参数进行归并，优化，翻译，形成大的字典（conf、kb）然后就可以通过读取这些来确定应该调用哪些功能了。</span></p>
<p><span style="font-family:微软雅黑, Microsoft YaHei">于是api应该是用户需要自己配置的一个设置选项，在sqlmap.conf里</span></p>
<p><span style="font-family:微软雅黑, Microsoft YaHei">想测试一下它的功能，发现了自带了sqlmapapi.py</span></p>
<p><span style="font-family:微软雅黑, Microsoft YaHei">经过审计发现是一个进程通信的共享池</span></p>
<p><span style="font-family:微软雅黑, Microsoft YaHei">示例如下</span></p>
<p><span style="font-family:微软雅黑, Microsoft YaHei"><img src="./SQLMAP阅读手记二{参数翻译、系统初始化} – Wupco's Blog/20891487689512.png"/></span></p>
<p></p>
<blockquote><p>help        Show this help message</p>
<p>new ARGS    Start a new scan task with provided arguments (e.g. 'new -u "http://testphp.vulnweb.com/artists.php?artist=1"')</p>
<p>use TASKID  Switch current context to different task (e.g. 'use c04d8c5c7582efb4')</p>
<p>data        Retrieve and show data for current task</p>
<p>log         Retrieve and show log for current task</p>
<p>status      Retrieve and show status for current task</p>
<p>stop        Stop current task</p>
<p>kill        Kill current task</p>
<p>list        Display all tasks</p>
<p>flush       Flush tasks (delete all tasks)</p>
<p>exit        Exit this client</p>
</blockquote>
<p><span style="font-family:微软雅黑, Microsoft YaHei"><img src="./SQLMAP阅读手记二{参数翻译、系统初始化} – Wupco's Blog/41971487689512.png"/>结合sqlmap中的注释</span></p>
<pre class="brush:python;toolbar:false"># Overwrite system standard output and standard error to write
            # to an IPC database</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>很明显，是sqlmap对外开放的api(</span><span style='font-family: 微软雅黑, "Microsoft YaHei"; text-decoration: line-through;'>其实看名字就应该想到，绕了一大圈</span><span style='font-family: 微软雅黑, "Microsoft YaHei";'>)</span></p>
<p><span style="font-family:微软雅黑, Microsoft YaHei">缺省状态下是没有这个选项的。所以如果我们要做二次开发，就可以直接利用这个api选项，通过进程通信的方式来完成sqlmap的功能。</span></p>
<p><span style="font-family:微软雅黑, Microsoft YaHei">接下来挂载时钟，输出免责声明，就来到了<br/></span></p>
<pre class="brush:python;toolbar:false">init()</pre>
<p dir="ltr"><span style="font-family:微软雅黑, Microsoft YaHei">跟踪到/lib/core/option.py</span></p>
<pre class="brush:python;toolbar:false">def init():
    """
    Set attributes into both configuration and knowledge base singletons
    based upon command line and configuration file options.
    """

    _useWizardInterface()
    setVerbosity()
    _saveConfig()
    _setRequestFromFile()
    _cleanupOptions()
    _dirtyPatches()
    _purgeOutput()
    _checkDependencies()
    _createTemporaryDirectory()
    _basicOptionValidation()
    _setProxyList()
    _setTorProxySettings()
    _setDNSServer()
    _adjustLoggingFormatter()
    _setMultipleTargets()
    _setTamperingFunctions()
    _setWafFunctions()
    _setTrafficOutputFP()
    _resolveCrossReferences()
    _checkWebSocket()

    parseTargetUrl()
    parseTargetDirect()

    if any((conf.url, conf.logFile, conf.bulkFile, conf.sitemapUrl, conf.requestFile, conf.googleDork, conf.liveTest)):
        _setHTTPTimeout()
        _setHTTPExtraHeaders()
        _setHTTPCookies()
        _setHTTPReferer()
        _setHTTPHost()
        _setHTTPUserAgent()
        _setHTTPAuthentication()
        _setHTTPHandlers()
        _setDNSCache()
        _setSocketPreConnect()
        _setSafeVisit()
        _doSearch()
        _setBulkMultipleTargets()
        _setSitemapTargets()
        _checkTor()
        _setCrawler()
        _findPageForms()
        _setDBMS()
        _setTechnique()

    _setThreads()
    _setOS()
    _setWriteFile()
    _setMetasploit()
    _setDBMSAuthentication()
    loadBoundaries()
    loadPayloads()
    _setPrefixSuffix()
    update()
    _loadQueries()</pre>
<p dir="ltr"><span style='font-family: 微软雅黑, "Microsoft YaHei";'>这里就根据conf和kb里的内容进行初始化了。</span></p>
<p dir="ltr"><span style='font-family: 微软雅黑, "Microsoft YaHei";'>首先是新手教学模式（选择性开启）</span></p>
<p dir="ltr"><span style='font-family: 微软雅黑, "Microsoft YaHei";'></span></p>
<pre class="brush:python;toolbar:false">_useWizardInterface()</pre>
<pre class="brush:python;toolbar:false">def _useWizardInterface():
    """
    Presents simple wizard interface for beginner users
    """

    if not conf.wizard:
        return

    logger.info("starting wizard interface")

    while not conf.url:
        message = "Please enter full target URL (-u): "
        conf.url = readInput(message, default=None)

    message = "%s data (--data) [Enter for None]: " % ((conf.method if conf.method != HTTPMETHOD.GET else conf.method) or HTTPMETHOD.POST)
    conf.data = readInput(message, default=None)

    if not (filter(lambda _: '=' in unicode(_), (conf.url, conf.data)) or '*' in conf.url):
        warnMsg = "no GET and/or %s parameter(s) found for testing " % ((conf.method if conf.method != HTTPMETHOD.GET else conf.method) or HTTPMETHOD.POST)
        warnMsg += "(e.g. GET parameter 'id' in 'http://www.site.com/vuln.php?id=1'). "
        if not conf.crawlDepth and not conf.forms:
            warnMsg += "Will search for forms"
            conf.forms = True
        logger.warn(warnMsg)

    choice = None

    while choice is None or choice not in ("", "1", "2", "3"):
        message = "Injection difficulty (--level/--risk). Please choose:\n"
        message += "[1] Normal (default)\n[2] Medium\n[3] Hard"
        choice = readInput(message, default='1')

        if choice == '2':
            conf.risk = 2
            conf.level = 3
        elif choice == '3':
            conf.risk = 3
            conf.level = 5
        else:
            conf.risk = 1
            conf.level = 1

    if not conf.getAll:
        choice = None

        while choice is None or choice not in ("", "1", "2", "3"):
            message = "Enumeration (--banner/--current-user/etc). Please choose:\n"
            message += "[1] Basic (default)\n[2] Intermediate\n[3] All"
            choice = readInput(message, default='1')

            if choice == '2':
                map(lambda x: conf.__setitem__(x, True), WIZARD.INTERMEDIATE)
            elif choice == '3':
                map(lambda x: conf.__setitem__(x, True), WIZARD.ALL)
            else:
                map(lambda x: conf.__setitem__(x, True), WIZARD.BASIC)

    logger.debug("muting sqlmap.. it will do the magic for you")
    conf.verbose = 0

    conf.batch = True
    conf.threads = 4

    dataToStdout("\nsqlmap is running, please wait..\n\n")</pre>
<p dir="ltr"><span style='font-family: 微软雅黑, "Microsoft YaHei";'>conf.wizard对应的前面参数分析中的 <span style='font-family: 微软雅黑, "Microsoft YaHei";'>--wizard 参数（如果使用了这个选项就把conf.wizard置为True）</span></span></p>
<p dir="ltr"><span style="font-family:微软雅黑, Microsoft YaHei">接下来就是按照新手模式将sqlmap的基本功能拆解并上提示的一步一步展示出来</span></p>
<p dir="ltr"><span style="font-family:微软雅黑, Microsoft YaHei"><img src="./SQLMAP阅读手记二{参数翻译、系统初始化} – Wupco's Blog/78061487689512.png"/></span></p>
<p dir="ltr"><span style='font-family: 微软雅黑, "Microsoft YaHei";'>一直到这个函数结束，也只是对conf的属性进行赋值，并没有进行实质的操作。</span></p>
<p dir="ltr"><span style='font-family: 微软雅黑, "Microsoft YaHei";'>接下来就是log级的设置（选择性开启）</span></p>
<p dir="ltr"><span style='font-family: 微软雅黑, "Microsoft YaHei";'></span></p>
<pre class="brush:python;toolbar:false">setVerbosity()</pre>
<pre class="brush:python;toolbar:false">def setVerbosity():
    """
    This function set the verbosity of sqlmap output messages.
    """

    if conf.verbose is None:
        conf.verbose = 1

    conf.verbose = int(conf.verbose)

    if conf.verbose == 0:
        logger.setLevel(logging.ERROR)
    elif conf.verbose == 1:
        logger.setLevel(logging.INFO)
    elif conf.verbose &gt; 2 and conf.eta:
        conf.verbose = 2
        logger.setLevel(logging.DEBUG)
    elif conf.verbose == 2:
        logger.setLevel(logging.DEBUG)
    elif conf.verbose == 3:
        logger.setLevel(CUSTOM_LOGGING.PAYLOAD)
    elif conf.verbose == 4:
        logger.setLevel(CUSTOM_LOGGING.TRAFFIC_OUT)
    elif conf.verbose &gt;= 5:
        logger.setLevel(CUSTOM_LOGGING.TRAFFIC_IN)</pre>
<p dir="ltr"><span style='font-family: 微软雅黑, "Microsoft YaHei";'>conf.verbose存储的就是-v后的数字[0-6]，从这里也可以看出缺省值设置为1。</span></p>
<p dir="ltr"><span style='font-family: 微软雅黑, "Microsoft YaHei";'>数字越大输出的信息越全面，当然运行时也会加大命令行的滚动，大量的输出导致运行速度缓慢。所以按照需求最小化选择参数可以保证最大的效果和效率。一般都使用缺省设置，有时需要查看payload就要设置log级为3，刚好达到需求。</span></p>
<p dir="ltr"><span style='font-family: 微软雅黑, "Microsoft YaHei";'>接下来是输出配置到ini文件中（选择性开启）<br/></span></p>
<p dir="ltr"><span style='font-family: 微软雅黑, "Microsoft YaHei";'></span></p>
<pre class="brush:python;toolbar:false">_saveConfig()</pre>
<pre class="brush:python;toolbar:false">def _saveConfig():
    """
    Saves the command line options to a sqlmap configuration INI file
    Format.
    """

    if not conf.saveConfig:
        return

    debugMsg = "saving command line options to a sqlmap configuration INI file"
    logger.debug(debugMsg)

    config = UnicodeRawConfigParser()
    userOpts = {}

    for family in optDict.keys():
        userOpts[family] = []

    for option, value in conf.items():
        for family, optionData in optDict.items():
            if option in optionData:
                userOpts[family].append((option, value, optionData[option]))

    for family, optionData in userOpts.items():
        config.add_section(family)

        optionData.sort()

        for option, value, datatype in optionData:
            if datatype and isListLike(datatype):
                datatype = datatype[0]

            if option in IGNORE_SAVE_OPTIONS:
                continue

            if value is None:
                if datatype == OPTION_TYPE.BOOLEAN:
                    value = "False"
                elif datatype in (OPTION_TYPE.INTEGER, OPTION_TYPE.FLOAT):
                    if option in defaults:
                        value = str(defaults[option])
                    else:
                        value = "0"
                elif datatype == OPTION_TYPE.STRING:
                    value = ""

            if isinstance(value, basestring):
                value = value.replace("\n", "\n ")

            config.set(family, option, value)

    confFP = openFile(conf.saveConfig, "wb")

    try:
        config.write(confFP)
    except IOError, ex:
        errMsg = "something went wrong while trying "
        errMsg += "to write to the configuration file '%s' ('%s')" % (conf.saveConfig, getSafeExString(ex))
        raise SqlmapSystemException(errMsg)

    infoMsg = "saved command line options to the configuration file '%s'" % conf.saveConfig
    logger.info(infoMsg)</pre>
<p dir="ltr"><span style='font-family: 微软雅黑, "Microsoft YaHei";'>conf.saveConfig对应参数分析中的<span style='font-family: 微软雅黑, "Microsoft YaHei";'>--save=SAVECONFIG 参数，可以将当前配置导出为ini文件方便再次导入。</span></span></p>
<p dir="ltr"><span style="font-family:微软雅黑, Microsoft YaHei">把conf的一些信息重整合成方便输出的形式，输出如下</span></p>
<p dir="ltr"><span style="font-family:微软雅黑, Microsoft YaHei"><img src="./SQLMAP阅读手记二{参数翻译、系统初始化} – Wupco's Blog/87521487689512.png"/></span></p>
<p dir="ltr"><span style='font-family: 微软雅黑, "Microsoft YaHei";'>接下来是判断（文件存在性）并从文件中读取完整request信息（可选参数）<br/></span></p>
<p dir="ltr"><span style='font-family: 微软雅黑, "Microsoft YaHei";'></span></p>
<pre class="brush:python;toolbar:false">_setRequestFromFile()</pre>
<pre class="brush:python;toolbar:false">def _setRequestFromFile():
    """
    This function checks if the way to make a HTTP request is through supplied
    textual file, parses it and saves the information into the knowledge base.
    """

    if not conf.requestFile:
        return

    addedTargetUrls = set()

    conf.requestFile = safeExpandUser(conf.requestFile)

    infoMsg = "parsing HTTP request from '%s'" % conf.requestFile
    logger.info(infoMsg)

    if not os.path.isfile(conf.requestFile):
        errMsg = "the specified HTTP request file "
        errMsg += "does not exist"
        raise SqlmapFilePathException(errMsg)

    _feedTargetsDict(conf.requestFile, addedTargetUrls)</pre>
<p dir="ltr"><span style='font-family: 微软雅黑, "Microsoft YaHei";'>这里conf.requestFile就是对应的-r参数。后面对文件的存在性做了检测，最后一步</span></p>
<p dir="ltr"><span style='font-family: 微软雅黑, "Microsoft YaHei";'></span></p>
<pre class="brush:python;toolbar:false">_feedTargetsDict(conf.requestFile, addedTargetUrls)</pre>
<p dir="ltr"><span style='font-family: 微软雅黑, "Microsoft YaHei";'>则是对文件内信息整理并导入conf配置中，这个函数在别的地方也被调用，是一个对文件中request信息通用化处理的一个函数。</span></p>
<pre class="brush:python;toolbar:false">def _feedTargetsDict(reqFile, addedTargetUrls):
    """
    Parses web scarab and burp logs and adds results to the target URL list
    """

    def _parseWebScarabLog(content):
        """
        Parses web scarab logs (POST method not supported)
        """

        reqResList = content.split(WEBSCARAB_SPLITTER)

        for request in reqResList:
            url = extractRegexResult(r"URL: (?P&lt;result&gt;.+?)\n", request, re.I)
            method = extractRegexResult(r"METHOD: (?P&lt;result&gt;.+?)\n", request, re.I)
            cookie = extractRegexResult(r"COOKIE: (?P&lt;result&gt;.+?)\n", request, re.I)

            if not method or not url:
                logger.debug("not a valid WebScarab log data")
                continue

            if method.upper() == HTTPMETHOD.POST:
                warnMsg = "POST requests from WebScarab logs aren't supported "
                warnMsg += "as their body content is stored in separate files. "
                warnMsg += "Nevertheless you can use -r to load them individually."
                logger.warning(warnMsg)
                continue

            if not(conf.scope and not re.search(conf.scope, url, re.I)):
                if not kb.targets or url not in addedTargetUrls:
                    kb.targets.add((url, method, None, cookie, None))
                    addedTargetUrls.add(url)</pre>
<p dir="ltr"><span style='font-family: 微软雅黑, "Microsoft YaHei";'>首先对文件中http请求包头部进行分割处理，之后分别进行检查，然后更新到kb中相应部分。</span></p>
<p dir="ltr"><span style='font-family: 微软雅黑, "Microsoft YaHei";'>这里注意到对WebScarab log文件有所限制，这个之后在-l参数对应的部分做说明。</span></p>
<p dir="ltr"><span style='font-family: 微软雅黑, "Microsoft YaHei";'>接下来是对conf中的信息进行正则分析过滤（一些是直接改变存储方式，比如对数据类型进行转换）<br/></span></p>
<p dir="ltr"><span style='font-family: 微软雅黑, "Microsoft YaHei";'></span></p>
<pre class="brush:python;toolbar:false">_cleanupOptions()</pre>
<p dir="ltr"><span style='font-family: 微软雅黑, "Microsoft YaHei";'>这段太长而且大多都是对conf里属性分别正则分析的代码，就不贴上来了。</span></p>
<p dir="ltr"><span style='font-family: 微软雅黑, "Microsoft YaHei";'>这里会保持多线程信息的同步。</span></p>
<pre class="brush:python;toolbar:false">  threadData = getCurrentThreadData()
  threadData.reset()</pre>
<p dir="ltr"><span style='font-family: 微软雅黑, "Microsoft YaHei";'>接下来是对http response包最大大小的规定，以便于能够接受因为注入而带来的过长的返回包。</span></p>
<pre class="brush:python;toolbar:false">_dirtyPatches()</pre>
<pre class="brush:python;toolbar:false">def _dirtyPatches():
    """
    Place for "dirty" Python related patches
    """

    httplib._MAXLINE = 1 * 1024 * 1024</pre>
<p dir="ltr"><span style='font-family: 微软雅黑, "Microsoft YaHei";'>查阅资料发现httplib也是python的一个相对底层的http请求模块，它封装在urllib内建模块之下，用起来比urllib更灵活。</span></p>
<p dir="ltr"><span style='font-family: 微软雅黑, "Microsoft YaHei";'>接下来是清空输出目录选项(可选择参数)</span></p>
<pre class="brush:python;toolbar:false">_purgeOutput()</pre>
<pre class="brush:python;toolbar:false">def _purgeOutput():
    """
    Safely removes (purges) output directory.
    """

    if conf.purgeOutput:
        purge(paths.SQLMAP_OUTPUT_PATH)</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>conf.purgeOutput是对应参数分析中的--purge-output参数。</span></p>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'></span></p>
<pre class="brush:python;toolbar:false">purge(paths.SQLMAP_OUTPUT_PATH)</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>这个函数可追溯到/lib/utils/purge.py</span></p>
<p><span style="font-family:微软雅黑, Microsoft YaHei">因为代码太长，就不贴了。这个模块是安全的将某目录下的文件删除，自然是按照国际标准的“安全方式”。首先检查文件夹（目录）的存在性，然后将里面的所有文件循环导入列表中。首先更改文件权限（try），之后将随机内容覆写到各文件中，之后清空文件。</span></p>
<pre class="brush:python;toolbar:false"> for filepath in filepaths:
        try:
            with open(filepath, 'w') as f:
                pass
        except:
            pass</pre>
<p><span style="font-family:微软雅黑, Microsoft YaHei">之后随机化文件名、目录名，最后整体删除。这个流程值得学习，可以mark一下。</span></p>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>接下来是检查缺失（非核心）的sqlmap依赖 （可选参数）</span></p>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'></span></p>
<pre class="brush:python;toolbar:false">_checkDependencies()</pre>
<pre class="brush:python;toolbar:false">def _checkDependencies():
    """
    Checks for missing dependencies.
    """

    if conf.dependencies:
        checkDependencies()</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>conf.dependencies对应的正是--dependencies参数</span></p>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>checkDependencies()定义在\lib\utils\deps.py模块</span></p>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>接下来是为sqlmap运行建立临时文件。<br/></span></p>
<pre class="brush:python;toolbar:false">_createTemporaryDirectory()</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>接下来是<span style='font-family: 微软雅黑, "Microsoft YaHei";'>对于用户输入基本参数的错误进行分类输出。</span></span></p>
<pre class="brush:python;toolbar:false">_basicOptionValidation()</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>接下来是从文件中读取代理信息（可选参数）</span></p>
<pre class="brush:python;toolbar:false">_setProxyList()</pre>
<pre class="brush:python;toolbar:false">def _setProxyList():
    if not conf.proxyFile:
        return

    conf.proxyList = []
    for match in re.finditer(r"(?i)((http[^:]*|socks[^:]*)://)?([\w.]+):(\d+)", readCachedFileContent(conf.proxyFile)):
        _, type_, address, port = match.groups()
        conf.proxyList.append("%s://%s:%s" % (type_ or "http", address, port))</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>conf.proxyFile对应 --proxy-file参数。</span></p>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>接下来是匿名访问代理的设置（可选参数）<br/></span></p>
<pre class="brush:python;toolbar:false">_setTorProxySettings()</pre>
<pre class="brush:python;toolbar:false">def _setTorProxySettings():
    if not conf.tor:
        return

    if conf.torType == PROXY_TYPE.HTTP:
        _setTorHttpProxySettings()
    else:
        _setTorSocksProxySettings()</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>conf.tor对应的就是--tor参数了，conf.torType就是--tor-type参数，在_setTorHttpProxySettings()中有conf.torPort对应--tor-port参数，如果没有此选项就使用缺省的端口DEFAULT_TOR_HTTP_PORTS。</span></p>
<p><span style="font-family:微软雅黑, Microsoft YaHei">接下来是</span><span style='font-family: "Lucida Grande", "Helvetica Neue", Arial, "Hiragino Sans GB", "Noto Sans CJK SC", "Heiti SC", "Microsoft YaHei", "WenQuanYi Microhei", sans-serif; color: rgb(136, 136, 136); font-size: 15px; letter-spacing: 0.6px; background-color: rgba(160, 160, 160, 0.0980392);'>DNS exfiltration attack</span><span style='font-size: 15px; letter-spacing: 0.6px; background-color: rgba(160, 160, 160, 0.0980392); color: rgb(0, 0, 0); font-family: 微软雅黑, "Microsoft YaHei";'>相关的DNS配置(可选参数)</span></p>
<pre class="brush:python;toolbar:false">_setDNSServer()</pre>
<pre class="brush:python;toolbar:false">def _setDNSServer():
    if not conf.dnsName:
        return

    infoMsg = "setting up DNS server instance"
    logger.info(infoMsg)

    isAdmin = runningAsAdmin()

    if isAdmin:
        try:
            conf.dnsServer = DNSServer()
            conf.dnsServer.run()
        except socket.error, msg:
            errMsg = "there was an error while setting up "
            errMsg += "DNS server instance ('%s')" % msg
            raise SqlmapGenericException(errMsg)
    else:
        errMsg = "you need to run sqlmap as an administrator "
        errMsg += "if you want to perform a DNS data exfiltration attack "
        errMsg += "as it will need to listen on privileged UDP port 53 "
        errMsg += "for incoming address resolution attempts"
        raise SqlmapMissingPrivileges(errMsg)</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>conf.dnsName对应的就是 --dns-domain参数，注意这里要求必须用管理员权限运行sqlmap。</span></p>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>接下来是调整log信息格式<br/></span></p>
<pre class="brush:python;toolbar:false">_adjustLoggingFormatter()</pre>
<pre class="brush:python;toolbar:false">def _adjustLoggingFormatter():
    """
    Solves problem of line deletition caused by overlapping logging messages
    and retrieved data info in inference mode
    """

    if hasattr(FORMATTER, '_format'):
        return

    def format(record):
        message = FORMATTER._format(record)
        message = boldifyMessage(message)
        if kb.get("prependFlag"):
            message = "\n%s" % message
            kb.prependFlag = False
        return message

    FORMATTER._format = FORMATTER.format
    FORMATTER.format = format</pre>
<p><span style="font-family:微软雅黑, Microsoft YaHei">意义不明，应该是解决重叠的输出信息导致行缺失？</span></p>
<p><span style="font-family:微软雅黑, Microsoft YaHei">接下来是burp或WebScarab中提取出代理记录（可选参数）</span></p>
<pre class="brush:python;toolbar:false">_setMultipleTargets()</pre>
<pre class="brush:python;toolbar:false">def _setMultipleTargets():
    """
    Define a configuration parameter if we are running in multiple target
    mode.
    """

    initialTargetsCount = len(kb.targets)
    addedTargetUrls = set()

    if not conf.logFile:
        return

    debugMsg = "parsing targets list from '%s'" % conf.logFile
    logger.debug(debugMsg)

    if not os.path.exists(conf.logFile):
        errMsg = "the specified list of targets does not exist"
        raise SqlmapFilePathException(errMsg)

    if os.path.isfile(conf.logFile):
        _feedTargetsDict(conf.logFile, addedTargetUrls)

    elif os.path.isdir(conf.logFile):
        files = os.listdir(conf.logFile)
        files.sort()

        for reqFile in files:
            if not re.search("([\d]+)\-request", reqFile):
                continue

            _feedTargetsDict(os.path.join(conf.logFile, reqFile), addedTargetUrls)

    else:
        errMsg = "the specified list of targets is not a file "
        errMsg += "nor a directory"
        raise SqlmapFilePathException(errMsg)

    updatedTargetsCount = len(kb.targets)

    if updatedTargetsCount &gt; initialTargetsCount:
        infoMsg = "sqlmap parsed %d " % (updatedTargetsCount - initialTargetsCount)
        infoMsg += "(parameter unique) requests from the "
        infoMsg += "targets list ready to be tested"
        logger.info(infoMsg)</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>conf.logFile就对应着-l参数，这里是从<span style='font-family: 微软雅黑, "Microsoft YaHei";'>burp或WebScarab log文件中提取信息更新conf和kb</span></span></p>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>之前说过要在这里备注上_feedTargetsDict（）函数对于WebScarab的特殊要求</span></p>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>内容上必须包含METHOD和URL，POST方式不能在发送包的body中放POST数据，否则应使用-r的形式读取信息。<br/></span></p>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>接下来是从自定义tamper脚本中加载函数（可选参数）<br/></span></p>
<pre class="brush:python;toolbar:false">_setTamperingFunctions()</pre>
<p><span style="font-family:微软雅黑, Microsoft YaHei">conf.tamper对应的就是--tamper参数。</span></p>
<p><span style="font-family:微软雅黑, Microsoft YaHei">使用时引用的函数最好不要超过三个。</span></p>
<p><span style="font-family:微软雅黑, Microsoft YaHei">tamper文件都在tamper目录中，可以依据标准格式自定义，比如把payload用base64编码等......</span></p>
<pre class="brush:python;toolbar:false"> if kb.tamperFunctions and len(kb.tamperFunctions) &gt; 3:
            warnMsg = "using too many tamper scripts is usually not "
            warnMsg += "a good idea"
            logger.warning(warnMsg)</pre>
<p><span style="font-family:微软雅黑, Microsoft YaHei">接下来是加载WAF/IDS/IPS测试函数(可选参数)</span></p>
<pre class="brush:python;toolbar:false">_setWafFunctions()</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>conf.identifyWaf对应的是--identify-waf参数</span></p>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>sqlmap能够测试的WAF基本上是很齐全了，都在waf目录中。</span></p>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>接下来是记录http流量到文本文件中（可选参数）<br/></span></p>
<pre class="brush:python;toolbar:false">_setTrafficOutputFP()</pre>
<pre class="brush:python;toolbar:false">def _setTrafficOutputFP():
    if conf.trafficFile:
        infoMsg = "setting file for logging HTTP traffic"
        logger.info(infoMsg)

        conf.trafficFP = openFile(conf.trafficFile, "w+")</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>conf.trafficFile对应的-t参数。</span></p>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>接下来是解决交叉引用（模块相互引用）<br/></span></p>
<pre class="brush:python;toolbar:false">_resolveCrossReferences()</pre>
<pre class="brush:python;toolbar:false">def _resolveCrossReferences():
    lib.core.threads.readInput = readInput
    lib.core.common.getPageTemplate = getPageTemplate
    lib.core.convert.singleTimeWarnMessage = singleTimeWarnMessage
    lib.request.connect.setHTTPHandlers = _setHTTPHandlers
    lib.utils.search.setHTTPHandlers = _setHTTPHandlers
    lib.controller.checks.setVerbosity = setVerbosity</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>接下来是检查WebSocket协议</span></p>
<pre class="brush:python;toolbar:false">_checkWebSocket()</pre>
<pre class="brush:python;toolbar:false">def _checkWebSocket():
    if conf.url and (conf.url.startswith("ws:/") or conf.url.startswith("wss:/")):
        try:
            from websocket import ABNF
        except ImportError:
            errMsg = "sqlmap requires third-party module 'websocket-client' "
            errMsg += "in order to use WebSocket funcionality"
            raise SqlmapMissingDependence(errMsg)</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>接下来是解析url，然后把各部分配置到相应属性</span></p>
<pre class="brush:python;toolbar:false">parseTargetUrl()</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>在/lib/core/common.py</span></p>
<pre class="brush:python;toolbar:false">def parseTargetUrl():
    """
    Parse target URL and set some attributes into the configuration singleton.
    """
    
    if not conf.url:
        return
    
    originalUrl = conf.url 
    
    #url是否为ipv6地址
    if re.search("\[.+\]", conf.url) and not socket.has_ipv6:
        errMsg = "IPv6 addressing is not supported "
        errMsg += "on this platform"
        raise SqlmapGenericException(errMsg)

    #如果url没有包含协议名，根据端口自动加上协议名
    if not re.search("^http[s]*://", conf.url, re.I) and \
            not re.search("^ws[s]*://", conf.url, re.I):
        if ":443/" in conf.url:
            conf.url = "https://" + conf.url
        else:
            conf.url = "http://" + conf.url
    
    #替换参数前问号
    if CUSTOM_INJECTION_MARK_CHAR in conf.url:
        conf.url = conf.url.replace('?', URI_QUESTION_MARKER)
    
    #分割url
    try:
        urlSplit = urlparse.urlsplit(conf.url)
    except ValueError, ex:
        errMsg = "invalid URL '%s' has been given ('%s'). " % (conf.url, getSafeExString(ex))
        errMsg += "Please be sure that you don't have any leftover characters (e.g. '[' or ']') "
        errMsg += "in the hostname part"
        raise SqlmapGenericException(errMsg)

    #根据分割的信息对conf几个属性赋值
    hostnamePort = urlSplit.netloc.split(":") if not re.search("\[.+\]", urlSplit.netloc) else filter(None, (re.search("\[.+\]", urlSplit.netloc).group(0), re.search("\](:(?P&lt;port&gt;\d+))?", urlSplit.netloc).group("port")))
   
    conf.scheme = urlSplit.scheme.strip().lower() if not conf.forceSSL else "https"
    conf.path = urlSplit.path.strip()
    conf.hostname = hostnamePort[0].strip()

    conf.ipv6 = conf.hostname != conf.hostname.strip("[]")
    conf.hostname = conf.hostname.strip("[]").replace(CUSTOM_INJECTION_MARK_CHAR, "")

    try:
        _ = conf.hostname.encode("idna")
    except LookupError:
        _ = conf.hostname.encode(UNICODE_ENCODING)
    except UnicodeError:
        _ = None

    if any((_ is None, re.search(r'\s', conf.hostname), '..' in conf.hostname, conf.hostname.startswith('.'))):
        errMsg = "invalid target URL"
        raise SqlmapSyntaxException(errMsg)

    if len(hostnamePort) == 2:
        try:
            conf.port = int(hostnamePort[1])
        except:
            errMsg = "invalid target URL"
            raise SqlmapSyntaxException(errMsg)
    elif conf.scheme == "https":
        conf.port = 443
    else:
        conf.port = 80
    
    #url格式标准化
    conf.url = getUnicode("%s://%s:%d%s" % (conf.scheme, ("[%s]" % conf.hostname) if conf.ipv6 else conf.hostname, conf.port, conf.path))
    conf.url = conf.url.replace(URI_QUESTION_MARKER, '?')

    if urlSplit.query:
        if '=' not in urlSplit.query:
            conf.url = "%s?%s" % (conf.url, getUnicode(urlSplit.query))
        else:
            conf.parameters[PLACE.GET] = urldecode(urlSplit.query) if urlSplit.query and urlencode(DEFAULT_GET_POST_DELIMITER, None) not in urlSplit.query else urlSplit.query
    
    #添加referer
    if not conf.referer and (intersect(REFERER_ALIASES, conf.testParameter, True) or conf.level &gt;= 3):
        debugMsg = "setting the HTTP Referer header to the target URL"
        logger.debug(debugMsg)
        conf.httpHeaders = filter(lambda (key, value): key != HTTP_HEADER.REFERER, conf.httpHeaders)
        conf.httpHeaders.append((HTTP_HEADER.REFERER, conf.url.replace(CUSTOM_INJECTION_MARK_CHAR, "")))
    
    #添加host
    if not conf.host and (intersect(HOST_ALIASES, conf.testParameter, True) or conf.level &gt;= 5):
        debugMsg = "setting the HTTP Host header to the target URL"
        logger.debug(debugMsg)
        conf.httpHeaders = filter(lambda (key, value): key != HTTP_HEADER.HOST, conf.httpHeaders)
        conf.httpHeaders.append((HTTP_HEADER.HOST, getHostHeader(conf.url)))

    #更新kb中的原始url
    if conf.url != originalUrl:
        kb.originalUrls[conf.url] = originalUrl</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>接下来是数据库直连时解析数据库信息并配置到各属性上</span></p>
<pre class="brush:python;toolbar:false">parseTargetDirect()</pre>
<pre class="brush:python;toolbar:false">def parseTargetDirect():
    """
    Parse target dbms and set some attributes into the configuration singleton.
    """

    if not conf.direct:
        return

    details = None
    remote = False

    for dbms in SUPPORTED_DBMS:
        #拆分数据库信息
        details = re.search("^(?P&lt;dbms&gt;%s)://(?P&lt;credentials&gt;(?P&lt;user&gt;.+?)\:(?P&lt;pass&gt;.*)\@)?(?P&lt;remote&gt;(?P&lt;hostname&gt;.+?)\:(?P&lt;port&gt;[\d]+)\/)?(?P&lt;db&gt;[\w\d\ \:\.\_\-\/\\\\]+?)$" % dbms, conf.direct, re.I)

        if details:
            conf.dbms = details.group("dbms")
            
            #证书信息
            if details.group('credentials'):
                conf.dbmsUser = details.group("user")
                conf.dbmsPass = details.group("pass")
            else:
                if conf.dbmsCred:
                    conf.dbmsUser, conf.dbmsPass = conf.dbmsCred.split(':')
                else:
                    conf.dbmsUser = unicode()
                    conf.dbmsPass = unicode()

            if not conf.dbmsPass:
                conf.dbmsPass = None
            
            #数据库所在服务器
            if details.group("remote"):
                remote = True
                conf.hostname = details.group("hostname").strip()
                conf.port = int(details.group("port"))
            else:
                conf.hostname = "localhost"
                conf.port = 0

            conf.dbmsDb = details.group("db")
            conf.parameters[None] = "direct connection"

            break

    if not details:
        errMsg = "invalid target details, valid syntax is for instance "
        errMsg += "'mysql://USER:PASSWORD@DBMS_IP:DBMS_PORT/DATABASE_NAME' "
        errMsg += "or 'access://DATABASE_FILEPATH'"
        raise SqlmapSyntaxException(errMsg)

    for dbmsName, data in DBMS_DICT.items():
        if dbmsName == conf.dbms or conf.dbms.lower() in data[0]:
            try:
               
                #ACCESS,SQLITE,FIREBIRD数据库不能远程直连
                if dbmsName in (DBMS.ACCESS, DBMS.SQLITE, DBMS.FIREBIRD):
                    if remote:
                        warnMsg = "direct connection over the network for "
                        warnMsg += "%s DBMS is not supported" % dbmsName
                        logger.warn(warnMsg)

                        conf.hostname = "localhost"
                        conf.port = 0
                elif not remote:
                    errMsg = "missing remote connection details (e.g. "
                    errMsg += "'mysql://USER:PASSWORD@DBMS_IP:DBMS_PORT/DATABASE_NAME' "
                    errMsg += "or 'access://DATABASE_FILEPATH')"
                    raise SqlmapSyntaxException(errMsg)
                
                #调用相应sql模块
                if dbmsName in (DBMS.MSSQL, DBMS.SYBASE):
                    import _mssql
                    import pymssql

                    if not hasattr(pymssql, "__version__") or pymssql.__version__ &lt; "1.0.2":
                        errMsg = "'%s' third-party library must be " % data[1]
                        errMsg += "version &gt;= 1.0.2 to work properly. "
                        errMsg += "Download from '%s'" % data[2]
                        raise SqlmapMissingDependence(errMsg)

                elif dbmsName == DBMS.MYSQL:
                    import pymysql
                elif dbmsName == DBMS.PGSQL:
                    import psycopg2
                elif dbmsName == DBMS.ORACLE:
                    import cx_Oracle
                elif dbmsName == DBMS.SQLITE:
                    import sqlite3
                elif dbmsName == DBMS.ACCESS:
                    import pyodbc
                elif dbmsName == DBMS.FIREBIRD:
                    import kinterbasdb
            except ImportError:
                if _sqlalchemy and data[3] in _sqlalchemy.dialects.__all__:
                    pass
                else:
                    errMsg = "sqlmap requires '%s' third-party library " % data[1]
                    errMsg += "in order to directly connect to the DBMS "
                    errMsg += "%s. You can download it from '%s'" % (dbmsName, data[2])
                    errMsg += ". Alternative is to use a package 'python-sqlalchemy' "
                    errMsg += "with support for dialect '%s' installed" % data[3]
                    raise SqlmapMissingDependence(errMsg)</pre>
<p><span style="font-family:微软雅黑, Microsoft YaHei">下面是在如下条件（<span style='color: rgb(136, 136, 136); font-family: 微软雅黑, "Microsoft YaHei"; font-size: 15px; letter-spacing: 0.6px;'>基本参数</span>）下执行的</span></p>
<pre class="brush:python;toolbar:false">if any((conf.url, conf.logFile, conf.bulkFile, conf.sitemapUrl, conf.requestFile, conf.googleDork, conf.liveTest)):</pre>
<p><span style="font-family:微软雅黑, Microsoft YaHei">首先是设置http请求间隔（最短3秒)</span></p>
<pre class="brush:python;toolbar:false">_setHTTPTimeout()</pre>
<pre class="brush:python;toolbar:false">def _setHTTPTimeout():
    """
    Set the HTTP timeout
    """

    if conf.timeout:
        debugMsg = "setting the HTTP timeout"
        logger.debug(debugMsg)

        conf.timeout = float(conf.timeout)

        if conf.timeout &lt; 3.0:
            warnMsg = "the minimum HTTP timeout is 3 seconds, sqlmap "
            warnMsg += "will going to reset it"
            logger.warn(warnMsg)

            conf.timeout = 3.0
    else:
        conf.timeout = 30.0

    socket.setdefaulttimeout(conf.timeout)</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>接下来是头部信息的设置</span></p>
<pre class="brush:python;toolbar:false">_setHTTPExtraHeaders()</pre>
<pre class="brush:python;toolbar:false">def _setHTTPExtraHeaders():
    if conf.headers:
        debugMsg = "setting extra HTTP headers"
        logger.debug(debugMsg)

        conf.headers = conf.headers.split("\n") if "\n" in conf.headers else conf.headers.split("\\n")
        #遍历headers，分离header中的key和value
        for headerValue in conf.headers:
            if not headerValue.strip():
                continue

            if headerValue.count(':') &gt;= 1:
                header, value = (_.lstrip() for _ in headerValue.split(":", 1))

                if header and value:
                    conf.httpHeaders.append((header, value))
            else:
                errMsg = "invalid header value: %s. Valid header format is 'name:value'" % repr(headerValue).lstrip('u')
                raise SqlmapSyntaxException(errMsg)
    
    elif not conf.requestFile and len(conf.httpHeaders or []) &lt; 2:
        conf.httpHeaders.append((HTTP_HEADER.ACCEPT_LANGUAGE, "en-us,en;q=0.5"))
        if not conf.charset:
            conf.httpHeaders.append((HTTP_HEADER.ACCEPT_CHARSET, "ISO-8859-15,utf-8;q=0.7,*;q=0.7"))
        else:
            conf.httpHeaders.append((HTTP_HEADER.ACCEPT_CHARSET, "%s;q=0.7,*;q=0.1" % conf.charset))

        # Invalidating any caching mechanism in between
        # Reference: http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html
        conf.httpHeaders.append((HTTP_HEADER.CACHE_CONTROL, "no-cache,no-store"))
        conf.httpHeaders.append((HTTP_HEADER.PRAGMA, "no-cache"))</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>指定cookie</span></p>
<pre class="brush:python;toolbar:false">_setHTTPCookies()</pre>
<pre class="brush:python;toolbar:false">def _setHTTPCookies():
    """
    Set the HTTP Cookie header
    """

    if conf.cookie:
        debugMsg = "setting the HTTP Cookie header"
        logger.debug(debugMsg)

        conf.httpHeaders.append((HTTP_HEADER.COOKIE, conf.cookie))</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>指定referer</span></p>
<pre class="brush:python;toolbar:false">_setHTTPReferer()</pre>
<pre class="brush:python;toolbar:false">def _setHTTPReferer():
    """
    Set the HTTP Referer
    """

    if conf.referer:
        debugMsg = "setting the HTTP Referer header"
        logger.debug(debugMsg)

        conf.httpHeaders.append((HTTP_HEADER.REFERER, conf.referer))</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>指定host</span></p>
<pre class="brush:python;toolbar:false">_setHTTPHost()</pre>
<pre class="brush:python;toolbar:false">def _setHTTPHost():
    """
    Set the HTTP Host
    """

    if conf.host:
        debugMsg = "setting the HTTP Host header"
        logger.debug(debugMsg)

        conf.httpHeaders.append((HTTP_HEADER.HOST, conf.host))</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>指定UA</span></p>
<pre class="brush:python;toolbar:false">_setHTTPUserAgent()</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>模拟手机UA</span></p>
<pre class="brush:python;toolbar:false">if conf.mobile:</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>指定UA</span></p>
<pre class="brush:python;toolbar:false"> elif conf.agent:</pre>
<p><span style="font-family:微软雅黑, Microsoft YaHei">缺省的UA</span></p>
<pre class="brush:python;toolbar:false"> elif not conf.randomAgent:
      _ = True

        for header, _ in conf.httpHeaders:
            if header == HTTP_HEADER.USER_AGENT:
                _ = False
                break

        if _:
            conf.httpHeaders.append((HTTP_HEADER.USER_AGENT, _defaultHTTPUserAgent()))</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>随机UA</span></p>
<pre class="brush:python;toolbar:false">else:
        if not kb.userAgents:
            debugMsg = "loading random HTTP User-Agent header(s) from "
            debugMsg += "file '%s'" % paths.USER_AGENTS
            logger.debug(debugMsg)

            try:
                kb.userAgents = getFileItems(paths.USER_AGENTS)
            except IOError:
                warnMsg = "unable to read HTTP User-Agent header "
                warnMsg += "file '%s'" % paths.USER_AGENTS
                logger.warn(warnMsg)

                conf.httpHeaders.append((HTTP_HEADER.USER_AGENT, _defaultHTTPUserAgent()))
                return

        userAgent = random.sample(kb.userAgents or [_defaultHTTPUserAgent()], 1)[0]

        infoMsg = "fetched random HTTP User-Agent header from "
        infoMsg += "file '%s': '%s'" % (paths.USER_AGENTS, userAgent)
        logger.info(infoMsg)

        conf.httpHeaders.append((HTTP_HEADER.USER_AGENT, userAgent))</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>接下来是检查并设置http(s)认证方式（账号密码/密钥文件）</span></p>
<pre class="brush:python;toolbar:false">_setHTTPAuthentication()</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>之后是按照设置配置全局代理</span></p>
<pre class="brush:python;toolbar:false">_setHTTPHandlers()</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>之后是设置DNS缓存</span></p>
<pre class="brush:python;toolbar:false">_setDNSCache()</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>接下来是预连接的初始化和相关函数重构</span></p>
<pre class="brush:python;toolbar:false">def _setSocketPreConnect():
    """
    Makes a pre-connect version of socket.connect
    """

    if conf.disablePrecon:
        return
    
    #预连接初始化
    def _():
        while kb.threadContinue and not conf.disablePrecon:
            try:
                for key in socket._ready:
                    if len(socket._ready[key]) &lt; SOCKET_PRE_CONNECT_QUEUE_SIZE:
                        family, type, proto, address = key
                        s = socket.socket(family, type, proto)
                        s._connect(address)
                        with kb.locks.socket:
                            socket._ready[key].append(s._sock)
            except KeyboardInterrupt:
                break
            except:
                pass
            finally:
                time.sleep(0.01)

    #改进的有关预连接的connect函数
    def connect(self, address):
        found = False
        #出栈一个预连接对象
        key = (self.family, self.type, self.proto, address)
        with kb.locks.socket:
            if key not in socket._ready:
                socket._ready[key] = []
            if len(socket._ready[key]) &gt; 0:
                self._sock = socket._ready[key].pop(0)
                found = True
        #正常的connect函数
        if not found:
            self._connect(address)

    if not hasattr(socket.socket, "_connect"):
        socket._ready = {}
        #socket模块本身的connect函数转为_connect,新产生的预连接的connect函数移植到socket对象上
        socket.socket._connect = socket.socket.connect
        socket.socket.connect = connect
        #启用预连接（初始化）
        thread = threading.Thread(target=_)
        setDaemon(thread)
        thread.start()</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>然后是分析safe-url配置到kb中相应属性上</span></p>
<pre class="brush:python;toolbar:false">_setSafeVisit()</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>接下来是配置google-dork功能所需的信息</span></p>
<pre class="brush:python;toolbar:false">_doSearch()
#link是从links（搜索结果）中取出的一个
kb.targets.add((link, conf.method, conf.data, conf.cookie, None))</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>接下来是-m（指定含有多个测试连接的文件）的相应属性的配置</span></p>
<pre class="brush:python;toolbar:false">_setBulkMultipleTargets()</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>可以说属于google-dork的一部分了，这里的连接url都由用户给出。</span></p>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>接下来是-x(xml地图上读取url)的相应属性的配置<br/></span></p>
<pre class="brush:python;toolbar:false">_setSitemapTargets()</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>正则过滤出欲测试url然后就与上面相同了。</span></p>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>接下来是通过访问<a _src="https://check.torproject.org/的返回结果来检查匿名访问是否可用" href="https://check.torproject.org/的返回结果来检查匿名访问是否可用">https://check.torproject.org/</a>的返回结果来检查匿名访问是否可用。</span></p>
<pre class="brush:python;toolbar:false">_checkTor()</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>接下来是执行爬虫功能（需用户提交参数开启）</span></p>
<pre class="brush:python;toolbar:false">def _setCrawler():
    if not conf.crawlDepth:
        return

    if not any((conf.bulkFile, conf.sitemapUrl)):
        crawl(conf.url)
    else:
        if conf.bulkFile:
            targets = getFileItems(conf.bulkFile)
        else:
            targets = parseSitemap(conf.sitemapUrl)
        for i in xrange(len(targets)):
            try:
                target = targets[i]
                crawl(target)

                if conf.verbose in (1, 2):
                    status = "%d/%d links visited (%d%%)" % (i + 1, len(targets), round(100.0 * (i + 1) / len(targets)))
                    dataToStdout("\r[%s] [INFO] %s" % (time.strftime("%X"), status), True)
            except Exception, ex:
                errMsg = "problem occurred while crawling at '%s' ('%s')" % (target, getSafeExString(ex))
                logger.error(errMsg)</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>crawl函数在爬虫模块/lib/utils/crawler.py</span></p>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>接下来是--forms，解析出页面的所有表单的功能实现。</span></p>
<pre class="brush:python;toolbar:false">_findPageForms()</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>调用了/lib/core/common.py中的findPageForms()函数，而对于除了-u方式直接输入目标url的其他输入方式都采用先解析urls，再分别查表的方式。</span></p>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>然后是处理--dbms选项，指定数据库类型。</span></p>
<pre class="brush:python;toolbar:false">_setDBMS()</pre>
<pre class="brush:python;toolbar:false">def _setDBMS():
    """
    Force the back-end DBMS option.
    """

    if not conf.dbms:
        return

    debugMsg = "forcing back-end DBMS to user defined value"
    logger.debug(debugMsg)

    conf.dbms = conf.dbms.lower()
    regex = re.search("%s ([\d\.]+)" % ("(%s)" % "|".join([alias for alias in SUPPORTED_DBMS])), conf.dbms, re.I)

    if regex:
        conf.dbms = regex.group(1)
        Backend.setVersion(regex.group(2))

    if conf.dbms not in SUPPORTED_DBMS:
        errMsg = "you provided an unsupported back-end database management "
        errMsg += "system. Supported DBMSes are as follows: %s. " % ', '.join(sorted(_ for _ in DBMS_DICT))
        errMsg += "If you do not know the back-end DBMS, do not provide "
        errMsg += "it and sqlmap will fingerprint it for you."
        raise SqlmapUnsupportedDBMSException(errMsg)

    for dbms, aliases in DBMS_ALIASES:
        if conf.dbms in aliases:
            conf.dbms = dbms

            break</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei"; text-decoration: none;'>然后是处理--technique参数，指定注入技术</span></p>
<pre class="brush:python;toolbar:false">def _setTechnique():
    validTechniques = sorted(getPublicTypeMembers(PAYLOAD.TECHNIQUE), key=lambda x: x[1])
    validLetters = [_[0][0].upper() for _ in validTechniques]

    if conf.tech and isinstance(conf.tech, basestring):
        _ = []

        for letter in conf.tech.upper():
            if letter not in validLetters:
                errMsg = "value for --technique must be a string composed "
                errMsg += "by the letters %s. Refer to the " % ", ".join(validLetters)
                errMsg += "user's manual for details"
                raise SqlmapSyntaxException(errMsg)

            for validTech, validInt in validTechniques:
                if letter == validTech[0]:
                    _.append(validInt)
                    break

        conf.tech = _</pre>
<p><span style="font-family:微软雅黑, Microsoft YaHei">有关必选参数的初始化处理到这里就结束了，接下来是设置线程数</span></p>
<pre class="brush:python;toolbar:false">def _setThreads():
    if not isinstance(conf.threads, int) or conf.threads &lt;= 0:
        conf.threads = 1</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>接下来是--os参数，设置数据库所在的系统环境</span></p>
<pre class="brush:python;toolbar:false"> _setOS()</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'></span><span style='font-family: 微软雅黑, "Microsoft YaHei";'>接下来是--file-write参数，数据库写文件功能的路径检查</span></p>
<pre class="brush:python;toolbar:false">_setWriteFile()</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'></span><span style='font-family: 微软雅黑, "Microsoft YaHei";'>接下来是--os-pwn --os-smbrelay --os-bof 三个参数 检查Metasploit框架的路径等信息</span></p>
<pre class="brush:python;toolbar:false"> _setMetasploit()</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>接下来是设置非缓存用户的数据库账号和口令</span></p>
<pre class="brush:python;toolbar:false">_setDBMSAuthentication()</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'></span><span style='font-family: 微软雅黑, "Microsoft YaHei";'>接下来是解析（payload适用条件以及payload的使用范围等）【边界】配置文件boundaries.xml，然后进行相关配置</span></p>
<pre class="brush:python;toolbar:false"> loadBoundaries()</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'></span><span style='font-family: 微软雅黑, "Microsoft YaHei";'>接下来是解析payload配置文件(payloads下的几个xml文件)来进行相关配置，比如注入方式、类型等</span></p>
<pre class="brush:python;toolbar:false">loadPayloads()</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'></span><span style='font-family: 微软雅黑, "Microsoft YaHei";'>接下来是对payload前缀后缀相关功能的参数的配置（创建一个新的类似conf、kb的对象专门设置边界值）</span></p>
<pre class="brush:python;toolbar:false">def _setPrefixSuffix():
    if conf.prefix is not None and conf.suffix is not None:
        # Create a custom boundary object for user's supplied prefix
        # and suffix
        boundary = AttribDict()

        boundary.level = 1
        boundary.clause = [0]
        boundary.where = [1, 2, 3]
        boundary.prefix = conf.prefix
        boundary.suffix = conf.suffix

        if " like" in boundary.suffix.lower():
            if "'" in boundary.suffix.lower():
                boundary.ptype = 3
            elif '"' in boundary.suffix.lower():
                boundary.ptype = 5
        elif "'" in boundary.suffix:
            boundary.ptype = 2
        elif '"' in boundary.suffix:
            boundary.ptype = 4
        else:
            boundary.ptype = 1

        # user who provides --prefix/--suffix does not want other boundaries
        # to be tested for
        conf.boundaries = [boundary]</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>接下来是sqlmap自更新相关参数的实现【从github拖最新版】（话说为什么要在这里更新，感觉结构上不太合适呀！）</span></p>
<pre class="brush:python;toolbar:false"> update()</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'>接下来是初始化的最后一步，解析各种数据库sql语法文件(queries.xml)，构造sql语法</span></p>
<pre class="brush:python;toolbar:false">def _loadQueries():
    """
    Loads queries from 'xml/queries.xml' file.
    """

    def iterate(node, retVal=None):
        class DictObject(object):
            def __init__(self):
                self.__dict__ = {}

            def __contains__(self, name):
                return name in self.__dict__

        if retVal is None:
            retVal = DictObject()

        for child in node.findall("*"):
            instance = DictObject()
            retVal.__dict__[child.tag] = instance
            if child.attrib:
                instance.__dict__.update(child.attrib)
            else:
                iterate(child, instance)

        return retVal

    tree = ElementTree()
    try:
        tree.parse(paths.QUERIES_XML)
    except Exception, ex:
        errMsg = "something seems to be wrong with "
        errMsg += "the file '%s' ('%s'). Please make " % (paths.QUERIES_XML, getSafeExString(ex))
        errMsg += "sure that you haven't made any changes to it"
        raise SqlmapInstallationException, errMsg

    for node in tree.findall("*"):
        queries[node.attrib['value']] = iterate(node)</pre>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'></span></p>
<p><span style='font-family: 微软雅黑, "Microsoft YaHei";'><br/></span></p>
<p></p>
</article>
<section class="ending">
<ul class="sns">
<li class="tencent"><a href="http://wpa.qq.com/msgrd?v=3&amp;uin=827977014&amp;site=qq&amp;menu=yes" target="_blank"><i class="iconfont"></i></a></li>
<li class="zhihu"><a href="https://www.zhihu.com/people/wupco " target="_blank"><i class="iconfont"></i></a></li>
</ul>
<div class="reward">
                打
                <ul>
<li><img src="./SQLMAP阅读手记二{参数翻译、系统初始化} – Wupco's Blog/QQ图片20170222193616.png"/>用支付宝打我</li>
<li><img src="./SQLMAP阅读手记二{参数翻译、系统初始化} – Wupco's Blog/QQ图片20170222193616.png"/>用微信打我</li>
</ul>
</div>
<div class="about">
<img alt="" class="avatar avatar-80 photo" height="80" src="./SQLMAP阅读手记二{参数翻译、系统初始化} – Wupco's Blog/cd0d984309c15bd1f668df0d0343eccds=80&amp;d=mm&amp;r=g" srcset="http://cn.gravatar.com/avatar/cd0d984309c15bd1f668df0d0343eccd?s=160&amp;d=mm&amp;r=g 2x" width="80"> <p></p>
</img></div>
</section>
<!-- You can start editing here. -->
<!-- If comments are open, but there are no comments. -->
<div class="comment-respond" id="respond">
<h3 class="comment-reply-title" id="reply-title">发表评论 <small><a href="/?p=378#respond" id="cancel-comment-reply-link" rel="nofollow" style="display:none;">取消回复</a></small></h3> <form action="http://www.wupco.cn/wp-comments-post.php" class="comment-form" id="commentform" method="post">
<p class="comment-notes"><span id="email-notes">电子邮件地址不会被公开。</span> 必填项已用<span class="required">*</span>标注</p><p class="comment-form-comment"><label for="comment">评论</label> <textarea aria-required="true" cols="45" id="comment" maxlength="65525" name="w" required="required" rows="8"></textarea><textarea cols="100%" name="comment" rows="4" style="display:none"></textarea></p><p class="comment-form-author"><label for="author">姓名 <span class="required">*</span></label> <input aria-required="true" id="author" maxlength="245" name="author" required="required" size="30" type="text" value=""/></p>
<p class="comment-form-email"><label for="email">电子邮件 <span class="required">*</span></label> <input aria-describedby="email-notes" aria-required="true" id="email" maxlength="100" name="email" required="required" size="30" type="text" value=""/></p>
<p class="comment-form-url"><label for="url">站点</label> <input id="url" maxlength="200" name="url" size="30" type="text" value=""/></p>
<p class="form-submit"><input class="submit" id="submit" name="submit" type="submit" value="发表评论"/> <input id="comment_post_ID" name="comment_post_ID" type="hidden" value="378"/>
<input id="comment_parent" name="comment_parent" type="hidden" value="0"/>
</p> </form>
</div><!-- #respond -->
</section>
<div class="clearer"></div>
<nav class="navigator">
</nav>
</div>
</div>
<div class="clearer"></div>
<div class="search">
<form action="http://www.wupco.cn" method="get">
<input autocomplete="off" class="search_key" name="s" placeholder="Enter search keywords..." required="required" type="text" value=""/>
<button alt="Search" type="submit">Search</button>
</form>
</div>
<footer id="footer">
<section class="links_adlink">
<ul class="container">
</ul>
</section>
友情链接:<a href="http://www.hazzel.cn">Hazzel师傅</a> <a href="http://www.yqxiaojunjie.com/">俊杰师傅</a> <a href="http://margular.github.io">sunshine</a> <a href="https://3wapp.github.io/">janes师傅</a><br/> <a href="http://www.au1ge.xyz/">au1ge</a><br/>
© 2017 <a href="http://www.wupco.cn">Wupco's Blog</a>
<a class="back2top"></a>
</footer>
<script type="text/javascript">SyntaxHighlighter.all();</script><script type="text/javascript">
/* <![CDATA[ */
var ajaxcomment = {"ajax_url":"http:\/\/www.wupco.cn\/wp-admin\/admin-ajax.php","order":"asc","formpostion":"top"};
/* ]]> */
</script>
<script src="./SQLMAP阅读手记二{参数翻译、系统初始化} – Wupco's Blog/app.jsver=20141010" type="text/javascript"></script>
<script style="display:none">
function index_overloaded(){

}
</script>
<script src="./SQLMAP阅读手记二{参数翻译、系统初始化} – Wupco's Blog/jquery.min.js"></script>
<script src="./SQLMAP阅读手记二{参数翻译、系统初始化} – Wupco's Blog/functions.js"></script>
<script>
</script>
</body>
</html>